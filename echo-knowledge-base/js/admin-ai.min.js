(function(e){e((function(){function t(){e(document).on("click","#delete-selected",(function(t){let a=e(this);let n=a.closest(".epkb-submissions-table-container");let o=n.find("table");if(o.attr("id")!=="epkb-chat-conversations-table"){return}t.preventDefault();t.stopPropagation();t.stopImmediatePropagation();let l=[];o.find(".select-row:checked").each((function(){let t=e(this).closest("tr").data("id");if(t){l.push(t)}}));if(l.length===0){i(epkb_vars.no_conversations_selected||"No conversations selected.");return}if(!confirm((epkb_vars.confirm_delete_selected||"Are you sure you want to delete {count} selected conversation(s)?").replace("{count}",l.length))){return}s("show",epkb_vars.deleting_conversations||"Deleting conversations...");e.ajax({url:(epkb_vars.wpApiSettings?epkb_vars.wpApiSettings.root:"/wp-json/")+"epkb/v1/ai-chat/admin/conversations/bulk",type:"DELETE",data:JSON.stringify({ids:l}),contentType:"application/json",beforeSend:function(e){if(epkb_vars.wpApiSettings&&epkb_vars.wpApiSettings.nonce){e.setRequestHeader("X-WP-Nonce",epkb_vars.wpApiSettings.nonce)}else if(epkb_vars.nonce){e.setRequestHeader("X-WP-Nonce",epkb_vars.nonce)}},success:function(t){s("remove");if(t&&t.deleted){r(t.message||(epkb_vars.conversations_deleted||"{count} conversation(s) deleted successfully.").replace("{count}",t.deleted));l.forEach((function(t){o.find('tr[data-id="'+t+'"]').fadeOut(400,(function(){e(this).remove();n.find("#delete-selected").prop("disabled",true);e("#select-all-epkb-chat-conversations-table").prop("checked",false);let a=e(".epkb-ai-conversation-messages");if(a.find('[data-conversation-id="'+t+'"]').length>0){a.empty();e(".epkb-ai-no-selection").show()}}))}))}else{i(epkb_vars.failed_delete_conversations||"Failed to delete conversations.")}},error:function(e,t,a){s("remove");console.error("Failed to delete conversations:",a);i(epkb_vars.failed_delete_conversations||"Failed to delete conversations.")}});return false}));e(document).on("click","#delete-all",(function(t){let a=e(this);let n=a.closest(".epkb-submissions-table-container");let o=n.find("table");if(o.attr("id")!=="epkb-chat-conversations-table"){return}t.preventDefault();t.stopPropagation();t.stopImmediatePropagation();if(!confirm(epkb_vars.confirm_delete_all||"Are you sure you want to delete ALL chat conversations? This action cannot be undone.")){return}s("show",epkb_vars.deleting_all_conversations||"Deleting all conversations...");e.ajax({url:(epkb_vars.wpApiSettings?epkb_vars.wpApiSettings.root:"/wp-json/")+"epkb/v1/ai-chat/admin/conversations",type:"DELETE",beforeSend:function(e){if(epkb_vars.wpApiSettings&&epkb_vars.wpApiSettings.nonce){e.setRequestHeader("X-WP-Nonce",epkb_vars.wpApiSettings.nonce)}else if(epkb_vars.nonce){e.setRequestHeader("X-WP-Nonce",epkb_vars.nonce)}},success:function(t){s("remove");if(t&&t.deleted!==undefined){r(t.message||(epkb_vars.all_conversations_deleted||"All conversations deleted successfully."));o.find("tbody").empty().append('<tr class="epkb-no-results"><td colspan="100%">'+(epkb_vars.no_conversations_found||"No conversations found.")+"</td></tr>");e(".epkb-ai-conversation-messages").empty();e(".epkb-ai-no-selection").show();n.find("#delete-selected, #delete-all").prop("disabled",true);e("#select-all-epkb-chat-conversations-table").prop("checked",false)}else{i(epkb_vars.failed_delete_all||"Failed to delete all conversations.")}},error:function(e,t,a){s("remove");console.error("Failed to delete all conversations:",a);i(epkb_vars.failed_delete_all||"Failed to delete all conversations.")}});return false}))}t();e(document).on("click",".epkb-ai-page-container .epkb-ai-create-vector-store",(function(t){t.preventDefault();let s=e(this);let n=e(".epkb-ai-vector-store-status");let o=e(".epkb-ai-vector-store-action");let i=s.html();s.prop("disabled",true).html('<span class="epkb-ai-spinner"></span> '+epkb_vars.creating_text||"Creating...");n.html('<span class="epkb-ai-progress-indicator"><span class="epkb-ai-spinner"></span> '+(epkb_vars.processing_text||"Processing...")+"</span>");let l={action:"epkb_ai_create_vector_store",_wpnonce_epkb_ajax_action:epkb_vars.ai_create_vector_store_nonce||epkb_vars.nonce,epkb_kb_id:e("#epkb-list-of-kbs").val()};a(l,(function(t){if(!t.error&&typeof t.message!="undefined"){r(t.message);n.html(t.status_html);o.html("");e(".epkb-ai-vector-store-setup").attr("data-setup-status","active")}else{s.prop("disabled",false).html(i);n.html('<span class="epkb-ai-status--error">'+(epkb_vars.error_text||"Error")+"</span>")}}),null,false,(function(){if(s.prop("disabled")){s.prop("disabled",false).html(i)}}),false,false)}));e(document).on("click",".epkb-ai-page-container .epkb-ai-recreate-vector-store",(function(t){t.preventDefault();let s=e(this);let n=e(".epkb-ai-vector-store-status");let o=e(".epkb-ai-vector-store-action");let i=s.html();s.prop("disabled",true).html('<span class="epkb-ai-spinner"></span> '+epkb_vars.recreating_text||"Recreating...");n.html('<span class="epkb-ai-progress-indicator"><span class="epkb-ai-spinner"></span> '+(epkb_vars.processing_text||"Processing...")+"</span>");let l={action:"epkb_ai_recreate_vector_store",_wpnonce_epkb_ajax_action:epkb_vars.ai_recreate_vector_store_nonce||epkb_vars.nonce,epkb_kb_id:e("#epkb-list-of-kbs").val()};a(l,(function(t){if(!t.error&&typeof t.message!="undefined"){r(t.message);n.html(t.status_html);o.html("");e(".epkb-ai-vector-store-setup").attr("data-setup-status","active")}else{s.prop("disabled",false).html(i);n.html('<span class="epkb-ai-status--error">'+(epkb_vars.error_text||"Error")+"</span>")}}),null,false,(function(){if(s.prop("disabled")){s.prop("disabled",false).html(i)}}),false,false)}));e(document).on("click",".epkb-ai-page-container .epkb-ai-upload-files",(function(t){t.preventDefault();let s=e(this);let n=e(".epkb-ai-files-status");let o=e(".epkb-ai-files-action");let i=s.html();s.prop("disabled",true).html('<span class="epkb-ai-spinner"></span> '+epkb_vars.uploading_text||"Uploading...");n.html('<span class="epkb-ai-progress-indicator"><span class="epkb-ai-spinner"></span> '+(epkb_vars.uploading_files_text||"Uploading files...")+"</span>");let l={action:"epkb_ai_upload_files",_wpnonce_epkb_ajax_action:epkb_vars.ai_upload_files_nonce||epkb_vars.nonce,epkb_kb_id:e("#epkb-list-of-kbs").val()};a(l,(function(t){if(!t.error&&typeof t.message!="undefined"){r(t.message);n.html(t.status_html);o.html(t["action_button"]);e(".epkb-ai-files-setup").attr("data-setup-status","active")}else{s.prop("disabled",false).html(i);n.html('<span class="epkb-ai-status--error">'+(epkb_vars.error_text||"Error")+"</span>")}}),null,false,(function(){if(s.prop("disabled")){s.prop("disabled",false).html(i)}}),false)}));e(document).on("click",".epkb-ai-page-container .epkb-ai-reupload-files",(function(t){t.preventDefault();let s=e(this);let n=e(".epkb-ai-files-status");let o=e(".epkb-ai-files-action");let i=s.html();s.prop("disabled",true).html('<span class="epkb-ai-spinner"></span> '+epkb_vars.reuploading_text||"Re-uploading...");n.html('<span class="epkb-ai-progress-indicator"><span class="epkb-ai-spinner"></span> '+(epkb_vars.reuploading_files_text||"Re-uploading files...")+"</span>");let l={action:"epkb_ai_reupload_files",_wpnonce_epkb_ajax_action:epkb_vars.ai_reupload_files_nonce||epkb_vars.nonce,epkb_kb_id:e("#epkb-list-of-kbs").val()};a(l,(function(e){if(!e.error&&typeof e.message!="undefined"){r(e.message);n.html(e.status_html);s.prop("disabled",false).html(i)}else{s.prop("disabled",false).html(i);n.html('<span class="epkb-ai-status--error">'+(epkb_vars.error_text||"Error")+"</span>")}}),null,false,(function(){if(s.prop("disabled")){s.prop("disabled",false).html(i)}}),false)}));e(document).on("click",".epkb-admin__list-actions-row .epkb_save_ai_settings",(function(t){t.preventDefault();let n=e(".epkb-ai__api-settings"),o=e(".epkb-ai__labels-settings"),i=e(".epkb-ai__disclaimer-settings"),l=e(".epkb-ai__search-settings"),c=e(".epkb-ai__chat-settings"),p=e(".epkb-ai__beta-settings");let d=[];i.find('[name="disclaimer_accepted"]:checked').each((function(){d.push(e(this).val())}));let b={action:"epkb_save_ai_settings",_wpnonce_epkb_ajax_action:epkb_vars.save_ai_settings_nonce||epkb_vars.nonce,epkb_kb_id:e("#epkb-list-of-kbs").val(),model:n.find('[name="ai_api_model"]').val(),openai_key:n.find('[name="openai_key"]').val(),assistant_setup_status:e(".epkb-ai-assistant-setup").data("setup-status"),disclaimer_accepted:d,ai_search_enabled:l.find('[name="ai_search_enabled"]').is(":checked")?"on":"off",ai_chat_enabled:c.find('[name="ai_chat_enabled"]').is(":checked")?"on":"off",ai_beta_access_code:p.find('[name="ai_beta_access_code"]').val()};s("show",epkb_vars.saving_settings||"Saving settings...");a(b,(function(e){if(!e.error&&typeof e.message!="undefined"){r(e.message)}}),null,false,null,false);return false}));e(document).on("click","#epkb-search-conversations-table tbody tr:not(.epkb-row-info), #epkb-chat-conversations-table tbody tr:not(.epkb-row-info)",(function(t){if(e(t.target).is('input[type="checkbox"], button, a')){return}let a=e(this);let s=a.data("id");let n=a.closest("table").attr("id");let o=n==="epkb-chat-conversations-table"?"chat":"search";if(!s){console.error("No conversation ID found for this row");return}a.siblings().removeClass("selected");a.addClass("selected");let i=a.closest(".epkb-ai-discussions-layout");let r=i.find(".epkb-ai-conversation-messages");let l=i.find(".epkb-ai-no-selection");l.hide();r.html('<div class="epkb-ai-loading"><div class="epkb-ai-spinner"></div></div>').show();let c=(epkb_vars.wpApiSettings?epkb_vars.wpApiSettings.root:"/wp-json/")+"epkb/v1/ai-chat/admin/conversations/"+s;e.ajax({url:c,type:"GET",beforeSend:function(e){if(epkb_vars.wpApiSettings&&epkb_vars.wpApiSettings.nonce){e.setRequestHeader("X-WP-Nonce",epkb_vars.wpApiSettings.nonce)}else if(epkb_vars.nonce){e.setRequestHeader("X-WP-Nonce",epkb_vars.nonce)}},success:function(e){if(e&&e.messages){let t='<div class="epkb-ai-conversation-details">';t+='<div class="epkb-ai-conversation-header">';t+="<strong>"+(epkb_vars.user_label||"User")+":</strong> "+e.user+"<br>";t+="<strong>"+(epkb_vars.created_label||"Created")+":</strong> "+e.created;t+="</div>";t+='<div class="epkb-ai-messages">';e.messages.forEach((function(e){let a=e.role==="user"?"epkb-ai-user-message":"epkb-ai-assistant-message";let s=e.role==="user"?epkb_vars.user_label||"User":epkb_vars.assistant_label||"Assistant";t+='<div class="epkb-ai-message '+a+'">';t+='<div class="epkb-ai-message-role">'+s+"</div>";t+='<div class="epkb-ai-message-content">'+e.content+"</div>";if(e.timestamp){t+='<div class="epkb-ai-message-timestamp">'+e.timestamp+"</div>"}t+="</div>"}));t+="</div></div>";r.html(t)}else{r.html('<p class="epkb-ai-error">'+(epkb_vars.failed_load_conversation||"Failed to load conversation details.")+"</p>")}},error:function(e,t,a){console.error("Failed to load conversation details:",a);r.html('<p class="epkb-ai-error">'+(epkb_vars.failed_load_conversation||"Failed to load conversation details.")+"</p>")}})}));e(document).on("change","#epkb-chat-conversations-table .select-row",(function(){let t=e(this).closest("table");let a=t.closest(".epkb-submissions-table-container");let s=t.find(".select-row:checked").length;let n=t.find(".select-row").length;e("#select-all-epkb-chat-conversations-table").prop("checked",s===n&&n>0);a.find("#delete-selected").prop("disabled",s===0)}));e(document).on("change","#select-all-epkb-chat-conversations-table",(function(){let t=e(this).prop("checked");let a=e("#epkb-chat-conversations-table");let s=a.closest(".epkb-submissions-table-container");a.find(".select-row").prop("checked",t);s.find("#delete-selected").prop("disabled",!t||a.find(".select-row").length===0)}));e(document).ready((function(){e(".epkb-ai-discussions-layout").each((function(){let t=e(this);let a=t.find(".epkb-ai-discussions-header h3").text().includes("Search")?"search":"chat";t.find("#epkb-search-conversations-table, #epkb-chat-conversations-table").attr("data-mode",a)}))}));e(document).on("click","#epkb_ai_reset_logs",(function(){let t={action:"epkb_ai_reset_logs",_wpnonce_epkb_ajax_action:epkb_vars.ai_reset_logs_nonce||epkb_vars.nonce,epkb_kb_id:e("#epkb-list-of-kbs").val()};a(t,(function(){location.reload()}))}));e(".epkb-admin__items-list__more-items-message form").on("submit",(function(t){t.preventDefault();let s=e(this).closest(".epkb-admin__items-list__more-items-message").parent();let n=e(this);let o=s.find(".epkb-admin__items-list .epkb-admin__items-list__no-results");let i=parseInt(n.find('[name="page_number"]').val());let r={action:n.find('[name="action"]').val(),page_number:i+1,_wpnonce_epkb_ajax_action:epkb_vars.nonce,epkb_kb_id:e("#epkb-list-of-kbs").val()};a(r,(function(t){if(!t.error&&typeof t.message!="undefined"){let a=e(t.items);a.css("display","none");i=i+1;if(t.total_number<=t.per_page*i){s.find(".epkb-admin__items-list__more-items-message").remove()}e(o).before(a);a.fadeIn(1e3);n.find('[name="page_number"]').val(i)}}));return false}));function a(t,a,o,i,r,l){let c;let p;a=typeof a==="undefined"?"epkb_callback_noop":a;e.ajax({type:"POST",dataType:"json",data:t,url:ajaxurl,beforeSend:function(e){if(l!==false){if(typeof l=="object"){s("show","",l)}else{s("show","")}}}}).done((function(e){p=e?e:"";if(p.error||typeof p.message==="undefined"){if(p.error&&p.message){c=p.message}else{c=n("",epkb_vars.reload_try_again,"error")}}})).fail((function(e,t,a){c=a?" ["+a+"]":epkb_vars.unknown_error;c=n(epkb_vars.error_occurred+". "+epkb_vars.msg_try_again,c,"error")})).always((function(){p=typeof p==="undefined"?"":p;if(typeof r=="function"){r(p)}s("remove","");if(c){e(".epkb-bottom-notice-message").remove();e("body #epkb-admin-page-wrap").append(c).removeClass("fadeOutDown");setTimeout((function(){e(".epkb-bottom-notice-message").addClass("fadeOutDown")}),1e4);return}if(typeof a==="function"){if(o==="undefined"){a(p)}else{a(p,o)}}else{if(i){location.reload()}}}))}function s(t,a,s){if(t==="show"){let t=typeof s=="undefined"?"":"epkb-admin-dialog-box-loading--relative";let n='<div class="epkb-admin-dialog-box-loading '+t+'">'+'<div class="epkb-admin-dbl__header">'+'<div class="epkb-admin-dbl-icon epkbfa epkbfa-hourglass-half"></div>'+(a?'<div class="epkb-admin-text">'+a+"</div>":"")+"</div>"+"</div>"+'<div class="epkb-admin-dialog-box-overlay '+t+'"></div>';if(typeof s=="undefined"){e("body").append(n)}else{s.append(n)}}else if(t==="remove"){e(".epkb-admin-dialog-box-loading").remove();e(".epkb-admin-dialog-box-overlay").remove()}}function n(e,t,a){return'<div class="epkb-bottom-notice-message">'+'<div class="contents">'+'<span class="'+a+'">'+(e?"<h4>"+e+"</h4>":"")+(t?"<p>"+t+"</p>":"")+"</span>"+"</div>"+'<div class="epkb-close-notice epkbfa epkbfa-window-close"></div>'+"</div>"}let o;function i(t,a=""){e(".epkb-bottom-notice-message").remove();e("body #epkb-admin-page-wrap").append(n(a,t,"error"));clearTimeout(o);o=setTimeout((function(){e(".epkb-bottom-notice-message").addClass("fadeOutDown")}),1e4)}function r(t,a=""){e(".epkb-bottom-notice-message").remove();e("body #epkb-admin-page-wrap").append(n(a,t,"success"));clearTimeout(o);o=setTimeout((function(){e(".epkb-bottom-notice-message").addClass("fadeOutDown")}),1e4)}var l=e("#epkb-conversations-table");if(!l.length){return}var c=l.data("rows-per-page");var p=l.data("total-rows");var d=l.data("total-pages");var b=l.data("current-page");var _=l.data("sort-column");var f=l.data("sort-order");var u=l.data("filter");var k=l.data("has-checkboxes");function v(t,a,n,o){s("show","Loading searches...");e.ajax({url:ajaxurl,type:"POST",data:{action:"epkb_get_search_table_conversations_data",_wpnonce_epkb_ajax_action:epkb_vars.nonce,table_id:"epkb-conversations-table",page:t,sort_column:a,sort_order:n,filter:o,fetch_html:true},success:function(e){if(e.success){m(e.data);b=e.data.current_page;d=e.data.total_pages}},error:function(){console.log("AJAX error fetching table data")},complete:function(){s("remove","")}})}function m(t){var a=l.find("tbody");if(t.html){a.html(t.html)}e("#current-page").text(t.current_page);e("#total-pages").text(t.total_pages);e("#first-page, #prev-page").prop("disabled",t.current_page<=1);e("#next-page, #last-page").prop("disabled",t.current_page>=t.total_pages||t.total_pages===0)}function g(e,t){var a;return function(){var s=this,n=arguments;clearTimeout(a);a=setTimeout((function(){e.apply(s,n)}),t)}}e("#filter-"+l.attr("id")).on("input",g((function(){var t=e(this).val();u=t;v(1,_,f,t)}),1e3));l.find("thead th.sortable").on("click",(function(){var t=e(this).data("column");var a=_===t&&f==="asc"?"desc":"asc";l.find("thead th.sortable").removeAttr("data-sort-order");e(this).attr("data-sort-order",a);l.find("thead th.sortable").attr("data-sort","");e(this).attr("data-sort",a);_=t;f=a;v(1,t,a,u)}));e("#first-page").on("click",(function(){if(b>1)v(1,_,f,u)}));e("#prev-page").on("click",(function(){if(b>1)v(b-1,_,f,u)}));e("#next-page").on("click",(function(){if(b<d)v(b+1,_,f,u)}));e("#last-page").on("click",(function(){if(b<d)v(d,_,f,u)}));if(k){e("#select-all-"+l.attr("id")).on("change",(function(){l.find(".select-row").prop("checked",e(this).prop("checked"))}))}if(k){e("#delete-selected").on("click",(function(){var t=l.find(".select-row:checked").map((function(){return e(this).data("id")})).get();if(t.length>0&&confirm("Are you sure you want to delete the selected rows?")){s("show","Deleting selected searches...");e.ajax({url:ajaxurl,type:"POST",data:{action:"epkb_delete_search_table_selected_conversation_rows",_wpnonce_epkb_ajax_action:epkb_vars.nonce,table_id:"epkb-conversations-table",ids:t,current_page:b},success:function(e){if(e.success){b=e.data.current_page;d=e.data.total_pages;v(b,_,f,u)}},error:function(){s("remove","")}})}}))}e("#delete-all").on("click",(function(){if(confirm("Are you sure you want to delete all rows?")){s("show","Deleting all searches...");e.ajax({url:ajaxurl,type:"POST",data:{action:"epkb_delete_all_search_table_conversations",_wpnonce_epkb_ajax_action:epkb_vars.nonce,table_id:"epkb-conversations-table"},success:function(e){if(e.success){b=e.data.current_page;d=e.data.total_pages;v(b,_,f,u)}},error:function(){s("remove","")}})}}));e("#first-page, #prev-page").prop("disabled",b<=1);e("#next-page, #last-page").prop("disabled",b>=d||d===0);if(_){var h=l.find('thead th[data-column="'+_+'"]');h.attr("data-sort-order",f);h.attr("data-sort",f)}var w=l.data("filter");if(w){e("#filter-"+l.attr("id")).val(w)}}))})(jQuery);