(function(e){e((function(){e(document).on("click",".epkb-ai-page-container .epkb-ai-create-vector-store",(function(t){t.preventDefault();let s=e(this);let n=e(".epkb-ai-vector-store-status");let i=e(".epkb-ai-vector-store-action");let r=s.html();s.prop("disabled",true).html('<span class="epkb-ai-spinner"></span> '+epkb_vars.creating_text||"Creating...");n.html('<span class="epkb-ai-progress-indicator"><span class="epkb-ai-spinner"></span> '+(epkb_vars.processing_text||"Processing...")+"</span>");let l={action:"epkb_ai_create_vector_store",_wpnonce_epkb_ajax_action:epkb_vars.ai_create_vector_store_nonce||epkb_vars.nonce,epkb_kb_id:e("#epkb-list-of-kbs").val()};a(l,(function(a){if(!a.error&&typeof a.message!="undefined"){o(a.message);n.html(a.status_html);i.html("");e(".epkb-ai-vector-store-setup").attr("data-setup-status","active")}else{s.prop("disabled",false).html(r);n.html('<span class="epkb-ai-status--error">'+(epkb_vars.error_text||"Error")+"</span>")}}),null,false,(function(){if(s.prop("disabled")){s.prop("disabled",false).html(r)}}),false)}));e(document).on("click",".epkb-ai-page-container .epkb-ai-recreate-vector-store",(function(t){t.preventDefault();let s=e(this);let n=e(".epkb-ai-vector-store-status");let i=e(".epkb-ai-vector-store-action");let r=s.html();s.prop("disabled",true).html('<span class="epkb-ai-spinner"></span> '+epkb_vars.recreating_text||"Recreating...");n.html('<span class="epkb-ai-progress-indicator"><span class="epkb-ai-spinner"></span> '+(epkb_vars.processing_text||"Processing...")+"</span>");let l={action:"epkb_ai_recreate_vector_store",_wpnonce_epkb_ajax_action:epkb_vars.ai_recreate_vector_store_nonce||epkb_vars.nonce,epkb_kb_id:e("#epkb-list-of-kbs").val()};a(l,(function(a){if(!a.error&&typeof a.message!="undefined"){o(a.message);n.html(a.status_html);i.html("");e(".epkb-ai-vector-store-setup").attr("data-setup-status","active")}else{s.prop("disabled",false).html(r);n.html('<span class="epkb-ai-status--error">'+(epkb_vars.error_text||"Error")+"</span>")}}),null,false,(function(){if(s.prop("disabled")){s.prop("disabled",false).html(r)}}),false)}));e(document).on("click",".epkb-ai-page-container .epkb-ai-upload-files",(function(t){t.preventDefault();let s=e(this);let n=e(".epkb-ai-files-status");let i=e(".epkb-ai-files-action");let r=s.html();s.prop("disabled",true).html('<span class="epkb-ai-spinner"></span> '+epkb_vars.uploading_text||"Uploading...");n.html('<span class="epkb-ai-progress-indicator"><span class="epkb-ai-spinner"></span> '+(epkb_vars.uploading_files_text||"Uploading files...")+"</span>");let l={action:"epkb_ai_upload_files",_wpnonce_epkb_ajax_action:epkb_vars.ai_upload_files_nonce||epkb_vars.nonce,epkb_kb_id:e("#epkb-list-of-kbs").val()};a(l,(function(a){if(!a.error&&typeof a.message!="undefined"){o(a.message);n.html(a.status_html);i.html(a["action_button"]);e(".epkb-ai-files-setup").attr("data-setup-status","active")}else{s.prop("disabled",false).html(r);n.html('<span class="epkb-ai-status--error">'+(epkb_vars.error_text||"Error")+"</span>")}}),null,false,(function(){if(s.prop("disabled")){s.prop("disabled",false).html(r)}}))}));e(document).on("click",".epkb-ai-page-container .epkb-ai-reupload-files",(function(t){t.preventDefault();let s=e(this);let n=e(".epkb-ai-files-status");let i=e(".epkb-ai-files-action");let r=s.html();s.prop("disabled",true).html('<span class="epkb-ai-spinner"></span> '+epkb_vars.reuploading_text||"Re-uploading...");n.html('<span class="epkb-ai-progress-indicator"><span class="epkb-ai-spinner"></span> '+(epkb_vars.reuploading_files_text||"Re-uploading files...")+"</span>");let l={action:"epkb_ai_reupload_files",_wpnonce_epkb_ajax_action:epkb_vars.ai_reupload_files_nonce||epkb_vars.nonce,epkb_kb_id:e("#epkb-list-of-kbs").val()};a(l,(function(e){if(!e.error&&typeof e.message!="undefined"){o(e.message);n.html(e.status_html);s.prop("disabled",false).html(r)}else{s.prop("disabled",false).html(r);n.html('<span class="epkb-ai-status--error">'+(epkb_vars.error_text||"Error")+"</span>")}}),null,false,(function(){if(s.prop("disabled")){s.prop("disabled",false).html(r)}}))}));e(document).on("click",".epkb-admin__list-actions-row .epkb_save_ai_settings",(function(t){t.preventDefault();let s=e(".epkb-ai__api-settings"),n=e(".epkb-ai__labels-settings"),i=e(".epkb-ai__disclaimer-settings"),r=e(".epkb-ai__search-settings"),l=e(".epkb-ai__chat-settings");let p=[];i.find('[name="disclaimer_accepted"]:checked').each((function(){p.push(e(this).val())}));let c={action:"epkb_save_ai_settings",_wpnonce_epkb_ajax_action:epkb_vars.save_ai_settings_nonce||epkb_vars.nonce,epkb_kb_id:e("#epkb-list-of-kbs").val(),model:s.find('[name="ai_api_model"]').val(),openai_key:s.find('[name="openai_key"]').val(),assistant_setup_status:e(".epkb-ai-assistant-setup").data("setup-status"),disclaimer_accepted:p,ai_search_enabled:r.find('[name="ai_search_enabled"]').is(":checked")?"on":"off",ai_chat_enabled:l.find('[name="ai_chat_enabled"]').is(":checked")?"on":"off"};a(c,(function(e){if(!e.error&&typeof e.message!="undefined"){o(e.message)}}));return false}));e(document).on("click","#epkb-search-conversations-table tbody tr:not(.epkb-row-info), #epkb-chat-conversations-table tbody tr:not(.epkb-row-info)",(function(t){if(e(t.target).is('input[type="checkbox"], button, a')){return}let s=e(this);let n=s.data("id");let i=s.closest("table").attr("id");let o=i==="epkb-chat-conversations-table"?"chat":"search";if(!n){console.error("No conversation ID found for this row");return}s.siblings().removeClass("selected");s.addClass("selected");let r=s.closest(".epkb-ai-discussions-layout");let l=r.find(".epkb-ai-conversation-messages");let p=r.find(".epkb-ai-no-selection");p.hide();l.html('<div class="epkb-ai-loading"><div class="epkb-ai-spinner"></div></div>').show();let c={action:o==="chat"?"epkb_get_chat_table_conversation_details":"epkb_get_search_table_conversation_details",conversation_id:n,mode:o,_wpnonce_epkb_ajax_action:epkb_vars.nonce,epkb_kb_id:e("#epkb-list-of-kbs").val()};a(c,(function(e){if(e&&e.html){l.html(e.html)}else{l.html('<p class="epkb-ai-error">Failed to load conversation details.</p>')}}))}));e(document).ready((function(){e(".epkb-ai-discussions-layout").each((function(){let a=e(this);let t=a.find(".epkb-ai-discussions-header h3").text().includes("Search")?"search":"chat";a.find("#epkb-search-conversations-table, #epkb-chat-conversations-table").attr("data-mode",t)}))}));e(document).on("click","#epkb_ai_reset_logs",(function(){let t={action:"epkb_ai_reset_logs",_wpnonce_epkb_ajax_action:epkb_vars.ai_reset_logs_nonce||epkb_vars.nonce,epkb_kb_id:e("#epkb-list-of-kbs").val()};a(t,(function(){location.reload()}))}));e(".epkb-admin__items-list__more-items-message form").on("submit",(function(t){t.preventDefault();let s=e(this).closest(".epkb-admin__items-list__more-items-message").parent();let n=e(this);let i=s.find(".epkb-admin__items-list .epkb-admin__items-list__no-results");let o=parseInt(n.find('[name="page_number"]').val());let r={action:n.find('[name="action"]').val(),page_number:o+1,_wpnonce_epkb_ajax_action:epkb_vars.nonce,epkb_kb_id:e("#epkb-list-of-kbs").val()};a(r,(function(a){if(!a.error&&typeof a.message!="undefined"){let t=e(a.items);t.css("display","none");o=o+1;if(a.total_number<=a.per_page*o){s.find(".epkb-admin__items-list__more-items-message").remove()}e(i).before(t);t.fadeIn(1e3);n.find('[name="page_number"]').val(o)}}));return false}));function a(a,n,i,o,r,l){let p;let c;n=typeof n==="undefined"?"epkb_callback_noop":n;e.ajax({type:"POST",dataType:"json",data:a,url:ajaxurl,beforeSend:function(e){if(l){if(typeof l=="undefined"){t("show","")}if(typeof l=="object"){t("show","",l)}}}}).done((function(e){c=e?e:"";if(c.error||typeof c.message==="undefined"){if(c.error&&c.message){p=c.message}else{p=s("",epkb_vars.reload_try_again,"error")}}})).fail((function(e,a,t){p=t?" ["+t+"]":epkb_vars.unknown_error;p=s(epkb_vars.error_occurred+". "+epkb_vars.msg_try_again,p,"error")})).always((function(){c=typeof c==="undefined"?"":c;if(typeof r=="function"){r(c)}t("remove","");if(p){e(".epkb-bottom-notice-message").remove();e("body #epkb-admin-page-wrap").append(p).removeClass("fadeOutDown");setTimeout((function(){e(".epkb-bottom-notice-message").addClass("fadeOutDown")}),1e4);return}if(typeof n==="function"){if(i==="undefined"){n(c)}else{n(c,i)}}else{if(o){location.reload()}}}))}function t(a,t,s){if(a==="show"){let a=typeof s=="undefined"?"":"epkb-admin-dialog-box-loading--relative";let n='<div class="epkb-admin-dialog-box-loading '+a+'">'+'<div class="epkb-admin-dbl__header">'+'<div class="epkb-admin-dbl-icon epkbfa epkbfa-hourglass-half"></div>'+(t?'<div class="epkb-admin-text">'+t+"</div>":"")+"</div>"+"</div>"+'<div class="epkb-admin-dialog-box-overlay '+a+'"></div>';if(typeof s=="undefined"){e("body").append(n)}else{s.append(n)}}else if(a==="remove"){e(".epkb-admin-dialog-box-loading").remove();e(".epkb-admin-dialog-box-overlay").remove()}}function s(e,a,t){return'<div class="epkb-bottom-notice-message">'+'<div class="contents">'+'<span class="'+t+'">'+(e?"<h4>"+e+"</h4>":"")+(a?"<p>"+a+"</p>":"")+"</span>"+"</div>"+'<div class="epkb-close-notice epkbfa epkbfa-window-close"></div>'+"</div>"}let n;function i(a,t=""){e(".epkb-bottom-notice-message").remove();e("body #epkb-admin-page-wrap").append(s(t,a,"error"));clearTimeout(n);n=setTimeout((function(){e(".epkb-bottom-notice-message").addClass("fadeOutDown")}),1e4)}function o(a,t=""){e(".epkb-bottom-notice-message").remove();e("body #epkb-admin-page-wrap").append(s(t,a,"success"));clearTimeout(n);n=setTimeout((function(){e(".epkb-bottom-notice-message").addClass("fadeOutDown")}),1e4)}var r=e("#epkb-conversations-table");if(!r.length){return}var l=r.data("rows-per-page");var p=r.data("total-rows");var c=r.data("total-pages");var d=r.data("current-page");var _=r.data("sort-column");var b=r.data("sort-order");var f=r.data("filter");var u=r.data("has-checkboxes");function k(a,s,n,i){t("show","Loading searches...");e.ajax({url:ajaxurl,type:"POST",data:{action:"epkb_get_search_table_conversations_data",_wpnonce_epkb_ajax_action:epkb_vars.nonce,table_id:"epkb-conversations-table",page:a,sort_column:s,sort_order:n,filter:i,fetch_html:true},success:function(e){if(e.success){m(e.data);d=e.data.current_page;c=e.data.total_pages}},error:function(){console.log("AJAX error fetching table data")},complete:function(){t("remove","")}})}function m(a){var t=r.find("tbody");if(a.html){t.html(a.html)}e("#current-page").text(a.current_page);e("#total-pages").text(a.total_pages);e("#first-page, #prev-page").prop("disabled",a.current_page<=1);e("#next-page, #last-page").prop("disabled",a.current_page>=a.total_pages||a.total_pages===0)}function v(e,a){var t;return function(){var s=this,n=arguments;clearTimeout(t);t=setTimeout((function(){e.apply(s,n)}),a)}}e("#filter-"+r.attr("id")).on("input",v((function(){var a=e(this).val();f=a;k(1,_,b,a)}),1e3));r.find("thead th.sortable").on("click",(function(){var a=e(this).data("column");var t=_===a&&b==="asc"?"desc":"asc";r.find("thead th.sortable").removeAttr("data-sort-order");e(this).attr("data-sort-order",t);r.find("thead th.sortable").attr("data-sort","");e(this).attr("data-sort",t);_=a;b=t;k(1,a,t,f)}));e("#first-page").on("click",(function(){if(d>1)k(1,_,b,f)}));e("#prev-page").on("click",(function(){if(d>1)k(d-1,_,b,f)}));e("#next-page").on("click",(function(){if(d<c)k(d+1,_,b,f)}));e("#last-page").on("click",(function(){if(d<c)k(c,_,b,f)}));if(u){e("#select-all-"+r.attr("id")).on("change",(function(){r.find(".select-row").prop("checked",e(this).prop("checked"))}))}if(u){e("#delete-selected").on("click",(function(){var a=r.find(".select-row:checked").map((function(){return e(this).data("id")})).get();if(a.length>0&&confirm("Are you sure you want to delete the selected rows?")){t("show","Deleting selected searches...");e.ajax({url:ajaxurl,type:"POST",data:{action:"epkb_delete_search_table_selected_conversation_rows",_wpnonce_epkb_ajax_action:epkb_vars.nonce,table_id:"epkb-conversations-table",ids:a,current_page:d},success:function(e){if(e.success){d=e.data.current_page;c=e.data.total_pages;k(d,_,b,f)}},error:function(){t("remove","")}})}}))}e("#delete-all").on("click",(function(){if(confirm("Are you sure you want to delete all rows?")){t("show","Deleting all searches...");e.ajax({url:ajaxurl,type:"POST",data:{action:"epkb_delete_all_search_table_conversations",_wpnonce_epkb_ajax_action:epkb_vars.nonce,table_id:"epkb-conversations-table"},success:function(e){if(e.success){d=e.data.current_page;c=e.data.total_pages;k(d,_,b,f)}},error:function(){t("remove","")}})}}));e("#first-page, #prev-page").prop("disabled",d<=1);e("#next-page, #last-page").prop("disabled",d>=c||c===0);if(_){var h=r.find('thead th[data-column="'+_+'"]');h.attr("data-sort-order",b);h.attr("data-sort",b)}var g=r.data("filter");if(g){e("#filter-"+r.attr("id")).val(g)}}))})(jQuery);