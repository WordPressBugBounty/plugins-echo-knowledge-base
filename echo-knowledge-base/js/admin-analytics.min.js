jQuery(document).ready((function(t){const e=t("#epkb-analytics-date-range-preset");const a=t(".epkb-analytics-date-range-custom");const o=t("#epkb-analytics-date-range-apply");const n=t("#epkb-analytics-date-start");const i=t("#epkb-analytics-date-end");const s=t(".epkb-analytics-page-container");let r="all-time";const l=t(".epkb-analytics-date-range-filter__quick-buttons");const d={today:"Today",yesterday:"Yesterday","this-week":"This Week","this-month":"This Month","last-6-months":"Last 6 Months","this-year":"This Year","last-year":"Last Year",custom:"Custom Range"};if(e.length){e.on("change",(function(){const e=t(this).val();if(e==="custom"){a.show();t(".epkb-analytics-date-range-quick-btn").removeClass("is-active");t(".epkb-analytics-date-range-quick-btn--temp").remove()}else if(e){a.hide();r=e;c(e);p(e);t(this).val("")}}))}l.on("click",".epkb-analytics-date-range-quick-btn",(function(){const o=t(this).data("preset");r=o;a.hide();if(!t(this).hasClass("epkb-analytics-date-range-quick-btn--temp")){t(".epkb-analytics-date-range-quick-btn--temp").remove()}t(".epkb-analytics-date-range-quick-btn").removeClass("is-active");t(this).addClass("is-active");e.val("");p(o)}));function c(e){t(".epkb-analytics-date-range-quick-btn--temp").remove();t(".epkb-analytics-date-range-quick-btn").removeClass("is-active");const a=t('.epkb-analytics-date-range-quick-btn[data-preset="'+e+'"]');if(a.length){a.addClass("is-active")}else{const a=d[e]||e;const o=t('<button type="button" class="epkb-analytics-date-range-quick-btn epkb-analytics-date-range-quick-btn--temp is-active" data-preset="'+e+'">'+a+"</button>");l.prepend(o)}}if(o.length){o.on("click",(function(){p("custom")}))}function p(e){const a=e||r||"all-time";const o=n.val();const l=i.val();const d=s.data("kb-id");if(a==="custom"&&(!o||!l)){alert("Please select both start and end dates.");return}if(a==="custom"&&new Date(o)>new Date(l)){alert("Start date must be before end date.");return}x("Loading...");t.ajax({url:window.ajaxurl||window.epkb_vars&&window.epkb_vars.ajax_url,method:"POST",dataType:"json",data:{action:"epkb_get_filtered_analytics",kb_id:d,preset:a,start_date:o,end_date:l,_wpnonce_epkb_ajax_action:window.epkb_vars&&window.epkb_vars.nonce?window.epkb_vars.nonce:""}}).done((function(e){if(e&&e.success&&e.data&&e.data.sections){const a=e.data.sections;t.each(a,(function(e,a){const o=t('.epkb-analytics-tab-panel[data-analytics-panel="'+e+'"]');if(o.length){o.find(".epkb-analytics-tab-panel__inner").html(a)}}));const o=t(".epkb-analytics-tab-button.is-active").data("analytics-tab");setTimeout((function(){if(o==="ai-chat"){y()}else if(o==="time-based-analytics"){h()}else if(o==="article-views"){u()}else if(o==="rating"){k()}else if(o==="all-data"||o==="kb-search"||o==="search-shortcode"||o==="widgets"){m()}}),100)}else{alert("Failed to load analytics data. Please try again.")}})).fail((function(){alert("Failed to load analytics data. Please try again.")})).always((function(){A()}))}const b=t(".epkb-analytics-tab-button");const f=t(".epkb-analytics-tab-panel");if(b.length){b.on("click",(function(){const e=t(this).data("analytics-tab");b.removeClass("is-active");t(this).addClass("is-active");f.removeClass("is-active");f.filter(`[data-analytics-panel="${e}"]`).addClass("is-active");if(e==="ai-chat"){setTimeout(y,80)}else if(e==="time-based-analytics"){setTimeout(h,80)}else if(e==="article-views"){setTimeout(u,80)}else if(e==="rating"){setTimeout(k,80)}else if(e==="all-data"||e==="kb-search"||e==="search-shortcode"||e==="widgets"){setTimeout(m,80)}}))}function g(e){let a;let o;let n;let i;let s;if(t(".epkb-analytics-page-container").length>0){a=[];o=[];s=t("#"+e+" .epkb-pie-data-list .epkb-first-10").length;t("#"+e+" .epkb-pie-data-list .epkb-first-10").each((function(){a.push(t(this).find(".epkb-pie-chart-count").text());o.push(t(this).find(".epkb-pie-chart-word").text())}));if(t("#"+e).hasClass("epkb-pie-chart-container-show-data")){n=0;i="Remaining Results";s=t("#"+e+" .epkb-pie-data-list li").length;t("#"+e+" .epkb-pie-data-list .epkb-after-10").each((function(){n+=Number(t(this).find(".epkb-pie-chart-count").text())}));a.push(n);o.push(i)}t("#"+e+" .epkb-pie-data-total").remove();t("#"+e+" h4").append('<span class="epkb-pie-data-total"> ( '+s+" )</span>");t("#"+e+"-chart").remove();t("#"+e+" .epkb-pie-chart-right-col #epkb-pie-chart").append('<canvas id="'+e+"-chart"+'"><canvas>');const r=document.getElementById(e+"-chart").getContext("2d");new Chart(r,{type:"doughnut",data:{labels:o,datasets:[{data:a,backgroundColor:["#aed581","#4fc3f7","#FED32F","#ef5350","#D0D8E0","#ff8a65","#ba68c8","#4A7BEC","#768CA3","#8d6e63","#444444"]}]},options:{maintainAspectRatio:false,legend:{display:false,position:"left"}}})}}function u(){if(!t("#epkb-article-views-data-content").length){return}if(t("#epkb-popular-articles").length){g("epkb-popular-articles")}if(t("#epkb-not-popular-articles").length){g("epkb-not-popular-articles")}if(t("#epkb-high-performers").length){g("epkb-high-performers")}if(t("#epkb-low-performers").length){g("epkb-low-performers")}}function h(){if(!t(".epkb-time-based-analytics-container").length){return}const e=t("#epkb-time-chart");if(e.length){const t=e.data("weekly-data");if(t&&t.length>0){const e=t.map((t=>t.week_label));const a=t.map((t=>t.total_views));const o=document.getElementById("epkb-time-chart").getContext("2d");if(window.epkbTimeChart&&typeof window.epkbTimeChart.destroy==="function"){window.epkbTimeChart.destroy()}window.epkbTimeChart=new Chart(o,{type:"line",data:{labels:e,datasets:[{label:"Views",data:a,borderColor:"#4A7BEC",backgroundColor:"rgba(74, 123, 236, 0.1)",borderWidth:2,fill:true,tension:.4,pointRadius:4,pointBackgroundColor:"#4A7BEC",pointBorderColor:"#fff",pointBorderWidth:2,pointHoverRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{mode:"index",intersect:false,backgroundColor:"rgba(0, 0, 0, 0.8)",padding:12,titleColor:"#fff",bodyColor:"#fff",borderColor:"#4A7BEC",borderWidth:1,displayColors:false,callbacks:{title:function(t){return t[0].label},label:function(t){return"Views: "+t.parsed.y.toLocaleString()}}}},scales:{y:{beginAtZero:true,ticks:{precision:0},grid:{color:"rgba(0, 0, 0, 0.05)"}},x:{grid:{display:false},ticks:{maxRotation:45,minRotation:45}}}}})}}const a=t("#epkb-engagement-distribution-chart");if(a.length){const t=a.data("distribution");if(t&&t.length>0){const e=t.map((t=>t.label));const a=t.map((t=>t.count));const o=document.getElementById("epkb-engagement-distribution-chart").getContext("2d");if(window.epkbEngagementChart&&typeof window.epkbEngagementChart.destroy==="function"){window.epkbEngagementChart.destroy()}const n={"0 Views":"#ef5350","1-10 Views":"#ff8a65","11-50 Views":"#FED32F","51-100 Views":"#aed581","101-500 Views":"#4fc3f7","500+ Views":"#4A7BEC"};const i=e.map((t=>n[t]||"#999999"));window.epkbEngagementChart=new Chart(o,{type:"bar",data:{labels:e,datasets:[{label:"Number of Articles",data:a,backgroundColor:i,borderColor:i,borderWidth:1,borderRadius:4}]},options:{indexAxis:"y",responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.8)",padding:12,titleColor:"#fff",bodyColor:"#fff",borderColor:"#4A7BEC",borderWidth:1,displayColors:false,callbacks:{label:function(t){const e=t.parsed.x;const a=t.dataset.data.reduce(((t,e)=>t+e),0);const o=(e/a*100).toFixed(1);return e+" articles ("+o+"%)"}}}},scales:{x:{beginAtZero:true,ticks:{precision:0},grid:{color:"rgba(0, 0, 0, 0.05)"}},y:{grid:{display:false}}}}})}}const o=t("#epkb-searches-chart");if(o.length){const t=o.data("searches-data");if(t&&t.length>0){const e=t.map((t=>t.week_label));const a=t.map((t=>t.total_searches));const o=document.getElementById("epkb-searches-chart").getContext("2d");if(window.epkbSearchesChart&&typeof window.epkbSearchesChart.destroy==="function"){window.epkbSearchesChart.destroy()}window.epkbSearchesChart=new Chart(o,{type:"line",data:{labels:e,datasets:[{label:"Searches",data:a,borderColor:"#f39c12",backgroundColor:"rgba(243, 156, 18, 0.1)",borderWidth:2,fill:true,tension:.4,pointRadius:4,pointBackgroundColor:"#f39c12",pointBorderColor:"#fff",pointBorderWidth:2,pointHoverRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{mode:"index",intersect:false,backgroundColor:"rgba(0, 0, 0, 0.8)",padding:12,titleColor:"#fff",bodyColor:"#fff",borderColor:"#f39c12",borderWidth:1,displayColors:false,callbacks:{title:function(t){return t[0].label},label:function(t){return"Searches: "+t.parsed.y.toLocaleString()}}}},scales:{y:{beginAtZero:true,ticks:{precision:0},grid:{color:"rgba(0, 0, 0, 0.05)"}},x:{grid:{display:false},ticks:{maxRotation:45,minRotation:45}}}}})}}const n=t("#epkb-ratings-chart");if(n.length){const t=n.data("ratings-data");if(t&&t.length>0){const e=t.map((t=>t.week_label));const a=t.map((t=>t.positive_ratings));const o=t.map((t=>t.negative_ratings));const n=document.getElementById("epkb-ratings-chart").getContext("2d");if(window.epkbRatingsChart&&typeof window.epkbRatingsChart.destroy==="function"){window.epkbRatingsChart.destroy()}window.epkbRatingsChart=new Chart(n,{type:"line",data:{labels:e,datasets:[{label:"Positive Feedback",data:a,borderColor:"#27ae60",backgroundColor:"rgba(39, 174, 96, 0.1)",borderWidth:2,fill:true,tension:.4,pointRadius:4,pointBackgroundColor:"#27ae60",pointBorderColor:"#fff",pointBorderWidth:2,pointHoverRadius:6},{label:"Negative Feedback",data:o,borderColor:"#e74c3c",backgroundColor:"rgba(231, 76, 60, 0.1)",borderWidth:2,fill:true,tension:.4,pointRadius:4,pointBackgroundColor:"#e74c3c",pointBorderColor:"#fff",pointBorderWidth:2,pointHoverRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,position:"top",labels:{usePointStyle:true,padding:15}},tooltip:{mode:"index",intersect:false,backgroundColor:"rgba(0, 0, 0, 0.8)",padding:12,titleColor:"#fff",bodyColor:"#fff",borderColor:"#4A7BEC",borderWidth:1,displayColors:true,callbacks:{title:function(t){return t[0].label},label:function(t){return t.dataset.label+": "+t.parsed.y.toLocaleString()}}}},scales:{y:{beginAtZero:true,ticks:{precision:0},grid:{color:"rgba(0, 0, 0, 0.05)"}},x:{grid:{display:false},ticks:{maxRotation:45,minRotation:45}}}}})}}}function k(){if(!t("#eprf-rating-data-content").length){return}if(typeof display_eprf_pie_chart==="function"){display_eprf_pie_chart("eprf-best-ratinges-data");display_eprf_pie_chart("eprf-worst-ratinges-data");display_eprf_pie_chart("eprf-popular-ratinges-data");display_eprf_pie_chart("eprf-no-result-popular-ratinges-data")}}function m(){if(typeof display_asea_pie_chart!=="function"){return}const e=t(".epkb-analytics-tab-panel.is-active");e.find(".asea-pie-chart-container").each((function(){const e=t(this).attr("id");if(e){display_asea_pie_chart(e)}}))}function y(){C();w();v()}function C(){const e=t("#epkb-ai-chat-conversations-chart");if(!e.length){return}const a=e.data("chart-data");if(!a||!Array.isArray(a)||a.length===0){return}if(window.epkbAIChatConversationsChart&&typeof window.epkbAIChatConversationsChart.destroy==="function"){window.epkbAIChatConversationsChart.destroy()}const o=a.map((t=>{const e=new Date(t.date);return e.toLocaleDateString(undefined,{month:"short",day:"numeric"})}));const n=a.map((t=>t.conversations||0));const i=document.getElementById("epkb-ai-chat-conversations-chart").getContext("2d");window.epkbAIChatConversationsChart=new Chart(i,{type:"line",data:{labels:o,datasets:[{label:"Conversations",data:n,borderColor:"#2271b1",backgroundColor:"rgba(34, 113, 177, 0.1)",borderWidth:2,fill:true,tension:.3,pointBackgroundColor:"#2271b1",pointBorderColor:"#fff",pointBorderWidth:2,pointRadius:4,pointHoverRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.8)",padding:12,titleColor:"#fff",bodyColor:"#fff"}},scales:{x:{grid:{display:false},ticks:{maxRotation:45,minRotation:45}},y:{beginAtZero:true,ticks:{precision:0},grid:{color:"rgba(0, 0, 0, 0.05)"}}}}})}function w(){const e=t("#epkb-ai-chat-messages-chart");if(!e.length){return}const a=e.data("chart-data");if(!a||!Array.isArray(a)||a.length===0){return}if(window.epkbAIChatMessagesChart&&typeof window.epkbAIChatMessagesChart.destroy==="function"){window.epkbAIChatMessagesChart.destroy()}const o=a.map((t=>{const e=new Date(t.date);return e.toLocaleDateString(undefined,{month:"short",day:"numeric"})}));const n=a.map((t=>t.messages||0));const i=document.getElementById("epkb-ai-chat-messages-chart").getContext("2d");window.epkbAIChatMessagesChart=new Chart(i,{type:"line",data:{labels:o,datasets:[{label:"Messages",data:n,borderColor:"#9b59b6",backgroundColor:"rgba(155, 89, 182, 0.1)",borderWidth:2,fill:true,tension:.3,pointBackgroundColor:"#9b59b6",pointBorderColor:"#fff",pointBorderWidth:2,pointRadius:4,pointHoverRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.8)",padding:12,titleColor:"#fff",bodyColor:"#fff"}},scales:{x:{grid:{display:false},ticks:{maxRotation:45,minRotation:45}},y:{beginAtZero:true,ticks:{precision:0},grid:{color:"rgba(0, 0, 0, 0.05)"}}}}})}function v(){const e=t("#epkb-ai-chat-engagement-chart");if(!e.length){return}const a=e.data("chart-data");if(!a||!Array.isArray(a)||a.length===0){return}if(window.epkbAIChatEngagementChart&&typeof window.epkbAIChatEngagementChart.destroy==="function"){window.epkbAIChatEngagementChart.destroy()}const o=a.map((t=>{const e=new Date(t.date);return e.toLocaleDateString(undefined,{month:"short",day:"numeric"})}));const n=a.map((t=>t.thumbs_up||0));const i=a.map((t=>t.thumbs_down||0));const s=a.map((t=>t.handoffs||0));const r=document.getElementById("epkb-ai-chat-engagement-chart").getContext("2d");window.epkbAIChatEngagementChart=new Chart(r,{type:"bar",data:{labels:o,datasets:[{label:"Thumbs Up",data:n,backgroundColor:"#27ae60",borderColor:"#1e8449",borderWidth:1},{label:"Thumbs Down",data:i,backgroundColor:"#e74c3c",borderColor:"#c0392b",borderWidth:1},{label:"Handoffs",data:s,backgroundColor:"#f39c12",borderColor:"#d68910",borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,position:"top",labels:{usePointStyle:true,padding:15}},tooltip:{mode:"index",intersect:false,backgroundColor:"rgba(0, 0, 0, 0.8)",padding:12,titleColor:"#fff",bodyColor:"#fff",borderColor:"#4A7BEC",borderWidth:1,displayColors:true}},scales:{x:{stacked:true,grid:{display:false},ticks:{maxRotation:45,minRotation:45}},y:{stacked:true,beginAtZero:true,ticks:{precision:0},grid:{color:"rgba(0, 0, 0, 0.05)"}}}}})}const _=t(".epkb-article-views-toggle__input");if(_.length){_.on("change",(function(){const e=t(this);const a=e.is(":checked");if(!a){e.prop("checked",false);return}const o=e.closest(".epkb-analytics-article-views-disabled");const n=o.data("kb-id");const i=o.find(".epkb-article-views-toggle__status");const s=window.ajaxurl||window.epkb_vars&&window.epkb_vars.ajax_url;if(!n||!s){console.error("EPKB: Missing data to toggle article views counter.",{kbId:n,ajaxUrl:s});e.prop("checked",false);return}if(o.hasClass("is-processing")){return}const r=o.data("enablingMessage")||"Enabling article views counter...";const l=o.data("successMessage")||"Article views counter enabled. Reloading...";const d=o.data("errorMessage")||"Unable to update setting. Please try again.";o.addClass("is-processing");e.prop("disabled",true);if(i.length){i.text(r)}t.ajax({url:s,method:"POST",dataType:"json",data:{action:"epkb_toggle_article_views_counter",kb_id:n,enable:"on",_wpnonce_epkb_ajax_action:window.epkb_vars&&window.epkb_vars.nonce?window.epkb_vars.nonce:""}}).done((function(t){if(t&&t.success){if(i.length){i.text(l)}setTimeout((function(){window.location.reload()}),600);return}c(t&&t.data&&t.data.message?t.data.message:d)})).fail((function(){c(d)}));function c(t){o.removeClass("is-processing");e.prop("disabled",false).prop("checked",false);if(i.length){i.text(t)}}}))}if(t(".epkb-analytics-page-container").length>0){t(document).on("click",".epkb-pie-chart__more-button",(function(){const e=t(this).closest(".epkb-pie-chart-container").attr("id");t("#"+e).toggleClass("epkb-pie-chart-container-show-data");t(`#${e} .epkb-pie-chart__more-button__more-text`).toggleClass("epkb-hidden");t(`#${e} .epkb-pie-chart__more-button__less-text`).toggleClass("epkb-hidden");g(e)}));t(document).on("click",".epkb-article-list__more-button",(function(){const e=t(this);const a=e.closest(".epkb-list-container, .epkb-improvement-container");const o=a.find(".epkb-after-20");o.toggle();e.find(".epkb-article-list__more-button__more-text").toggleClass("epkb-hidden");e.find(".epkb-article-list__more-button__less-text").toggleClass("epkb-hidden")}))}if(t('.epkb-analytics-tab-button[data-analytics-tab="ai-chat"]').hasClass("is-active")){setTimeout(y,80)}if(t('.epkb-analytics-tab-button[data-analytics-tab="article-views"]').hasClass("is-active")){setTimeout(u,80)}if(t('.epkb-analytics-tab-button[data-analytics-tab="time-based-analytics"]').hasClass("is-active")){setTimeout(h,80)}if(t('.epkb-analytics-tab-button[data-analytics-tab="rating"]').hasClass("is-active")){setTimeout(k,80)}function x(e){A();const a='<div class="epkb-admin-dialog-box-loading">'+'<div class="epkb-admin-dbl__header">'+'<div class="epkb-admin-dbl-icon epkbfa epkbfa-hourglass-half"></div>'+(e?'<div class="epkb-admin-text">'+e+"</div>":"")+"</div>"+"</div>"+'<div class="epkb-admin-dialog-box-overlay"></div>';t("body").append(a)}function A(){t(".epkb-admin-dialog-box-loading").remove();t(".epkb-admin-dialog-box-overlay").remove()}}));