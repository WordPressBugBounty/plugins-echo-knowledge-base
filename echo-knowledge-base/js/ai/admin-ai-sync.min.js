(function(){"use strict";const{useState:e,useEffect:s,useCallback:t,useRef:r,createContext:o,useContext:n,createElement:a}=wp.element;const{__:c}=wp.i18n;const{showError:l,showSuccess:i,makeApiRequest:d}=window.EPKB_AI_Util_React||{};const{logError:u}=window.EPKBChatUtils||{};const p=o({job:{status:"idle",total:0,processed:0,percent:0,errors:0},setJob:()=>{},cancelJob:()=>{},cleanupSync:()=>{},registerPostUpdateHandler:()=>{},unregisterPostUpdateHandler:()=>{},notifyAllHandlers:()=>{},setStopPolling:()=>{}});window.EPKB_AI_SyncContext=p;window.EPKB_AI_SyncProvider=({children:o})=>{const[n,g]=e({status:"idle",total:0,processed:0,percent:0,errors:0});const w=r(null);const h=r([]);const k=t((e=>{if(typeof e==="function"){h.current.push(e)}}),[]);const m=t((e=>{h.current=h.current.filter((s=>s!==e))}),[]);const S=t((e=>{h.current.forEach((s=>{try{s(e)}catch(e){u("AI Sync","Error calling post update handler",{message:e.message||"Unknown error"})}}))}),[]);const _=t(((e="unknown",s=true)=>{if(w.current&&typeof w.current==="function"){w.current();w.current=null}g({status:"idle",total:0,processed:0,percent:0,errors:0});if(s){switch(e){case"canceled":i(c("Sync canceled","echo-knowledge-base"));break;case"no_posts":l(c("No posts found to sync","echo-knowledge-base"));break;case"error":break;case"completed":break}}}),[]);const P=t((async()=>{try{await d("cancel-all-sync",{method:"POST"});_("canceled",true)}catch(e){l(c("Failed to cancel sync","echo-knowledge-base"));_("canceled",false)}}),[_]);s((()=>{const e=async()=>{try{const e=await d("sync-progress",{method:"GET"});const s=e.progress||{};if(s.cancel_requested||s.status==="canceled"){return}if(s.status==="running"||s.status==="scheduled"){g({status:s.status,total:s.total||0,processed:s.processed||0,percent:s.percent||0,errors:s.errors||0,type:s.type||""});if(w.current&&typeof w.current==="function"){w.current()}if(s.type==="direct"){const e=b(g,S);const s=f(g);w.current=()=>{e();s()}}else{w.current=y(g,S)}}}catch(e){}};e();return()=>{if(w.current&&typeof w.current==="function"){w.current()}}}),[S]);const $=t((e=>{S(e)}),[S]);const A=t((e=>{if(w.current&&typeof w.current==="function"){w.current()}w.current=e}),[]);s((()=>{const e=()=>{if(n.status==="running"&&n.type==="direct"){const e=`${window.epkb_ai_api?.rest_url||"/wp-json/"}epkb-ai-api/v1/admin/cancel-all-sync`;const s=JSON.stringify({});if(navigator.sendBeacon){const t=new Blob([s],{type:"application/json"});navigator.sendBeacon(e,t)}else{const t=new XMLHttpRequest;t.open("POST",e,false);t.setRequestHeader("Content-Type","application/json");t.setRequestHeader("X-WP-Nonce",window.epkb_ai_api?.nonce||"");t.send(s)}}};window.addEventListener("beforeunload",e);return()=>{window.removeEventListener("beforeunload",e)}}),[n.status,n.type]);return a(p.Provider,{value:{job:n,setJob:g,cancelJob:P,cleanupSync:_,registerPostUpdateHandler:k,unregisterPostUpdateHandler:m,notifyAllHandlers:$,setStopPolling:A}},o)};const g=()=>{const e=n(p);if(!e){throw new Error("useSyncContext must be used within SyncProvider")}return e};const f=e=>{let s=false;let t=null;async function r(){if(s)return;try{const o=await d("sync-progress",{method:"GET"});const n=o.progress||{};e({status:n.status||"idle",total:n.total||0,processed:n.processed||0,percent:n.percent||0,errors:n.errors||0,type:n.type||"",retrying:n.retrying||false});if(n.status==="canceled"||n.status==="idle"){s=true;e({status:"idle",total:0,processed:0,percent:0,errors:0});return}if(n.status==="running"||n.status==="scheduled"){if(!s){t=setTimeout(r,15e3)}}}catch(e){if(e.name!=="AbortError"&&!s){u("AI Sync","Status polling failed",{message:e.message||"Unknown error",code:e.code})}}}r();return()=>{s=true;if(t){clearTimeout(t);t=null}}};const b=(e,s)=>{let t=false;let r=null;async function o(){if(t)return;try{const n=await d("process-next",{method:"POST"});if(!n.success){if(!t){u("AI Sync","Process next failed",{message:n.message||"Unknown error",status:n.status,code:n.code})}return}if(n.progress){e({status:n.progress.status||"idle",total:n.progress.total||0,processed:n.progress.processed||0,percent:n.progress.percent||0,errors:n.progress.errors||0,retrying:n.progress.retrying||false})}if(n.status==="canceled"||n.status==="idle"||n.progress&&(n.progress.status==="canceled"||n.progress.status==="idle")){t=true;e({status:"idle",total:0,processed:0,percent:0,errors:0});return}if(n.status==="failed"&&n.message){l(n.message);t=true;e({status:"failed",total:n.progress?.total||0,processed:n.progress?.processed||0,percent:n.progress?.percent||0,errors:n.progress?.errors||0});return}if(n.updated_posts&&n.updated_posts.length>0){const e=n.updated_posts.map((e=>({...e,status:e.status==="error"?"error":"synced",error_message:e.message})));if(s){s(e)}}if(n.status==="running"&&!t){r=setTimeout(o,1e3)}}catch(e){if(e.name!=="AbortError"&&!t){u("AI Sync","Process next error",{message:e.message||"Unknown error",code:e.code,status:e.status});r=setTimeout(o,5e3)}}}o();return()=>{t=true;if(r){clearTimeout(r);r=null}}};const y=(e,s)=>{let t=false;let r=null;async function o(){if(t)return;try{const s=await d("sync-progress",{method:"GET"});const n=s.progress||{};e({status:n.status||"idle",total:n.total||0,processed:n.processed||0,percent:n.percent||0,errors:n.errors||0});if(n.status==="canceled"||n.status==="idle"){t=true;e({status:"idle",total:0,processed:0,percent:0,errors:0});return}if((n.status==="running"||n.status==="scheduled")&&!t){r=setTimeout(o,3e3)}}catch(e){if(e.name!=="AbortError"&&!t){u("AI Sync","Cron polling error",{message:e.message||"Unknown error",code:e.code,status:e.status})}}}o();return()=>{t=true;if(r){clearTimeout(r);r=null}}};const w=async(e,s,t,r,o,n)=>{const a=e==="direct"?"start-direct-sync":"start-cron-sync";try{const i=await d(a,{method:"POST",data:{selected_post_ids:s,collection_id:t}});if(i.success){r({status:"running",total:i.total||(typeof s==="string"?0:s.length),processed:0,percent:0,errors:0,justStarted:true});if(e==="direct"){const e=b(r,o);const s=f(r);return()=>{e();s()}}else{return y(r,o)}}else{const e=i.error==="no_posts"?"no_posts":"error";if(e==="error"){l(i.message||c("Failed to start sync","echo-knowledge-base"))}n(e,e==="no_posts");return null}}catch(e){l(e.message||c("Failed to start sync","echo-knowledge-base"));n("error",false);throw e}};window.EPKB_AI_SyncControls=({collectionId:o,selectedPostIds:n=[],disabled:l=false,onPostUpdate:i,hasApiKey:d=true,onSelectAll:u=null,isAllSelected:p=false,selectedRecordsCount:f=0,isFiltered:b=false,onSyncStart:y=null,isSelectAllActive:h=false,activeStatusTab:k="all"})=>{const m=g();const{job:S,setJob:_,cancelJob:P,cleanupSync:$,setStopPolling:A}=m;const[v,E]=e(false);const[N,C]=e("basic_timer");const T=t((async()=>{E(true);_({status:"running",total:typeof n==="string"?0:n.length,processed:0,percent:0,errors:0,justStarted:true});if(y){y()}const e=e=>{if(i){i(e)}if(m.notifyAllHandlers){m.notifyAllHandlers(e)}};if(typeof n!=="string"){const s=n.map((e=>({id:e,status:"updating",last_synced:(new Date).toISOString()})));e(s)}try{const s=N==="wordpress_cron"?"cron":"direct";const t=await w(s,n,o,_,e,$);if(t){A(t)}else{if(typeof n!=="string"){const s=n.map((e=>({id:e,status:"not_synced",last_synced:null})));e(s)}}}catch(s){if(typeof n!=="string"){const s=n.map((e=>({id:e,status:"not_synced",last_synced:null})));e(s)}}finally{E(false)}}),[N,n,o,_,i,y,m,A,$]);const I=S.status==="running"||S.status==="scheduled";const x=!l&&(typeof n==="string"||n.length>0)&&!I&&!v&&d;const B=r(S.status);s((()=>{if(S.status==="running"&&B.current!=="running"&&y){y()}if(S.status==="completed"&&B.current!=="completed"&&y){y()}B.current=S.status}),[S.status,y]);return a("div",{className:"epkb-ai-sync-controls"},!d&&a("div",{className:"epkb-ai-info-message",style:{marginTop:"10px",marginBottom:"10px"}},a("p",{style:{margin:0,color:"#d63638"}},c("OpenAI API key is required to sync content. Please configure it in General Settings.","echo-knowledge-base"))),a("div",{className:"epkb-ai-form-group"},a("label",{className:"epkb-sync-label"},c("Sync Method","echo-knowledge-base")),a("div",{className:"epkb-ai-radio-group"},a("label",{className:"epkb-ai-radio-label"},a("input",{type:"radio",name:"sync_method",value:"basic_timer",checked:N==="basic_timer",onChange:()=>C("basic_timer")}),a("span",null,c("Basic Timer","echo-knowledge-base"))))),u&&a("div",{className:"epkb-ai-form-group epkb-ai-checkbox-group"},a("label",{className:"epkb-ai-checkbox-label"},a("span",null,b?c("Select All Filtered Records","echo-knowledge-base"):c("Select All Records","echo-knowledge-base")),a("input",{type:"checkbox",checked:p,onChange:e=>u(e.target.checked)}))),a("div",{className:"epkb-ai-form-group"},a("div",{className:"epkb-ai-selected-records-count"},(()=>{const e=()=>{const e={all:"",error:c("Error","echo-knowledge-base"),pending:c("Pending","echo-knowledge-base"),outdated:c("Outdated","echo-knowledge-base"),added:c("Added","echo-knowledge-base"),updated:c("Updated","echo-knowledge-base")};return e[k]||""};const s=e();if(s&&k!=="all"&&f>0){return`${f} ${c("Selected","echo-knowledge-base")} ${s} ${c("Records","echo-knowledge-base")}`}else if(k!=="all"&&f===0){return`${f} ${c("selected records","echo-knowledge-base")}`}else{return`${f} ${c("selected records","echo-knowledge-base")}`}})())),a("div",{className:"epkb-ai-sync-buttons"},I?a("div",{style:{display:"flex",gap:"10px"}},a("button",{className:"epkb-ai-button epkb-ai-button-primary disabled",disabled:true,style:{cursor:"not-allowed"}},c("Sync in Progress","echo-knowledge-base")),a("button",{className:"epkb-ai-button epkb-ai-button-danger",onClick:P,style:{backgroundColor:"#d63638",borderColor:"#d63638",color:"#fff"}},c("Cancel Sync","echo-knowledge-base"))):a("button",{className:`epkb-ai-button epkb-ai-button-primary ${!x?"disabled":""}`,onClick:T,disabled:!x,title:!d?c("API key required","echo-knowledge-base"):n!=="ALL"&&n.length===0?c("Select at least one item to sync","echo-knowledge-base"):""},c("Start Sync","echo-knowledge-base"))))};window.EPKB_AI_SyncProgressBar=()=>{const{job:t,setJob:r}=g();const[o,n]=e(false);s((()=>{if(t.justStarted){n(true);const e=setTimeout((()=>{n(false);r((e=>({...e,justStarted:false})))}),3e3);return()=>clearTimeout(e)}}),[t.justStarted,r]);s((()=>{if(t.status==="completed"||t.status==="canceled"||t.status==="failed"){}}),[t.status]);if(t.status==="idle")return null;let l="";if(t.status==="running"){if(o){l=c("Sync started successfully! ","echo-knowledge-base")}if(t.total===0){l+=c("Starting sync...","echo-knowledge-base")}else if(t.retrying){l+=`${c("Retrying failed posts:","echo-knowledge-base")} ${t.processed} ${c("of","echo-knowledge-base")} ${t.total}...`}else{l+=`${c("Processing","echo-knowledge-base")} ${t.processed} ${c("of","echo-knowledge-base")} ${t.total} ${c("posts","echo-knowledge-base")}...`}}else if(t.status==="completed"){l=`${c("Completed! Processed","echo-knowledge-base")} ${t.processed} ${c("posts","echo-knowledge-base")}`;if(t.errors>0){l+=` ${c("with","echo-knowledge-base")} ${t.errors} ${c("errors","echo-knowledge-base")}`}}else if(t.status==="failed"){l=`${c("Sync stopped after 5 consecutive errors. Processed","echo-knowledge-base")} ${t.processed} ${c("of","echo-knowledge-base")} ${t.total} ${c("posts with","echo-knowledge-base")} ${t.errors} ${c("total errors","echo-knowledge-base")}`}else if(t.status==="scheduled"){l=c("Sync scheduled, waiting to start...","echo-knowledge-base")}else if(t.status==="canceled"){l=c("Sync canceled","echo-knowledge-base")}return a("div",{className:"epkb-ai-sync-progress"},a("div",{className:"epkb-ai-progress-bar"},a("div",{className:"epkb-ai-progress-fill",style:{width:`${t.percent}%`}}),a("span",{className:"epkb-ai-progress-percentage"},`${t.percent}%`)),l&&a("p",{className:"epkb-ai-progress-message",style:t.status==="failed"?{color:"#d54e21"}:{}},l))};window.EPKB_AI_Sync={startSync:w,pollSyncStatus:f,processDirectSync:b,pollCronSync:y,useSyncContext:g}})();