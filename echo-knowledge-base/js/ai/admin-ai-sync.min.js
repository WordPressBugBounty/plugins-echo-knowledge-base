(function(){"use strict";const{useState:e,useEffect:s,useCallback:t,useRef:c,createContext:n,useContext:o,createElement:r}=wp.element;const{__:a}=wp.i18n;const{showError:l,showSuccess:i,makeApiRequest:d}=window.EPKB_AI_Util_React||{};const u=n({job:{status:"idle",total:0,processed:0,percent:0,errors:0},setJob:()=>{},cancelJob:()=>{}});window.EPKB_AI_SyncContext=u;window.EPKB_AI_SyncProvider=({children:n,onPostUpdate:o})=>{const[p,y]=e({status:"idle",total:0,processed:0,percent:0,errors:0});const g=c(null);const h=t((async()=>{try{await d("cancel-all-sync",{method:"POST"});y({status:"canceled",total:0,processed:0,percent:0,errors:0});i(a("Sync canceled","echo-knowledge-base"))}catch(e){l(a("Failed to cancel sync","echo-knowledge-base"))}}),[]);s((()=>{const e=async()=>{try{const e=await d("sync-progress",{method:"GET"});const s=e.progress||{};if(s.status==="running"||s.status==="scheduled"){y({status:s.status,total:s.total||0,processed:s.processed||0,percent:s.percent||0,errors:s.errors||0});if(g.current&&typeof g.current==="function"){g.current()}g.current=b(y,o)}}catch(e){console.log("No active sync found")}};e();return()=>{if(g.current&&typeof g.current==="function"){g.current()}}}),[o]);return r(u.Provider,{value:{job:p,setJob:y,cancelJob:h}},n)};const p=()=>{const e=o(u);if(!e){throw new Error("useSyncContext must be used within SyncProvider")}return e};const b=(e,s)=>{let t=false;async function c(){if(t)return;try{const t=await d("sync-progress",{method:"GET"});const n=t.progress||{};e({status:n.status||"idle",total:n.total||0,processed:n.processed||0,percent:n.percent||0,errors:n.errors||0});if(s&&n.updated_posts){s(n.updated_posts)}if(n.status==="running"||n.status==="scheduled"){setTimeout(c,3e3)}}catch(e){if(e.name!=="AbortError"){console.error("Sync polling error:",e)}}}c();return()=>{t=true}};const y=async(e,s,t,c,n)=>{const o=e==="direct"?"start-direct-sync":"start-cron-sync";try{const r=await d(o,{method:"POST",data:{selected_post_ids:s,collection_id:t}});if(r.success){const t=e==="direct"?a("Sync started successfully","echo-knowledge-base"):a("Background sync scheduled","echo-knowledge-base");i(t);c({status:"running",total:r.total||(s==="ALL"?0:s.length),processed:0,percent:0,errors:0});return b(c,n)}return null}catch(e){l(e.message||a("Failed to start sync","echo-knowledge-base"));throw e}};window.EPKB_AI_SyncControls=({collectionId:n,selectedPostIds:o=[],disabled:l=false,onPostUpdate:i,hasApiKey:d=true,onSelectAll:u=null,isAllSelected:b=false,selectedRecordsCount:g=0,isFiltered:h=false,onSyncStart:k=null,isSelectAllActive:m=false})=>{const{job:f,setJob:w,cancelJob:S}=p();const[_,P]=e(false);const[v,A]=e("basic_timer");const N=c(null);s((()=>()=>{if(N.current&&typeof N.current==="function"){N.current()}}),[]);const C=t((async()=>{P(true);try{if(N.current&&typeof N.current==="function"){N.current()}const e=v==="wordpress_cron"?"cron":"direct";N.current=await y(e,o,n,w,i)}catch(e){}finally{P(false)}}),[v,o,n,w,i]);const E=f.status==="running"||f.status==="scheduled";const x=!l&&(o==="ALL"||o.length>0)&&!E&&!_&&d;const I=c(f.status);s((()=>{if(f.status==="running"&&I.current!=="running"&&k){k()}if(f.status==="completed"&&I.current!=="completed"&&k){k()}I.current=f.status}),[f.status,k]);return r("div",{className:"epkb-ai-sync-controls"},!d&&r("div",{className:"epkb-ai-info-message",style:{marginTop:"10px",marginBottom:"10px"}},r("p",{style:{margin:0,color:"#d63638"}},a("OpenAI API key is required to sync content. Please configure it in General Settings.","echo-knowledge-base"))),r("div",{className:"epkb-ai-form-group"},r("label",null,a("Invoke Sync by","echo-knowledge-base")),r("div",{className:"epkb-ai-radio-group"},r("label",{className:"epkb-ai-radio-label"},r("input",{type:"radio",name:"sync_method",value:"basic_timer",checked:v==="basic_timer",onChange:()=>A("basic_timer")}),r("span",null,a("Basic Timer Scheduler","echo-knowledge-base"))),r("label",{className:"epkb-ai-radio-label"},r("input",{type:"radio",name:"sync_method",value:"wordpress_cron",checked:v==="wordpress_cron",onChange:()=>A("wordpress_cron")}),r("span",null,a("WordPress Cron Scheduler","echo-knowledge-base"))))),u&&r("div",{className:"epkb-ai-form-group epkb-ai-checkbox-group"},r("label",{className:"epkb-ai-checkbox-label"},r("input",{type:"checkbox",checked:b,onChange:e=>u(e.target.checked)}),r("span",null,h?a("Select All Filtered Records","echo-knowledge-base"):a("Select All Records","echo-knowledge-base")))),r("div",{className:"epkb-ai-form-group"},r("div",{className:"epkb-ai-selected-records-count"},`${g} ${a("selected records","echo-knowledge-base")}`)),r("div",{className:"epkb-ai-sync-buttons"},E?r("div",{style:{display:"flex",gap:"10px"}},r("button",{className:"epkb-ai-button epkb-ai-button-primary disabled",disabled:true,style:{cursor:"not-allowed"}},a("Sync in Progress","echo-knowledge-base")),r("button",{className:"epkb-ai-button epkb-ai-button-secondary",onClick:S},a("Cancel Sync","echo-knowledge-base"))):r("button",{className:`epkb-ai-button epkb-ai-button-primary ${!x?"disabled":""}`,onClick:C,disabled:!x,title:!d?a("API key required","echo-knowledge-base"):o!=="ALL"&&o.length===0?a("Select at least one item to sync","echo-knowledge-base"):""},a("Start Sync","echo-knowledge-base"))))};window.EPKB_AI_SyncProgressBar=()=>{const{job:e}=p();if(e.status==="idle")return null;let s="";if(e.status==="running"){if(e.total===0){s="Starting sync..."}else{s=`Processing ${e.processed} of ${e.total} posts...`}}else if(e.status==="completed"){s=`Completed! Processed ${e.processed} posts`;if(e.errors>0){s+=` with ${e.errors} errors`}}else if(e.status==="scheduled"){s="Sync scheduled, waiting to start..."}else if(e.status==="canceled"){s="Sync canceled"}return r("div",{className:"epkb-ai-sync-progress"},r("div",{className:"epkb-ai-progress-bar"},r("div",{className:"epkb-ai-progress-fill",style:{width:`${e.percent}%`}}),r("span",{className:"epkb-ai-progress-percentage"},`${e.percent}%`)),s&&r("p",{className:"epkb-ai-progress-message"},s))};window.EPKB_AI_Sync={startSync:y,pollSyncProgress:b,useSyncContext:p}})();