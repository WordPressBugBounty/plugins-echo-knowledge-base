(function(e){"use strict";window.EPKBAISearchResultsUtils={getLoadingHTML:function(){return'<div class="epkb-ai-sr-loading">'+'<div class="epkb-ai-sr-skeleton">'+'<div class="epkb-ai-sr-skeleton__section">'+'<div class="epkb-ai-sr-skeleton__title"></div>'+'<div class="epkb-ai-sr-skeleton__line"></div>'+'<div class="epkb-ai-sr-skeleton__line"></div>'+'<div class="epkb-ai-sr-skeleton__line epkb-ai-sr-skeleton__line--short"></div>'+"</div>"+"</div>"+"</div>"},getErrorHTML:function(e,i){return'<div class="epkb-ai-sr-error">'+'<p class="epkb-ai-sr-error__message">'+e+"</p>"+'<button class="epkb-ai-sr-error__retry">'+(i.try_again||"Try Again")+"</button>"+"</div>"},showCenteredLoader:function(i,t){if(!i||!i.length){return}i.find(".epkb-ai-sr-columns").css("display","none");i.find(".epkb-ai-sr-centered-loader").remove();var s=e('<div class="epkb-ai-sr-centered-loader">'+'<div class="epkb-ai-sr-main-loader">'+'<div class="epkb-ai-sr-main-loader__spinner"></div>'+'<div class="epkb-ai-sr-main-loader__text">'+(t.loading_text||"Loading...")+"</div>"+"</div>"+"</div>");i.append(s)},hideCenteredLoader:function(e){if(!e||!e.length){return}var i=e.find(".epkb-ai-sr-centered-loader");i.hide().remove();e.find(".epkb-ai-sr-columns").css("display","")},parseAiAnswerFormatting:function(e){if(typeof window.EPKBChatUtils==="undefined"||typeof window.EPKBChatUtils.parseMessageFormatting!=="function"){return}var i=e.find(".epkb-ai-sr-ai-answer-text");if(!i.length){return}var t=i.text();if(!t){return}var s=window.EPKBChatUtils.parseMessageFormatting(t);i.html(s)},storePendingSection:function(e,i){sessionStorage.setItem("epkb_ai_pending_"+e,i)},displayPendingSections:function(i){i.find(".epkb-ai-sr-section-wrapper").each((function(){var i=e(this);var t=i.data("section-id");if(!t||i.hasClass("epkb-ai-sr-static-section")){return}var s=t==="ai_answer"||t==="matching_articles"||t==="matching-articles";if(s){return}var r=sessionStorage.getItem("epkb_ai_pending_"+t);if(r){i.html(r).show();sessionStorage.removeItem("epkb_ai_pending_"+t)}}))},hideEmptySections:function(i){if(!i||!i.length){return}i.find(".epkb-ai-sr-section-wrapper").each((function(){var i=e(this);if(i.find(".epkb-ai-sr-loading").length>0){i.hide()}}))},getClarificationMessage:function(e,i){var t=i.clarify_prompt||"We could not find an answer. Could you clarify or rephrase your question?";if(!e||!e.data){return t}var s=e.data;var r=typeof s.clarify_prompt==="string"?s.clarify_prompt.trim():"";return r||t},showClarificationMessage:function(i,t){if(!t||!t.length){return}t.find(".epkb-ai-sr-clarification").remove();var s=e('<div class="epkb-ai-sr-clarification" role="status" aria-live="polite">'+"<p>"+i+"</p>"+"</div>");t.append(s)},removeClarificationMessage:function(e){if(e&&e.length){e.find(".epkb-ai-sr-clarification").remove()}},handleCopyClick:function(e){var i=e.closest(".epkb-ai-sr-section");var t=i.find(".epkb-ai-sr-section__content");if(!t.length){return}var s=this.extractPlainText(t);if(!s){return}this.copyToClipboard(s,e)},extractPlainText:function(i){var t=[];var s=i.find(".epkb-ai-sr-ai-answer-text");if(s.length){return s.text().trim()}var r=i.find(".epkb-ai-sr-steps-list");if(r.length){r.find(".epkb-ai-sr-step-item").each((function(i){t.push(i+1+". "+e(this).text().trim())}));return t.join("\n")}var a=i.find(".epkb-ai-sr-tasks-list");if(a.length){a.find(".epkb-ai-sr-task-item").each((function(){var i=e(this).clone().children(".epkb-ai-sr-task-checkbox").remove().end().text().trim();t.push("â€¢ "+i)}));return t.join("\n")}return i.text().trim()},copyToClipboard:function(e,i){var t=this;if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(e).then((function(){t.showCopiedFeedback(i)})).catch((function(){t.fallbackCopyToClipboard(e,i)}))}else{this.fallbackCopyToClipboard(e,i)}},fallbackCopyToClipboard:function(e,i){var t=document.createElement("textarea");t.value=e;t.style.position="fixed";t.style.opacity="0";document.body.appendChild(t);t.focus();t.select();try{document.execCommand("copy");this.showCopiedFeedback(i)}catch(e){console.error("Copy failed:",e)}t.remove()},showCopiedFeedback:function(e){e.addClass("epkb-ai-sr-copy-btn--copied");setTimeout((function(){e.removeClass("epkb-ai-sr-copy-btn--copied")}),2e3)}};window.epkbAISearchResults=e.extend(window.epkbAISearchResults||{},{PRIMARY_SECTIONS:["ai_answer","matching_articles"],STATIC_SECTIONS:["feedback","contact_us","contact-us"],dialog:null,currentQuery:"",currentKbId:0,chatId:null,isAdmin:false,displayed:false,configError:false,sections:{},init:function(){this.isAdmin=typeof wp!=="undefined"&&wp.hasOwnProperty("data");this.bindEvents()},getSectionType:function(e){if(this.PRIMARY_SECTIONS.indexOf(e)!==-1){return"primary"}if(this.STATIC_SECTIONS.indexOf(e)!==-1){return"static"}return"dynamic"},bindEvents:function(){var i=this;e(document).on("click",".epkb-ai-sr-dialog__close",(function(e){e.preventDefault();i.closeDialog()}));e(document).on("keydown",(function(e){if(e.key==="Escape"&&i.dialog&&i.dialog.is(":visible")){i.closeDialog()}}));e(document).on("click",".epkb-ai-sr-error__retry",(function(t){t.preventDefault();var s=e(this).closest(".epkb-ai-sr-section-wrapper").data("section-id");i.loadSection(s)}));e(document).on("click",".epkb-ai-sr-feedback-btn",(function(t){t.preventDefault();var s=e(this).data("vote");i.recordFeedback(s,e(this))}));e(document).on("click",".epkb-ai-sr-dialog .epkb-ai-sr-keyword-tag a",(function(t){t.preventDefault();var s=e(this).data("keyword");if(s){i.handleQueryClick(s)}}));e(document).on("click",".epkb-ai-sr-dialog .epkb-ai-sr-question-link",(function(t){t.preventDefault();var s=e(this).data("question");if(s){i.handleQueryClick(s)}}));e(document).on("click",".epkb-ai-sr-contact-button",(function(t){t.preventDefault();i.handleContactButtonClick(e(this))}));e(document).on("click",".epkb-ai-sr-copy-btn",(function(i){i.preventDefault();EPKBAISearchResultsUtils.handleCopyClick(e(this))}));e(window).on("resize.epkb-ai-sr-dialog",(function(){if(i.dialog&&i.dialog.is(":visible")){i.positionDialogBelowSearchBox()}}));e(window).on("scroll.epkb-ai-sr-dialog",(function(){if(i.dialog&&i.dialog.is(":visible")){i.positionDialogBelowSearchBox()}}))},positionDialogBelowSearchBox:function(){if(!this.dialog||this.dialog.length===0){return}var i=e("#epkb-ml-search-box");if(i.length===0){i=e(".asea-search-box")}if(i.length===0){console.warn("AI Search Results: Search box not found (tried #epkb-ml-search-box and .asea-search-box)");return}var t=i.offset();var s=i.outerHeight();var r=t.top+s;this.dialog.css({top:r+"px"})},openDialog:function(i,t,s){if(!i||!t){console.error("AI Search Results: Missing query or KB ID");return}this.currentQuery=i;this.currentKbId=t;this.currentCollectionId=s||null;this.resetState();this.dialog=e("#epkb-ai-sr-dialog");if(this.dialog.length===0){console.error("AI Search Results: Dialog not found in DOM");return}this.positionDialogBelowSearchBox();this.dialog.fadeIn(300);this.dialog.find(".epkb-ai-sr-section-wrapper").hide();EPKBAISearchResultsUtils.removeClarificationMessage(this.dialog);this.showCenteredLoader();this.loadSection("ai_answer",false);this.loadSection("matching_articles",false);this.loadSecondarySections()},showConfigurationError:function(e){this.hideCenteredLoader();this.dialog.find(".epkb-ai-sr-columns").css("display","");var i='<div class="epkb-ai-sr-config-error">'+'<div class="epkb-ai-sr-config-error__icon"><span class="epkbfa epkbfa-exclamation-triangle"></span></div>'+'<div class="epkb-ai-sr-config-error__message">'+e+"</div>"+"</div>";var t=this.dialog.find(".epkb-ai-sr-column--primary");if(t.length){t.html(i).show()}else{this.dialog.find(".epkb-ai-sr-column").first().html(i).show()}this.dialog.find(".epkb-ai-sr-column--secondary").hide()},closeDialog:function(){if(this.dialog){this.dialog.find(".epkb-ai-sr-columns").css("display","none");this.dialog.hide();this.hideCenteredLoader();EPKBAISearchResultsUtils.removeClarificationMessage(this.dialog)}},resetState:function(){this.sections={};this.displayed=false;this.chatId=null;this.configError=false},showCenteredLoader:function(){if(!this.dialog){return}EPKBAISearchResultsUtils.showCenteredLoader(this.dialog,epkbAISearchResults.i18n)},hideCenteredLoader:function(){if(this.dialog){EPKBAISearchResultsUtils.hideCenteredLoader(this.dialog)}},showLoadingForPendingSections:function(){var i=this;this.dialog.find(".epkb-ai-sr-section-wrapper").each((function(){var t=e(this);var s=t.data("section-id");if(!s||t.hasClass("epkb-ai-sr-static-section")){return}var r=i.sections[s];if(!r||!r.loaded){if(t.length&&!t.is(":visible")){t.html(EPKBAISearchResultsUtils.getLoadingHTML()).show()}}}))},loadSecondarySections:function(){var i=this;this.dialog.find(".epkb-ai-sr-section-wrapper").each((function(){var t=e(this).data("section-id");if(!t||i.getSectionType(t)!=="dynamic"){return}i.loadSection(t,false)}))},loadSection:function(i,t){var s=this;var r=this.dialog.find('[data-section-id="'+i+'"]');if(!r.length){return}if(t!==false){r.show().html(EPKBAISearchResultsUtils.getLoadingHTML())}var a={query:this.currentQuery,kb_id:this.currentKbId,chat_id:this.chatId};if(this.currentCollectionId){a.collection_id=this.currentCollectionId}e.ajax({url:epkbAISearchResults.rest_url+"epkb-public/v1/ai-search-results/"+i.replace(/_/g,"-"),type:"POST",data:JSON.stringify(a),contentType:"application/json",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",epkbAISearchResults.rest_nonce)},success:function(e){if(e.new_token){epkbAISearchResults.rest_nonce=e.new_token}s.handleSectionResponse(i,e,r)},error:function(e,t,a){s.handleSectionError(i,e,r)}})},handleSectionResponse:function(e,i,t){if(this.configError){return}var s=this.getSectionType(e);var r=i.has_content&&i.html;var a=i.error_type||"";var n=["collection_not_found","no_vector_store","provider_mismatch"].indexOf(a)!==-1;if(n&&i.error){this.showConfigurationError(i.error);this.configError=true;return}this.sections[e]={loaded:true,valid:r,html:i.html||"",wrapper:t,response:i};if(e==="ai_answer"&&i.data&&i.data.chat_id){this.chatId=i.data.chat_id}if(s==="primary"){if(i.error&&!r){this.showConfigurationError(i.error);this.configError=true;return}if(r){this.hideCenteredLoader();if(e==="ai_answer"){t.html(i.html);EPKBAISearchResultsUtils.parseAiAnswerFormatting(t);t.show()}else{t.html(i.html).show()}this.showLoadingForPendingSections()}this.checkAndDisplay();return}if(s==="static"){return}if(r){if(this.displayed){t.html(i.html).show();sessionStorage.removeItem("epkb_ai_pending_"+e)}else{EPKBAISearchResultsUtils.storePendingSection(e,i.html);t.hide()}}else{if(this.isAdmin&&i.error){var o=EPKBAISearchResultsUtils.getErrorHTML(i.error,epkbAISearchResults.i18n);t.html(o).show()}else{t.hide()}}},handleSectionError:function(e,i,t){var s=this.getSectionType(e);var r=i.responseJSON||{};var a=r.error_type||"";var n=["collection_not_found","no_vector_store","provider_mismatch"].indexOf(a)!==-1;if(n&&r.error){this.showConfigurationError(r.error);this.configError=true;return}var o=r.message||r.error||null;if(s==="primary"&&o){this.showConfigurationError(o);this.configError=true;return}this.sections[e]={loaded:true,valid:false,html:"",wrapper:t,response:i.responseJSON||{}};var c="";var l="";if(i.responseJSON&&i.responseJSON.message){l=i.responseJSON.message}else{l="HTTP "+i.status+": "+i.statusText}if(this.isAdmin){c=epkbAISearchResults.i18n.error_admin+" "+l}else{c=epkbAISearchResults.i18n.error}var d=EPKBAISearchResultsUtils.getErrorHTML(c,epkbAISearchResults.i18n);t.html(d);if(s==="primary"){this.checkAndDisplay()}},checkAndDisplay:function(){if(this.displayed){return}var e=this.sections.ai_answer;var i=this.sections.matching_articles;if(!e||!e.loaded||!i||!i.loaded){return}var t=e.valid||i.valid;if(t){this.finalizeValidDisplay()}else{this.finalizeInvalidDisplay()}},finalizeValidDisplay:function(){this.displayed=true;this.hideCenteredLoader();EPKBAISearchResultsUtils.removeClarificationMessage(this.dialog);var i=this.sections.ai_answer;var t=this.sections.matching_articles;if(i&&!i.valid&&t&&t.valid){var s=i.response;var r=EPKBAISearchResultsUtils.getClarificationMessage(s,epkbAISearchResults.i18n);var a=e('<div class="epkb-ai-sr-confirmation" role="status" aria-live="polite">'+"<p>"+r+"</p>"+"</div>");var n=s&&s.title?s.title:"";var o='<div class="epkb-ai-sr-section epkb-ai-sr-section--ai-answer" data-section-id="ai-answer">';if(n){o+='<h3 class="epkb-ai-sr-section__title">'+n+"</h3>"}o+='<div class="epkb-ai-sr-section__content">'+a.html()+"</div></div>";i.wrapper.html(o).show()}else if(i&&!i.valid){i.wrapper.hide()}if(t&&!t.valid){t.wrapper.hide()}this.dialog.find(".epkb-ai-sr-static-section").show();EPKBAISearchResultsUtils.displayPendingSections(this.dialog)},finalizeInvalidDisplay:function(){this.displayed=true;this.hideCenteredLoader();this.hidePrimarySections();this.dialog.find(".epkb-ai-sr-static-section").hide();this.dialog.find(".epkb-ai-sr-section-wrapper").hide();var e=this.sections.ai_answer?this.sections.ai_answer.response:null;var i=EPKBAISearchResultsUtils.getClarificationMessage(e,epkbAISearchResults.i18n);EPKBAISearchResultsUtils.showClarificationMessage(i,this.dialog)},hidePrimarySections:function(){var e=this.sections.ai_answer;var i=this.sections.matching_articles;if(e&&e.wrapper){e.wrapper.hide()}if(i&&i.wrapper){i.wrapper.hide()}},handleQueryClick:function(i){if(!i||!this.dialog||!this.dialog.is(":visible")){return}this.dialog.find('input[type="text"], input[type="search"]').first().val(i);e(".epkb-ml-search-box__input").val(i);e("#asea_advanced_search_terms").val(i);this.currentQuery=i;this.resetState();EPKBAISearchResultsUtils.removeClarificationMessage(this.dialog);this.dialog.find(".epkb-ai-sr-section-wrapper").hide();this.showCenteredLoader();this.loadSection("ai_answer",false);this.loadSection("matching_articles",false);this.loadSecondarySections()},recordFeedback:function(i,t){var s=this;if(!this.chatId){console.error("AI Search Results: No chat_id available for feedback");return}var r=t.closest(".epkb-ai-sr-feedback-buttons");e(".epkb-ai-sr-feedback-btn").prop("disabled",true);var a=epkbAISearchResults.i18n.feedback_submitting||"Submitting...";t.html('<span class="epkbfa epkbfa-spinner epkbfa-spin" style="margin-right: 5px;"></span>'+a);e.ajax({url:epkbAISearchResults.rest_url+"epkb-public/v1/ai-search-results/record-feedback",type:"POST",data:JSON.stringify({chat_id:this.chatId,vote:i}),contentType:"application/json",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",epkbAISearchResults.rest_nonce)},success:function(e){if(e.new_token){epkbAISearchResults.rest_nonce=e.new_token}var i=epkbAISearchResults.i18n.feedback_thanks||"Thank you for your feedback!";t.closest(".epkb-ai-sr-feedback-buttons").html('<p class="epkb-ai-sr-feedback-thanks">'+i+"</p>")},error:function(i){console.error("Failed to record feedback:",i);e(".epkb-ai-sr-feedback-btn").prop("disabled",false);if(s.isAdmin&&i.responseJSON&&i.responseJSON.message){alert("Failed to record feedback: "+i.responseJSON.message)}}})},handleContactButtonClick:function(e){var i=e.closest(".epkb-ai-sr-contact-box");var t=i.find(".epkb-ai-sr-contact-form");if(t.is(":visible")){var s=i.find("#epkb-ai-sr-contact-name");var r=i.find("#epkb-ai-sr-contact-email");var a=s.val().trim();var n=r.val().trim();if(!a){alert(epkbAISearchResults.i18n.contact_name_required||"Please enter your name");s.focus();return}if(!n){alert(epkbAISearchResults.i18n.contact_email_required||"Please enter your email");r.focus();return}this.submitContactSupport(a,n,e)}else{t.slideDown(300);e.text(epkbAISearchResults.i18n.submit||"Submit")}},submitContactSupport:function(i,t,s){var r=this;var a=s.closest(".epkb-ai-sr-contact-box");s.prop("disabled",true).text(epkbAISearchResults.i18n.submitting||"Submitting...");e.ajax({url:epkbAISearchResults.rest_url+"epkb-public/v1/ai-search-results/submit-contact-support",type:"POST",data:JSON.stringify({query:this.currentQuery,name:i,email:t,chat_id:this.chatId||""}),contentType:"application/json",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",epkbAISearchResults.rest_nonce)},success:function(e){if(e.new_token){epkbAISearchResults.rest_nonce=e.new_token}var i=epkbAISearchResults.i18n.contact_success||"Thank you! We will get back to you soon.";a.html('<p class="epkb-ai-sr-contact-success">'+i+"</p>")},error:function(e){console.error("Failed to submit contact support:",e);s.prop("disabled",false).text(epkbAISearchResults.i18n.submit||"Submit");var i=epkbAISearchResults.i18n.contact_error||"Failed to submit. Please try again.";if(r.isAdmin&&e.responseJSON&&e.responseJSON.message){i=e.responseJSON.message}alert(i)}})}});window.epkbAISearchResultsShortcode={init:function(){this.bindEvents()},bindEvents:function(){var i=this;e(document).on("submit",".epkb-ai-sr-shortcode__search-form",(function(t){t.preventDefault();var s=e(this);var r=s.closest(".epkb-ai-sr-shortcode");var a=s.find(".epkb-ai-sr-shortcode__input").val().trim();var n=r.data("kb-id");var o=r.data("collection-id");if(a){i.submitSearch(a,n,o,s)}}));e(document).on("click",".epkb-ai-sr-shortcode .epkb-ai-sr-error__retry",(function(i){i.preventDefault();var t=e(this).closest(".epkb-ai-sr-section-wrapper").data("section-id");epkbAISearchResults.loadSection(t)}));e(document).on("click",".epkb-ai-sr-shortcode .epkb-ai-sr-feedback-btn",(function(i){i.preventDefault();var t=e(this).data("vote");epkbAISearchResults.recordFeedback(t,e(this))}));e(document).on("click",".epkb-ai-sr-shortcode .epkb-ai-sr-keyword-tag a",(function(t){t.preventDefault();var s=e(this).data("keyword");if(s){i.handleQueryClick(s,e(this))}}));e(document).on("click",".epkb-ai-sr-shortcode .epkb-ai-sr-question-link",(function(t){t.preventDefault();var s=e(this).data("question");if(s){i.handleQueryClick(s,e(this))}}));e(document).on("click",".epkb-ai-sr-shortcode .epkb-ai-sr-contact-button",(function(i){i.preventDefault();epkbAISearchResults.handleContactButtonClick(e(this))}))},submitSearch:function(e,i,t,s){if(!e||!i){return}var r=s.closest(".epkb-ai-sr-shortcode");var a=r.find(".epkb-ai-sr-shortcode__results");epkbAISearchResults.currentQuery=e;epkbAISearchResults.currentKbId=i;epkbAISearchResults.currentCollectionId=t;epkbAISearchResults.resetState();a.fadeIn(300);a.find(".epkb-ai-sr-section-wrapper").hide();EPKBAISearchResultsUtils.removeClarificationMessage(a);EPKBAISearchResultsUtils.showCenteredLoader(a,epkbAISearchResults.i18n);epkbAISearchResults.dialog=a;epkbAISearchResults.loadSection("ai_answer",false);epkbAISearchResults.loadSection("matching_articles",false);epkbAISearchResults.loadSecondarySections()},handleQueryClick:function(i,t){if(!i){return}var s=t.closest(".epkb-ai-sr-shortcode");var r=s.find(".epkb-ai-sr-shortcode__input");var a=s.find(".epkb-ai-sr-shortcode__search-form");r.val(i);a.submit();e("html, body").animate({scrollTop:s.offset().top-100},300)}};e(document).ready((function(){if(typeof epkbAISearchResults!=="undefined"&&typeof epkbAISearchResults.init==="function"){epkbAISearchResults.init()}if(typeof epkbAISearchResultsShortcode!=="undefined"&&typeof epkbAISearchResultsShortcode.init==="function"){epkbAISearchResultsShortcode.init()}}))})(jQuery);