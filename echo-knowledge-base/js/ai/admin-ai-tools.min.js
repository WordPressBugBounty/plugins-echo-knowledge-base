(function(){"use strict";const{useState:e,useEffect:a,useRef:s,createElement:o}=wp.element;const{__:n}=wp.i18n;const{showError:t,showSuccess:l,makeApiRequest:i,handleSessionError:c}=window.EPKB_AI_Util_React||{};const d=({settings:s,tabData:i})=>{const[d,b]=e(i?.active_sub_tab||"debug");const[u,p]=e(i?.debug_enabled==="on");const[r,g]=e([]);const[k,m]=e([]);const[h,w]=e([]);const[f,v]=e("");const[N,_]=e("");const[y,E]=e("");const[A,C]=e(false);const[I,j]=e(false);const[T,P]=e(false);const[x,O]=e(null);const[D,S]=e(null);const[L,R]=e([]);const[$,F]=e([]);const[K,W]=e([]);const B=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.hostname.includes(".local")||window.location.hostname.includes(".test");a((()=>{if(u){q();J();V();G();X()}}),[u]);a((()=>{Q()}),[f,L]);a((()=>{M()}),[N,$]);a((()=>{U()}),[y,K]);const Q=()=>{if(!L.length)return;if(!f){g(L);return}const e=L.filter((e=>{if(f==="ai-related"){return e.message&&(e.message.toLowerCase().includes("epkb")||e.message.toLowerCase().includes("ai"))}return e.level===f}));g(e)};const M=()=>{if(!$.length)return;if(!N){m($);return}const e=$.filter((e=>{if(N==="ai-related"){return e.message&&(e.message.toLowerCase().includes("epkb")||e.message.toLowerCase().includes("ai"))}return e.level===N}));m(e)};const U=()=>{if(!K.length)return;if(!y){w(K);return}const e=K.filter((e=>e.level===y));w(e)};const H=async e=>{try{const a=await jQuery.ajax({url:ajaxurl,type:"POST",dataType:"json",data:{action:"epkb_ai_toggle_debug_mode",enabled:e?"on":"off",_wpnonce:i?.nonce||""}});if(a.success){p(e);l(n("Debug mode updated successfully","echo-knowledge-base"));setTimeout((()=>window.location.reload()),1e3)}else{t(a.data.message||n("Failed to update debug mode","echo-knowledge-base"))}}catch(e){const a=await c(e);if(!a){t(n("Error updating debug mode","echo-knowledge-base"))}}};const q=async()=>{C(true);try{const e=await jQuery.ajax({url:ajaxurl,type:"POST",dataType:"json",data:{action:"epkb_ai_get_php_error_logs",filter:"",_wpnonce:i?.nonce||""}});if(e.success){R(e.data.logs||[]);if(!f){g(e.data.logs||[])}else{Q()}}else{t(e.data.message||n("Failed to load PHP logs","echo-knowledge-base"))}}catch(e){const a=await c(e);if(!a){t(n("Error loading PHP logs","echo-knowledge-base"))}}finally{C(false)}};const J=async()=>{j(true);try{const e=await jQuery.ajax({url:ajaxurl,type:"POST",dataType:"json",data:{action:"epkb_ai_get_wp_error_logs",filter:"",_wpnonce:i?.nonce||""}});if(e.success){F(e.data.logs||[]);if(!N){m(e.data.logs||[])}else{M()}}else{t(e.data.message||n("Failed to load WP logs","echo-knowledge-base"))}}catch(e){const a=await c(e);if(!a){t(n("Error loading WP logs","echo-knowledge-base"))}}finally{j(false)}};const V=async()=>{P(true);try{const e=await jQuery.ajax({url:ajaxurl,type:"POST",dataType:"json",data:{action:"epkb_ai_get_ai_logs",filter:"",_wpnonce:i?.nonce||""}});if(e.success){W(e.data.logs||[]);if(!y){w(e.data.logs||[])}else{U()}}else{t(e.data.message||n("Failed to load AI logs","echo-knowledge-base"))}}catch(e){const a=await c(e);if(!a){t(n("Error loading AI logs","echo-knowledge-base"))}}finally{P(false)}};const z=async()=>{const{showConfirmDialog:e}=window.EPKB_AI_Util_React||{};if(!e){t(n("Dialog utility not available","echo-knowledge-base"));return}const a=await e({title:n("Clear AI Logs","echo-knowledge-base"),message:n("Are you sure you want to clear all AI logs? This action cannot be undone.","echo-knowledge-base"),confirmText:n("Clear Logs","echo-knowledge-base"),cancelText:n("Cancel","echo-knowledge-base"),confirmButtonClass:"epkb-ai-button-danger"});if(!a){return}try{const e=await jQuery.ajax({url:ajaxurl,type:"POST",dataType:"json",data:{action:"epkb_ai_clear_ai_logs",_wpnonce:i?.nonce||""}});if(e.success){w([]);W([]);l(n("AI logs cleared successfully","echo-knowledge-base"))}else{t(e.data.message||n("Failed to clear AI logs","echo-knowledge-base"))}}catch(e){const a=await c(e);if(!a){t(n("Error clearing AI logs","echo-knowledge-base"))}}};const G=()=>{const e=i?.system_info||{};const a={};Object.entries(e).forEach((([e,s])=>{if(!e.includes("ai_")&&!e.includes("openai")&&!e.includes("vector")){a[e]=s}}));O(a)};const X=()=>{const e={ai_config:i?.ai_config||{},data_collections:i?.data_collections||[],openai_status:i?.openai_status||{}};S(e)};const Y=()=>{const e=document.createElement("iframe");e.style.display="none";e.name="download-frame-"+Date.now();document.body.appendChild(e);const a=document.createElement("form");a.method="POST";a.action=window.location.href;a.target=e.name;const s=document.createElement("input");s.type="hidden";s.name="action";s.value="epkb_download_ai_debug_info";a.appendChild(s);const o=document.createElement("input");o.type="hidden";o.name="_wpnonce";o.value=i?.nonce||"";a.appendChild(o);document.body.appendChild(a);a.submit();setTimeout((()=>{document.body.removeChild(a);document.body.removeChild(e)}),5e3)};const Z=e=>o("div",{className:`epkb-ai-log-entry epkb-ai-log-${e.level}`,key:`${e.timestamp}-${Math.random()}`},o("div",{className:"epkb-ai-log-header"},o("span",{className:"epkb-ai-log-timestamp"},e.timestamp),o("span",{className:`epkb-ai-log-level ${e.level}`},e.level)),o("div",{className:"epkb-ai-log-message"},e.message),e.context&&Object.keys(e.context).length>0&&o("div",{className:"epkb-ai-log-context"},o("pre",null,JSON.stringify(e.context,null,2))));const ee=i?.sub_tabs||{};const ae=window.EPKB_AI_Tuning?.AIAdminTuning;const se=()=>o("div",{className:"epkb-ai-sub-tabs-nav"},Object.entries(ee).map((([e,a])=>o("button",{key:e,className:`epkb-ai-sub-tab-button ${d===e?"active":""}`,onClick:()=>b(e)},a.icon&&o("span",{className:a.icon})," ",a.title))));const oe=()=>{if(d==="tuning"){if(ae){return o(ae,{tabData:i?.tuning_config||{},settings:{ajax_nonce:s?.ajax_nonce}})}else{return o("div",{className:"epkb-ai-no-content"},o("p",null,n("Tuning component not loaded","echo-knowledge-base")))}}return o("div",{className:"epkb-ai-debug-content"},o("div",{className:"epkb-ai-debug-toggle-section"},o("h3",null,n("Debug Mode","echo-knowledge-base")),o("div",{className:"epkb-ai-setting-row"},o("label",{className:"epkb-ai-switch"},o("input",{type:"checkbox",checked:u,onChange:e=>H(e.target.checked)}),o("span",{className:"epkb-ai-slider"})),o("span",{className:"epkb-ai-setting-label"},n("Enable Debug Mode","echo-knowledge-base"),B&&o("span",{className:"epkb-ai-localhost-notice"},n(" (Localhost detected)","echo-knowledge-base")))),o("p",{className:"epkb-ai-setting-description"},n("Enable debug mode to view system logs and troubleshoot AI features. This will load additional debugging tools.","echo-knowledge-base"))),u?o("div",{className:"epkb-ai-debug-sections"},o("div",{className:"epkb-ai-debug-toggle-section"},o("h3",null,n("AI Information","echo-knowledge-base")),o("div",{className:"epkb-ai-debug-section epkb-ai-ai-info"},o("div",null,o("div",{className:"epkb-ai-info-grid"},o("div",{className:"epkb-ai-info-item"},o("span",{className:"epkb-ai-info-label"},n("AI Chat","echo-knowledge-base")),o("span",{className:`epkb-ai-info-value epkb-ai-status-indicator ${i?.system_info?.ai_chat?.value==="Enabled"?"epkb-status-enabled":"epkb-status-disabled"}`},i?.system_info?.ai_chat?.value==="Enabled"?o("span",{className:"epkbfa epkbfa-check-circle epkb-ai-status-success"}):o("span",null,n("Disabled","echo-knowledge-base")))),o("div",{className:"epkb-ai-info-item"},o("span",{className:"epkb-ai-info-label"},n("AI Search","echo-knowledge-base")),o("span",{className:`epkb-ai-info-value epkb-ai-status-indicator ${i?.system_info?.ai_search?.value==="Enabled"?"epkb-status-enabled":"epkb-status-disabled"}`},i?.system_info?.ai_search?.value==="Enabled"?o("span",{className:"epkbfa epkbfa-check-circle epkb-ai-status-success"}):o("span",null,n("Disabled","echo-knowledge-base")))),o("div",{className:"epkb-ai-info-item"},o("span",{className:"epkb-ai-info-label"},n("OpenAI API Key","echo-knowledge-base")),o("span",{className:`epkb-ai-info-value epkb-ai-status-indicator ${i?.system_info?.openai_api?.value==="Configured"?"epkb-status-enabled":"epkb-status-disabled"}`},i?.system_info?.openai_api?.value==="Configured"?o("span",{className:"epkbfa epkbfa-check-circle epkb-ai-status-success"}):o("span",null,n("Missing API Key","echo-knowledge-base"))))),o("div",{className:"epkb-ai-subsection"},o("h4",null,n("Data Collections","echo-knowledge-base")),D?.data_collections&&D.data_collections.length>0?o("div",{className:"epkb-ai-data-collections"},D.data_collections.map(((e,a)=>o("div",{className:"epkb-ai-collection-item",key:e.id||a},o("h5",null,e.name||n("Unnamed Collection","echo-knowledge-base")),o("div",{className:"epkb-ai-collection-details"},o("div",null,o("span",null,n("Vector Store:","echo-knowledge-base")+" ",o("strong",null,e.vector_store_status==="created"?n("Created","echo-knowledge-base"):n("Not created","echo-knowledge-base"))),e.vector_store_id&&o("span",null," (ID: "+e.vector_store_id+")")),o("div",null,o("span",null,n("Total Records:","echo-knowledge-base")+" ",o("strong",null,e.db_record_count||"0"))),e.status_counts&&o("div",{className:"epkb-ai-status-counts"},o("span",{className:"epkb-ai-status-label"},n("Status:","echo-knowledge-base")),e.status_counts.added>0&&o("span",{className:"epkb-ai-status-item epkb-ai-status-added"},n("Added:","echo-knowledge-base")+" "+e.status_counts.added),e.status_counts.updated>0&&o("span",{className:"epkb-ai-status-item epkb-ai-status-updated"},n("Updated:","echo-knowledge-base")+" "+e.status_counts.updated),e.status_counts.outdated>0&&o("span",{className:"epkb-ai-status-item epkb-ai-status-outdated"},n("Outdated:","echo-knowledge-base")+" "+e.status_counts.outdated),e.status_counts.error>0&&o("span",{className:"epkb-ai-status-item epkb-ai-status-error"},n("Error:","echo-knowledge-base")+" "+e.status_counts.error),e.status_counts.pending>0&&o("span",{className:"epkb-ai-status-item epkb-ai-status-pending"},n("Pending:","echo-knowledge-base")+" "+e.status_counts.pending))))))):o("p",{className:"epkb-ai-no-data"},n("No data collections found.","echo-knowledge-base")))))),o("div",{className:"epkb-ai-debug-toggle-section"},o("h3",null,n("System Information","echo-knowledge-base")),o("div",{className:"epkb-ai-debug-section epkb-ai-system-info"},o("div",{className:"epkb-ai-info-grid"},x&&Object.entries(x).map((([e,a])=>o("div",{className:"epkb-ai-info-item",key:e},o("span",{className:"epkb-ai-info-label"},a.label+":"),o("span",{className:`epkb-ai-info-value ${a.class||""}`},a.value))))),o("div",{className:"epkb-ai-debug-actions"},o("button",{className:"epkb-ai-btn epkb-ai-btn-primary",onClick:Y},o("span",{className:"epkbfa epkbfa-download"})," ",n("Download Debug Info","echo-knowledge-base"))))),o("div",{className:"epkb-ai-debug-toggle-section"},o("h3",null,n("Logs","echo-knowledge-base")),o("div",{className:"epkb-ai-logs-subsection"},o("h4",null,n("PHP Error Log","echo-knowledge-base")),o("div",{className:"epkb-ai-debug-section epkb-ai-php-error-log"},o("div",{className:"epkb-ai-debug-controls"},o("button",{className:"epkb-ai-btn epkb-ai-btn-primary",onClick:q},o("span",{className:"epkbfa epkbfa-refresh"})," ",n("Refresh","echo-knowledge-base")),o("select",{className:"epkb-ai-select",value:f,onChange:e=>v(e.target.value)},o("option",{value:""},n("All Errors","echo-knowledge-base")),o("option",{value:"fatal"},n("Fatal Errors","echo-knowledge-base")),o("option",{value:"warning"},n("Warnings","echo-knowledge-base")),o("option",{value:"notice"},n("Notices","echo-knowledge-base")),o("option",{value:"ai-related"},n("AI Related Only","echo-knowledge-base")))),o("div",{className:"epkb-ai-log-container"},A?o("div",{className:"epkb-ai-loading-spinner"}):r.length===0?o("div",{className:"epkb-ai-no-logs"},n("No logs found.","echo-knowledge-base")):r.map((e=>Z(e)))))),o("h4",null,n("WordPress Error Log","echo-knowledge-base")),o("div",{className:"epkb-ai-debug-section epkb-ai-wp-error-log"},o("div",{className:"epkb-ai-debug-controls"},o("button",{className:"epkb-ai-btn epkb-ai-btn-primary",onClick:J},o("span",{className:"epkbfa epkbfa-refresh"})," ",n("Refresh","echo-knowledge-base")),o("select",{className:"epkb-ai-select",value:N,onChange:e=>_(e.target.value)},o("option",{value:""},n("All Errors","echo-knowledge-base")),o("option",{value:"fatal"},n("Fatal Errors","echo-knowledge-base")),o("option",{value:"warning"},n("Warnings","echo-knowledge-base")),o("option",{value:"notice"},n("Notices","echo-knowledge-base")),o("option",{value:"ai-related"},n("AI Related Only","echo-knowledge-base")))),o("div",{className:"epkb-ai-log-container"},I?o("div",{className:"epkb-ai-loading-spinner"}):k.length===0?o("div",{className:"epkb-ai-no-logs"},n("No logs found.","echo-knowledge-base")):k.map((e=>Z(e))))),o("h4",null,n("AI Activity Log","echo-knowledge-base")),o("div",{className:"epkb-ai-debug-section epkb-ai-activity-log"},o("div",{className:"epkb-ai-debug-controls"},o("button",{className:"epkb-ai-btn epkb-ai-btn-primary",onClick:V},o("span",{className:"epkbfa epkbfa-refresh"})," ",n("Refresh","echo-knowledge-base")),o("button",{className:"epkb-ai-btn epkb-ai-btn-danger",onClick:z},o("span",{className:"epkbfa epkbfa-trash"})," ",n("Clear Logs","echo-knowledge-base")),o("select",{className:"epkb-ai-select",value:y,onChange:e=>E(e.target.value)},o("option",{value:""},n("All Levels","echo-knowledge-base")),o("option",{value:"error"},n("Errors Only","echo-knowledge-base")),o("option",{value:"warning"},n("Warnings","echo-knowledge-base")),o("option",{value:"info"},n("Info","echo-knowledge-base")))),o("div",{className:"epkb-ai-log-container"},T?o("div",{className:"epkb-ai-loading-spinner"}):h.length===0?o("div",{className:"epkb-ai-no-logs"},n("No logs found.","echo-knowledge-base")):h.map((e=>Z(e))))))):o("div",{className:"epkb-ai-debug-disabled"},o("p",null,n("Debug mode is disabled. Enable it above to view debug information.","echo-knowledge-base"))))};return o("div",{className:"epkb-ai-tools-container"},Object.keys(ee).length>0&&o("div",{className:"epkb-ai-sub-tabs"},se()),o("div",{className:"epkb-ai-sub-tab-content"},oe()))};window.EPKB_AI_Tools={AIAdminTools:d}})();