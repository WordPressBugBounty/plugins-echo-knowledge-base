(function(){"use strict";const{useState:e,useEffect:t,useCallback:o,createElement:a,Fragment:n,createContext:s,useContext:l,useMemo:c,useRef:i}=wp.element;const{__:r}=wp.i18n;const{showError:d,showSuccess:p,makeApiRequest:g,showConfirmDialog:b}=window.EPKB_AI_Util_React||{};const{SyncProvider:u,SyncControls:h,SyncProgressBar:m}=window.EPKB_AI_Sync?{SyncProvider:window.EPKB_AI_SyncProvider,SyncControls:window.EPKB_AI_SyncControls,SyncProgressBar:window.EPKB_AI_SyncProgressBar}:{};const f=s();window.EPKB_AI_TrainingDataCacheContext=f;const k=({children:o})=>{t((()=>{if(window.performance&&window.performance.navigation.type===1){try{sessionStorage.removeItem("epkb_ai_training_data_cache")}catch(e){console.warn("Failed to clear cache on reload:",e)}}const e=()=>{try{const e=sessionStorage.getItem("epkb_ai_training_data_cache");if(e){const t=JSON.parse(e);const o=Date.now();const a=5*60*1e3;let n=false;for(const e in t){if(t[e]&&t[e].timestamp&&o-t[e].timestamp>a){delete t[e];n=true}}if(n){sessionStorage.setItem("epkb_ai_training_data_cache",JSON.stringify(t))}}}catch(e){console.warn("Failed to check cache expiry:",e)}};e()}),[]);const n=()=>{try{const e=sessionStorage.getItem("epkb_ai_training_data_cache");return e?JSON.parse(e):{}}catch(e){console.warn("Failed to load cache from session storage:",e);return{}}};const[s,l]=e(n);t((()=>{try{sessionStorage.setItem("epkb_ai_training_data_cache",JSON.stringify(s))}catch(e){if(e.name==="QuotaExceededError"){l({});try{sessionStorage.removeItem("epkb_ai_training_data_cache")}catch(e){console.warn("Failed to clear session storage:",e)}}else{console.warn("Failed to save cache to session storage:",e)}}}),[s]);const i=c((()=>({get:e=>s[e],set:(e,t)=>{l((o=>({...o,[e]:{...t,timestamp:Date.now()}})))},remove:e=>{l((t=>{const o={...t};delete o[e];return o}))},clear:()=>{l({});try{sessionStorage.removeItem("epkb_ai_training_data_cache")}catch(e){console.warn("Failed to clear session storage:",e)}},clearCollection:e=>{l((t=>{const o={...t};Object.keys(o).forEach((t=>{if(t.startsWith(`collection_${e}_`)){delete o[t]}}));return o}))},clearNonExistentCollections:e=>{l((t=>{const o={...t};Object.keys(o).forEach((t=>{const a=t.match(/^collection_(\d+)_/);if(a){const n=parseInt(a[1]);if(!e.includes(n)){delete o[t]}}}));return o}))}})),[s]);return a(f.Provider,{value:i},o)};const w=()=>{const e=l(f);if(!e){throw new Error("useTrainingDataCache must be used within TrainingDataCacheProvider")}return e};const y=window.EPKB_AI_DataSourceTable||(()=>a("div",null,"DataSourceTable component not loaded"));const _=({collectionId:o,config:s,onSyncStart:l=null,onActionChange:c=null,hasApiKey:i=true,isDeletingDialogOpen:u=false,selectedRecordsCount:m=0,selectedIds:f=[],trainingData:k=[],bulkDeleteHandler:w=null,onDeleteCollection:y=null,collectionName:_="",onSelectAll:S=null,isAllSelected:x=false,onTableRefresh:C=null,isFiltered:v=false,updateRowsHandler:A=null,isSelectAllActive:D=false,totalItems:N=0})=>{const[I,P]=e(null);const[T,E]=e([]);const[B,R]=e(false);const[K,F]=e(null);const[$,O]=e(_);const[U]=e(_);const[z,L]=e(false);t((()=>{if(c){c(I)}}),[I,c]);const[H,W]=e(false);const j=async()=>{if(!$.trim()){d(r("Collection name cannot be empty","echo-knowledge-base"));return}L(true);try{const e=await g(`training-collections/${o}`,{method:"PUT",data:{name:$}});if(e.success){p(r("Collection name updated successfully","echo-knowledge-base"));setTimeout((()=>{window.location.reload()}),1e3)}}catch(e){if(e.message!=="API key required"&&!e._errorDisplayed){d(e.message||r("Failed to update collection name","echo-knowledge-base"))}}finally{L(false)}};const q=async()=>{const e=await b({title:r("Delete Collection","echo-knowledge-base"),message:`${r("Are you sure you want to delete this collection?","echo-knowledge-base")}\n\n${r("Type the collection name to confirm:","echo-knowledge-base")} "${_}"`,confirmText:r("Delete","echo-knowledge-base"),cancelText:r("Cancel","echo-knowledge-base"),confirmButtonClass:"epkb-ai-button-danger",requireInput:true,inputPlaceholder:r("Enter collection name","echo-knowledge-base"),inputMatch:_});if(!e){return}W(true);try{const e=await g(`training-collections/${o}`,{method:"DELETE"});if(e.success){p(r("Collection deleted successfully","echo-knowledge-base"));if(y){y(o)}}}catch(e){console.error("Delete collection error:",e);if(e.message!=="API key required"&&!e._errorDisplayed){d(e.message||r("Failed to delete collection","echo-knowledge-base"))}}finally{}};const M=async()=>{if(T.length===0){d(r("Please select at least one data type","echo-knowledge-base"));return}R(true);try{const e=await g(`training-collections/${o}/add-data`,{method:"POST",data:{data_types:T}});if(e.success){F(e.message||r("Data added successfully","echo-knowledge-base"));E([]);if(C){C()}}}catch(e){if(e.message!=="API key required"&&!e._errorDisplayed){d(e.message||r("Failed to add data","echo-knowledge-base"))}}finally{R(false)}};if(!I){return a("div",{className:"epkb-ai-data-source-settings"},a("h3",{className:"epkb-ai-data-source-heading"},r("Choose an Action","echo-knowledge-base")),a("div",{className:"epkb-ai-action-buttons"},a("button",{className:"epkb-ai-button epkb-ai-button-secondary",onClick:()=>P("add")},a("span",null,r("Choose Training Data","echo-knowledge-base")),a("span",{className:"epkbfa epkbfa-caret-right"})),a("button",{className:"epkb-ai-button epkb-ai-button-secondary",onClick:()=>P("sync")},a("span",null,r("Send Data to AI","echo-knowledge-base")),a("span",{className:"epkbfa epkbfa-caret-right"})),a("button",{className:"epkb-ai-button epkb-ai-button-secondary",onClick:()=>P("remove")},a("span",null,r("Other Actions","echo-knowledge-base")),a("span",{className:"epkbfa epkbfa-caret-right"}))))}const J=()=>{switch(I){case"add":return r("Add Training Data","echo-knowledge-base");case"sync":return r("Send Data AI","echo-knowledge-base");case"remove":return r("Other Actions","echo-knowledge-base");default:return""}};return a("div",{className:"epkb-ai-data-source-settings"},a("button",{className:"epkb-ai-back-button",onClick:()=>{P(null);F(null)}},a("span",{className:"epkbfa epkbfa-chevron-left"}),r("Back","echo-knowledge-base")),a("h3",{style:{marginBottom:"20px",fontSize:"24px",fontWeight:"600"}},J()),I==="add"&&a("div",{className:"epkb-ai-action-content"},a("p",{style:{color:"#666",marginBottom:"15px"}},r("Choose which content types you want to include in your AI training data.","echo-knowledge-base")),a("div",{className:"epkb-ai-checkbox-list"},a("label",{style:{display:"flex",alignItems:"center",marginBottom:"10px",cursor:"pointer"}},a("input",{type:"checkbox",checked:T.includes("epkb_post_type_1"),onChange:e=>{if(e.target.checked){E([...T,"epkb_post_type_1"])}else{E(T.filter((e=>e!=="epkb_post_type_1")))}},style:{marginRight:"10px"}}),a("span",{style:{fontWeight:"500"}},r("KB #1","echo-knowledge-base")))),a("p",{style:{color:"#888",fontSize:"13px",fontStyle:"italic",marginTop:"10px"}},r("More post types will be available in future updates.","echo-knowledge-base")),a("div",{style:{marginTop:"20px"}},a("button",{className:"epkb-ai-button epkb-ai-button-primary",onClick:M,disabled:B||T.length===0},B?r("Adding Data...","echo-knowledge-base"):r("Add Data","echo-knowledge-base")),K&&a("div",{className:"epkb-ai-add-data-success-message",style:{marginTop:"15px",padding:"15px",backgroundColor:"#d4edda",border:"1px solid #c3e6cb",borderRadius:"4px",color:"#155724",fontSize:"14px",lineHeight:"1.5"}},a("span",{className:"epkbfa epkbfa-check-circle",style:{marginRight:"8px",color:"#28a745"}}),K))),I==="sync"&&a("div",{className:"epkb-ai-action-content"},(()=>{let e;if(D){e="ALL"}else{e=f.map((e=>{const t=k.find((t=>t.id===e));return t?t.item_id:null})).filter((e=>e!==null))}return a(n,null,h&&a(h,{collectionId:o,selectedPostIds:e,disabled:!i||u||e!=="ALL"&&e.length===0,onPostUpdate:A,hasApiKey:i,onSelectAll:S,isAllSelected:x,selectedRecordsCount:m,isFiltered:v,onSyncStart:l,isSelectAllActive:D}))})(),a("p",{style:{color:"#666",marginTop:"15px",fontSize:"14px"}},r("Select items from the table and choose a sync method to update your AI training data.","echo-knowledge-base"))),I==="remove"&&a("div",{className:"epkb-ai-action-content"},a("p",{style:{color:"#666",marginBottom:"20px"}},r("Manage your collection settings and data.","echo-knowledge-base")),a("div",{className:"epkb-ai-collection-name-section",style:{marginBottom:"30px"}},a("h4",{style:{marginBottom:"10px",fontSize:"16px",fontWeight:"600"}},r("Collection Name","echo-knowledge-base"),a("span",{style:{color:"#999",fontWeight:"normal",fontSize:"14px",marginLeft:"10px"}},`(ID: ${o})`)),a("div",{style:{display:"flex",alignItems:"center",gap:"10px"}},a("input",{type:"text",value:$,onChange:e=>O(e.target.value),style:{padding:"8px 12px",border:"1px solid #ddd",borderRadius:"4px",fontSize:"14px",flex:"1",maxWidth:"400px"},placeholder:r("Enter collection name","echo-knowledge-base")}),a("button",{className:"epkb-ai-button epkb-ai-button-primary",onClick:j,disabled:z||$===U,style:{padding:"8px 20px",cursor:z||$===U?"not-allowed":"pointer",opacity:z||$===U?.5:1}},z?r("Saving...","echo-knowledge-base"):r("Save","echo-knowledge-base"))),a("p",{style:{marginTop:"8px",color:"#666",fontSize:"13px"}},r("Change the display name for this collection.","echo-knowledge-base"))),a("hr",{style:{margin:"30px 0",border:"none",borderTop:"1px solid #e5e5e5"}}),(()=>null)(),a("div",{className:"epkb-ai-delete-selected-section",style:{marginBottom:"25px"}},a("div",{style:{display:"flex",alignItems:"center",gap:"15px"}},a("button",{id:"epkb-ai-delete-selected-btn",className:"epkb-ai-button epkb-ai-button-danger",onClick:e=>{e.preventDefault();e.stopPropagation();if(w&&typeof w==="function"){try{w()}catch(e){console.error("Error calling bulkDeleteHandler:",e)}}else{console.error("bulkDeleteHandler is not a function:",w);d(r("Unable to delete items. Please refresh the page and try again.","echo-knowledge-base"))}},disabled:!w||f.length===0,style:{padding:"10px 20px",backgroundColor:"#d63638",borderColor:"#d63638",color:"#fff",cursor:!w||f.length===0?"not-allowed":"pointer",opacity:!w||f.length===0?.5:1}},r("Delete Selected","echo-knowledge-base")),a("span",{style:{color:"#666",fontSize:"14px"}},`${f.length} ${r("Selected Records","echo-knowledge-base")}`)),a("p",{style:{marginTop:"10px",color:"#666",fontSize:"13px"}},r("Delete the selected training data items from this collection.","echo-knowledge-base"))),a("hr",{style:{margin:"30px 0",border:"none",borderTop:"1px solid #e5e5e5"}}),a("div",{className:"epkb-ai-delete-collection-section"},a("button",{className:"epkb-ai-button epkb-ai-button-danger epkb-ai-delete-collection-btn",onClick:q,disabled:H,style:{padding:"10px 20px",backgroundColor:"#d63638",borderColor:"#d63638",color:"#fff",cursor:H?"not-allowed":"pointer"}},H?r("Deleting...","echo-knowledge-base"):r("Delete Collection","echo-knowledge-base")),a("p",{style:{marginTop:"10px",color:"#666",fontSize:"13px"}},r("This will permanently delete all training data in this collection.","echo-knowledge-base")))))};const S=({collection:n,config:s,hasApiKey:c,onDeleteCollection:i})=>{const[r,d]=e(false);const[p,g]=e(false);const[b,h]=e(false);const[f,k]=e([]);const[w,S]=e([]);const[x,C]=e(null);const[v,A]=e(null);const[D,N]=e(0);const[I,P]=e(0);const[T,E]=e(false);const[B,R]=e(null);const[K,F]=e(false);const $=v&&f.length>0&&D>0&&f.length===D;const O=window.EPKB_AI_SyncContext?l(window.EPKB_AI_SyncContext):null;t((()=>{if(O&&O.job){const e=O.job.status;if(e==="completed"||e==="canceled"||e==="idle"){d(false)}}}),[O?.job?.status]);const U=o((e=>{C((()=>e))}),[]);const z=o((e=>{const t=t=>{F(t);if(e){e(t)}};A((()=>t))}),[]);const L=o((e=>{R((()=>e))}),[]);const H=o((e=>{if(e===null){d(false)}}),[]);const W=o((e=>{k(e)}),[]);const j=o((()=>{P((e=>e+1))}),[]);const q=o((()=>{k([]);F(false);d(true)}),[]);const M=a("div",{className:"epkb-ai-data-collection-wrapper"},m&&a("div",{className:"epkb-ai-sync-progress-container",style:{padding:"0 20px"}},a(m)),a("div",{className:"epkb-ai-data-source-layout"},a(y,{collectionId:n.id,collectionName:n.name,hasApiKey:c,onSelectedIdsChange:W,onBulkDeleteCallback:U,onSelectAllCallback:z,onTotalItemsChange:N,onTrainingDataChange:S,refreshTrigger:I,isSyncing:r,onFilterStateChange:E,onUpdateRowsCallback:L,initialStats:n.stats||null,selectedIds:f}),a(_,{collectionId:n.id,config:s,onSyncStart:q,onActionChange:H,hasApiKey:c,isDeletingDialogOpen:b,selectedRecordsCount:K?D:f.length,selectedIds:f,trainingData:w,bulkDeleteHandler:x,onDeleteCollection:i,collectionName:n.name,onSelectAll:v,isAllSelected:K,onTableRefresh:j,isFiltered:T,updateRowsHandler:B,isSelectAllActive:K,totalItems:D})));return u?a(u,{onPostUpdate:B},M):M};const x=({settings:o,tabData:n,hasApiKey:s})=>{const l=n||{};const c=l.ai_config||{};c.available_post_types=l.available_post_types||{};c.is_wp_cron_disabled=l.is_wp_cron_disabled||false;const i=l.data_collections||[];const[b,u]=e(i);const h=w();t((()=>{const e=b.map((e=>e.id));h.clearNonExistentCollections(e)}),[]);const[m,f]=e(b.length>0?`collection-${b[0].id}`:"add-new");const k=m.startsWith("collection-")?b.find((e=>`collection-${e.id}`===m)):null;const y=e=>{const t=b.filter((t=>t.id!==e));u(t);setTimeout((()=>{window.location.reload()}),1e3)};const _=o?.has_valid_beta_code||false;const x=c?.ai_disclaimer_accepted==="on";if(!x){const{DisclaimerRequiredMessage:e}=window.EPKB_AI_Util_React||{};if(e){return a(e,{i18n:o?.i18n||{},onAccept:()=>{const e=new URL(window.location.href);if(e.searchParams.has("page")){e.searchParams.set("active_tab","general-settings");window.location.href=e.toString()}}})}}if(!_){const{BetaAccessMessage:e}=window.EPKB_AI_Util_React||{};if(e){return a(e,{i18n:o?.i18n||{},onSignUp:()=>{const e=new URL(window.location.href);if(e.searchParams.has("page")){e.searchParams.set("active_tab","dashboard");window.location.href=e.toString()}}})}}const C=async()=>{const e=l.next_collection_id;if(!e){d(r("Unable to determine next collection ID","echo-knowledge-base"));return}h.clearCollection(e);try{const t=await g("training-collections",{method:"POST",data:{collection_id:e,name:r("Data Collection","echo-knowledge-base")+" "+e}});if(t.success){p(r("Collection created successfully","echo-knowledge-base"));setTimeout((()=>{window.location.reload()}),1e3)}}catch(e){if(!e._errorDisplayed){d(e.message||r("Failed to create collection","echo-knowledge-base"))}}};const v=l.sub_tabs?Object.values(l.sub_tabs):[];if(v.length>0){return a("div",{className:"epkb-ai-training-data-container"},a("div",{className:"epkb-ai-sub-tabs"},a("div",{className:"epkb-ai-sub-tabs-nav"},v.map((e=>a("button",{key:e.id,className:`epkb-ai-sub-tab-button epkb-ai-sub-tab-${e.id} ${m===e.id?"active":""}`,onClick:()=>{if(e.is_add_new){C()}else{f(e.id)}}},e.icon&&a("span",{className:e.icon})," ",e.title))))),k&&a(S,{collection:k,config:c,hasApiKey:s,onDeleteCollection:y}),!k&&a("div",{className:"epkb-ai-empty-state"},a("p",null,r('No collections available. Click "Add New" to create one.',"echo-knowledge-base"))))}return a("div",{className:"epkb-ai-training-data-container"},a("div",{className:"epkb-ai-empty-state"},a("p",null,r("No training data configuration available.","echo-knowledge-base"))))};const C=e=>a(k,null,a(x,e));window.EPKB_AI_TrainingData={AIAdminTrainingData:C}})();