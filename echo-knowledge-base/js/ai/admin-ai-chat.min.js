(function(){"use strict";const{useState:e,useEffect:a,useCallback:s,createElement:t}=wp.element;const{__:n}=wp.i18n;const{showError:i,showSuccess:o,makeApiRequest:l,showLoadingDialog:c,useTableSearch:r,formatServerDateTime:d}=window.EPKB_AI_Util_React||{};const p=e=>{const a=document.createElement("div");a.className="epkb-ai-dialog epkb-ai-loading-dialog";a.style.cssText=`\n\t\t\tposition: fixed;\n\t\t\tbottom: 20px;\n\t\t\tright: 20px;\n\t\t\tbackground: white;\n\t\t\tborder-radius: 8px;\n\t\t\tpadding: 24px;\n\t\t\tmax-width: 350px;\n\t\t\tbox-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);\n\t\t\tz-index: 999999;\n\t\t\tdisplay: flex;\n\t\t\talign-items: center;\n\t\t\tgap: 16px;\n\t\t\tborder: 1px solid #ddd;\n\t\t`;const s=document.createElement("div");s.className="epkb-loading-spinner";s.style.cssText="width: 24px; height: 24px; flex-shrink: 0;";const t=document.createElement("p");t.style.cssText="margin: 0; color: #555; font-size: 14px; line-height: 1.5; font-weight: 500;";t.textContent=e;a.appendChild(s);a.appendChild(t);document.body.appendChild(a);a.offsetHeight;return{close:()=>{a.style.transition="opacity 0.3s ease-out";a.style.opacity="0";setTimeout((()=>a.remove()),300)}}};const b=({conversations:a,selectedId:s,onSelect:i,onDelete:l,isLoading:c,onRefresh:b,onSearch:u,allConversations:h})=>{const[m,g]=e([]);const[k,f]=e(false);const[v,w]=e("desc");const{searchTerm:N,displayedData:_,isSearching:y,searchMessage:x,handleSearchChange:C,clearSearch:S}=r({data:a,allData:h,onServerSearch:u,searchFields:["first_message","conversation","user_name","user"]});const E=[..._].sort(((e,a)=>{const s=new Date(e.time||e.created_at||0);const t=new Date(a.time||a.created_at||0);if(v==="asc"){return s-t}else{return t-s}}));const A=e=>{if(e){g(E.map((e=>e.id)))}else{g([])}};const D=()=>{w(v==="asc"?"desc":"asc")};const I=(e,a)=>{if(a){g([...m,e])}else{g(m.filter((a=>a!==e)))}};const R=async()=>{if(m.length===0)return;const{showConfirmDialog:e}=window.EPKB_AI_Util_React||{};if(!e){if(!confirm(n("Are you sure you want to delete the selected conversations?","echo-knowledge-base"))){return}}else{const a=await e({title:n("Delete Conversations","echo-knowledge-base"),message:n("Are you sure you want to delete the selected conversations?","echo-knowledge-base"),confirmText:n("Delete","echo-knowledge-base"),cancelText:n("Cancel","echo-knowledge-base"),confirmButtonClass:"epkb-ai-button-destructive"});if(!a){return}}const a=p(n("Deleting conversations...","echo-knowledge-base"));m.forEach((e=>{const a=document.getElementById(`chat-row-${e}`);if(a){a.style.opacity="0.5";a.style.transition="opacity 0.3s ease"}}));try{await l(m);g([])}catch(e){m.forEach((e=>{const a=document.getElementById(`chat-row-${e}`);if(a){a.style.opacity="1"}}));throw e}finally{if(a){a.close()}}};const P=async()=>{f(true);await b();f(false);o(n("Conversations refreshed successfully","echo-knowledge-base"))};return t("div",{className:"epkb-ai-data-source-table"},t("div",{className:"epkb-ai-table-content"},t("div",{className:"epkb-submissions-table-container"},t("div",{className:"epkb-table-filter-container"},t("div",{className:"epkb-ai-search-input"},t("input",{type:"text",placeholder:n("Search conversations...","echo-knowledge-base"),value:N,onChange:e=>C(e.target.value)}),t("span",{className:"epkb-ai-search-icon epkbfa epkbfa-search"})),t("button",{className:"epkb-ai-button epkb-ai-button-success",onClick:P,disabled:c||k,style:{backgroundColor:"#46b450",borderColor:"#46b450",color:"#fff",padding:"6px 12px",fontSize:"14px",marginRight:m.length>0?"10px":"0"}},k?n("Refreshing...","echo-knowledge-base"):t("span",null,t("span",{className:"epkbfa epkbfa-refresh",style:{marginRight:"5px"}}),n("Refresh","echo-knowledge-base"))),m.length>0&&t("button",{className:"epkb-ai-button epkb-ai-button-destructive",onClick:R},n("Delete Selected","echo-knowledge-base"))),c?t("div",{className:"epkb-ai-loading"},t("div",{className:"epkb-loading-spinner"}),t("p",null,n("Loading conversations...","echo-knowledge-base"))):E.length===0&&!N?t("div",{className:"epkb-ai-no-data"},t("p",null,n("No conversations found","echo-knowledge-base"))):t("table",{id:"epkb-chat-conversations-table"},t("thead",null,t("tr",null,t("th",null,t("input",{type:"checkbox",checked:m.length===E.length&&E.length>0,onChange:e=>A(e.target.checked)})),t("th",{"data-column":"time",style:{cursor:"pointer",userSelect:"none"},onClick:D},t("span",null,n("Time","echo-knowledge-base")," ",v==="asc"?"↑":"↓")),t("th",{"data-column":"user"},n("User","echo-knowledge-base")),t("th",{"data-column":"conversation"},n("Conversation","echo-knowledge-base")))),t("tbody",null,E.map((e=>t("tr",{key:e.id,id:`chat-row-${e.id}`,className:s===e.id?"selected":"",onClick:()=>i(e.id)},t("td",null,t("input",{type:"checkbox",checked:m.includes(e.id),onChange:a=>I(e.id,a.target.checked),onClick:e=>e.stopPropagation()})),t("td",null,d?d(e.time||e.created_at,"-"):e.time||e.created_at||"-"),t("td",null,e.user_id&&e.user_id>0?t("a",{href:`user-edit.php?user_id=${e.user_id}`,target:"_blank",rel:"noopener noreferrer",style:{textDecoration:"none"}},e.user||e.user_name):e.user||e.user_name),t("td",null,e.conversation||e.first_message||"")))))),(x||y)&&t("div",{className:"epkb-ai-search-message",style:{textAlign:"center",padding:"10px",color:"#666",fontStyle:"italic"}},y?n("Searching server for more results...","echo-knowledge-base"):x))))};const u=({conversation:e})=>{if(!e){return t("div",{className:"epkb-ai-data-source-settings"},t("div",{className:"epkb-ai-action-content"},t("div",{className:"epkb-ai-no-selection"},t("p",null,n("Select a conversation to view details","echo-knowledge-base")))))}return t("div",{className:"epkb-ai-data-source-settings"},t("div",{className:"epkb-ai-discussion-details-content"},t("div",{className:"epkb-ai-conversation-messages"},t("div",{className:"epkb-ai-conversation-meta"},t("h4",null,n("Conversation Info","echo-knowledge-base")),t("div",{className:"epkb-ai-meta-item"},t("span",{className:"epkb-ai-meta-label"},n("User:","echo-knowledge-base")),t("span",{className:"epkb-ai-meta-value"},e.user_id&&e.user_id>0?t("a",{href:`user-edit.php?user_id=${e.user_id}`,target:"_blank",rel:"noopener noreferrer"},e.user||"Guest"):e.user||"Guest")),t("div",{className:"epkb-ai-meta-item"},t("span",{className:"epkb-ai-meta-label"},n("Started:","echo-knowledge-base")),t("span",{className:"epkb-ai-meta-value"},d?d(e.time,"-"):e.time||"-")),t("div",{className:"epkb-ai-meta-item"},t("span",{className:"epkb-ai-meta-label"},n("Messages:","echo-knowledge-base")),t("span",{className:"epkb-ai-meta-value"},e.message_count||0)),t("div",{className:"epkb-ai-meta-item"},t("span",{className:"epkb-ai-meta-label"},n("Status:","echo-knowledge-base")),t("span",{className:"epkb-ai-meta-value"},e.status||"answered")),e.rating>0&&t("div",{className:"epkb-ai-meta-item"},t("span",{className:"epkb-ai-meta-label"},n("Rating:","echo-knowledge-base")),t("span",{className:"epkb-ai-meta-value"},e.rating+"/5"))),t("div",{className:"epkb-ai-conversation-thread"},t("h4",null,n("Full Conversation","echo-knowledge-base")),e.messages&&e.messages.length>0?t("div",{className:"epkb-ai-messages-list"},e.messages.map(((e,a)=>t("div",{key:a,className:`epkb-ai-message epkb-ai-message-${e.role}`},t("div",{className:"epkb-ai-message-header"},t("span",{className:"epkb-ai-message-role"},e.role==="user"?n("User","echo-knowledge-base"):n("AI Assistant","echo-knowledge-base")),e.timestamp&&t("span",{className:"epkb-ai-message-time"},e.timestamp)),t("div",{className:"epkb-ai-message-content"},e.content))))):t("div",{className:"epkb-ai-no-messages"},t("p",null,n("No messages in this conversation.","echo-knowledge-base")))))))};const h=({settings:e,onChange:a,onSave:s,isSaving:i})=>{const o=(s,n)=>{const i=e.hasOwnProperty(s)?e[s]:n.value||"";switch(n.type){case"toggle":return t("div",{className:"epkb-ai-field epkb-ai-field-toggle"},t("label",{className:"epkb-ai-toggle-label"},t("input",{type:"checkbox",checked:i==="on",onChange:e=>a(s,e.target.checked?"on":"off")}),t("span",{className:"epkb-ai-toggle-text"},n.label)),n.description&&t("p",{className:"epkb-ai-field-description"},n.description));case"password":return t("div",{className:"epkb-ai-field epkb-ai-field-password"},t("label",{className:"epkb-ai-field-label"},n.label),t("input",{type:"password",className:"epkb-ai-input",value:i||"",onChange:e=>a(s,e.target.value),placeholder:n.placeholder}),n.description&&t("p",{className:"epkb-ai-field-description"},n.description));case"text":return t("div",{className:"epkb-ai-field epkb-ai-field-text"},t("label",{className:"epkb-ai-field-label"},n.label),t("input",{type:"text",className:"epkb-ai-input",value:i||"",onChange:e=>a(s,e.target.value),placeholder:n.placeholder}),n.description&&t("p",{className:"epkb-ai-field-description"},n.description));case"textarea":return t("div",{className:"epkb-ai-textarea-field"},t("label",null,n.label),t("textarea",{value:i,onChange:e=>a(s,e.target.value),rows:n.rows||3,placeholder:n.placeholder}),n.description&&t("p",{className:"epkb-ai-field-description"},n.description));case"number":return t("div",{className:"epkb-ai-field epkb-ai-field-number"},t("label",{className:"epkb-ai-field-label"},n.label),t("input",{type:"number",className:"epkb-ai-input",value:i,onChange:e=>a(s,e.target.value),min:n.min,max:n.max,step:n.step}),n.description&&t("p",{className:"epkb-ai-field-description"},n.description));case"select":return t("div",{className:"epkb-ai-field epkb-ai-field-select"},t("label",{className:"epkb-ai-field-label"},n.label),t("select",{className:"epkb-ai-select",value:i,onChange:e=>a(s,e.target.value)},Object.entries(n.options).map((([e,a])=>t("option",{key:e,value:e},a)))),n.description&&t("p",{className:"epkb-ai-field-description"},n.description));default:return null}};return t("div",{className:"epkb-ai-settings"},Object.entries(e.sections||{}).map((([e,a])=>t("div",{key:e,className:"epkb-ai-settings-section"},t("div",{className:"epkb-ai-section-header"},a.icon&&t("span",{className:a.icon}),t("div",{className:"epkb-ai-header-text"},t("h3",null,a.title))),t("div",{className:"epkb-ai-section-content"},Object.entries(a.fields||{}).map((([e,a])=>t("div",{key:e,className:"epkb-ai-field-row"},o(e,a)))))))),t("div",{className:"epkb-ai-settings-actions"},t("button",{className:"epkb-ai-button epkb-ai-button-primary",onClick:s,disabled:i},i?n("Saving...","echo-knowledge-base"):n("Save Settings","echo-knowledge-base"))))};const m=({settings:i,tabData:o,isLoading:l,onDataChange:c,makeApiRequest:r,showError:d,showSuccess:p})=>{const[m,g]=e("chat-history");const[k,f]=e(null);const[v,w]=e([]);const[N,_]=e(null);const[y,x]=e(false);const[C,S]=e(false);const[E,A]=e(o?.ai_config||{});const[D,I]=e(false);const[R,P]=e(false);a((()=>{if(o){w([]);if(o.ai_config){A(o.ai_config)}}}),[o]);const T=s((async()=>{P(true);try{const e=await r("ai-chat/conversations",{method:"GET",params:{kb_id:i?.kb_id||1,per_page:100}});if(e&&e.conversations){let a=[...e.conversations];const s=e.pagination?.total_pages||1;for(let e=2;e<=s;e++){const s=await r("ai-chat/conversations",{method:"GET",params:{kb_id:i?.kb_id||1,page:e,per_page:100}});if(s&&s.conversations){a=[...a,...s.conversations]}}_(a);return a}}catch(e){console.error("Failed to fetch all conversations for filtering:",e);throw e}finally{P(false)}return[]}),[r,i?.kb_id]);const U=s((async e=>{if(!e)return null;if(R)return null;if(N&&N.length>0){return N}try{const e=await T();return e}catch(e){console.error("Server search failed:",e);return null}}),[T,R,N]);const B=async()=>{if(!r){console.warn("makeApiRequest not available yet");return Promise.resolve([])}if(E.ai_chat_enabled!=="on"){console.log("AI Chat is disabled, skipping API call");w([]);_(null);I(true);return Promise.resolve([])}x(true);try{const e=await r("ai-chat/conversations",{method:"GET",params:{kb_id:i?.kb_id||1,per_page:20}});if(e&&e.conversations){w(e.conversations);I(true);_(null);return e.conversations}else{console.error("No conversations found in response");w([]);I(true);_(null);return[]}}catch(e){d(e.message||n("Failed to load conversations","echo-knowledge-base"));throw e}finally{x(false)}};a((()=>{if(m==="chat-history"&&!D){B()}}),[m,D,i?.kb_id,r]);a((()=>()=>{I(false);w([]);_(null);f(null)}),[]);const L=i?.has_valid_beta_code||false;const $=o?.ai_config?.ai_disclaimer_accepted==="on";const F=(e,a)=>{A((s=>({...s,[e]:a})))};const G=async()=>{S(true);try{const e={ai_chat_enabled:E.ai_chat_enabled,ai_chat_model:E.ai_chat_model,ai_chat_instructions:E.ai_chat_instructions};const a=await r("ai/settings",{method:"POST",data:{settings:e}});if(a.success){p(n("Settings saved successfully","echo-knowledge-base"));c({ai_config:E})}}catch(e){d(e.message||n("Failed to save settings","echo-knowledge-base"))}finally{S(false)}};const O=async e=>{try{const a=await r("ai-chat/conversations/bulk",{method:"DELETE",data:{ids:e}});const s=a.success||a===true||typeof a==="string"&&a.includes("deleted successfully")||a.message&&a.message.includes("deleted successfully");if(s){const s=typeof a==="string"?a:a.message||n("Conversations deleted successfully","echo-knowledge-base");p(s);w((a=>a.filter((a=>!e.includes(a.id)))));_((a=>a?a.filter((a=>!e.includes(a.id))):null));if(e.includes(k)){f(null)}}else{throw new Error(a.message||a||n("Failed to delete conversations","echo-knowledge-base"))}}catch(e){d(e.message||n("Failed to delete conversations","echo-knowledge-base"));throw e}};const K=v.find((e=>e.id===k));const j=[{id:"chat-history",title:n("Chat History","echo-knowledge-base")},{id:"chat-settings",title:n("Settings","echo-knowledge-base")}];const q=o?.sub_tabs?Object.values(o.sub_tabs):j;if(!$){const{DisclaimerRequiredMessage:e}=window.EPKB_AI_Util_React||{};if(e){return t(e,{i18n:i?.i18n||{},onAccept:()=>{const e=new URL(window.location.href);if(e.searchParams.has("page")){e.searchParams.set("active_tab","general-settings");window.location.href=e.toString()}}})}}if(!L){const{BetaAccessMessage:e}=window.EPKB_AI_Util_React||{};if(e){return t(e,{i18n:i?.i18n||{},onSignUp:()=>{const e=new URL(window.location.href);if(e.searchParams.has("page")){e.searchParams.set("active_tab","dashboard");window.location.href=e.toString()}}})}}const M=()=>{switch(m){case"chat-history":if(E.ai_chat_enabled!=="on"){return t("div",{className:"epkb-ai-disabled-message"},t("div",{className:"epkb-ai-notice epkb-ai-notice-warning"},t("h3",null,n("AI Chat is Disabled","echo-knowledge-base")),t("p",null,n("To view chat history, please enable AI Chat in the Settings tab.","echo-knowledge-base")),t("button",{className:"epkb-ai-button epkb-ai-button-primary",onClick:()=>g("chat-settings")},n("Go to Settings","echo-knowledge-base"))))}return t("div",{className:"epkb-ai-data-source-layout"},t(b,{conversations:v,allConversations:N,selectedId:k,onSelect:f,onDelete:O,isLoading:y,onRefresh:()=>B(),onSearch:U}),t(u,{conversation:K}));case"chat-settings":return t(h,{settings:{...E,sections:o?.settings_sections||{api_config:{title:n("API Configuration","echo-knowledge-base"),icon:"epkbfa epkbfa-cog",fields:{}}}},onChange:F,onSave:G,isSaving:C});default:return null}};return t("div",{className:"epkb-ai-chat-container"},q.length>0&&t("div",{className:"epkb-ai-sub-tabs"},t("div",{className:"epkb-ai-sub-tabs-nav"},q.map((e=>t("button",{key:e.id,className:`epkb-ai-sub-tab-button epkb-ai-sub-tab-${e.id} ${m===e.id?"active":""}`,onClick:()=>g(e.id)},e.title))))),M())};window.EPKB_AI_Chat={AIAdminChat:m}})();