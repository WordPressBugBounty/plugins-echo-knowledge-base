(function(){"use strict";const{useState:e,useEffect:a,useCallback:t,createElement:s}=wp.element;const{__:n}=wp.i18n;const{showError:i,showSuccess:o,makeApiRequest:c,showLoadingDialog:l,useTableSearch:r,formatServerDateTime:d}=window.EPKB_AI_Util_React||{};const{logError:p}=window.EPKBChatUtils||{};const b=e=>{const a=document.createElement("div");a.className="epkb-ai-dialog epkb-ai-loading-dialog";a.style.cssText=`\n\t\t\tposition: fixed;\n\t\t\tbottom: 20px;\n\t\t\tright: 20px;\n\t\t\tbackground: white;\n\t\t\tborder-radius: 8px;\n\t\t\tpadding: 24px;\n\t\t\tmax-width: 350px;\n\t\t\tbox-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);\n\t\t\tz-index: 999999;\n\t\t\tdisplay: flex;\n\t\t\talign-items: center;\n\t\t\tgap: 16px;\n\t\t\tborder: 1px solid #ddd;\n\t\t`;const t=document.createElement("div");t.className="epkb-loading-spinner";t.style.cssText="width: 24px; height: 24px; flex-shrink: 0;";const s=document.createElement("p");s.style.cssText="margin: 0; color: #555; font-size: 14px; line-height: 1.5; font-weight: 500;";s.textContent=e;a.appendChild(t);a.appendChild(s);document.body.appendChild(a);a.offsetHeight;return{close:()=>{a.style.transition="opacity 0.3s ease-out";a.style.opacity="0";setTimeout((()=>a.remove()),300)}}};const u=({conversations:a,selectedId:t,onSelect:i,onDelete:c,isLoading:l,onRefresh:p,onSearch:u,allConversations:m})=>{const[h,g]=e([]);const[k,f]=e(false);const[v,w]=e("desc");const{searchTerm:_,displayedData:N,isSearching:y,searchMessage:C,handleSearchChange:x,clearSearch:S}=r({data:a,allData:m,onServerSearch:u,searchFields:["first_message","conversation","user_name","user"]});const A=[...N].sort(((e,a)=>{const t=new Date(e.time||e.created_at||0);const s=new Date(a.time||a.created_at||0);if(v==="asc"){return t-s}else{return s-t}}));const E=e=>{if(e){g(A.map((e=>e.id)))}else{g([])}};const D=()=>{w(v==="asc"?"desc":"asc")};const I=(e,a)=>{if(a){g([...h,e])}else{g(h.filter((a=>a!==e)))}};const P=async()=>{if(h.length===0)return;const{showConfirmDialog:e}=window.EPKB_AI_Util_React||{};if(!e){if(!confirm(n("Are you sure you want to delete the selected conversations?","echo-knowledge-base"))){return}}else{const a=await e({title:n("Delete Conversations","echo-knowledge-base"),message:n("Are you sure you want to delete the selected conversations?","echo-knowledge-base"),confirmText:n("Delete","echo-knowledge-base"),cancelText:n("Cancel","echo-knowledge-base"),confirmButtonClass:"epkb-ai-button-destructive"});if(!a){return}}const a=b(n("Deleting conversations...","echo-knowledge-base"));h.forEach((e=>{const a=document.getElementById(`chat-row-${e}`);if(a){a.style.opacity="0.5";a.style.transition="opacity 0.3s ease"}}));try{await c(h);g([])}catch(e){h.forEach((e=>{const a=document.getElementById(`chat-row-${e}`);if(a){a.style.opacity="1"}}));throw e}finally{if(a){a.close()}}};const T=async()=>{f(true);await p();f(false);o(n("Conversations refreshed successfully","echo-knowledge-base"))};return s("div",{className:"epkb-ai-data-source-table"},s("div",{className:"epkb-ai-table-content"},s("div",{className:"epkb-submissions-table-container"},s("div",{className:"epkb-table-filter-container"},s("div",{className:"epkb-ai-search-input"},s("input",{type:"text",placeholder:n("Search conversations...","echo-knowledge-base"),value:_,onChange:e=>x(e.target.value)}),s("span",{className:"epkb-ai-search-icon epkbfa epkbfa-search"})),s("button",{className:"epkb-ai-button epkb-ai-button-success",onClick:T,disabled:l||k,style:{backgroundColor:"#46b450",borderColor:"#46b450",color:"#fff",padding:"6px 12px",fontSize:"14px",marginRight:h.length>0?"10px":"0"}},k?n("Refreshing...","echo-knowledge-base"):s("span",null,s("span",{className:"epkbfa epkbfa-refresh",style:{marginRight:"5px"}}),n("Refresh","echo-knowledge-base"))),h.length>0&&s("button",{className:"epkb-ai-button epkb-ai-button-destructive",onClick:P},n("Delete Selected","echo-knowledge-base"))),l?s("div",{className:"epkb-ai-loading"},s("div",{className:"epkb-loading-spinner"}),s("p",null,n("Loading conversations...","echo-knowledge-base"))):A.length===0&&!_?s("div",{className:"epkb-ai-no-data"},s("p",null,n("No conversations found","echo-knowledge-base"))):s("table",{id:"epkb-chat-conversations-table"},s("thead",null,s("tr",null,s("th",null,s("input",{type:"checkbox",checked:h.length===A.length&&A.length>0,onChange:e=>E(e.target.checked)})),s("th",{"data-column":"time",style:{cursor:"pointer",userSelect:"none"},onClick:D},s("span",null,n("Time","echo-knowledge-base")," ",v==="asc"?"↑":"↓")),s("th",{"data-column":"user"},n("User","echo-knowledge-base")),s("th",{"data-column":"conversation"},n("Conversation","echo-knowledge-base")))),s("tbody",null,A.map((e=>s("tr",{key:e.id,id:`chat-row-${e.id}`,className:t===e.id?"selected":"",onClick:()=>i(e.id)},s("td",null,s("input",{type:"checkbox",checked:h.includes(e.id),onChange:a=>I(e.id,a.target.checked),onClick:e=>e.stopPropagation()})),s("td",null,d?d(e.time||e.created_at,"-"):e.time||e.created_at||"-"),s("td",null,e.user_id&&e.user_id>0?s("a",{href:`user-edit.php?user_id=${e.user_id}`,target:"_blank",rel:"noopener noreferrer",style:{textDecoration:"none"}},e.user||e.user_name):e.user||e.user_name),s("td",null,e.conversation||e.first_message||"")))))),(C||y)&&s("div",{className:"epkb-ai-search-message",style:{textAlign:"center",padding:"10px",color:"#666",fontStyle:"italic"}},y?n("Searching server for more results...","echo-knowledge-base"):C))))};const m=({conversation:e})=>{if(!e){return s("div",{className:"epkb-ai-data-source-settings"},s("h3",{className:"epkb-ai-data-source-heading"},n("Conversation Details","echo-knowledge-base")),s("div",{className:"epkb-ai-action-content"},s("div",{className:"epkb-ai-no-selection"},s("p",null,n("Select a conversation to view details","echo-knowledge-base")))))}return s("div",{className:"epkb-ai-data-source-settings"},s("h3",{className:"epkb-ai-data-source-heading"},n("Conversation Details","echo-knowledge-base")),s("div",{className:"epkb-ai-discussion-details-content"},s("div",{className:"epkb-ai-conversation-messages"},s("div",{className:"epkb-ai-conversation-meta"},s("h4",null,n("Conversation Info","echo-knowledge-base")),s("div",{className:"epkb-ai-meta-item"},s("span",{className:"epkb-ai-meta-label"},n("User:","echo-knowledge-base")),s("span",{className:"epkb-ai-meta-value"},e.user_id&&e.user_id>0?s("a",{href:`user-edit.php?user_id=${e.user_id}`,target:"_blank",rel:"noopener noreferrer"},e.user||"Guest"):e.user||"Guest")),s("div",{className:"epkb-ai-meta-item"},s("span",{className:"epkb-ai-meta-label"},n("Started:","echo-knowledge-base")),s("span",{className:"epkb-ai-meta-value"},d?d(e.time,"-"):e.time||"-")),s("div",{className:"epkb-ai-meta-item"},s("span",{className:"epkb-ai-meta-label"},n("Messages:","echo-knowledge-base")),s("span",{className:"epkb-ai-meta-value"},e.message_count||0)),s("div",{className:"epkb-ai-meta-item"},s("span",{className:"epkb-ai-meta-label"},n("Status:","echo-knowledge-base")),s("span",{className:"epkb-ai-meta-value"},e.status||"answered")),e.rating>0&&s("div",{className:"epkb-ai-meta-item"},s("span",{className:"epkb-ai-meta-label"},n("Rating:","echo-knowledge-base")),s("span",{className:"epkb-ai-meta-value"},e.rating+"/5"))),s("div",{className:"epkb-ai-conversation-thread"},s("h4",null,n("Full Conversation","echo-knowledge-base")),e.messages&&e.messages.length>0?s("div",{className:"epkb-ai-messages-list"},e.messages.map(((e,a)=>s("div",{key:a,className:`epkb-ai-message epkb-ai-message-${e.role}`},s("div",{className:"epkb-ai-message-header"},s("span",{className:"epkb-ai-message-role"},e.role==="user"?n("User","echo-knowledge-base"):n("AI Assistant","echo-knowledge-base")),e.timestamp&&s("span",{className:"epkb-ai-message-time"},d?d(e.timestamp,""):e.timestamp)),s("div",{className:"epkb-ai-message-bubble"},s("div",{className:"epkb-ai-message-content"},e.content)))))):s("div",{className:"epkb-ai-no-messages"},s("p",null,n("No messages in this conversation.","echo-knowledge-base")))))))};const h=({field:t,fieldName:n,value:i,onChange:o,onPresetChange:c})=>{const[l,r]=e(false);a((()=>{const e=e=>{if(!e.target.closest(".epkb-ai-custom-dropdown")){r(false)}};const a=document.querySelector(".epkb-ai-behavior-preset-select");const t=a?a.closest(".epkb-ai-settings-section"):null;if(t){if(l){t.classList.add("epkb-has-dropdown-open")}else{t.classList.remove("epkb-has-dropdown-open")}}if(l){document.addEventListener("click",e);return()=>{document.removeEventListener("click",e);if(t){t.classList.remove("epkb-has-dropdown-open")}}}}),[l]);const d=e=>{const a=e.split(" - ");if(a.length===2){return{name:a[0].trim(),description:a[1].trim()}}return{name:e,description:""}};const p=t.options[i]||"";const b=d(p);return s("div",{className:"epkb-ai-field epkb-ai-field-select epkb-ai-behavior-preset-select"},s("label",{className:"epkb-ai-field-label"},t.label),s("div",{className:"epkb-ai-custom-dropdown"},s("div",{className:"epkb-ai-dropdown-trigger",onClick:()=>r(!l)},s("span",{className:"epkb-ai-dropdown-value"},b.name),s("span",{className:"epkb-ai-dropdown-arrow"},l?"▲":"▼")),l&&s("div",{className:"epkb-ai-dropdown-menu"},Object.entries(t.options).map((([e,a])=>{const t=d(a);return s("div",{key:e,className:"epkb-ai-dropdown-option"+(i===e?" selected":""),onClick:()=>{o(n,e);if(c){c(e)}r(false)}},s("div",{className:"epkb-ai-option-name"},t.name),t.description&&s("div",{className:"epkb-ai-option-description"},t.description))})))),t.description&&s("p",{className:"epkb-ai-field-description"},t.description))};const g=({settings:e,onChange:a,onSave:t,isSaving:i,onPresetChange:o})=>{const c=(t,i)=>{const c=e.hasOwnProperty(t)?e[t]:i.value||"";switch(i.type){case"toggle":return s("div",{className:"epkb-ai-field epkb-ai-field-toggle"},s("label",{className:"epkb-ai-toggle-label"},s("input",{type:"checkbox",checked:c==="on",onChange:e=>a(t,e.target.checked?"on":"off")}),s("span",{className:"epkb-ai-toggle-text"},i.label)),i.description&&s("p",{className:"epkb-ai-field-description"},i.description));case"password":return s("div",{className:"epkb-ai-field epkb-ai-field-password"},s("label",{className:"epkb-ai-field-label"},i.label),s("input",{type:"password",className:"epkb-ai-input",value:c||"",onChange:e=>a(t,e.target.value),placeholder:i.placeholder}),i.description&&s("p",{className:"epkb-ai-field-description"},i.description));case"text":return s("div",{className:"epkb-ai-field epkb-ai-field-text"},s("label",{className:"epkb-ai-field-label"},i.label),s("input",{type:"text",className:"epkb-ai-input",value:c||"",onChange:e=>a(t,e.target.value),placeholder:i.placeholder}),i.description&&s("p",{className:"epkb-ai-field-description"},i.description));case"textarea":return s("div",{className:"epkb-ai-textarea-field"},s("div",{className:"epkb-ai-textarea-header"},s("label",null,i.label),i.show_reset&&s("button",{type:"button",className:"epkb-ai-reset-button",onClick:async()=>{if(i.default){const{showConfirmDialog:e}=window.EPKB_AI_Util_React||{};if(!e){if(confirm(n("Are you sure you want to reset to default instructions?","echo-knowledge-base"))){a(t,i.default)}}else{const s=await e({title:n("Reset Instructions","echo-knowledge-base"),message:n("Are you sure you want to reset to default instructions? Your custom instructions will be lost.","echo-knowledge-base"),confirmText:n("Reset","echo-knowledge-base"),cancelText:n("Cancel","echo-knowledge-base"),confirmButtonClass:"epkb-ai-button-destructive"});if(s){a(t,i.default)}}}}},n("Reset to Default","echo-knowledge-base"))),s("textarea",{value:c,onChange:e=>a(t,e.target.value),rows:i.rows||3,placeholder:i.placeholder}),i.description&&s("p",{className:"epkb-ai-field-description"},i.description));case"number":return s("div",{className:"epkb-ai-field epkb-ai-field-number"},s("label",{className:"epkb-ai-field-label"},i.label),s("input",{type:"number",className:"epkb-ai-input",value:c,onChange:e=>a(t,e.target.value),min:i.min,max:i.max,step:i.step}),i.description&&s("p",{className:"epkb-ai-field-description"},i.description));case"select":if(i.field_class&&i.field_class.includes("epkb-ai-behavior-preset-select")){return s(h,{field:i,fieldName:t,value:c,onChange:a,onPresetChange:o})}return s("div",{className:"epkb-ai-field epkb-ai-field-select"+(i.field_class?" "+i.field_class:"")},s("label",{className:"epkb-ai-field-label"},i.label),s("select",{className:"epkb-ai-select",value:c,onChange:e=>a(t,e.target.value)},Object.entries(i.options).map((([e,a])=>s("option",{key:e,value:e},a)))),i.description&&s("p",{className:"epkb-ai-field-description"},i.description));default:return null}};return s("div",{className:"epkb-ai-settings"},Object.entries(e.sections||{}).map((([e,a])=>s("div",{key:e,className:"epkb-ai-settings-section"},s("div",{className:"epkb-ai-section-header"},a.icon&&s("span",{className:a.icon}),s("div",{className:"epkb-ai-header-text"},s("h3",null,a.title))),s("div",{className:"epkb-ai-section-content"},Object.entries(a.fields||{}).map((([e,a])=>s("div",{key:e,className:"epkb-ai-field-row"},c(e,a)))))))),s("div",{className:"epkb-ai-settings-actions"},s("button",{className:"epkb-ai-button epkb-ai-button-primary",onClick:t,disabled:i},i?n("Saving...","echo-knowledge-base"):n("Save Settings","echo-knowledge-base"))))};const k=({settings:i,tabData:o,isLoading:c,onDataChange:l,makeApiRequest:r,showError:d,showSuccess:b,onTabSwitch:h})=>{const[k,f]=e("chat-history");const[v,w]=e(null);const[_,N]=e([]);const[y,C]=e(null);const[x,S]=e(false);const[A,E]=e(false);const[D,I]=e(o?.ai_config||{});const[P,T]=e(false);const[R,L]=e(false);a((()=>{if(o){N([]);if(o.ai_config){I(o.ai_config)}}}),[o]);const U=t((async()=>{L(true);try{const e=await r("ai-chat/conversations",{method:"GET",params:{kb_id:i?.kb_id||1,per_page:100}});if(e&&e.conversations){let a=[...e.conversations];const t=e.pagination?.total_pages||1;for(let e=2;e<=t;e++){const t=await r("ai-chat/conversations",{method:"GET",params:{kb_id:i?.kb_id||1,page:e,per_page:100}});if(t&&t.conversations){a=[...a,...t.conversations]}}C(a);return a}}catch(e){p("AI Chat Admin","Failed to fetch all conversations for filtering",{message:e.message||"Unknown error"});throw e}finally{L(false)}return[]}),[r,i?.kb_id]);const B=t((async e=>{if(!e)return null;if(R)return null;if(y&&y.length>0){return y}try{const e=await U();return e}catch(e){p("AI Chat Admin","Server search failed",{message:e.message||"Unknown error",searchTerm:searchTerm});return null}}),[U,R,y]);const G=async()=>{if(!r){return Promise.resolve([])}if(D.ai_chat_enabled!=="on"){N([]);C(null);T(true);return Promise.resolve([])}S(true);try{const e=await r("ai-chat/conversations",{method:"GET",params:{kb_id:i?.kb_id||1,per_page:20}});if(e&&e.conversations){N(e.conversations);T(true);C(null);return e.conversations}else{p("AI Chat Admin","No conversations found in response",{response:e});N([]);T(true);C(null);return[]}}catch(e){d(e.message||n("Failed to load conversations","echo-knowledge-base"));throw e}finally{S(false)}};a((()=>{if(k==="chat-history"&&!P){G()}}),[k,P,i?.kb_id,r]);a((()=>()=>{T(false);N([]);C(null);w(null)}),[]);const O=o?.ai_config?.ai_disclaimer_accepted==="on";const $=(e,a)=>{I((t=>({...t,[e]:a})))};const F=e=>{const a=window.epkb_ai_api?.presets?.chat||{};if(e!=="custom"&&a[e]){const t=a[e];I((a=>{const s={...a,ai_chat_preset:e};if(t.model!==undefined)s.ai_chat_model=t.model;if(t.verbosity!==undefined)s.ai_chat_verbosity=t.verbosity;if(t.reasoning!==undefined)s.ai_chat_reasoning=t.reasoning;if(t.temperature!==undefined)s.ai_chat_temperature=t.temperature;if(t.max_output_tokens!==undefined)s.ai_chat_max_output_tokens=t.max_output_tokens;if(t.top_p!==undefined)s.ai_chat_top_p=t.top_p;return s}))}else{I((a=>({...a,ai_chat_preset:e})))}};const K=async()=>{E(true);try{const e={ai_chat_enabled:D.ai_chat_enabled,ai_chat_model:D.ai_chat_model,ai_chat_instructions:D.ai_chat_instructions,ai_chat_verbosity:D.ai_chat_verbosity,ai_chat_reasoning:D.ai_chat_reasoning,ai_chat_temperature:D.ai_chat_temperature,ai_chat_max_output_tokens:D.ai_chat_max_output_tokens,ai_chat_top_p:D.ai_chat_top_p};const a=await r("ai/settings",{method:"POST",data:{settings:e}});if(a.success){b(n("Settings saved successfully","echo-knowledge-base"));l({ai_config:D});setTimeout((()=>{const e=new URL(window.location.href);e.searchParams.set("active_tab","chat");window.location.href=e.toString()}),1e3)}}catch(e){d(e.message||n("Failed to save settings","echo-knowledge-base"))}finally{E(false)}};const j=async e=>{try{const a=await r("ai-chat/conversations/bulk",{method:"DELETE",data:{ids:e}});const t=a.success||a===true||typeof a==="string"&&a.includes("deleted successfully")||a.message&&a.message.includes("deleted successfully");if(t){const t=typeof a==="string"?a:a.message||n("Conversations deleted successfully","echo-knowledge-base");b(t);N((a=>a.filter((a=>!e.includes(a.id)))));C((a=>a?a.filter((a=>!e.includes(a.id))):null));if(e.includes(v)){w(null)}}else{throw new Error(a.message||a||n("Failed to delete conversations","echo-knowledge-base"))}}catch(e){d(e.message||n("Failed to delete conversations","echo-knowledge-base"));throw e}};const q=_.find((e=>e.id===v));const z=[{id:"chat-history",title:n("Chat History","echo-knowledge-base")},{id:"chat-settings",title:n("Settings","echo-knowledge-base")}];const M=o?.sub_tabs?Object.values(o.sub_tabs):z;if(!O){const{DisclaimerRequiredMessage:e}=window.EPKB_AI_Util_React||{};if(e){return s(e,{i18n:i?.i18n||{},onAccept:()=>{if(h){h("general-settings")}else{const e=new URL(window.location.href);if(e.searchParams.has("page")){e.searchParams.set("active_tab","general-settings");window.location.href=e.toString()}}}})}}const H=o?.ai_config?.ai_key&&o.ai_config.ai_key.length>0;const Y=!O||!H;const J=()=>{switch(k){case"chat-history":if(D.ai_chat_enabled!=="on"){return s("div",{className:"epkb-ai-disabled-message"},s("div",{className:"epkb-ai-notice epkb-ai-notice-warning"},s("h3",null,n("AI Chat is Disabled","echo-knowledge-base")),s("p",null,n("To view chat history, please enable AI Chat in the Settings tab.","echo-knowledge-base")),s("button",{className:"epkb-ai-button epkb-ai-button-primary",onClick:()=>f("chat-settings")},n("Go to Settings","echo-knowledge-base"))))}return s("div",{className:"epkb-ai-chat-history-wrapper"},Y&&s("div",{className:"epkb-ai-notice epkb-ai-notice-warning",style:{marginBottom:"20px"}},s("p",null,!H?n("OpenAI API key is not configured. Please configure it in General Settings to use AI Chat features.","echo-knowledge-base"):n("Please accept the data privacy agreement in General Settings to use AI Chat features.","echo-knowledge-base")),s("a",{href:"#",className:"epkb-ai-button epkb-ai-button-small",onClick:e=>{e.preventDefault();const a=new URL(window.location.href);a.searchParams.set("active_tab","general-settings");window.location.href=a.toString()}},n("Go to General Settings","echo-knowledge-base"))),s("div",{className:"epkb-ai-data-source-layout"},s(u,{conversations:_,allConversations:y,selectedId:v,onSelect:w,onDelete:j,isLoading:x,onRefresh:()=>G(),onSearch:B}),s(m,{conversation:q})));case"chat-settings":return s(g,{settings:{...D,sections:o?.settings_sections||{api_config:{title:n("API Configuration","echo-knowledge-base"),icon:"epkbfa epkbfa-cog",fields:{}}}},onChange:$,onSave:K,isSaving:A,onPresetChange:F});default:return null}};return s("div",{className:"epkb-ai-chat-container"},M.length>0&&s("div",{className:"epkb-ai-sub-tabs"},s("div",{className:"epkb-ai-sub-tabs-nav"},M.map((e=>s("button",{key:e.id,className:`epkb-ai-sub-tab-button epkb-ai-sub-tab-${e.id} ${k===e.id?"active":""}`,onClick:()=>f(e.id)},e.title))))),J())};window.EPKB_AI_Chat={AIAdminChat:k}})();