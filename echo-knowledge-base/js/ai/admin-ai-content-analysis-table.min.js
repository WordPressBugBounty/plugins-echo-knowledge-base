(function(){"use strict";const{useState:e,useEffect:a,useCallback:t,createElement:n,Fragment:s,useContext:o,useRef:r,useMemo:l,createRoot:i}=wp.element;const{__:c}=wp.i18n;const{showError:d,showSuccess:u,makeApiRequest:g,showConfirmDialog:p,formatServerDateTime:m,useTableSearch:f,clearAllEPKBSessionStorage:y}=window.EPKB_AI_Util_React||{};const h=()=>{let e=false;let a=[];let t=[];let n=[];let s=null;try{const o=localStorage.getItem("epkb_analysis_batch_state");if(o){s=JSON.parse(o);if((s.status==="running"||s.status==="scheduled")&&!s.failed_at&&s.status!=="failed"&&s.status!=="completed"){e=true}}const r=localStorage.getItem("epkb_analysis_in_progress");if(r){a=JSON.parse(r)}const l=localStorage.getItem("epkb_analysis_completed");if(l){t=JSON.parse(l)}if(e){n=a.filter((e=>!t.includes(e)))}}catch(e){}return{hasActiveBatch:e,inProgressIds:a,completedIds:t,pendingIds:n,batchState:s}};const _=({collectionId:i=1,settings:m={},onSelectedIdsChange:_,onBulkDeleteCallback:b,onSelectAllCallback:v,onTotalItemsChange:z,refreshTrigger:k=0,initialData:A=null,onTrainingDataChange:S=null,isAnalyzing:C=false,onUpdateRowsCallback:w=null})=>{const N=window.EPKB_AI_ContentAnalysisCacheContext?o(window.EPKB_AI_ContentAnalysisCacheContext):null;const T=window.EPKB_AI_ContentAnalysisSyncContext?o(window.EPKB_AI_ContentAnalysisSyncContext):null;const[I,x]=e((()=>{let e=[];if(N){const a=N.get("table_analysisData");if(a&&Array.isArray(a.value)){e=a.value}}if(e.length===0&&A&&A.data){if(A.data.all&&A.data.all.data){e=A.data.all.data}}try{const a="epkb_content_analysis_cache_analysis_results_cache";const t=localStorage.getItem(a);if(t&&e.length>0){const a=JSON.parse(t);const n=a.value||{};const{hasActiveBatch:s,pendingIds:o}=h();e=e.map((e=>{const a=String(e.item_id||e.id);const t=n[a];const r=s&&o.includes(a);let l={...e};if(t){if(t.score!==undefined&&t.score!=="-"&&t.score!=="Analyzing..."){l.score=t.score;l.status=t.status||"analyzed"}if(t.importance!==undefined&&t.importance!=="Analyzing..."){l.importance=t.importance}if(t.scoreComponents&&t.scoreComponents.length>0&&!t.scoreComponents.some((e=>e.value==="Analyzing..."))){l.scoreComponents=t.scoreComponents}if(t.analyzed_at){l.last_analyzed=t.analyzed_at}else if(t.last_analyzed){l.last_analyzed=t.last_analyzed}if(t.error_message){l.error_message=t.error_message}}if(r&&(!t||t.score===undefined||t.score==="-"||t.score==="Analyzing...")){l.score="Analyzing...";l.importance="Analyzing...";l.scoreComponents=[{name:"Tags Usage",value:"Analyzing..."},{name:"Score 2",value:"Analyzing..."},{name:"Score 3",value:"Analyzing..."}];l.status="analyzing";l.last_analyzed="In Progress"}if(!l.scoreComponents){l.scoreComponents=e.scoreComponents||[{name:"Tags Usage",value:"-"},{name:"Score 2",value:"-"},{name:"Score 3",value:"-"}]}return l}))}}catch(a){if(N&&e.length>0){const a=N.get("analysis_results_cache");if(a&&a.value){const t=a.value;let n=false;let s=[];try{const e=h();n=e.hasActiveBatch;s=e.pendingIds}catch(e){}e=e.map((e=>{const a=String(e.item_id||e.id);const o=t[a];const r=n&&s.includes(a);let l={...e};if(o){if(o.score!==undefined&&o.score!=="-"&&o.score!=="Analyzing..."){l.score=o.score;l.status=o.status||"analyzed"}if(o.importance!==undefined&&o.importance!=="Analyzing..."){l.importance=o.importance}if(o.scoreComponents&&o.scoreComponents.length>0&&!o.scoreComponents.some((e=>e.value==="Analyzing..."))){l.scoreComponents=o.scoreComponents}if(o.analyzed_at){l.last_analyzed=o.analyzed_at}else if(o.last_analyzed){l.last_analyzed=o.last_analyzed}if(o.error_message){l.error_message=o.error_message}}if(r&&(!o||o.score===undefined||o.score==="-"||o.score==="Analyzing...")){l.score="Analyzing...";l.importance="Analyzing...";l.scoreComponents=[{name:"Tags Usage",value:"Analyzing..."},{name:"Score 2",value:"Analyzing..."},{name:"Score 3",value:"Analyzing..."}];l.status="analyzing";l.last_analyzed="In Progress"}if(!l.scoreComponents){l.scoreComponents=e.scoreComponents||[{name:"Tags Usage",value:"-"},{name:"Score 2",value:"-"},{name:"Score 3",value:"-"}]}return l}))}}}return e}));const[P,U]=e((()=>{if(N){const e=N.get("analyzed_articles_map");if(e&&e.value){return e.value}}return{}}));const[D,E]=e([]);const[B,$]=e((()=>{if(N){const e=N.get("table_analysisData");if(e&&Array.isArray(e.value)&&e.value.length>0){return false}}return!(A&&A.data&&A.data.all)}));const[R,J]=e((()=>{if(N){const e=N.get("tabDataCache");if(e&&e.value){return e.value}}return{}}));const[M,O]=e(false);const[K,L]=e(null);const[j,F]=e((()=>{if(N){const e=N.get("table_currentPage");return e&&typeof e.value==="number"&&e.value>0?e.value:1}return 1}));const[H,W]=e((()=>{if(N){const e=N.get("table_totalPages");if(e&&typeof e.value==="number"&&e.value>0){return e.value}}if(A&&A.data&&A.data.all&&A.data.all.pagination){return A.data.all.pagination.total_pages}return 1}));const[G,Y]=e(false);const[q,Q]=e(new Set);const V=20;const[X,Z]=e((()=>{if(N){const e=N.get("table_activeStatusTab");return e&&typeof e.value==="string"?e.value:"all"}return"all"}));const[ee,ae]=e((()=>{if(N){const e=N.get("table_sortField");return e&&typeof e.value==="string"?e.value:null}return null}));const[te,ne]=e((()=>{if(N){const e=N.get("table_sortDirection");return e&&(e.value==="asc"||e.value==="desc")?e.value:"asc"}return"asc"}));const[se,oe]=e((()=>{if(N){const e=N.get("table_currentSearchTerm");return e&&typeof e.value==="string"?e.value:""}return""}));a((()=>{if(N){N.set("table_analysisData",I)}}),[I]);a((()=>{if(N){N.set("tabDataCache",R)}}),[R]);a((()=>{if(N){N.set("analyzed_articles_map",P)}}),[P]);a((()=>{if(N){N.set("table_currentPage",j)}}),[j]);a((()=>{if(N){N.set("table_totalPages",H)}}),[H]);a((()=>{if(N){N.set("table_activeStatusTab",X)}}),[X]);a((()=>{if(N){N.set("table_sortField",ee)}}),[ee]);a((()=>{if(N){N.set("table_sortDirection",te)}}),[te]);a((()=>{if(N){N.set("table_currentSearchTerm",se)}}),[se]);const re=t((async e=>{oe(e||"");F(1);return null}),[]);const{searchTerm:le,displayedData:ie,isSearching:ce,searchMessage:de,handleSearchChange:ue,clearSearch:ge}=f({data:I,allData:null,onServerSearch:re,searchFields:["title","score","importance"]});const pe=t((()=>{let e=[...ie];if(ee){e.sort(((e,a)=>{if(X==="to_analyse"&&ee==="importance"){let t=e.importance==="N/A"?0:parseInt(e.importance)||0;let n=a.importance==="N/A"?0:parseInt(a.importance)||0;let s=e.score==="-"?0:parseInt(e.score)||0;let o=a.score==="-"?0:parseInt(a.score)||0;let r=t*(100-s)/100;let l=n*(100-o)/100;if(r!==l){return l-r}if(t!==n){return n-t}return s-o}if(X==="to_improve"&&ee==="importance"){let t=e.importance==="N/A"?0:parseInt(e.importance)||0;let n=a.importance==="N/A"?0:parseInt(a.importance)||0;let s=e.score==="-"?0:parseInt(e.score)||0;let o=a.score==="-"?0:parseInt(a.score)||0;let r=t*(100-s)/100;let l=n*(100-o)/100;if(r!==l){return l-r}if(t!==n){return n-t}return s-o}let t=e[ee];let n=a[ee];if(ee==="score"){t=t==="-"?0:parseInt(t)||0;n=n==="-"?0:parseInt(n)||0}if(ee==="importance"){t=t==="N/A"?-1:parseInt(t)||0;n=n==="N/A"?-1:parseInt(n)||0}if(ee==="last_analyzed"||ee==="updated"){t=new Date(t||0).getTime();n=new Date(n||0).getTime()}if(ee==="display_status"){const e={"To Analyze":1,"To Improve":2,Done:3,Ignored:4};t=e[t]||5;n=e[n]||5}if(t<n)return te==="asc"?-1:1;if(t>n)return te==="asc"?1:-1;return 0}))}return e}),[ie,ee,te,X]);const me=t((()=>{const e=pe();return e}),[pe]);const fe=r(true);const ye=r(false);a((()=>{fe.current=true;ye.current=false;F(1);Z("all");oe("")}),[i]);a((()=>{F(1)}),[X,se]);const he=t((async(e=false)=>{if(!e&&A&&fe.current){$(false);return}const a=`${X}_page_${j}_search_${se||"none"}`;if(!e&&R[a]){const e=R[a];x(e.data);W(e.totalPages);O(false);return}if(!e){try{const e="epkb_content_analysis_cache_analysis_results_cache";const a=localStorage.getItem(e);if(a){const e=JSON.parse(a);const t=e.value||{};if(Object.keys(t).length>0){U((e=>({...e,...t})))}}}catch(e){}}const t=I&&I.length>0;if(X!=="all"||j!==1){O(true)}else if(!t){$(true)}try{const a=await g("content-analysis-articles",{method:"GET",params:{page:j,per_page:V,status:X,search:se||"",kb_id:1}});if(a.success&&a.data){if((!a.data||a.data.length===0)&&I&&I.length>0){$(false);return}let t={};let n=false;let s=[];try{const e="epkb_content_analysis_cache_analysis_results_cache";const a=localStorage.getItem(e);if(a){const e=JSON.parse(a);t=e.value||{};if(Object.keys(t).length>0){U(t)}}const o=h();n=o.hasActiveBatch;s=o.pendingIds}catch(e){}const o=a.data.map((e=>{const a=String(e.item_id||e.id);const o=t[a];const r=P[a];let l=null;if(N){const e=N.get("analysis_results_cache");if(e&&e.value&&e.value[a]){l=e.value[a]}}const i=o||l||r;const c=n&&s.includes(a);let d={...e};if(o&&a===String(e.item_id||e.id)){}if(i){if(i.score!==undefined&&i.score!=="-"&&i.score!=="Analyzing..."){d.score=i.score;d.status=i.status||"analyzed"}if(i.importance!==undefined&&i.importance!=="Analyzing..."){d.importance=i.importance}if(i.scoreComponents&&i.scoreComponents.length>0&&!i.scoreComponents.some((e=>e.value==="Analyzing..."))){d.scoreComponents=i.scoreComponents}else if(!d.scoreComponents){d.scoreComponents=[{name:"Tags Usage",value:"-"},{name:"Score 2",value:"-"},{name:"Score 3",value:"-"}]}if(i.analyzed_at){d.last_analyzed=i.analyzed_at}else if(i.last_analyzed){d.last_analyzed=i.last_analyzed}if(i.error_message){d.error_message=i.error_message}}if(c&&(!i||i.score===undefined||i.score==="-"||i.score==="Analyzing...")){d.score="Analyzing...";d.importance="Analyzing...";d.scoreComponents=[{name:"Score 2",value:"Analyzing..."},{name:"Tags Usage",value:"Analyzing..."},{name:"Score 3",value:"Analyzing..."}];d.status="analyzing";d.last_analyzed="In Progress"}if(!d.scoreComponents){d.scoreComponents=[{name:"Tags Usage",value:"-"},{name:"Tags Usage",value:"-"},{name:"Score 3",value:"-"}]}return d}));x(o);if(a.pagination){W(a.pagination.total_pages)}const r=`${X}_page_${j}_search_${se||"none"}`;if(e||!R[r]){if(X!=="all"||j!==1||se){try{const e=await g("content-analysis-articles",{method:"GET",params:{page:1,per_page:100,status:"all",search:"",kb_id:1}});if(e.success&&e.data){const a=e.data.filter((e=>e.display_status==="To Analyze")).length;const t=e.data.filter((e=>e.display_status==="To Improve")).length;const n=e.pagination?e.pagination.total:e.data.length;L({all:n,to_analyse:a,to_improve:t,recent:n})}}catch(e){}}else{const e=o.filter((e=>e.display_status==="To Analyze")).length;const t=o.filter((e=>e.display_status==="To Improve")).length;const n=a.pagination?a.pagination.total:o.length;L({all:n,to_analyse:e,to_improve:t,recent:n})}}J((e=>({...e,[r]:{data:o,totalPages:a.pagination?a.pagination.total_pages:1,timestamp:Date.now()}})));setTimeout((()=>{ze()}),10);setTimeout((()=>{ze()}),100);setTimeout((()=>{ze()}),300)}}catch(e){if(e.status===404||e.code==="rest_no_route"){if(I&&I.length>0){$(false);return}let e=[];for(let a=0;a<5;a++){if(a===2){e.push({id:100+a,item_id:100+a,title:`Article with Error ${100+a}`,score:"-",importance:"N/A",scoreComponents:[{name:"Tags Usage",value:"-"},{name:"Score 2",value:"-"},{name:"Score 3",value:"-"}],last_analyzed:"Error",updated:"2024-01-01",status:"error",error_message:"Failed to analyze article: Unable to process content due to invalid format or missing data. Please check the article content and try again.",error_code:500})}else{e.push({id:100+a,item_id:100+a,title:`Article ${100+a}`,score:Math.floor(Math.random()*40)+60,importance:Math.floor(Math.random()*50)+50,scoreComponents:[{name:"Tags Usage",value:Math.floor(Math.random()*40)+60},{name:"Score 2",value:Math.floor(Math.random()*40)+60},{name:"Score 3",value:Math.floor(Math.random()*40)+60}],last_analyzed:"Not analyzed",updated:"2024-01-01",status:"not_analyzed"})}}try{const a="epkb_content_analysis_cache_analysis_results_cache";const t=localStorage.getItem(a);if(t){const a=JSON.parse(t);const n=a.value||{};const{hasActiveBatch:s,pendingIds:o}=h();e=e.map((e=>{const a=String(e.item_id||e.id);const t=n[a];const r=s&&o.includes(a);let l={...e};if(t){if(t.score!==undefined&&t.score!=="-"&&t.score!=="Analyzing..."){l.score=t.score;l.status=t.status||"analyzed"}if(t.importance!==undefined&&t.importance!=="Analyzing..."){l.importance=t.importance}if(t.scoreComponents&&t.scoreComponents.length>0&&!t.scoreComponents.some((e=>e.value==="Analyzing..."))){l.scoreComponents=t.scoreComponents}if(t.analyzed_at){l.last_analyzed=t.analyzed_at}else if(t.last_analyzed){l.last_analyzed=t.last_analyzed}if(t.error_message){l.error_message=t.error_message}}if(r&&(!t||t.score===undefined||t.score==="-"||t.score==="Analyzing...")){l.score="Analyzing...";l.importance="Analyzing...";l.scoreComponents=[{name:"Score 2",value:"Analyzing..."},{name:"Tags Usage",value:"Analyzing..."},{name:"Score 3",value:"Analyzing..."}];l.status="analyzing";l.last_analyzed="In Progress"}return l}))}}catch(e){}x(e);W(1);setTimeout((()=>{ze()}),10);setTimeout((()=>{ze()}),100);setTimeout((()=>{ze()}),300)}else{d(c("Failed to fetch analysis data","echo-knowledge-base"))}}finally{$(false);O(false)}}),[j,X,se,V,m,R]);a((()=>{const e=()=>{if(!A||!A.data||ye.current){return false}if(j!==1||se){return false}if(X!=="all"){return false}if(A.data[X]&&A.data[X].data!==undefined){return true}return false};if(e()){let e=A.data[X].data;const a=A.data[X].pagination;try{const a="epkb_content_analysis_cache_analysis_results_cache";const t=localStorage.getItem(a);if(t){const a=JSON.parse(t);const n=a.value||{};const{hasActiveBatch:s,pendingIds:o}=h();e=e.map((e=>{const a=String(e.item_id||e.id);const t=n[a];const r=s&&o.includes(a);let l={...e};if(t){if(t.score!==undefined&&t.score!=="-"&&t.score!=="Analyzing..."){l.score=t.score;l.status=t.status||"analyzed"}if(t.importance!==undefined&&t.importance!=="Analyzing..."){l.importance=t.importance}if(t.scoreComponents&&t.scoreComponents.length>0&&!t.scoreComponents.some((e=>e.value==="Analyzing..."))){l.scoreComponents=t.scoreComponents}else if(!l.scoreComponents){l.scoreComponents=[{name:"Tags Usage",value:"-"},{name:"Score 2",value:"-"},{name:"Score 3",value:"-"}]}if(t.analyzed_at){l.last_analyzed=t.analyzed_at}else if(t.last_analyzed){l.last_analyzed=t.last_analyzed}if(t.error_message){l.error_message=t.error_message}}if(r&&(!t||t.score===undefined||t.score==="-"||t.score==="Analyzing...")){l.score="Analyzing...";l.importance="Analyzing...";l.scoreComponents=[{name:"Tags Usage",value:"Analyzing..."},{name:"Score 2",value:"Analyzing..."},{name:"Score 3",value:"Analyzing..."}];l.status="analyzing";l.last_analyzed="In Progress"}if(!l.scoreComponents){l.scoreComponents=[{name:"Tags Usage",value:"-"},{name:"Score 2",value:"-"},{name:"Score 3",value:"-"}]}return l}))}}catch(e){}x(e);W(a?a.total_pages:1);$(false);fe.current=false;setTimeout((()=>{ze()}),10);setTimeout((()=>{ze()}),100);setTimeout((()=>{ze()}),300)}else{he()}}),[j,X,se,A]);const _e=t((e=>{if(e){if(X!=="to_analyse"){Z("to_analyse");F(1);ae("importance");ne("desc")}const e=I.filter((e=>e.display_status==="To Analyze"));const a=e.map((e=>String(e.item_id||e.id)));E(a)}else{E([])}}),[X,I]);const be=async()=>{Y(true);ye.current=true;J({});L(null);U({});try{const e=localStorage.getItem("epkb_analysis_batch_state");if(e){const a=JSON.parse(e);if(a.status==="completed"||a.status==="failed"){localStorage.removeItem("epkb_analysis_batch_state");localStorage.removeItem("epkb_analysis_in_progress");localStorage.removeItem("epkb_analysis_completed")}}}catch(e){}y();await he(true);Y(false);u(c("Data refreshed successfully","echo-knowledge-base"))};const ve=t((async()=>{if(!D.length)return;const e=await p({title:c("Delete Selected Items","echo-knowledge-base"),message:c("Are you sure you want to delete the selected items?","echo-knowledge-base"),confirmText:c("Delete","echo-knowledge-base"),cancelText:c("Cancel","echo-knowledge-base"),confirmButtonClass:"epkb-ai-button-danger"});if(!e){return}u(c("Items deleted successfully","echo-knowledge-base"));E([])}),[D]);const ze=t((()=>{let e={};try{const a="epkb_content_analysis_cache_analysis_results_cache";const t=localStorage.getItem(a);if(t){const a=JSON.parse(t);if(a.value&&typeof a.value==="object"){e=a.value}else if(typeof a==="object"&&!a.value){e=a}}else{}}catch(e){}const{hasActiveBatch:a,pendingIds:t}=h();if(Object.keys(e).length>0){U(e);if(N){N.set("analysis_results_cache",{value:e,timestamp:Date.now()});N.set("analyzed_articles_map",e)}}x((n=>{if(!n||n.length===0){return n}if(n.length>0){const e=n[0]}let s=0;const o=n.map((n=>{const o=String(n.item_id||n.id);const r=e[o];const l=a&&t.includes(o);let i={...n};let c=false;if(r&&r.score!==undefined&&r.score!=="-"&&r.score!=="Analyzing..."){i.score=r.score;i.status=r.status||"analyzed";c=true;if(r.importance!==undefined&&r.importance!=="Analyzing..."){i.importance=r.importance}if(r.scoreComponents&&r.scoreComponents.length>0&&!r.scoreComponents.some((e=>e.value==="Analyzing..."))){i.scoreComponents=r.scoreComponents}if(r.analyzed_at){i.last_analyzed=r.analyzed_at}if(r.error_message){i.error_message=r.error_message}}if(l&&(!r||r.score===undefined||r.score==="-"||r.score==="Analyzing...")){i.score="Analyzing...";i.importance="Analyzing...";i.scoreComponents=[{name:"Score 2",value:"Analyzing..."},{name:"Tags Usage",value:"Analyzing..."},{name:"Score 3",value:"Analyzing..."}];i.status="analyzing";i.last_analyzed="In Progress";c=true}if(!i.scoreComponents){i.scoreComponents=n.scoreComponents||[{name:"Tags Usage",value:"-"},{name:"Score 2",value:"-"},{name:"Score 3",value:"-"}]}if(c)s++;return i}));if(o.length>0){const e=o[0]}return o}))}),[N,X]);const ke=t((e=>{if(!e||e.length===0)return;U((a=>{const t={...a};e.forEach((e=>{const a=String(e.id);if(e.status==="analyzing"){t[a]={score:"Analyzing...",importance:"Analyzing...",scoreComponents:[{name:"Score 2",value:"Analyzing..."},{name:"Tags Usage",value:"Analyzing..."},{name:"Score 3",value:"Analyzing..."}],status:"analyzing",last_analyzed:e.analyzed_at||"In Progress"}}else if(e.status==="error"){t[a]={score:"-",importance:"N/A",scoreComponents:[{name:"Tags Usage",value:"-"},{name:"Score 2",value:"-"},{name:"Score 3",value:"-"}],status:"error",error_message:e.message||e.error_message,last_analyzed:"Error"}}else if(e.score!==undefined||e.importance!==undefined||e.scoreComponents){t[a]={score:e.score,importance:e.importance,scoreComponents:e.scoreComponents||[{name:"Tags Usage",value:e.tags_usage||"-"},{name:"Score 2",value:"-"},{name:"Score 3",value:"-"}],status:e.status||"analyzed",last_analyzed:e.analyzed_at,analyzed_at:e.analyzed_at}}}));return t}));x((a=>{let t=false;const n=[...a];e.forEach((e=>{const a=String(e.id);const s=n.findIndex((e=>{const t=String(e.item_id)===a;const n=String(e.id)===a;return t||n}));if(s!==-1){const a=n[s];let o=false;const r=a.score!==undefined&&a.score!=="-"&&a.score!=="Analyzing...";if(e.status==="analyzing"){o=true;n[s]={...a,status:"analyzing",score:"Analyzing...",importance:"Analyzing...",scoreComponents:[{name:"Score 2",value:"Analyzing..."},{name:"Tags Usage",value:"Analyzing..."},{name:"Score 3",value:"Analyzing..."}],last_analyzed:e.analyzed_at||"In Progress"}}else if(e.status==="error"){if(a.status!=="error"||a.error_message!==(e.message||e.error_message)){o=true;n[s]={...a,status:"error",error_message:e.message||e.error_message||c("Unknown error occurred","echo-knowledge-base"),score:"-",importance:"N/A",scoreComponents:[{name:"Tags Usage",value:"-"},{name:"Tags Usage",value:"-"},{name:"Score 3",value:"-"}],last_analyzed:"Error"}}}else{const t=e.score!==undefined?e.score:a.score;const r=e.importance!==undefined?e.importance:a.importance;const l=e.status||"analyzed";if(a.status==="analyzing"||a.status!==l||a.score!==t||a.importance!==r||a.last_analyzed==="Not analyzed"||a.last_analyzed==="Never"||a.last_analyzed==="In Progress"||a.last_analyzed==="Queued"||a.last_analyzed==="Processing..."){o=true;n[s]={...a,score:t,importance:r,scoreComponents:e.scoreComponents||a.scoreComponents,last_analyzed:e.analyzed_at||a.last_analyzed,status:l,error_message:undefined}}}if(o){t=true}}}));return t?n:a}));try{const a="epkb_content_analysis_cache_analysis_results_cache";let t={};const n=localStorage.getItem(a);if(n){const e=JSON.parse(n);t=e.value||{}}e.forEach((e=>{const a=String(e.id);if(e.status==="analyzing"){}else if(e.status==="error"){t[a]={id:e.id,score:"-",importance:"N/A",scoreComponents:[{name:"Tags Usage",value:"-"},{name:"Score 2",value:"-"},{name:"Score 3",value:"-"}],status:"error",error_message:e.message||e.error_message,analyzed_at:"Error",cached_at:Date.now()}}else if(e.score!==undefined||e.importance!==undefined){t[a]={id:e.id,score:e.score,importance:e.importance,scoreComponents:e.scoreComponents||[{name:"Tags Usage",value:e.tags_usage||"-"},{name:"Score 2",value:"-"},{name:"Score 3",value:"-"}],status:e.status||"analyzed",analyzed_at:e.analyzed_at,cached_at:Date.now()}}}));localStorage.setItem(a,JSON.stringify({value:t,timestamp:Date.now()}))}catch(e){}}),[]);a((()=>{if(w){w(ke)}}),[w]);a((()=>{const e=async()=>{let e=false;ze();const{hasActiveBatch:a,pendingIds:t,batchState:n}=h();if(a&&n){e=true;if(T&&T.setAnalysisJob){T.setAnalysisJob(n)}if(T&&T.setShowAnalysisProgress){T.setShowAnalysisProgress(true)}}if(a&&t.length>0){x((e=>{if(e.length===0){return e}return e.map((e=>{const a=String(e.item_id||e.id);if(t.includes(a)){return{...e,score:"Analyzing...",importance:"Analyzing...",scoreComponents:[{name:"Score 2",value:"Analyzing..."},{name:"Tags Usage",value:"Analyzing..."},{name:"Score 3",value:"Analyzing..."}],status:"analyzing",last_analyzed:"In Progress"}}return e}))}))}await he(true);if(a&&t.length>0){setTimeout((()=>{const e=t.map((e=>({id:e,status:"analyzing",analyzed_at:"In Progress"})));Ae.current(e)}),200)}};const a=setTimeout(e,100);return()=>clearTimeout(a)}),[]);const Ae=r(ke);a((()=>{Ae.current=ke}),[ke]);a((()=>{if(I&&I.length>0){const e=I.filter((e=>e.score!==undefined&&e.score!=="-"&&e.score!=="Analyzing..."));if(e.length>0){try{const a="epkb_content_analysis_cache_analysis_results_cache";let t={};const n=localStorage.getItem(a);if(n){const e=JSON.parse(n);t=e.value||{}}e.forEach((e=>{const a=String(e.item_id||e.id);t[a]={id:e.item_id||e.id,score:e.score,importance:e.importance,scoreComponents:e.scoreComponents,status:e.status||"analyzed",analyzed_at:e.last_analyzed,cached_at:Date.now()}}));localStorage.setItem(a,JSON.stringify({value:t,timestamp:Date.now()}))}catch(e){}}}}),[I]);a((()=>{if(!window.EPKB_AI_ContentAnalysisTable){window.EPKB_AI_ContentAnalysisTable={}}window.EPKB_AI_ContentAnalysisTable.refreshAllRows=ze;return()=>{if(window.EPKB_AI_ContentAnalysisTable&&window.EPKB_AI_ContentAnalysisTable.refreshAllRows===ze){delete window.EPKB_AI_ContentAnalysisTable.refreshAllRows}}}),[ze]);a((()=>{if(T&&T.registerArticleUpdateHandler){const e=e=>{Ae.current(e);setTimeout((()=>{ze()}),50)};T.registerArticleUpdateHandler(e);return()=>{if(T.unregisterArticleUpdateHandler){T.unregisterArticleUpdateHandler(e)}}}}),[T,ze]);a((()=>{const{hasActiveBatch:e,pendingIds:a}=h();if(e&&a.length>0&&I.length>0){const e=a.map((e=>({id:e,status:"analyzing",analyzed_at:"In Progress"})));Ae.current(e)}if(T&&T.analysisJob){const e=T.analysisJob;if((e.status==="running"||e.status==="scheduled")&&e.total>0){const e=T.analysisItems;if(e&&e.length>0&&I.length>0){const a=e.map((e=>({id:e.id,status:"analyzing",analyzed_at:"In Progress"})));if(a.length>0){Ae.current(a)}}}}}),[T?.analysisJob?.status,I.length]);a((()=>{if(T&&Array.isArray(T.analysisItems)){const e=T.analysisJob;if((e.status==="running"||e.status==="scheduled")&&T.analysisItems.length>0&&I.length>0){const e=T.analysisItems.map((e=>({id:e.id,status:"analyzing",analyzed_at:"In Progress"})));ke(e)}}}),[T?.analysisItems?.length,T?.analysisJob?.status]);a((()=>{if(S&&I){S(I)}}),[I,S]);a((()=>{if(k>0&&!C){ye.current=true;he(true);E([])}}),[k,C]);a((()=>{if(C){J({});L(null);const{hasActiveBatch:e,pendingIds:a}=h();if(e&&a.length>0&&I.length>0){const e=a.map((e=>({id:e,status:"analyzing",analyzed_at:"In Progress"})));Ae.current(e)}}}),[C,I.length]);a((()=>{if(_){const e=pe();let a=null;if(D.length===1){const t=e.find((e=>String(e.item_id||e.id)===D[0]));if(t){a={id:t.item_id||t.id,title:t.title,score:t.score,importance:t.importance,scoreComponents:t.scoreComponents||[{name:"Tags Usage",value:"-"},{name:"Score 2",value:"-"},{name:"Score 3",value:"-"}]}}}const t=[];e.forEach((e=>{const a=String(e.item_id||e.id);if(D.includes(a)){t.push(a)}}));_(t,a)}}),[D,_,ee,te,ie]);a((()=>{if(b&&ve){b((()=>{ve()}))}}),[b,ve]);a((()=>{if(v){v(_e)}}),[v,_e]);const Se=l((()=>I.length),[I]);a((()=>{if(z){z(Se)}}),[Se,z]);const Ce=e=>{const a=String(e);if(D.includes(a)){E(D.filter((e=>e!==a)))}else{E([...D,a])}};const we=e=>{Z(e);F(1);if(e==="to_analyse"){ae("importance");ne("desc")}else if(e==="to_improve"){ae("importance");ne("desc")}else if(e==="recent"){ae("updated");ne("desc")}else{ae("updated");ne("desc")}try{const e="epkb_content_analysis_cache_analysis_results_cache";const a=localStorage.getItem(e);if(a){const e=JSON.parse(a);const t=e.value||{};if(Object.keys(t).length>0){U(t);if(N){N.set("analysis_results_cache",{value:t,timestamp:Date.now()});N.set("analyzed_articles_map",t)}}}}catch(e){}ze();setTimeout((()=>{ze()}),50);setTimeout((()=>{ze()}),200);setTimeout((()=>{ze()}),500)};const Ne=e=>{if(ee===e){ne(te==="asc"?"desc":"asc")}else{ae(e);ne("asc")}};const Te=t((()=>{if(K){return{all:K.all||0,to_analyse:K.to_analyse||0,to_improve:K.to_improve||0,recent:K.recent||0}}if(A&&A.stats){return{all:A.stats.total||0,to_analyse:A.stats.to_analyse||0,to_improve:A.stats.to_improve||0,recent:A.stats.recent||0}}if(X==="all"&&I.length>0){const e=I.filter((e=>e.display_status==="To Analyze")).length;const a=I.filter((e=>e.display_status==="To Improve")).length;return{all:I.length,to_analyse:e,to_improve:a,recent:I.length}}return{all:0,to_analyse:0,to_improve:0,recent:0}}),[I,X,A,K]);if(!B&&I.length===0&&!se&&!G){let e="";let a="";switch(X){case"to_analyse":e=c("No articles need analysis","echo-knowledge-base");a=c("All articles have been analyzed. Great job!","echo-knowledge-base");break;case"to_improve":e=c("No articles need improvement","echo-knowledge-base");a=c("All analyzed articles have scores above 80%. Excellent!","echo-knowledge-base");break;case"recent":e=c("No recent articles","echo-knowledge-base");a=c("No articles have been modified recently.","echo-knowledge-base");break;case"all":default:e=c("No articles found","echo-knowledge-base");a=c("No articles are available in this knowledge base. Create some articles to start analyzing.","echo-knowledge-base");break}return n("div",{className:"epkb-ai-data-source-table"},n("div",{className:"epkb-ai-empty-state"},n("div",{className:"epkb-ai-empty-icon"},n("span",{className:"epkbfa epkbfa-file-text-o"})),n("h4",null,e),n("div",{style:{marginTop:"15px",marginBottom:"15px"}},n("p",null,a)),n("button",{className:"epkb-ai-button epkb-ai-button-success",onClick:be,disabled:G,style:{backgroundColor:"#46b450",borderColor:"#46b450",color:"#fff",padding:"8px 16px",fontSize:"14px",marginTop:"15px"}},G?c("Refreshing...","echo-knowledge-base"):n(s,null,n("span",{className:"epkbfa epkbfa-refresh",style:{marginRight:"5px"}}),c("Refresh","echo-knowledge-base")))))}return n("div",{className:"epkb-ai-data-source-table"},n("div",{className:"epkb-ai-table-content"},n("div",{className:"epkb-ai-table-actions"},n("div",{className:"epkb-ai-table-actions-left"},n("div",{className:"epkb-ai-status-tabs-bar"},(()=>{const e=Te();const a=["all","to_analyse","to_improve","recent"];const t={all:c("All","echo-knowledge-base"),to_analyse:c("To Analyze","echo-knowledge-base"),to_improve:c("To Improve","echo-knowledge-base"),recent:c("Recent","echo-knowledge-base")};return a.map((a=>{const s=e[a]||0;return n("button",{key:a,className:`epkb-ai-status-tab ${a===X?"active":""}`,onClick:()=>{we(a)}},n("span",{className:"epkb-ai-tab-label"},t[a]),n("span",{className:"epkb-ai-tab-count"},`(${s})`))}))})())),n("div",{className:"epkb-ai-table-actions-right"},n("div",{className:"epkb-ai-search-input"},n("input",{type:"text",placeholder:c("Search by title...","echo-knowledge-base"),value:le,onChange:e=>ue(e.target.value)}),n("span",{className:"epkb-ai-search-icon epkbfa epkbfa-search"})),n("button",{className:"epkb-ai-button epkb-ai-button-success",onClick:be,disabled:B||G,style:{backgroundColor:"#46b450",borderColor:"#46b450",color:"#fff",padding:"6px 12px",fontSize:"14px",marginLeft:"10px",marginRight:D.length>0?"15px":"0"}},G?c("Refreshing...","echo-knowledge-base"):n(s,null,n("span",{className:"epkbfa epkbfa-refresh",style:{marginRight:"5px"}}),c("Refresh","echo-knowledge-base"))),D.length>0&&n("span",{className:"epkb-ai-selected-count"},`${D.length} ${c("selected","echo-knowledge-base")}`))),B?n("div",{className:"epkb-ai-loading"},c("Loading content analysis data...","echo-knowledge-base")):n(s,null,n("table",{className:"epkb-ai-data-table"},n("thead",null,n("tr",null,n("th",{className:"epkb-ai-table-checkbox"},n("input",{type:"checkbox",checked:(()=>{const e=me();if(e.length===0)return false;return e.every((e=>D.includes(String(e.item_id||e.id))))})(),onChange:e=>_e(e.target.checked)})),n("th",null,n("div",{className:"epkb-ai-table-header-content"},n("span",null,c("Score","echo-knowledge-base")),n("span",{className:`epkb-ai-sort-arrows ${ee==="score"?"active":""}`,onClick:()=>Ne("score"),title:c("Sort","echo-knowledge-base"),style:{cursor:"pointer",marginLeft:"5px"}},ee==="score"&&te==="asc"?"↑":ee==="score"&&te==="desc"?"↓":"↕"))),n("th",null,n("div",{className:"epkb-ai-table-header-content"},n("span",null,c("Importance","echo-knowledge-base")),n("span",{className:`epkb-ai-sort-arrows ${ee==="importance"?"active":""}`,onClick:()=>Ne("importance"),title:c("Sort","echo-knowledge-base"),style:{cursor:"pointer",marginLeft:"5px"}},ee==="importance"&&te==="asc"?"↑":ee==="importance"&&te==="desc"?"↓":"↕"))),n("th",null,n("div",{className:"epkb-ai-table-header-content"},n("span",null,c("Title","echo-knowledge-base")),n("span",{className:`epkb-ai-sort-arrows ${ee==="title"?"active":""}`,onClick:()=>Ne("title"),title:c("Sort","echo-knowledge-base"),style:{cursor:"pointer",marginLeft:"5px"}},ee==="title"&&te==="asc"?"↑":ee==="title"&&te==="desc"?"↓":"↕"))),n("th",null,n("div",{className:"epkb-ai-table-header-content"},n("span",null,X==="recent"?c("Last Modified","echo-knowledge-base"):c("Status","echo-knowledge-base")),n("span",{className:`epkb-ai-sort-arrows ${ee===(X==="recent"?"updated":"display_status")?"active":""}`,onClick:()=>Ne(X==="recent"?"updated":"display_status"),title:c("Sort","echo-knowledge-base"),style:{cursor:"pointer",marginLeft:"5px"}},(()=>{const e=X==="recent"?"updated":"display_status";if(ee===e&&te==="asc")return"↑";if(ee===e&&te==="desc")return"↓";return"↕"})()))))),n("tbody",{style:{position:"relative"}},M&&n("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(255, 255, 255, 0.8)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:10}},n("div",{style:{textAlign:"center"}},n("div",{className:"epkb-ai-loading-spinner"}),n("div",{style:{marginTop:"10px"}},c("Loading...","echo-knowledge-base")))),me().length===0?n("tr",null,n("td",{colSpan:5,style:{textAlign:"center",padding:"20px"}},(()=>{if(se){return c("No articles match your search","echo-knowledge-base")}switch(X){case"to_analyse":return c("No articles need analysis","echo-knowledge-base");case"to_improve":return c("No articles need improvement","echo-knowledge-base");case"recent":return c("No recent articles","echo-knowledge-base");default:return c("No articles found","echo-knowledge-base")}})())):me().map((e=>{const a=q.has(e.id)?"epkb-ai-deleting-row":"";const t=e.score;const s=e.importance;const o=e=>{if(e>=80)return"#46b450";if(e>=60)return"#f0ad4e";return"#d54e21"};const r=e.scoreComponents||[{name:"Tags Usage",value:"-"},{name:"Score 2",value:"-"},{name:"Score 3",value:"-"}];const l=(e,a)=>({display:"inline-block",width:"12px",height:"12px",backgroundColor:a==="Score 2"||a==="Score 3"?"#ccc":e==="-"||e==="Analyzing..."?"#e0e0e0":o(e),marginRight:"3px",borderRadius:"2px"});const i=s;return n("tr",{key:e.id,className:a,"data-item-id":e.item_id||e.id,onClick:a=>{const t=a.target;const n=t.tagName.toLowerCase();const s=n==="a"||n==="button"||n==="input"||t.closest("a")||t.closest("button")||t.closest("input");if(!s){Ce(e.item_id||e.id)}},style:{cursor:"pointer"}},n("td",{className:"epkb-ai-table-checkbox"},n("input",{type:"checkbox",checked:D.includes(String(e.item_id||e.id)),onChange:()=>Ce(e.item_id||e.id)})),n("td",{style:{textAlign:"center"}},n("div",{className:"epkb-ai-score-components",title:r.map(((e,a)=>{if(e.name==="Score 2"||e.name==="Score 3"){return`Coming Soon`}if(e.name==="Tags Usage"){if(e.value==="-")return"Tags: Not analyzed";if(e.value==="Analyzing...")return"Tags: Analyzing...";return`Tags (Score: ${e.value}%)`}return`${e.name}: ${e.value==="-"?"Not analyzed":e.value==="Analyzing..."?"Analyzing...":e.value+"%"}`})).join("\n"),style:{cursor:"help",display:"inline-flex",alignItems:"center",fontSize:"14px"}},r.map(((e,a)=>n("span",{key:a,style:l(e.value,e.name)}))),n("span",{style:{marginLeft:"5px",fontWeight:"bold",color:(()=>{const e=r.find((e=>e.name==="Tags Usage"));const a=e?e.value:"-";return a==="-"||a==="Analyzing..."?"#666":o(a)})()}},(()=>{const e=r.find((e=>e.name==="Tags Usage"));return e?e.value:"-"})()))),n("td",{style:{padding:"8px 12px",textAlign:"center"}},i==="N/A"||i==="Analyzing..."?n("span",{style:{color:"#666",fontSize:"14px"}},i):n("div",{style:{position:"relative",width:"100px",height:"20px",backgroundColor:"#f0f0f0",borderRadius:"10px",overflow:"hidden",margin:"0 auto"}},n("div",{style:{position:"absolute",left:0,top:0,height:"100%",width:`${i}%`,background:"linear-gradient(90deg, #d1d5db, #e5e7eb)",transition:"width 0.3s ease",borderRadius:"10px"}}))),n("td",{className:"epkb-ai-table-title"},n("a",{href:`${window.epkb_ai_api.admin_url}post.php?post=${e.item_id}&action=edit`,target:"_blank",rel:"noopener noreferrer",style:{color:"inherit"}},e.title)),n("td",{className:"epkb-ai-table-status"},X==="recent"?(()=>{const a=e.updated;if(!a)return"-";try{const e=new Date(a);const t=new Date;const n=t-e;const s=Math.floor(n/(1e3*60*60*24));if(s===0){return c("Today","echo-knowledge-base")}else if(s===1){return c("Yesterday","echo-knowledge-base")}else if(s<7){return s+" "+c("days ago","echo-knowledge-base")}else if(s<30){const e=Math.floor(s/7);return e+" "+(e===1?c("week ago","echo-knowledge-base"):c("weeks ago","echo-knowledge-base"))}else{return e.toLocaleDateString()}}catch(e){return a}})():(()=>{const a=e.display_status||"To Improve";let t={padding:"4px 8px",borderRadius:"4px",fontSize:"12px",fontWeight:"500"};switch(a){case"To Analyze":t.backgroundColor="#fef2e0";t.color="#b85700";break;case"Ignored":t.backgroundColor="#f0f0f0";t.color="#666";break;case"Done":t.backgroundColor="#e0f5e0";t.color="#2a6d2a";break;case"To Improve":default:t.backgroundColor="#e3f2fd";t.color="#1976d2";break}return n("span",{style:t},c(a,"echo-knowledge-base"))})()))})))),(de||ce)&&n("div",{className:"epkb-ai-search-message",style:{textAlign:"center",padding:"10px",color:"#666",fontStyle:"italic"}},ce?c("Searching...","echo-knowledge-base"):de),(()=>{if(H<=1){return null}return n("div",{className:"epkb-ai-pagination"},n("button",{disabled:j===1,onClick:()=>F(j-1),className:"epkb-ai-button epkb-ai-button-secondary"},c("Previous","echo-knowledge-base")),n("span",{className:"epkb-ai-page-info"},`${c("Page","echo-knowledge-base")} ${j} ${c("of","echo-knowledge-base")} ${H}`),n("button",{disabled:j===H,onClick:()=>F(j+1),className:"epkb-ai-button epkb-ai-button-secondary"},c("Next","echo-knowledge-base")))})())))};window.EPKB_AI_ContentAnalysisTable=_;class b{constructor(){this.container=null;this.root=null}show(e,a,t){if(!this.container){this.container=document.createElement("div");this.container.id="epkb-ai-content-analysis-error-dialog-root";document.body.appendChild(this.container);const{render:e,unmountComponentAtNode:a}=wp.element;const t=wp.element;if(typeof t.createRoot==="function"){this.root=t.createRoot(this.container)}else if(typeof i==="function"){this.root=i(this.container)}else if(typeof e==="function"){this.root={render:a=>e(a,this.container),unmount:()=>{if(typeof a==="function"){a(this.container)}else{this.container.innerHTML=""}}}}}this.renderDialog({id:e,title:a,errorMessage:t})}renderDialog(e){const{id:a,title:t,errorMessage:s}=e;const o=n("div",{className:"epkb-ai-view-content-dialog-overlay",onClick:e=>{if(e.target.className==="epkb-ai-view-content-dialog-overlay"){this.close()}}},n("div",{className:"epkb-ai-view-content-dialog",style:{maxWidth:"600px"}},n("div",{className:"epkb-ai-dialog-header",style:{position:"relative"}},n("h3",null,c("Content Analysis Error","echo-knowledge-base")),n("span",{style:{position:"absolute",right:"50px",top:"50%",transform:"translateY(-50%)",fontSize:"14px",color:"#666",fontWeight:"normal"}},n("strong",null,c("Article ID:","echo-knowledge-base"))," ",a),n("button",{className:"epkb-ai-dialog-close",onClick:()=>this.close(),"aria-label":c("Close","echo-knowledge-base")},n("span",{className:"epkbfa epkbfa-times"}))),n("div",{className:"epkb-ai-dialog-body"},n("div",{className:"epkb-ai-error-content",style:{textAlign:"center",padding:"20px"}},n("div",{className:"epkb-ai-error-icon"},n("span",{className:"epkbfa epkbfa-exclamation-triangle",style:{fontSize:"48px",color:"#d54e21"}})),n("h4",{style:{marginTop:"20px",marginBottom:"10px"}},t),n("p",{style:{color:"#d54e21",marginTop:"15px"}},c("Error Processing Content Analysis","echo-knowledge-base")),n("div",{className:"epkb-ai-error-message",style:{marginTop:"15px",padding:"15px",backgroundColor:"#fef2f2",border:"1px solid #fee",borderRadius:"4px"}},n("p",{style:{margin:0,color:"#666"}},s)),n("div",{style:{marginTop:"20px"}},n("p",{style:{fontSize:"14px",color:"#666"}},c("This article could not be analyzed. Please try again or check the article content for issues.","echo-knowledge-base")))))));if(this.root&&typeof this.root.render==="function"){this.root.render(o)}}close(){if(this.root&&typeof this.root.unmount==="function"){this.root.unmount();this.root=null}else if(this.container){const{unmountComponentAtNode:e}=wp.element;if(typeof e==="function"){e(this.container)}else{this.container.innerHTML=""}}if(this.container&&this.container.parentNode){this.container.parentNode.removeChild(this.container);this.container=null}}}window.EPKB_AI_ContentAnalysisErrorDialog=new b})();