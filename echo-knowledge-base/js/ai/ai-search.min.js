jQuery(document).ready((function(e){const{parseAIChatErrorResponse:a,parseMessageFormatting:t,logError:s,showErrorMessage:r,createErrorReport:n,isInvalidNonceError:i}=window.EPKBChatUtils;async function o(){const e=window.epkbAISearch||{};try{const a=await fetch(e.rest_url+"epkb-public/v1/ai-chat/start-session",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});const t=await a.json();if(a.ok&&t.rest_nonce){e.rest_nonce=t.rest_nonce;return t.rest_nonce}return null}catch(e){console.error("AI Search: Failed to refresh nonce",e);return null}}function l(e){if(!e||!e.length){return""}const a=window.epkbAISearch||{};const t=a.sources_label||"Sources";let s='<div class="epkb-ai-search-sources">';s+='<div class="epkb-ai-search-sources__label">'+t+"</div>";s+='<ul class="epkb-ai-search-sources__list">';e.forEach((function(e){s+='<li class="epkb-ai-search-sources__item">';s+='<a href="'+e.url+'" target="_blank" rel="noopener noreferrer">';s+=e.title;s+="</a>";s+="</li>"}));s+="</ul>";s+="</div>";return s}function c(d,h,p,_,u,m,f=false){const b=window.epkbAISearch||{};let k=b.rest_url+b.search_endpoint;h.show();p.hide();_.hide();const w={query:d};if(u){w.kb_id=u}if(m){w.collection_id=m}return e.ajax({type:"POST",dataType:"json",url:k,data:JSON.stringify(w),contentType:"application/json",headers:{"X-WP-Nonce":b.rest_nonce}}).done((function(e){h.hide();if(e&&e.response){let a=t(e.response);if(e.sources&&e.sources.length>0){a+=l(e.sources)}p.html(a).show()}else{let a=e&&e.message||b.msg_try_again;_.text(a).show()}})).fail((async function(e,t,l){let k={};try{k=e.responseJSON||{}}catch(e){}if(!f&&i(e,k)){const e=await o();if(e){return c(d,h,p,_,u,m,true)}}h.hide();s("AI Search","Search request failed",{status:e.status,statusText:e.statusText,errorThrown:l,response:k,query:d});const w=a(new Error(k.message||"Request failed"),{status:e.status,data:k},b.is_admin);const g=b.is_admin?w.adminMessage:w.userMessage;r({message:g,isAdmin:b.is_admin,container:_,onReport:function(e){const a=n("AI Search",e,k,d);console.log("AI Search Error Report:\n",a);if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(a).then((()=>{alert("Error report copied to clipboard. Please share with support.")})).catch((()=>{alert("Error report logged to console. Please check console and share with support.")}))}else{alert("Error report logged to console. Please check console and share with support.")}},source:"search"})}))}e(document).on("click",".epkb-ml-ai-search-button",(function(a){a.preventDefault();let t=e(this);let s=t.closest(".epkb-ml-ai-search-section");let r=s.data("kb-id");let n=null;let i="";if(e("#asea_search_form").length){i=e("#asea_advanced_search_terms").val();n=e("#asea_search_form").data("collection-id")}else if(e("#epkb-ml-search-box").length){i=e(".epkb-ml-search-box__input").val();n=e("#epkb-ml-search-form").data("collection-id")}let o=t.find(".epkb-ml-ai-search-button__text");let l=o.text();o.text("Thinking...");t.prop("disabled",true);let d=s.find(".epkb-ml-ai-search-answer");if(d.length===0){let e='<div class="epkb-ml-ai-search-answer" style="display:none;">'+'<div class="epkb-ml-ai-search-answer__loading" style="display:none;">Loading...</div>'+'<div class="epkb-ml-ai-search-answer__content" style="display:none;"></div>'+'<div class="epkb-ml-ai-search-answer__error" style="display:none;"></div>'+"</div>";s.append(e);d=s.find(".epkb-ml-ai-search-answer")}let h=d.find(".epkb-ml-ai-search-answer__loading");let p=d.find(".epkb-ml-ai-search-answer__content");let _=d.find(".epkb-ml-ai-search-answer__error");if(d.is(":visible")){d.slideUp();o.text(l);t.prop("disabled",false);return}d.slideDown();if(p.html().trim()!==""){h.hide();p.show();o.text(l);t.prop("disabled",false);return}c(i,h,p,_,r,n).always((function(){o.text(l);t.prop("disabled",false)}))}));function d(){e('.epkb-ml-ai-search-section[data-display-mode="auto"]').each((function(){let a=e(this);let t=a.find(".epkb-ml-ai-search-answer");let s=a.find(".epkb-ml-ai-search-answer__loading");let r=a.find(".epkb-ml-ai-search-answer__content");let n=a.find(".epkb-ml-ai-search-answer__error");let i=a.data("kb-id");let o=null;let l="";if(e("#asea_advanced_search_terms").length){l=e("#asea_advanced_search_terms").val();o=e("#asea_search_form").data("collection-id")}else if(e(".epkb-ml-search-box__input").length){l=e(".epkb-ml-search-box__input").val();o=e("#epkb-ml-search-form").data("collection-id")}if(!l||r.html().trim()!==""){return}t.show();c(l,s,r,n,i,o)}))}let h=window.epkb_ml_search_result_callback;window.epkb_ml_search_result_callback=function(a){if(h){h(a)}e('.epkb-ml-ai-search-section[data-display-mode="auto"]').each((function(){let a=e(this);let t=a.find(".epkb-ml-ai-search-answer");let s=a.find(".epkb-ml-ai-search-answer__content");let r=a.find(".epkb-ml-ai-search-answer__error");s.empty().hide();r.hide()}));setTimeout(d,100);e('.epkb-ml-ai-search-section[data-display-mode="button"] .epkb-ml-ai-search-answer__content').empty()};window.epkb_perform_ai_search=c;window.epkb_init_ai_search_auto=d;e(document).on("ajaxComplete",(function(a,t,s){if(s&&s.url&&s.url.indexOf("asea-advanced-search-kb")!==-1){setTimeout((function(){e('.epkb-ml-ai-search-section[data-display-mode="auto"]').each((function(){let a=e(this);let t=a.find(".epkb-ml-ai-search-answer");let s=a.find(".epkb-ml-ai-search-answer__content");let r=a.find(".epkb-ml-ai-search-answer__error");s.empty().hide();r.hide()}));d()}),100)}}))}));