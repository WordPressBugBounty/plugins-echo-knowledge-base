jQuery(document).ready((function(e){const{parseAIChatErrorResponse:t,parseMessageFormatting:a}=window.EPKBChatUtils||{};function r(r,i,n,l){const o=window.epkbAISearch||{};let p=o.rest_url+o.search_endpoint;i.show();n.hide();l.hide();return e.ajax({type:"POST",dataType:"json",url:p,data:JSON.stringify({query:r}),contentType:"application/json",headers:{"X-WP-Nonce":o.rest_nonce}}).done((function(e){i.hide();if(e&&e.response){let t=e.response;if(a&&typeof a==="function"){t=a(e.response)}n.html(t).show()}else{let t=e&&e.message||o.msg_try_again;l.text(t).show()}})).fail((function(e,a,n){i.hide();let p={};try{p=e.responseJSON||{}}catch(e){}let c=null;if(t){c=t(new Error(p.message||"Request failed"),{status:e.status,data:p},o.is_admin)}let d;if(c){d=o.is_admin?c.adminMessage:c.userMessage}else{d=o.msg_try_again}if(o.is_admin){l.html(d+' <button class="epkb-ai-search-error__report-btn" style="margin-left: 10px; font-size: 12px; padding: 2px 8px; cursor: pointer;">Submit Issue</button>').show();l.find(".epkb-ai-search-error__report-btn").on("click",(function(){s(d,r)}))}else{l.text(d).show()}}))}e(document).on("click",".epkb-ml-ai-search-button",(function(t){t.preventDefault();let a=e(this);let i=a.closest(".epkb-ml-ai-search-section");let n=i.data("kb-id");let s=e(".epkb-ml-search-box__input").val();let l=a.find(".epkb-ml-ai-search-button__text");let o=l.text();l.text("Thinking...");a.prop("disabled",true);let p=i.find(".epkb-ml-ai-search-answer");if(p.length===0){let e='<div class="epkb-ml-ai-search-answer" style="display:none;">'+'<div class="epkb-ml-ai-search-answer__loading" style="display:none;">Loading...</div>'+'<div class="epkb-ml-ai-search-answer__content" style="display:none;"></div>'+'<div class="epkb-ml-ai-search-answer__error" style="display:none;"></div>'+"</div>";i.append(e);p=i.find(".epkb-ml-ai-search-answer")}let c=p.find(".epkb-ml-ai-search-answer__loading");let d=p.find(".epkb-ml-ai-search-answer__content");let _=p.find(".epkb-ml-ai-search-answer__error");if(p.is(":visible")){p.slideUp();l.text(o);a.prop("disabled",false);return}p.slideDown();if(d.html().trim()!==""){c.hide();d.show();l.text(o);a.prop("disabled",false);return}r(s,c,d,_).always((function(){l.text(o);a.prop("disabled",false)}))}));function i(){e('.epkb-ml-ai-search-section[data-display-mode="auto"]').each((function(){let t=e(this);let a=t.find(".epkb-ml-ai-search-answer__loading");let i=t.find(".epkb-ml-ai-search-answer__content");let n=t.find(".epkb-ml-ai-search-answer__error");let s=t.data("kb-id");let l=e(".epkb-ml-search-box__input").val();if(!l||i.html().trim()!==""){return}r(l,a,i,n)}))}let n=window.epkb_ml_search_result_callback;window.epkb_ml_search_result_callback=function(t){if(n){n(t)}setTimeout(i,100);e(".epkb-ml-ai-search-answer__content").empty()};window.epkb_perform_ai_search=r;window.epkb_init_ai_search_auto=i;function s(t,a){let r=e(".epkb-ml-ai-search-section");let i=r.data("is-admin")==="true";if(!i){return}let n=e("#epkb-ai-search-error-form-wrap .epkb-admin__error-form__container");if(n.length){let e="AI Search Error:\n"+t+"\n\nSearch Query: "+(a||"N/A")+"\nTimestamp: "+(new Date).toISOString();n.find(".epkb-admin__error-form__title").text("Report AI Search Error");n.find(".epkb-admin__error-form__desc").text("Help us improve by reporting this error");n.find("#epkb-admin__error-form__message").val(e);n.css("display","block").parent().css("display","block")}}}));