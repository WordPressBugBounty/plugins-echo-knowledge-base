jQuery(document).ready((function(e){const{parseAIChatErrorResponse:a,parseMessageFormatting:t,logError:s,showErrorMessage:r,createErrorReport:n}=window.EPKBChatUtils;function i(i,o,l,c){const d=window.epkbAISearch||{};let p=d.rest_url+d.search_endpoint;o.show();l.hide();c.hide();return e.ajax({type:"POST",dataType:"json",url:p,data:JSON.stringify({query:i}),contentType:"application/json",headers:{"X-WP-Nonce":d.rest_nonce}}).done((function(e){o.hide();if(e&&e.response){const a=t(e.response);l.html(a).show()}else{let a=e&&e.message||d.msg_try_again;c.text(a).show()}})).fail((function(e,t,l){o.hide();let p={};try{p=e.responseJSON||{}}catch(e){}s("AI Search","Search request failed",{status:e.status,statusText:e.statusText,errorThrown:l,response:p,query:i});const h=a(new Error(p.message||"Request failed"),{status:e.status,data:p},d.is_admin);const _=d.is_admin?h.adminMessage:h.userMessage;r({message:_,isAdmin:d.is_admin,container:c,onReport:function(e){const a=n("AI Search",e,p,i);console.log("AI Search Error Report:\n",a);if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(a).then((()=>{alert("Error report copied to clipboard. Please share with support.")})).catch((()=>{alert("Error report logged to console. Please check console and share with support.")}))}else{alert("Error report logged to console. Please check console and share with support.")}},source:"search"})}))}e(document).on("click",".epkb-ml-ai-search-button",(function(a){a.preventDefault();let t=e(this);let s=t.closest(".epkb-ml-ai-search-section");let r=s.data("kb-id");let n="";if(e("#asea_search_form").length){n=e("#asea_advanced_search_terms").val()}else if(e("#epkb-ml-search-box").length){n=e(".epkb-ml-search-box__input").val()}let o=t.find(".epkb-ml-ai-search-button__text");let l=o.text();o.text("Thinking...");t.prop("disabled",true);let c=s.find(".epkb-ml-ai-search-answer");if(c.length===0){let e='<div class="epkb-ml-ai-search-answer" style="display:none;">'+'<div class="epkb-ml-ai-search-answer__loading" style="display:none;">Loading...</div>'+'<div class="epkb-ml-ai-search-answer__content" style="display:none;"></div>'+'<div class="epkb-ml-ai-search-answer__error" style="display:none;"></div>'+"</div>";s.append(e);c=s.find(".epkb-ml-ai-search-answer")}let d=c.find(".epkb-ml-ai-search-answer__loading");let p=c.find(".epkb-ml-ai-search-answer__content");let h=c.find(".epkb-ml-ai-search-answer__error");if(c.is(":visible")){c.slideUp();o.text(l);t.prop("disabled",false);return}c.slideDown();if(p.html().trim()!==""){d.hide();p.show();o.text(l);t.prop("disabled",false);return}i(n,d,p,h).always((function(){o.text(l);t.prop("disabled",false)}))}));function o(){e('.epkb-ml-ai-search-section[data-display-mode="auto"]').each((function(){let a=e(this);let t=a.find(".epkb-ml-ai-search-answer");let s=a.find(".epkb-ml-ai-search-answer__loading");let r=a.find(".epkb-ml-ai-search-answer__content");let n=a.find(".epkb-ml-ai-search-answer__error");let o=a.data("kb-id");let l="";if(e("#asea_advanced_search_terms").length){l=e("#asea_advanced_search_terms").val()}else if(e(".epkb-ml-search-box__input").length){l=e(".epkb-ml-search-box__input").val()}if(!l||r.html().trim()!==""){return}t.show();i(l,s,r,n)}))}let l=window.epkb_ml_search_result_callback;window.epkb_ml_search_result_callback=function(a){if(l){l(a)}e('.epkb-ml-ai-search-section[data-display-mode="auto"]').each((function(){let a=e(this);let t=a.find(".epkb-ml-ai-search-answer");let s=a.find(".epkb-ml-ai-search-answer__content");let r=a.find(".epkb-ml-ai-search-answer__error");s.empty().hide();r.hide()}));setTimeout(o,100);e('.epkb-ml-ai-search-section[data-display-mode="button"] .epkb-ml-ai-search-answer__content').empty()};window.epkb_perform_ai_search=i;window.epkb_init_ai_search_auto=o;e(document).on("ajaxComplete",(function(a,t,s){if(s&&s.url&&s.url.indexOf("asea-advanced-search-kb")!==-1){setTimeout((function(){e('.epkb-ml-ai-search-section[data-display-mode="auto"]').each((function(){let a=e(this);let t=a.find(".epkb-ml-ai-search-answer");let s=a.find(".epkb-ml-ai-search-answer__content");let r=a.find(".epkb-ml-ai-search-answer__error");s.empty().hide();r.hide()}));o()}),100)}}))}));