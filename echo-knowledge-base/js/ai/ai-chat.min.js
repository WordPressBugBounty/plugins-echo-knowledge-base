(function(){"use strict";const e=window.wp&&window.wp.element;const t=e||window.React;const s=window.ReactDOM;if(!t||!s){window.EPKBChatUtils.logError("AI Chat","React is not available");return}if(!window.EPKBChatAPI||!window.EPKBChatSession||!window.EPKBChatUtils){window.EPKBChatUtils.logError("AI Chat","Required modules not loaded");return}const{useState:n,useEffect:a,useRef:o,createElement:r,memo:c}=t;const{ChatAPIClient:i}=window.EPKBChatAPI;const{SessionManager:l}=window.EPKBChatSession;const{isDebugMode:d,createMessage:u,prepareMessage:f,parseMessageFormatting:g,getChatRootElement:h,logError:p,showErrorMessage:m,createErrorReport:w,TypingIndicator:b,LoadingSkeleton:y,useFocusTrap:k}=window.EPKBChatUtils;const v=b(t);const C=y(t);const I=k(t);const _=c((function e({message:t,isUser:s}){const n=typeof t==="object"&&t!==null?t.text||t.content||String(t):String(t);const a=!s?g(n):n;return r("div",{className:`epkb-ai-chat-message ${s?"epkb-ai-chat-message--user":"epkb-ai-chat-message--assistant"}`},r("div",{className:"epkb-ai-chat-message-bubble"},r("div",{className:"epkb-ai-chat-message-content",...!s&&a!==n?{dangerouslySetInnerHTML:{__html:a}}:{}},!s&&a!==n?null:n)))}),((e,t)=>e.message===t.message&&e.isUser===t.isUser));function E(){const e=window.epkbAIChat||{};const t=e.welcome||"Hello! How can I help you today?";const s=h();const c=s&&s.getAttribute("data-is-admin")==="true";const g=d();const b=c||g;if(g&&!c){console.log("EPKB AI Chat: Debug mode enabled. Technical messages will be shown.");console.log("To disable debug mode, run: epkbEnableDebug(false)")}const y=o(new l);const k=o(new i({rest_url:e.rest_url,rest_nonce:e.rest_nonce,isAdmin:c,debugMode:g}));a((()=>{k.current.setSessionManager(y.current)}),[]);const[E,N]=n(false);const[S,A]=n([u(t,false)]);const[x,M]=n("");const[P,R]=n(false);const[U,T]=n("");const[K,D]=n(false);const[B,O]=n(false);const[F,L]=n(false);const[$,j]=n(e.rest_nonce||"");const[q,W]=n("");const H=o(e.rest_nonce||"");const J=o(false);const Q=o(false);const V=o("");const Y=o(false);const z=o(null);const G=o(false);const X=o(null);const Z=o(null);const ee=o(null);a((()=>{H.current=$;k.current.setNonce($)}),[$]);a((()=>{V.current=q}),[q]);a((()=>{async function e(){const e=y.current.load();if(e.chatId){const t=y.current.loadMessagesFromSessionStorage(e.chatId);if(t&&t.length>0){const s=t.map((e=>u(e.content,e.role==="user",e.id)));A(s);W(e.chatId);D(true);if(b){console.log(`Loaded ${s.length} messages from cache instantly!`)}return}return}}e()}),[]);a((()=>{if(!E||Q.current)return;Q.current=true;async function e(){const e=await k.current.startSession();if(!e.success&&b){p("AI Chat","Failed to establish session on chat open",{errorInfo:e.errorInfo})}if(!K){const e=y.current.load();if(e.chatId&&S.length===1){const t=await k.current.getConversation(e.chatId);if(t.success&&t.data){if(t.data.chat_id){W(t.data.chat_id);y.current.save(null,t.data.chat_id)}if(t.data.messages&&t.data.messages.length>0){const e=t.data.messages.map((e=>u(e.content,e.role==="user",e.id)));A(e);const s=t.data.messages.map((e=>({id:e.id,content:e.content,role:e.role})));y.current.saveMessages(t.data.chat_id,s);if(b){console.log(`Loaded ${e.length} messages from server on chat open`)}}}}D(true)}}e()}),[E,b]);a((()=>{if(Z.current){Z.current.scrollIntoView({behavior:"smooth"})}}),[S,P]);I(X,E,(()=>N(false)));a((()=>{if(E){G.current=true;if(ee.current){ee.current.focus()}}else if(G.current){if(z.current){z.current.focus()}}}),[E]);a((()=>()=>{J.current=false;k.current.clearRetries()}),[]);a((()=>{if(q&&S.length>1){const e=S.map((e=>({id:e.messageId,content:e.text,role:e.isUser?"user":"assistant"})));y.current.saveMessages(q,e)}}),[q,S]);function te(){R(false);J.current=false;L(false)}function se(e){if(e.new_token){if(b){console.log("Received new token from server")}j(e.new_token);H.current=e.new_token;k.current.setNonce(e.new_token)}}async function ne(e=false){const t=await k.current.refreshNonce(e);if(t){j(t);H.current=t}return t}async function ae(t,s,n=0){if(n>2){te();T("Unable to establish session. Please refresh the page.");return{success:false}}const a=q;if(a&&!a.startsWith("chat_")){if(b){console.warn("Invalid chat ID format:",a)}W("");y.current.clearChatOnly()}const o=Y.current;if(o){Y.current=false;if(b){console.log("Forcing new conversation for this message")}}const r=await k.current.sendMessageWithRetry(t,s,a,e.widget_id||"1",0,false,o,{onNewToken:se,onSessionUpdate:e=>{if(a&&V.current!==a){if(b){console.log("Session update ignored - conversation changed")}return}W(e.chatId);if(e.chatId){D(true)}},onSuccess:e=>{if(a&&V.current!==a){if(b){console.log("Message response ignored - conversation cleared")}te();return}let t;if(typeof e.response==="object"&&e.response!==null){t=e.response.text||e.response.content||JSON.stringify(e.response);if(b){console.log("Response object structure:",e.response)}}else{t=String(e.response)}const s=u(t,false,e.message_id);A((e=>{const t=e.some((e=>e.messageId===s.messageId||!e.isUser&&e.text===s.text&&Math.abs(e.id-s.id)<5e3));if(t){if(b){console.log("Duplicate bot message detected, skipping:",s.messageId)}return e}return[...e,s]}));te()},onInvalidNonce:async()=>{await ne(true)},onTimeoutError:(t,s)=>{te();const n=s?s.finalMessage:e.error_generic||"Unable to connect. Please refresh the page and try again.";T(n)},onRetry:(e,t)=>{if(e>1){R(true)}},onFinalError:async(t,a)=>{if(a&&a.code){if(a.code==="duplicate_request"){if(b){console.log("Duplicate request detected, original request still processing")}return}if(a.code==="conversation_expired"||a.code==="invalid_chat_id"||a.code==="chat_not_found"){te();re(a);return}if(a.code==="invalid_session"||a.code==="session_expired"){if(b){console.log("Session expired during message send, creating new session...")}const e=await k.current.startSession();if(e.canceled){te();T("Unable to establish session. Please refresh the page and try again.");return}if(e.success){W("");y.current.clearChatOnly();await ae(o,s,n+1);return}}}te();let o;if(a){o=a.finalMessage;if(a.type==="rate_limit"&&a.context.retryAfter){o+=` Please try again in ${a.context.retryAfter} seconds.`}if(c&&a.code){p("AI Chat","Message send failed",{type:a.type,code:a.code,statusCode:a.statusCode,context:a.context})}}else{o=e.error_generic||"Unable to connect. Please refresh the page and try again."}T(o)}});return r}const oe=async()=>{if(J.current)return;const e=f(x);if(!e.valid){return}k.current.clearRetries();T("");A((t=>[...t,e.message]));M("");R(true);J.current=true;L(true);try{await ae(e.text,e.messageId)}catch(e){if(b){p("AI Chat","Unexpected error in handleSend",{error:e.message||e,stack:e.stack})}T("An unexpected error occurred. Please try again.");te()}finally{if(J.current){J.current=false}}};function re(e){const s=e?.finalMessage||"Your previous conversation has expired. Starting a new conversation...";T(s);W("");y.current.clearChatOnly();A([u(t,false)]);D(false);setTimeout((()=>{T("")}),5e3)}function ce(){if(J.current){if(b){console.log("Cannot clear - message is being sent")}return}if(b){console.log("Clearing conversation...")}const e=q;k.current.clearRetries();W("");y.current.clearChatOnly();if(e){y.current.clearMessageCache(e)}A([u(t,false)]);T("");D(false);Y.current=true;if(b){console.log("Conversation cleared. New chat_id will be generated on next message.")}}const ie=e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();oe()}};function le(){return r("div",{className:"epkb-ai-chat-widget"},E&&r("div",{className:"epkb-ai-chat-window",role:"dialog","aria-modal":"true","aria-label":e.title||"AI Assistant",ref:X},r("div",{className:"epkb-ai-chat-header"},r("h3",null,e.title||"AI Assistant"),r("div",{className:"epkb-ai-chat-header-actions"},S.length>1&&r("button",{onClick:()=>ce(),className:"epkb-ai-chat-new",title:"New Conversation","aria-label":"Start new conversation"},"ðŸ”„"),r("button",{onClick:()=>N(false),className:"epkb-ai-chat-close","aria-label":"Close chat"},"Ã—"))),r("div",{className:"epkb-ai-chat-messages"},B&&S.length===1?r(C):S.map((e=>r(_,{key:e.messageId||e.id,message:e.text,isUser:e.isUser}))),P&&r(v),r("div",{ref:Z}),U&&r("div",{id:"epkb-ai-chat-error-container",className:"epkb-ai-chat-error",style:{position:"sticky",bottom:0,marginTop:"10px"},ref:e=>{if(e&&U){const t=window.jQuery;if(t){m({message:U,isAdmin:c&&b,container:t(e),onReport:e=>{const t=w("AI Chat",e,{},x||"N/A");console.log("AI Chat Error Report:\n",t);if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(t).then((()=>{alert("Error report copied to clipboard. Please share with support.")})).catch((()=>{alert("Error report logged to console. Please check console and share with support.")}))}else{alert("Error report logged to console. Please check console and share with support.")}},source:"chat"})}}}})),r("div",{className:"epkb-ai-chat-input-container"},r("div",{className:"epkb-ai-chat-input-wrapper"},r("input",{ref:ee,type:"text",value:x,onChange:e=>M(e.target.value),onKeyDown:ie,placeholder:e.placeholder||"Type your message...",className:"epkb-ai-chat-input"}),r("button",{onClick:oe,className:`epkb-ai-chat-send ${F?"epkb-ai-chat-send--loading":""}`,disabled:!x.trim()||F,"aria-label":F?"Sending message":"Send message"},F?"âŸ³":"âž¤")))),r("button",{onClick:()=>N(!E),className:`epkb-ai-chat-toggle ${E?"epkb-ai-chat-toggle--open":""}`,"aria-label":E?"Close chat":"Open chat",ref:z},E?"Ã—":"ðŸ’¬"))}return le()}function N(){const e=h();if(!e){p("AI Chat","Widget root element not found",{expectedId:window.epkbChatWidgetRoot||"epkb-ai-chat-widget-root"});return}if(typeof s.createRoot==="function"){const t=s.createRoot(e);t.render(r(E))}else{s.render(r(E),e)}}if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",N)}else{N()}})();