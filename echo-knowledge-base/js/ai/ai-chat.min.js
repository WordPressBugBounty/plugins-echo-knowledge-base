(function(){"use strict";const e=window.wp&&window.wp.element;const t=e||window.React;const n=window.ReactDOM;if(!t||!n){console.error("EPKB Chat widget: React is not available");return}if(!window.EPKBChatAPI||!window.EPKBChatSession||!window.EPKBChatUtils){console.error("EPKB Chat widget: Required modules not loaded");return}const{useState:s,useEffect:r,useRef:o,createElement:a,memo:c}=t;const{ChatAPIClient:i}=window.EPKBChatAPI;const{SessionManager:l}=window.EPKBChatSession;const{isDebugMode:u,createMessage:d,prepareMessage:f,parseMessageFormatting:g,getChatRootElement:p,TypingIndicator:m,LoadingSkeleton:h,useFocusTrap:b}=window.EPKBChatUtils;const w=m(t);const y=h(t);const _=b(t);const k=c((function e({message:t,isUser:n}){const s=typeof t==="object"&&t!==null?t.text||t.content||String(t):String(t);const r=!n?g(s):s;return a("div",{className:`epkb-ai-chat-message ${n?"epkb-ai-chat-message--user":"epkb-ai-chat-message--bot"}`},a("div",{className:"epkb-ai-chat-message-content",...!n&&r!==s?{dangerouslySetInnerHTML:{__html:r}}:{}},!n&&r!==s?null:s))}),((e,t)=>e.message===t.message&&e.isUser===t.isUser));function v(){const e=window.epkbAIChat||{};const t=e.welcome||"Hello! How can I help you today?";const n=p();const c=n&&n.getAttribute("data-is-admin")==="true";const g=u();const m=c||g;if(g&&!c){console.log("EPKB AI Chat: Debug mode enabled. Technical messages will be shown.");console.log("To disable debug mode, run: epkbEnableDebug(false)")}const h=o(new l);const b=o(new i({rest_url:e.rest_url,rest_nonce:e.rest_nonce,isAdmin:c,debugMode:g}));r((()=>{b.current.setSessionManager(h.current)}),[]);const[v,C]=s(false);const[S,I]=s([d(t,false)]);const[x,E]=s("");const[N,M]=s(false);const[A,P]=s("");const[T,R]=s(false);const[U,D]=s(false);const[q,K]=s(false);const[B,O]=s(e.rest_nonce||"");const[$,L]=s("");const F=o(e.rest_nonce||"");const H=o(false);const j=o(false);const W=o("");const J=o(false);const Q=o(null);const V=o(false);const Y=o(null);const z=o(null);const G=o(null);r((()=>{F.current=B;b.current.setNonce(B)}),[B]);r((()=>{W.current=$}),[$]);r((()=>{async function e(){const e=h.current.load();if(e.chatId){const t=h.current.loadMessagesFromSessionStorage(e.chatId);if(t&&t.length>0){const n=t.map((e=>d(e.content,e.role==="user",e.id)));I(n);L(e.chatId);R(true);if(m){console.log(`Loaded ${n.length} messages from cache instantly!`)}return}return}}e()}),[]);r((()=>{ce()}),[]);r((()=>{if(!v||j.current)return;j.current=true;async function e(){const e=await b.current.startSession();if(!e.success&&m){console.error("Failed to establish session on chat open:",e.errorInfo)}if(!T){const e=h.current.load();if(e.chatId&&S.length===1){const t=await b.current.getConversation(e.chatId);if(t.success&&t.data){if(t.data.chat_id){L(t.data.chat_id);h.current.save(null,t.data.chat_id)}if(t.data.messages&&t.data.messages.length>0){const e=t.data.messages.map((e=>d(e.content,e.role==="user",e.id)));I(e);const n=t.data.messages.map((e=>({id:e.id,content:e.content,role:e.role})));h.current.saveMessages(t.data.chat_id,n);if(m){console.log(`Loaded ${e.length} messages from server on chat open`)}}}}R(true)}}e()}),[v,m]);r((()=>{if(z.current){z.current.scrollIntoView({behavior:"smooth"})}}),[S,N]);_(Y,v,(()=>C(false)));r((()=>{if(v){V.current=true;if(G.current){G.current.focus()}}else if(V.current){if(Q.current){Q.current.focus()}}}),[v]);r((()=>()=>{H.current=false;b.current.clearRetries()}),[]);r((()=>{if($&&S.length>1){const e=S.map((e=>({id:e.messageId,content:e.text,role:e.isUser?"user":"assistant"})));h.current.saveMessages($,e)}}),[$,S]);function X(){M(false);H.current=false;K(false)}function Z(e){if(e.new_token){if(m){console.log("Received new token from server")}O(e.new_token);F.current=e.new_token;b.current.setNonce(e.new_token)}}async function ee(e=false){const t=await b.current.refreshNonce(e);if(t){O(t);F.current=t}return t}async function te(t,n,s=0){if(s>2){X();P("Unable to establish session. Please refresh the page.");return{success:false}}const r=$;if(r&&!r.startsWith("chat_")){if(m){console.warn("Invalid chat ID format:",r)}L("");h.current.clearChatOnly()}const o=J.current;if(o){J.current=false;if(m){console.log("Forcing new conversation for this message")}}const a=await b.current.sendMessageWithRetry(t,n,r,e.widget_id||"1",0,false,o,{onNewToken:Z,onSessionUpdate:e=>{if(r&&W.current!==r){if(m){console.log("Session update ignored - conversation changed")}return}L(e.chatId);if(e.chatId){R(true)}},onSuccess:e=>{if(r&&W.current!==r){if(m){console.log("Message response ignored - conversation cleared")}X();return}let t;if(typeof e.response==="object"&&e.response!==null){t=e.response.text||e.response.content||JSON.stringify(e.response);if(m){console.log("Response object structure:",e.response)}}else{t=String(e.response)}const n=d(t,false,e.message_id);I((e=>{const t=e.some((e=>e.messageId===n.messageId||!e.isUser&&e.text===n.text&&Math.abs(e.id-n.id)<5e3));if(t){if(m){console.log("Duplicate bot message detected, skipping:",n.messageId)}return e}return[...e,n]}));X()},onInvalidNonce:async()=>{await ee(true)},onTimeoutError:(t,n)=>{X();const s=n?n.finalMessage:e.error_generic||"Unable to connect. Please refresh the page and try again.";P(s)},onRetry:(e,t)=>{if(e>1){M(true)}},onFinalError:async(t,r)=>{if(r&&r.code){if(r.code==="duplicate_request"){if(m){console.log("Duplicate request detected, original request still processing")}return}if(r.code==="conversation_expired"||r.code==="invalid_chat_id"||r.code==="chat_not_found"){X();se(r);return}if(r.code==="invalid_session"||r.code==="session_expired"){if(m){console.log("Session expired during message send, creating new session...")}const e=await b.current.startSession();if(e.canceled){X();P("Unable to establish session. Please refresh the page and try again.");return}if(e.success){L("");h.current.clearChatOnly();await te(o,n,s+1);return}}}X();let o;if(r){o=r.finalMessage;if(r.type==="rate_limit"&&r.context.retryAfter){o+=` Please try again in ${r.context.retryAfter} seconds.`}if(c&&r.code){console.error("AI Chat Error Details:",{type:r.type,code:r.code,statusCode:r.statusCode,context:r.context})}}else{o=e.error_generic||"Unable to connect. Please refresh the page and try again."}P(o)}});return a}const ne=async()=>{if(H.current)return;const e=f(x);if(!e.valid){return}b.current.clearRetries();P("");I((t=>[...t,e.message]));E("");M(true);H.current=true;K(true);try{await te(e.text,e.messageId)}catch(e){if(m){console.error("Unexpected error in handleSend:",e)}P("An unexpected error occurred. Please try again.");X()}finally{if(H.current){H.current=false}}};function se(e){const n=e?.finalMessage||"Your previous conversation has expired. Starting a new conversation...";P(n);L("");h.current.clearChatOnly();I([d(t,false)]);R(false);setTimeout((()=>{P("")}),5e3)}function re(){if(H.current){if(m){console.log("Cannot clear - message is being sent")}return}if(m){console.log("Clearing conversation...")}const e=$;b.current.clearRetries();L("");h.current.clearChatOnly();if(e){h.current.clearMessageCache(e)}I([d(t,false)]);P("");R(false);J.current=true;if(m){console.log("Conversation cleared. New chat_id will be generated on next message.")}}const oe=e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();ne()}};function ae(e){const t=document.querySelector("#epkb-ai-chat-error-form-wrap");const n=t?t.querySelector(".epkb-admin__error-form__container"):null;if(n&&t){const s=`AI Chat Error:\n${e}\n\nUser Query: ${x||"N/A"}\nTimestamp: ${(new Date).toISOString()}`;n.querySelector(".epkb-admin__error-form__title").textContent="Report AI Chat Error";n.querySelector(".epkb-admin__error-form__desc").textContent="Help us improve by reporting this error";n.querySelector("#epkb-admin__error-form__message").value=s;t.style.cssText="display: block !important;";n.style.cssText="display: block !important;"}}function ce(){const e=document.querySelector("#epkb-ai-chat-error-form-wrap");if(!e)return;e.style.cssText="display: none !important;";const t=e.querySelectorAll(".epkb-close-notice, .epkb-admin__error-form__btn-cancel");t.forEach((t=>{t.addEventListener("click",(function(t){t.preventDefault();e.style.cssText="display: none !important;"}))}));const n=e.querySelector("#epkb-admin__error-form");if(n){n.addEventListener("submit",(function(t){t.preventDefault();setTimeout((()=>{e.style.cssText="display: none !important;"}),100)}))}}function ie(){return a("div",{className:"epkb-ai-chat-widget"},v&&a("div",{className:"epkb-ai-chat-window",role:"dialog","aria-modal":"true","aria-label":e.title||"AI Assistant",ref:Y},a("div",{className:"epkb-ai-chat-header"},a("h3",null,e.title||"AI Assistant"),a("div",{className:"epkb-ai-chat-header-actions"},S.length>1&&a("button",{onClick:()=>re(),className:"epkb-ai-chat-new",title:"New Conversation","aria-label":"Start new conversation"},"ðŸ”„"),a("button",{onClick:()=>C(false),className:"epkb-ai-chat-close","aria-label":"Close chat"},"Ã—"))),a("div",{className:"epkb-ai-chat-messages"},U&&S.length===1?a(y):S.map((e=>a(k,{key:e.messageId||e.id,message:e.text,isUser:e.isUser}))),N&&a(w),a("div",{ref:z}),A&&a("div",{className:"epkb-ai-chat-error",style:{position:"sticky",bottom:0,marginTop:"10px"}},A)),a("div",{className:"epkb-ai-chat-input-container"},a("div",{className:"epkb-ai-chat-input-wrapper"},a("input",{ref:G,type:"text",value:x,onChange:e=>E(e.target.value),onKeyDown:oe,placeholder:e.placeholder||"Type your message...",className:"epkb-ai-chat-input"}),a("button",{onClick:ne,className:`epkb-ai-chat-send ${q?"epkb-ai-chat-send--loading":""}`,disabled:!x.trim()||q,"aria-label":q?"Sending message":"Send message"},q?"âŸ³":"âž¤")))),a("button",{onClick:()=>C(!v),className:`epkb-ai-chat-toggle ${v?"epkb-ai-chat-toggle--open":""}`,"aria-label":v?"Close chat":"Open chat",ref:Q},v?"Ã—":"ðŸ’¬"))}return ie()}function C(){const e=p();if(!e){console.error("EPKB Chat widget root element not found");return}if(typeof n.createRoot==="function"){const t=n.createRoot(e);t.render(a(v))}else{n.render(a(v),e)}}if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",C)}else{C()}})();