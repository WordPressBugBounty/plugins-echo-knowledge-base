(function(){"use strict";const e=window.wp&&window.wp.element;const t=e||window.React;const n=window.ReactDOM;if(!t||!n){window.EPKBChatUtils.logError("AI Chat","React is not available");return}if(!window.EPKBChatAPI||!window.EPKBChatCache||!window.EPKBChatSession||!window.EPKBChatUtils||!window.EPKBChatDisplay){console.error("AI Chat: Required modules not loaded");return}const{useState:r,useEffect:s,useRef:o,createElement:a}=t;const{ChatAPIClient:c}=window.EPKBChatAPI;const{ChatCacheManager:i}=window.EPKBChatCache;const{SessionManager:l}=window.EPKBChatSession;const{isDebugMode:u,createMessage:d,prepareMessage:f,getChatRootElement:g,logError:h,TypingIndicator:w,LoadingSkeleton:m,useFocusTrap:p}=window.EPKBChatUtils;const{darkenColor:C,createMessageComponent:I,renderChatWidget:y}=window.EPKBChatDisplay;const _=w(t);const b=m(t);const v=p(t);const E=I(t);function M(){const e=window.epkbAIChat||{};const n=e.welcome_message||"Hello! How can I help you today?";const a=e.widget_header_background_color||"#0073aa";const w={launcher:e.launcher_background_color||"#0073aa",header:a,headerGradient:`linear-gradient(135deg, ${a} 0%, ${C(a,20)} 100%)`};const m={generic:e.error_generic_message||"Sorry, something went wrong. Please try again.",network:e.error_network_message||"Connection error. Please check your internet and try again.",timeout:e.error_timeout_message||"The request timed out. Please try again.",rateLimit:e.error_rate_limit_message||"Too many requests. Please wait a moment and try again."};const p=g();const I=p&&p.getAttribute("data-is-admin")==="true";const M=u();const P=I||M;if(M&&!I){console.log("EPKB AI Chat: Debug mode enabled. Technical messages will be shown.");console.log("To disable debug mode, run: epkbEnableDebug(false)")}const S=o(new i);const A=o(new l({rest_nonce:e.rest_nonce,isAdmin:I,debugMode:M}));const k=o(new c({rest_url:e.rest_url,rest_nonce:A.current.getNonce(),isAdmin:I,debugMode:M}));s((()=>{A.current.setApiClient(k.current)}),[]);const[R,x]=r(false);const[K,B]=r([d(n,false)]);const[T,D]=r("");const[U,L]=r(false);const[N,q]=r("");const[W,O]=r(false);const[$,F]=r(false);const[V,j]=r(false);const[H,G]=r("");const J=o(false);const Y=o(false);const z=o("");const Q=o(false);const X=o(null);const Z=o(false);const ee=o(null);const te=o(null);const ne=o(null);s((()=>{A.current.onNonceUpdate((e=>{k.current.setNonce(e)}));return()=>{A.current.cleanup()}}),[]);s((()=>{z.current=H}),[H]);s((()=>{async function e(){const e=S.current.loadChatId();if(e){const t=S.current.loadMessages(e);if(t&&t.length>0){const n=t.map((e=>d(e.content,e.role==="user",e.id)));B(n);G(e);O(true);if(P){console.log(`Loaded ${n.length} messages from cache instantly!`)}return}return}}e()}),[]);s((()=>{if(!R||Y.current)return;Y.current=true;async function e(){const e=await A.current.startSession();if(!e.success&&P){h("AI Chat","Failed to establish session on chat open",{errorInfo:e.errorInfo})}if(!W){const e=S.current.loadChatId();if(e&&K.length===1){const t=await k.current.getConversation(e);if(t.success&&t.data){if(t.data.chat_id){G(t.data.chat_id);S.current.saveChatId(t.data.chat_id)}if(t.data.messages&&t.data.messages.length>0){const e=t.data.messages.map((e=>d(e.content,e.role==="user",e.id)));B(e);const n=t.data.messages.map((e=>({id:e.id,content:e.content,role:e.role})));S.current.saveMessages(t.data.chat_id,n);if(P){console.log(`Loaded ${e.length} messages from server on chat open`)}}}else if(!t.success&&t.errorInfo){const r=t.errorInfo;if(A.current.isSessionError(r)){if(P){console.log("Authentication error on conversation load, starting fresh")}S.current.clearChatId();S.current.clearMessageCache(e);G("");B([d(n,false)])}}}O(true)}}e()}),[R,P]);s((()=>{if(te.current){te.current.scrollIntoView({behavior:"smooth"})}}),[K,U]);v(ee,R,(()=>x(false)));s((()=>{if(R){Z.current=true;if(ne.current){ne.current.focus()}}else if(Z.current){if(X.current){X.current.focus()}}}),[R]);s((()=>()=>{J.current=false;k.current.clearRetries()}),[]);s((()=>{if(H&&K.length>1){const e=K.map((e=>({id:e.messageId,content:e.text,role:e.isUser?"user":"assistant"})));S.current.saveMessages(H,e)}}),[H,K]);function re(){L(false);J.current=false;j(false)}function se(e){A.current.handleNewToken(e)}async function oe(e=false){return await A.current.refreshNonce(e)}async function ae(t,n,r=0){if(r>2){re();q("Unable to establish session. Please refresh the page.");return{success:false}}const s=H;if(s&&!s.startsWith("chat_")){if(P){console.warn("Invalid chat ID format:",s)}G("");S.current.clearChatId()}const o=Q.current;if(o){Q.current=false;if(P){console.log("Forcing new conversation for this message")}}const a=await k.current.sendMessageWithRetry(t,n,s,e.widget_id||"1",0,false,o,{onNewToken:se,onSessionUpdate:e=>{if(s&&z.current!==s){if(P){console.log("Session update ignored - conversation changed")}return}G(e.chatId);S.current.saveChatId(e.chatId);if(e.chatId){O(true)}},onSuccess:e=>{if(s&&z.current!==s){if(P){console.log("Message response ignored - conversation cleared")}re();return}let t;if(typeof e.response==="object"&&e.response!==null){t=e.response.text||e.response.content||JSON.stringify(e.response);if(P){console.log("Response object structure:",e.response)}}else{t=String(e.response)}const n=d(t,false,e.message_id);B((e=>{const t=e.some((e=>e.messageId===n.messageId||!e.isUser&&e.text===n.text&&Math.abs(e.id-n.id)<5e3));if(t){if(P){console.log("Duplicate bot message detected, skipping:",n.messageId)}return e}return[...e,n]}));re()},onInvalidNonce:async()=>{await oe(true)},onTimeoutError:(t,n)=>{re();const r=n?n.finalMessage:e.error_generic||"Unable to connect. Please refresh the page and try again.";q(r)},onRetry:(e,t)=>{if(e>1){L(true)}},onFinalError:async(t,s)=>{if(s&&s.code){if(s.code==="duplicate_request"){if(P){console.log("Duplicate request detected, original request still processing")}return}if(e==="clear"){re();ie();return}else if(e==="expired_conversation"){re();le(s);return}else if(e==="refresh_nonce"){return}const e=A.current.handleSessionError(s);if(e==="new_session"){if(P){console.log("Session expired during message send, creating new session...")}const e=await A.current.startSession();if(e.canceled){re();ue();return}if(e.success){G("");S.current.clearChatId();await ae(o,n,r+1);return}}}re();if(A.current.isSessionError(s)){if(P){console.log("Authentication/cookie error detected, starting new conversation")}ue();return}let o;if(s){o=s.finalMessage;if(s.type==="rate_limit"&&s.context.retryAfter){o+=` Please try again in ${s.context.retryAfter} seconds.`}if(I&&s.code){h("AI Chat","Message send failed",{type:s.type,code:s.code,statusCode:s.statusCode,context:s.context})}}else{o=e.error_generic||"Unable to connect. Please refresh the page and try again."}q(o)}});return a}const ce=async()=>{if(J.current)return;const e=f(T);if(!e.valid){return}k.current.clearRetries();q("");B((t=>[...t,e.message]));D("");L(true);J.current=true;j(true);try{await ae(e.text,e.messageId)}catch(e){if(P){h("AI Chat","Unexpected error in handleSend",{error:e.message||e,stack:e.stack})}q("An unexpected error occurred. Please try again.");re()}finally{if(J.current){J.current=false}}};function ie(){if(P){console.log("User state changed - starting new conversation")}const e=H;G("");S.current.clearChatId();if(e){S.current.clearMessageCache(e)}B([d(n,false)]);O(false);Q.current=true}function le(e){const t=e?.finalMessage||"Your previous conversation has expired. Starting a new conversation...";q(t);const r=H;G("");S.current.clearChatId();if(r){S.current.clearMessageCache(r)}B([d(n,false)]);O(false);setTimeout((()=>{q("")}),5e3)}function ue(){if(J.current){if(P){console.log("Cannot clear - message is being sent")}return}if(P){console.log("Clearing conversation...")}const e=H;k.current.clearRetries();G("");S.current.clearChatId();if(e){S.current.clearMessageCache(e)}B([d(n,false)]);q("");O(false);Q.current=true;if(P){console.log("Conversation cleared. New chat_id will be generated on next message.")}}const de=e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();ce()}};return y({isOpen:R,messages:K,inputValue:T,isTyping:U,errorMessage:N,isInitialConversationLoading:$,isSending:V,setIsOpen:x,setInputValue:D,handleSend:ce,handleKeyDown:de,clearConversation:ue,chatWindowRef:ee,messagesEndRef:te,inputRef:ne,toggleButtonRef:X,config:e,widgetColors:w,isAdmin:I,showTechnicalLogs:P,Message:E,TypingIndicator:_,LoadingSkeleton:b},t)}function P(){const e=g();if(!e){h("AI Chat","Widget root element not found",{expectedId:window.epkbChatWidgetRoot||"epkb-ai-chat-widget-root"});return}if(typeof n.createRoot==="function"){const t=n.createRoot(e);t.render(a(M))}else{n.render(a(M),e)}}if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",P)}else{P()}})();