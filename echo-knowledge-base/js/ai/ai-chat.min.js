(function(){"use strict";const e=window.wp&&window.wp.element;const t=e||window.React;const n=window.ReactDOM;if(!t||!n){window.EPKBChatUtils.logError("AI Chat","React is not available");return}if(!window.EPKBChatAPI||!window.EPKBChatSession||!window.EPKBChatUtils){window.EPKBChatUtils.logError("AI Chat","Required modules not loaded");return}const{useState:s,useEffect:a,useRef:r,createElement:o,memo:c}=t;const{ChatAPIClient:i}=window.EPKBChatAPI;const{SessionManager:l}=window.EPKBChatSession;const{isDebugMode:d,createMessage:u,prepareMessage:g,parseMessageFormatting:f,getChatRootElement:h,logError:p,showErrorMessage:m,createErrorReport:w,TypingIndicator:b,LoadingSkeleton:y,useFocusTrap:_}=window.EPKBChatUtils;const k=b(t);const v=y(t);const C=_(t);const I=c((function e({message:t,isUser:n}){const s=typeof t==="object"&&t!==null?t.text||t.content||String(t):String(t);const a=!n?f(s):s;return o("div",{className:`epkb-ai-chat-message ${n?"epkb-ai-chat-message--user":"epkb-ai-chat-message--assistant"}`},o("div",{className:"epkb-ai-chat-message-bubble"},o("div",{className:"epkb-ai-chat-message-content",...!n&&a!==s?{dangerouslySetInnerHTML:{__html:a}}:{}},!n&&a!==s?null:s)))}),((e,t)=>e.message===t.message&&e.isUser===t.isUser));function S(){const e=window.epkbAIChat||{};const t=e.welcome_message||"Hello! How can I help you today?";const n=(e,t=20)=>{e=e.replace("#","");let n=parseInt(e.substring(0,2),16);let s=parseInt(e.substring(2,4),16);let a=parseInt(e.substring(4,6),16);n=Math.floor(n*(1-t/100));s=Math.floor(s*(1-t/100));a=Math.floor(a*(1-t/100));const r=e=>{const t=e.toString(16);return t.length===1?"0"+t:t};return"#"+r(n)+r(s)+r(a)};const c=e.widget_header_background_color||"#0073aa";const f={launcher:e.launcher_background_color||"#0073aa",header:c,headerGradient:`linear-gradient(135deg, ${c} 0%, ${n(c,20)} 100%)`};const b={generic:e.error_generic_message||"Sorry, something went wrong. Please try again.",network:e.error_network_message||"Connection error. Please check your internet and try again.",timeout:e.error_timeout_message||"The request timed out. Please try again.",rateLimit:e.error_rate_limit_message||"Too many requests. Please wait a moment and try again."};const y=h();const _=y&&y.getAttribute("data-is-admin")==="true";const S=d();const E=_||S;if(S&&!_){console.log("EPKB AI Chat: Debug mode enabled. Technical messages will be shown.");console.log("To disable debug mode, run: epkbEnableDebug(false)")}const M=r(new l);const N=r(new i({rest_url:e.rest_url,rest_nonce:e.rest_nonce,isAdmin:_,debugMode:S}));a((()=>{N.current.setSessionManager(M.current)}),[]);const[P,x]=s(false);const[A,R]=s([u(t,false)]);const[U,T]=s("");const[K,D]=s(false);const[B,O]=s("");const[$,L]=s(false);const[q,F]=s(false);const[j,W]=s(false);const[H,G]=s(e.rest_nonce||"");const[J,Q]=s("");const V=r(e.rest_nonce||"");const Y=r(false);const z=r(false);const X=r("");const Z=r(false);const ee=r(null);const te=r(false);const ne=r(null);const se=r(null);const ae=r(null);a((()=>{V.current=H;N.current.setNonce(H)}),[H]);a((()=>{X.current=J}),[J]);a((()=>{async function e(){const e=M.current.load();if(e.chatId){const t=M.current.loadMessagesFromSessionStorage(e.chatId);if(t&&t.length>0){const n=t.map((e=>u(e.content,e.role==="user",e.id)));R(n);Q(e.chatId);L(true);if(E){console.log(`Loaded ${n.length} messages from cache instantly!`)}return}return}}e()}),[]);a((()=>{if(!P||z.current)return;z.current=true;async function e(){const e=await N.current.startSession();if(!e.success&&E){p("AI Chat","Failed to establish session on chat open",{errorInfo:e.errorInfo})}if(!$){const e=M.current.load();if(e.chatId&&A.length===1){const t=await N.current.getConversation(e.chatId);if(t.success&&t.data){if(t.data.chat_id){Q(t.data.chat_id);M.current.save(null,t.data.chat_id)}if(t.data.messages&&t.data.messages.length>0){const e=t.data.messages.map((e=>u(e.content,e.role==="user",e.id)));R(e);const n=t.data.messages.map((e=>({id:e.id,content:e.content,role:e.role})));M.current.saveMessages(t.data.chat_id,n);if(E){console.log(`Loaded ${e.length} messages from server on chat open`)}}}}L(true)}}e()}),[P,E]);a((()=>{if(se.current){se.current.scrollIntoView({behavior:"smooth"})}}),[A,K]);C(ne,P,(()=>x(false)));a((()=>{if(P){te.current=true;if(ae.current){ae.current.focus()}}else if(te.current){if(ee.current){ee.current.focus()}}}),[P]);a((()=>()=>{Y.current=false;N.current.clearRetries()}),[]);a((()=>{if(J&&A.length>1){const e=A.map((e=>({id:e.messageId,content:e.text,role:e.isUser?"user":"assistant"})));M.current.saveMessages(J,e)}}),[J,A]);function re(){D(false);Y.current=false;W(false)}function oe(e){if(e.new_token){if(E){console.log("Received new token from server")}G(e.new_token);V.current=e.new_token;N.current.setNonce(e.new_token)}}async function ce(e=false){const t=await N.current.refreshNonce(e);if(t){G(t);V.current=t}return t}async function ie(t,n,s=0){if(s>2){re();O("Unable to establish session. Please refresh the page.");return{success:false}}const a=J;if(a&&!a.startsWith("chat_")){if(E){console.warn("Invalid chat ID format:",a)}Q("");M.current.clearChatOnly()}const r=Z.current;if(r){Z.current=false;if(E){console.log("Forcing new conversation for this message")}}const o=await N.current.sendMessageWithRetry(t,n,a,e.widget_id||"1",0,false,r,{onNewToken:oe,onSessionUpdate:e=>{if(a&&X.current!==a){if(E){console.log("Session update ignored - conversation changed")}return}Q(e.chatId);if(e.chatId){L(true)}},onSuccess:e=>{if(a&&X.current!==a){if(E){console.log("Message response ignored - conversation cleared")}re();return}let t;if(typeof e.response==="object"&&e.response!==null){t=e.response.text||e.response.content||JSON.stringify(e.response);if(E){console.log("Response object structure:",e.response)}}else{t=String(e.response)}const n=u(t,false,e.message_id);R((e=>{const t=e.some((e=>e.messageId===n.messageId||!e.isUser&&e.text===n.text&&Math.abs(e.id-n.id)<5e3));if(t){if(E){console.log("Duplicate bot message detected, skipping:",n.messageId)}return e}return[...e,n]}));re()},onInvalidNonce:async()=>{await ce(true)},onTimeoutError:(t,n)=>{re();const s=n?n.finalMessage:e.error_generic||"Unable to connect. Please refresh the page and try again.";O(s)},onRetry:(e,t)=>{if(e>1){D(true)}},onFinalError:async(t,a)=>{if(a&&a.code){if(a.code==="duplicate_request"){if(E){console.log("Duplicate request detected, original request still processing")}return}if(a.code==="user_state_changed"||a.code==="user_mismatch"){re();de();return}if(a.code==="conversation_expired"||a.code==="invalid_chat_id"||a.code==="chat_not_found"){re();ue(a);return}if(a.code==="invalid_session"||a.code==="session_expired"){if(E){console.log("Session expired during message send, creating new session...")}const e=await N.current.startSession();if(e.canceled){re();O("Unable to establish session. Please refresh the page and try again.");return}if(e.success){Q("");M.current.clearChatOnly();await ie(r,n,s+1);return}}}re();let r;if(a){r=a.finalMessage;if(a.type==="rate_limit"&&a.context.retryAfter){r+=` Please try again in ${a.context.retryAfter} seconds.`}if(_&&a.code){p("AI Chat","Message send failed",{type:a.type,code:a.code,statusCode:a.statusCode,context:a.context})}}else{r=e.error_generic||"Unable to connect. Please refresh the page and try again."}O(r)}});return o}const le=async()=>{if(Y.current)return;const e=g(U);if(!e.valid){return}N.current.clearRetries();O("");R((t=>[...t,e.message]));T("");D(true);Y.current=true;W(true);try{await ie(e.text,e.messageId)}catch(e){if(E){p("AI Chat","Unexpected error in handleSend",{error:e.message||e,stack:e.stack})}O("An unexpected error occurred. Please try again.");re()}finally{if(Y.current){Y.current=false}}};function de(){if(E){console.log("User state changed - starting new conversation")}Q("");M.current.clearChatOnly();R([u(t,false)]);L(false);Z.current=true}function ue(e){const n=e?.finalMessage||"Your previous conversation has expired. Starting a new conversation...";O(n);Q("");M.current.clearChatOnly();R([u(t,false)]);L(false);setTimeout((()=>{O("")}),5e3)}function ge(){if(Y.current){if(E){console.log("Cannot clear - message is being sent")}return}if(E){console.log("Clearing conversation...")}const e=J;N.current.clearRetries();Q("");M.current.clearChatOnly();if(e){M.current.clearMessageCache(e)}R([u(t,false)]);O("");L(false);Z.current=true;if(E){console.log("Conversation cleared. New chat_id will be generated on next message.")}}const fe=e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();le()}};function he(){return o("div",{className:"epkb-ai-chat-widget"},P&&o("div",{className:"epkb-ai-chat-window",role:"dialog","aria-modal":"true","aria-label":e.widget_header_title||"AI Assistant",ref:ne},o("div",{className:"epkb-ai-chat-header",style:{background:f.headerGradient}},o("h3",null,e.widget_header_title||"AI Assistant"),o("div",{className:"epkb-ai-chat-header-actions"},A.length>1&&o("button",{onClick:()=>ge(),className:"epkb-ai-chat-new",title:"New Conversation","aria-label":"Start new conversation"},"ðŸ”„"),o("button",{onClick:()=>x(false),className:"epkb-ai-chat-close","aria-label":"Close chat"},"Ã—"))),o("div",{className:"epkb-ai-chat-messages"},q&&A.length===1?o(v):A.map((e=>o(I,{key:e.messageId||e.id,message:e.text,isUser:e.isUser}))),K&&o(k),o("div",{ref:se}),B&&o("div",{id:"epkb-ai-chat-error-container",className:"epkb-ai-chat-error",style:{position:"sticky",bottom:0,marginTop:"10px"},ref:e=>{if(e&&B){const t=window.jQuery;if(t){m({message:B,isAdmin:_&&E,container:t(e),onReport:e=>{const t=w("AI Chat",e,{},U||"N/A");console.log("AI Chat Error Report:\n",t);if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(t).then((()=>{alert("Error report copied to clipboard. Please share with support.")})).catch((()=>{alert("Error report logged to console. Please check console and share with support.")}))}else{alert("Error report logged to console. Please check console and share with support.")}},source:"chat"})}}}})),o("div",{className:"epkb-ai-chat-input-container"},o("div",{className:"epkb-ai-chat-input-wrapper"},o("input",{ref:ae,type:"text",value:U,onChange:e=>T(e.target.value),onKeyDown:fe,placeholder:e.input_placeholder_text||"Type your message...",className:"epkb-ai-chat-input"}),o("button",{onClick:le,className:`epkb-ai-chat-send ${j?"epkb-ai-chat-send--loading":""}`,disabled:!U.trim()||j,"aria-label":j?"Sending message":"Send message"},j?"âŸ³":"âž¤")))),o("button",{onClick:()=>x(!P),className:`epkb-ai-chat-toggle ${P?"epkb-ai-chat-toggle--open":""}`,"aria-label":P?"Close chat":"Open chat",style:{backgroundColor:f.launcher},ref:ee},P?"Ã—":"ðŸ’¬"))}return he()}function E(){const e=h();if(!e){p("AI Chat","Widget root element not found",{expectedId:window.epkbChatWidgetRoot||"epkb-ai-chat-widget-root"});return}if(typeof n.createRoot==="function"){const t=n.createRoot(e);t.render(o(S))}else{n.render(o(S),e)}}if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",E)}else{E()}})();