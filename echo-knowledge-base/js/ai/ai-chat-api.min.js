(function(){"use strict";if(!window.EPKBChatUtils){console.error("ChatAPIClient: EPKBChatUtils not loaded");return}const{isInvalidNonceError:e,parseErrorResponse:s,generateIdempotencyKey:t,prepareMessage:n,createHeaders:r,createFetchOptions:o}=window.EPKBChatUtils;class i{constructor(e){this.config=e||{};this.baseUrl=this.config.rest_url||"/wp-json";this.restNonce=this.config.rest_nonce||"";this.isAdmin=this.config.isAdmin||false;this.debugMode=this.config.debugMode||false;this.showTechnicalLogs=this.isAdmin||this.debugMode;this.sessionManager=null;this.retryTimeoutRef=null;if(this.showTechnicalLogs){if(!e){console.warn("ChatAPIClient: No configuration provided, using defaults")}if(!this.restNonce){console.warn("ChatAPIClient: No REST nonce provided, authentication may fail")}}}setSessionManager(e){if(!e&&this.showTechnicalLogs){console.warn("Session manager is null or undefined")}this.sessionManager=e}setNonce(e){this.restNonce=e}getNonce(){return this.restNonce}async refreshNonce(e=false){if(!e&&this.restNonce){return this.restNonce}const s=await this.startSession();if(s.success&&s.data.rest_nonce){return s.data.rest_nonce}return this.restNonce}async startSession(){try{const e=await fetch(`${this.baseUrl}epkb-public/v1/ai-chat/start-session`,o("POST",{},3e3,this.restNonce));if(!e.ok){const t=await e.json().catch((()=>({})));throw s(new Error("Failed to start session"),{status:e.status,data:t},this.isAdmin)}const t=await e.json();if(t.rest_nonce){this.restNonce=t.rest_nonce}return{success:true,data:t}}catch(e){const t=e.type?e:s(e,null,this.isAdmin);if(this.showTechnicalLogs){console.error("Failed to start session:",t)}if(e.name==="AbortError"||t.type==="timeout"){return{success:false,errorInfo:t,canceled:true}}return{success:false,errorInfo:t}}}async sendMessageWithRetry(e,n=null,r=null,o="1",i=0,a=false,c=false,l={}){try{const s=15e3+i*5e3;if(!n){n=t()}const u=await this.sendMessage(e,n,r,o,s,c);if(!u.success){if(u.invalidNonce&&!a&&l.onInvalidNonce){if(this.showTechnicalLogs){console.log("Invalid nonce detected, refreshing and retrying...")}await l.onInvalidNonce();return this.sendMessageWithRetry(e,n,r,o,i,true,c,l)}if(u.invalidNonce&&a&&u.errorInfo){if(l.onFinalError){l.onFinalError(new Error("Session expired"),u.errorInfo)}return{success:false,errorInfo:u.errorInfo}}const s=new Error(u.errorInfo?u.errorInfo.finalMessage:"Failed to get response");if(u.errorInfo){s.errorInfo=u.errorInfo;s.code=u.errorInfo.code}throw s}const h=u.data;if(h.new_token&&l.onNewToken){l.onNewToken(h)}if(this.sessionManager){const e=this.sessionManager.updateFromResponse(h);if(e){const e=this.sessionManager.getSessionInfo();if(l.onSessionUpdate){l.onSessionUpdate(e)}}}else{if(this.showTechnicalLogs){console.warn("Session manager not available for update")}}if(l.onSuccess){l.onSuccess(h)}return{success:true,data:h}}catch(t){const u=t.errorInfo||s(t,null,this.isAdmin);if(this.showTechnicalLogs){console.error("Chat error:",u)}if(this.showTechnicalLogs&&u.code){console.log(`Chat error code: ${u.code}, will retry: ${u.isRetryable}`)}const h=u.type==="timeout"?2:3;if(i<h&&u.isRetryable&&!a){const s=Math.pow(2,i)*1e3;if(l.onRetry){l.onRetry(i+1,s)}if(this.retryTimeoutRef){clearTimeout(this.retryTimeoutRef)}return new Promise((t=>{this.retryTimeoutRef=setTimeout((()=>{t(this.sendMessageWithRetry(e,n,r,o,i+1,false,c,l))}),s)}))}else{if(u.type==="timeout"&&!this.isAdmin&&l.onTimeoutError){l.onTimeoutError(t,u)}if(l.onFinalError){l.onFinalError(t,u)}return{success:false,errorInfo:u}}}}async sendMessage(t,n,r=null,i="1",a=3e4,c=false){const l={message:t,idempotency_key:n,widget_id:i};if(r){l.chat_id=r}if(c){l.force_new_conversation=true}try{const t=await fetch(`${this.baseUrl}epkb-public/v1/ai-chat/send-message`,o("POST",l,a,this.restNonce));const n=await t.json();if(n.new_token){this.restNonce=n.new_token}if(!t.ok){const r=s(new Error(n.message||"Failed to get response"),{status:t.status,data:n},this.isAdmin);return{success:false,invalidNonce:e(t,n),errorInfo:r}}return{success:true,data:n}}catch(e){const t=s(e,null,this.isAdmin);return{success:false,errorInfo:t}}}async getConversation(t=null){try{const n=new URL(`${this.baseUrl}epkb-public/v1/ai-chat/conversation`);if(t){n.searchParams.append("chat_id",t)}const r=await fetch(n.toString(),o("GET",null,1e4,this.restNonce));const i=await r.json();if(i.new_token){this.restNonce=i.new_token}if(!r.ok){const t=s(new Error(i.message||"Failed to get active conversation"),{status:r.status,data:i},this.isAdmin);const n={success:false,errorInfo:t,action:"continue",userMessage:null,shouldRetry:false,needsNonceRefresh:false};if(e(r,i)||t.code==="invalid_nonce"){n.needsNonceRefresh=true;n.shouldRetry=true;n.action="refresh_nonce";return n}if(t.code==="invalid_session"||t.code==="session_expired"){n.action="create_new_session";n.userMessage=null;return n}if(t.code==="conversation_expired"||t.code==="invalid_chat_id"||t.code==="chat_not_found"||t.code==="not_found"||t.statusCode===404){n.action="expired";n.userMessage="Your previous conversation has expired. Starting a new conversation...";return n}if(t.type==="rate_limit"){const e=t.context&&t.context.retryAfter?t.context.retryAfter:60;n.action="show_error";n.userMessage=`Too many requests. Please try again in ${e} seconds.`;return n}if(t.statusCode>=500){n.action="show_error";n.userMessage="Service temporarily unavailable. Please try again later.";return n}if(t.type==="timeout"||t.type==="network"){n.action="continue";if(this.showTechnicalLogs){console.warn("Network issue when checking active conversation")}return n}return n}return{success:true,data:i,action:"success"}}catch(e){const t=s(e,null,this.isAdmin);if(t.type==="network"||t.type==="timeout"){return{success:false,errorInfo:t,action:"continue",userMessage:null}}return{success:false,errorInfo:t,action:"continue",userMessage:null}}}async clearConversation(){try{const t=await fetch(`${this.baseUrl}epkb-public/v1/ai-chat/clear`,o("POST",{},1e4,this.restNonce));const n=await t.json();if(n.new_token){this.restNonce=n.new_token}if(!t.ok){const r=s(new Error(n.message||"Failed to clear conversation"),{status:t.status,data:n},this.isAdmin);const o={success:false,errorInfo:r,action:"show_error",userMessage:"Failed to start new conversation. Please try again.",shouldRetry:false,needsNonceRefresh:false};if(e(t,n)||r.code==="invalid_nonce"){o.needsNonceRefresh=true;o.shouldRetry=true;o.action="refresh_nonce";return o}if(r.code==="invalid_session"||r.code==="session_expired"){o.action="create_new_session";o.userMessage=null;return o}if(r.statusCode>=500){o.userMessage="Service temporarily unavailable. Please try again later.";return o}return o}return{success:true,data:n,action:"success"}}catch(e){const t=s(e,null,this.isAdmin);return{success:false,errorInfo:t,action:"show_error",userMessage:"Failed to start new conversation. Please try again."}}}clearRetries(){if(this.retryTimeoutRef){clearTimeout(this.retryTimeoutRef);this.retryTimeoutRef=null}}}window.EPKBChatAPI={ChatAPIClient:i}})();