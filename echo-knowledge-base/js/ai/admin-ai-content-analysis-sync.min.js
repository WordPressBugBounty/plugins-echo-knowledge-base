(function(){"use strict";const{useState:e,useEffect:t,useCallback:s,useRef:a,createContext:r,useContext:n,createElement:o}=wp.element;const{__:l}=wp.i18n;const{showError:c,showSuccess:i,makeApiRequest:d}=window.EPKB_AI_Util_React||{};const{logError:p}=window.EPKBChatUtils||{};const u=r({analysisJob:{status:"idle",total:0,processed:0,percent:0,errors:0,type:"analysis"},analysisItems:[],setAnalysisItems:()=>{},showAnalysisProgress:false,setShowAnalysisProgress:()=>{},setAnalysisJob:()=>{},cancelAnalysisJob:()=>{},cleanupAnalysis:()=>{},setStopAnalysisPolling:()=>{},registerArticleUpdateHandler:()=>{},unregisterArticleUpdateHandler:()=>{},notifyAllArticleHandlers:()=>{}});window.EPKB_AI_ContentAnalysisSyncContext=u;window.EPKB_AI_ContentAnalysisSyncProvider=({children:r})=>{const[n,y]=e({status:"idle",total:0,processed:0,percent:0,errors:0,type:"analysis"});const[_,f]=e([]);const[b,h]=e(false);const k=a(null);const A=a([]);const S=s((e=>{if(typeof e==="function"){A.current.push(e)}}),[]);const w=s((e=>{A.current=A.current.filter((t=>t!==e))}),[]);const I=s((e=>{A.current.forEach((t=>{try{t(e)}catch(e){p("AI Content Analysis","Error calling article update handler",{message:e?.message||"Unknown error"})}}))}),[]);const v=s(((e="unknown",t=true,s=false)=>{if(k.current&&typeof k.current==="function"){k.current();k.current=null}y({status:"idle",total:0,processed:0,percent:0,errors:0,type:"analysis"});h(false);try{localStorage.removeItem("epkb_analysis_batch_state");localStorage.removeItem("epkb_analysis_in_progress");localStorage.removeItem("epkb_analysis_completed")}catch(e){}if(s){f([])}if(t){switch(e){case"canceled":i(l("Analysis canceled","echo-knowledge-base"));break;case"no_articles":c(l("No articles found to analyze","echo-knowledge-base"));break;case"error":break;case"completed":break}}}),[]);const C=s((async()=>{try{await d("content-analysis-cancel",{method:"POST"});v("canceled",true)}catch(e){c(l("Failed to cancel analysis","echo-knowledge-base"));v("canceled",false)}}),[v]);t((()=>{const e=()=>{try{const e=localStorage.getItem("epkb_analysis_batch_state");if(e){const t=JSON.parse(e);if(t.status==="failed"||t.status==="completed"||t.failed_at){localStorage.removeItem("epkb_analysis_batch_state");localStorage.removeItem("epkb_analysis_in_progress");localStorage.removeItem("epkb_analysis_completed");return false}if(t&&(t.status==="running"||t.status==="scheduled")){const e=Date.now();const s=60*60*1e3;if(t.started_at&&e-t.started_at<s){y(t);h(true);return true}else{localStorage.removeItem("epkb_analysis_batch_state");localStorage.removeItem("epkb_analysis_in_progress");localStorage.removeItem("epkb_analysis_completed")}}}}catch(e){}return false};const t=e();const s=async()=>{let e=null;let t=[];try{const s=localStorage.getItem("epkb_analysis_batch_state");if(s){e=JSON.parse(s)}const a=localStorage.getItem("epkb_analysis_in_progress");if(a){t=JSON.parse(a)}}catch(e){}if(e&&(e.status==="running"||e.status==="scheduled")){const s=Date.now();const a=60*60*1e3;if(e.started_at&&s-e.started_at<a){y(e);h(true);if(t.length>0){let e=[];try{const t=localStorage.getItem("epkb_analysis_completed");if(t){e=JSON.parse(t)}}catch(e){}const s=t.filter((t=>!e.includes(t)));const a=s.map((e=>({id:e,status:"analyzing",analyzed_at:"In Progress"})));f(a);setTimeout((()=>{A.current.forEach((e=>{try{e(a)}catch(e){p("AI Content Analysis","Error calling article update handler",{message:e?.message||"Unknown error"})}}))}),1e3)}}else{localStorage.removeItem("epkb_analysis_batch_state");localStorage.removeItem("epkb_analysis_in_progress");localStorage.removeItem("epkb_analysis_completed")}}try{const e=await d("content-analysis-progress",{method:"GET"});const t=e.progress||{};if(t.cancel_requested||t.status==="canceled"){localStorage.removeItem("epkb_analysis_batch_state");localStorage.removeItem("epkb_analysis_in_progress");localStorage.removeItem("epkb_analysis_completed");return}if(t.status==="running"||t.status==="scheduled"){y({status:t.status,total:t.total||0,processed:t.processed||0,percent:t.percent||0,errors:t.errors||0,type:"analysis"});h(true);if(t.article_ids&&Array.isArray(t.article_ids)){const e=t.processed_ids||[];const s=t.current_processing_id;const a=t.article_ids.filter((t=>!e.includes(t)));const r=a.map((e=>({id:e,status:e===s?"analyzing":"pending",analyzed_at:e===s?"In Progress":"Queued"})));f(r);setTimeout((()=>{if(r.length>0){A.current.forEach((e=>{try{e(r)}catch(e){p("AI Content Analysis","Error calling article update handler",{message:e?.message||"Unknown error"})}}))}}),2e3)}if(k.current&&typeof k.current==="function"){k.current()}const e=e=>{A.current.forEach((t=>{try{t(e)}catch(e){p("AI Content Analysis","Error calling article update handler",{message:e?.message||"Unknown error"})}}));if(Array.isArray(e)){f((t=>{const s=new Map((t||[]).map((e=>[String(e.id),e])));e.forEach((e=>{const t=String(e.id);const a=s.get(t)||{id:e.id};s.set(t,{...a,id:e.id,status:e.status||a.status,score:e.score!==undefined?e.score:a.score,importance:e.importance!==undefined?e.importance:a.importance,analyzed_at:e.analyzed_at||a.analyzed_at,error_message:e.error_message||e.message||a.error_message})}));return Array.from(s.values())}))}};const s=e=>{if(!e||e.length===0)return;const t="epkb_content_analysis_cache_analysis_results_cache";let s={};try{const e=localStorage.getItem(t);if(e){s=JSON.parse(e).value||{}}}catch(e){}e.forEach((e=>{const t=String(e.id);s[t]={id:e.id,score:e.score,importance:e.importance,scoreComponents:e.scoreComponents,status:e.status,analyzed_at:e.analyzed_at,error_message:e.error_message||e.message,cached_at:Date.now()}}));try{localStorage.setItem(t,JSON.stringify({value:s,timestamp:Date.now()}))}catch(e){}};const a=m(y,e,s,true);const r=g(y,h);k.current=()=>{a();r()}}}catch(e){if(e.status===404||e.code==="rest_no_route"){p("AI Content Analysis","Content Analysis API endpoints not yet implemented",{message:"The Content Analysis feature requires backend API endpoints to be implemented.",status:e.status,code:e.code})}}};s();return()=>{if(k.current&&typeof k.current==="function"){k.current()}}}),[]);const E=s((e=>{if(k.current&&typeof k.current==="function"){k.current()}k.current=e}),[]);t((()=>{const e=()=>{if(n.status==="running"){const e=`${window.epkb_ai_api?.rest_url||"/wp-json/"}epkb-admin/v1/content-analysis-cancel`;const t=JSON.stringify({});if(navigator.sendBeacon){const s=new Blob([t],{type:"application/json"});navigator.sendBeacon(e,s)}else{const s=new XMLHttpRequest;s.open("POST",e,false);s.setRequestHeader("Content-Type","application/json");s.setRequestHeader("X-WP-Nonce",window.epkb_ai_api?.nonce||"");s.send(t)}}};window.addEventListener("beforeunload",e);return()=>{window.removeEventListener("beforeunload",e)}}),[n.status]);return o(u.Provider,{value:{analysisJob:n,setAnalysisJob:y,analysisItems:_,setAnalysisItems:f,showAnalysisProgress:b,setShowAnalysisProgress:h,cancelAnalysisJob:C,cleanupAnalysis:v,setStopAnalysisPolling:E,registerArticleUpdateHandler:S,unregisterArticleUpdateHandler:w,notifyAllArticleHandlers:I}},r)};const y=()=>{const e=n(u);if(!e){throw new Error("useContentAnalysisSyncContext must be used within ContentAnalysisSyncProvider")}return e};const g=(e,t)=>{let s=false;let a=null;async function r(){if(s)return;try{const n=await d("content-analysis-progress",{method:"GET"});const o=n.progress||{};e((e=>{if(e.status!==o.status||e.processed!==o.processed||e.percent!==o.percent||e.errors!==o.errors){const e={status:o.status||"idle",total:o.total||0,processed:o.processed||0,percent:o.percent||0,errors:o.errors||0,type:"analysis",retrying:o.retrying||false};try{const t=localStorage.getItem("epkb_analysis_batch_state");if(t){const s=JSON.parse(t);localStorage.setItem("epkb_analysis_batch_state",JSON.stringify({...s,...e,updated_at:Date.now()}))}}catch(e){}return e}return e}));if(o.status==="canceled"||o.status==="idle"){s=true;if(a){clearTimeout(a);a=null}e({status:"idle",total:0,processed:0,percent:0,errors:0,type:"analysis"});if(t){t(false)}return}if(o.status==="completed"){s=true;if(a){clearTimeout(a);a=null}const r={status:"completed",total:o.total||0,processed:o.processed||o.total||0,percent:100,errors:o.errors||0,type:"analysis"};e(r);try{localStorage.setItem("epkb_analysis_batch_state",JSON.stringify({...r,completed_at:Date.now()}))}catch(e){}setTimeout((()=>{e({status:"idle",total:0,processed:0,percent:0,errors:0,type:"analysis"});if(t){t(false)}try{localStorage.removeItem("epkb_analysis_batch_state");localStorage.removeItem("epkb_analysis_in_progress");localStorage.removeItem("epkb_analysis_completed")}catch(e){}}),5e3);return}if(o.status==="running"||o.status==="scheduled"){if(!s){a=setTimeout(r,3e3)}}}catch(e){if(e.name!=="AbortError"&&!s){p("AI Content Analysis","Status polling failed",{message:e.message||"Unknown error",code:e.code})}}}r();return()=>{s=true;if(a){clearTimeout(a);a=null}}};const m=(e,t,s,a=false)=>{let r=false;let n=null;let o=0;const u=3;async function y(){if(r)return;try{const a=await d("content-analysis-process-next",{method:"POST"});if(!a.success){o++;if(o>=u){c(l("Analysis stopped due to consecutive errors","echo-knowledge-base"));r=true;const t={status:"failed",total:0,processed:0,percent:0,errors:o,type:"analysis"};e(t);try{localStorage.setItem("epkb_analysis_batch_state",JSON.stringify({...t,failed_at:Date.now()}));setTimeout((()=>{localStorage.removeItem("epkb_analysis_batch_state");localStorage.removeItem("epkb_analysis_in_progress");localStorage.removeItem("epkb_analysis_completed")}),2e3)}catch(e){}return}if(!r){p("AI Content Analysis","Process next failed",{message:a.message||"Unknown error",status:a.status,code:a.code});n=setTimeout(y,3e3)}return}o=0;if(a.progress){const s={status:a.progress.status||"idle",total:a.progress.total||0,processed:a.progress.processed||0,percent:a.progress.percent||0,errors:a.progress.errors||0,type:"analysis",retrying:a.progress.retrying||false,currentArticle:a.current_article||null};e(s);try{const e=localStorage.getItem("epkb_analysis_batch_state");const t=localStorage.getItem("epkb_analysis_in_progress");const a=e?JSON.parse(e):{};const r=t?JSON.parse(t):[];localStorage.setItem("epkb_analysis_batch_state",JSON.stringify({...a,...s,article_ids:r.length>0?r:a.article_ids,updated_at:Date.now()}))}catch(e){}if(a.next_article_id&&t){const e=[{id:a.next_article_id,status:"analyzing",analyzed_at:"In Progress"}];t(e)}}if(a.status==="canceled"||a.status==="idle"||a.progress&&(a.progress.status==="canceled"||a.progress.status==="idle")){r=true;e({status:"idle",total:0,processed:0,percent:0,errors:0,type:"analysis"});return}if(a.status==="failed"&&a.message){c(a.message);r=true;e({status:"failed",total:a.progress?.total||0,processed:a.progress?.processed||0,percent:a.progress?.percent||0,errors:a.progress?.errors||0,type:"analysis"});return}if(a.analyzed_articles&&a.analyzed_articles.length>0){const e=a.analyzed_articles.map((e=>{if(e.status==="error"){return{id:e.id,status:"error",message:e.message||l("Unknown error occurred","echo-knowledge-base"),score:"-",importance:"N/A",scoreComponents:[{name:"Tags Usage",value:"-"},{name:"Score 2",value:"-"},{name:"Score 3",value:"-"}],analyzed_at:"Error",error_code:e.error_code}}else{return{id:e.id,title:e.title,score:e.score!==undefined?e.score:0,importance:e.importance!==undefined?e.importance:0,scoreComponents:e.scoreComponents||[{name:"Tags Usage",value:e.tags_usage||"-"},{name:"Score 2",value:"-"},{name:"Score 3",value:"-"}],status:e.status||"analyzed",analyzed_at:e.analyzed_at||(new Date).toISOString(),recommendations:e.recommendations||[]}}}));if(t){t(e)}if(s){s(e)}try{const t="epkb_content_analysis_cache_analysis_results_cache";let s={};const a=localStorage.getItem(t);if(a){const e=JSON.parse(a);s=e.value||{}}e.forEach((e=>{s[String(e.id)]={id:e.id,score:e.score,importance:e.importance,scoreComponents:e.scoreComponents,status:e.status,analyzed_at:e.analyzed_at,error_message:e.message,cached_at:Date.now()}}));localStorage.setItem(t,JSON.stringify({value:s,timestamp:Date.now()}));const r=localStorage.getItem("epkb_analysis_completed");let n=r?JSON.parse(r):[];const o=e.map((e=>String(e.id)));o.forEach((e=>{if(!n.includes(e)){n.push(e)}}));localStorage.setItem("epkb_analysis_completed",JSON.stringify(n))}catch(e){}}if(a.status==="completed"||a.progress&&a.progress.status==="completed"){r=true;e({status:"completed",total:a.progress?.total||0,processed:a.progress?.processed||a.progress?.total||0,percent:100,errors:a.progress?.errors||0,type:"analysis"});i(l("Content analysis completed successfully!","echo-knowledge-base"));setAnalysisItems([]);try{localStorage.removeItem("epkb_analysis_batch_state");localStorage.removeItem("epkb_analysis_in_progress");localStorage.removeItem("epkb_analysis_completed")}catch(e){}setTimeout((()=>{e({status:"idle",total:0,processed:0,percent:0,errors:0,type:"analysis"});setAnalysisItems([])}),5e3);return}const g=a.status==="running"||a.progress&&a.progress.status==="running";const m=a.progress&&a.progress.total>0&&a.progress.processed<a.progress.total;if((g||m)&&!r){n=setTimeout(y,1e3)}}catch(t){if(t.name!=="AbortError"&&!r){if(!a||o>0){o++}if(o>=u){c(l("Analysis stopped due to consecutive errors","echo-knowledge-base"));r=true;const t={status:"failed",total:0,processed:0,percent:0,errors:o,type:"analysis"};e(t);try{localStorage.setItem("epkb_analysis_batch_state",JSON.stringify({...t,failed_at:Date.now()}));setTimeout((()=>{localStorage.removeItem("epkb_analysis_batch_state");localStorage.removeItem("epkb_analysis_in_progress");localStorage.removeItem("epkb_analysis_completed")}),2e3)}catch(e){}return}if(t.code!=="fetch_error"||o>1){p("AI Content Analysis","Process next error",{message:t.message||"Unknown error",code:t.code,status:t.status})}const s=a&&o===0?8e3:5e3;n=setTimeout(y,s)}}}if(a){n=setTimeout(y,3e3)}else{y()}return()=>{r=true;if(n){clearTimeout(n);n=null}}};const _=async(e,t,s,a,r,n)=>{try{const o=await d("start-direct-analysis",{method:"POST",data:{article_ids:e}});if(o.success){t({status:"running",total:o.total||(typeof e==="string"?0:e.length),processed:0,percent:0,errors:0,type:"analysis"});const a=m(t,s,n);const l=g(t,r);return()=>{a();l()}}else{const e=o.error==="no_articles"?"no_articles":"error";if(e==="error"){c(o.message||l("Failed to start analysis","echo-knowledge-base"))}a(e,e==="no_articles");return null}}catch(e){if(e.status===404||e.code==="rest_no_route"){c(l("Content Analysis feature is not yet fully implemented. Backend API endpoints are required.","echo-knowledge-base"));p("AI Content Analysis","API endpoints not implemented",{message:"The Content Analysis start endpoint is not available.",status:e.status,code:e.code})}else{c(e.message||l("Failed to start analysis","echo-knowledge-base"))}a("error",false);throw e}};window.EPKB_AI_ContentAnalysisControls=({selectedArticleIds:t=[],disabled:a=false,onArticleUpdate:r,onAnalysisStart:n=null,isSelectAllActive:c=false,updateCacheCallback:i=null})=>{const d=y();const{analysisJob:p,setAnalysisJob:u,setAnalysisItems:g,setShowAnalysisProgress:m,cancelAnalysisJob:f,cleanupAnalysis:b,setStopAnalysisPolling:h,notifyAllArticleHandlers:k}=d;const[A,S]=e(false);const w=s((async()=>{S(true);m(true);const e={status:"running",total:typeof t==="string"?0:t.length,processed:0,percent:0,errors:0,type:"analysis",started_at:Date.now(),article_ids:t};u(e);try{localStorage.setItem("epkb_analysis_batch_state",JSON.stringify(e));if(typeof t!=="string"){localStorage.setItem("epkb_analysis_in_progress",JSON.stringify(t));localStorage.setItem("epkb_analysis_completed",JSON.stringify([]))}}catch(e){}if(n){n()}if(typeof t!=="string"&&t.length>0){const e=t.map(((e,t)=>({id:e,status:"analyzing",analyzed_at:t===0?"Processing...":"Queued"})));g(e);if(r){r(e)}if(k){k(e)}}try{const e=e=>{if(r){r(e)}if(k){k(e)}if(Array.isArray(e)){g((t=>{const s=new Map((t||[]).map((e=>[String(e.id),e])));e.forEach((e=>{const t=String(e.id);const a=s.get(t)||{id:e.id};s.set(t,{...a,id:e.id,status:e.status||a.status,score:e.score!==undefined?e.score:a.score,importance:e.importance!==undefined?e.importance:a.importance,analyzed_at:e.analyzed_at||a.analyzed_at,error_message:e.error_message||e.message||a.error_message})}));return Array.from(s.values())}))}};const s=typeof t==="string"?t:[...t];const a=await _(s,u,e,b,m,i);if(a){h(a)}else{if(typeof t!=="string"){const e=t.map((e=>({id:e,status:"not_analyzed",analyzed_at:null})));if(r){r(e)}if(k){k(e)}}}}catch(e){if(typeof t!=="string"){const e=t.map((e=>({id:e,status:"not_analyzed",analyzed_at:null})));if(r){r(e)}if(k){k(e)}}}finally{S(false)}}),[t,u,g,m,r,n,h,b,k,i]);const I=p.status==="running"||p.status==="scheduled";const v=!a&&(typeof t==="string"||t.length>0)&&!I&&!A;return o("div",{className:"epkb-ai-analysis-controls"},o("div",{className:"epkb-ai-form-group"},o("div",{className:"epkb-ai-selected-records-count"},`${typeof t==="string"?"All":t.length} ${l("articles selected for analysis","echo-knowledge-base")}`)),o("div",{className:"epkb-ai-analysis-buttons"},I?o("div",{style:{display:"flex",gap:"10px",flexDirection:"column"}},o("button",{className:"epkb-ai-button epkb-ai-button-primary disabled",disabled:true,style:{cursor:"not-allowed",background:"linear-gradient(135deg, #667EEA 0%, #764BA2 100%)",color:"#FFFFFF",opacity:.6}},l("Analysis in Progress","echo-knowledge-base")),o("button",{className:"epkb-ai-button epkb-ai-button-danger",onClick:f,style:{backgroundColor:"#d63638",borderColor:"#d63638",color:"#fff"}},l("Stop Analysis","echo-knowledge-base"))):o("button",{className:`epkb-ai-button epkb-ai-button-primary ${!v?"disabled":""}`,onClick:w,disabled:!v,style:{background:v?"linear-gradient(135deg, #667EEA 0%, #764BA2 100%)":"#ccc",color:"#FFFFFF",boxShadow:v?"0 4px 12px rgba(102, 126, 234, 0.3)":"none",opacity:v?1:.6}},l("Analyze Content","echo-knowledge-base"))))};window.EPKB_AI_ContentAnalysisProgressBar=()=>{const{analysisJob:e}=y();if(e.status==="idle")return null;let t="";if(e.status==="running"){if(e.total===0){t=l("Starting analysis...","echo-knowledge-base")}else if(e.retrying){t=`${l("Retrying failed articles:","echo-knowledge-base")} ${e.processed} ${l("of","echo-knowledge-base")} ${e.total}...`}else{t=`${l("Analyzing","echo-knowledge-base")} ${e.processed} ${l("of","echo-knowledge-base")} ${e.total} ${l("articles","echo-knowledge-base")}...`}}else if(e.status==="completed"){t=`${l("Completed! Analyzed","echo-knowledge-base")} ${e.processed} ${l("articles","echo-knowledge-base")}`;if(e.errors>0){t+=` ${l("with","echo-knowledge-base")} ${e.errors} ${l("errors","echo-knowledge-base")}`}}else if(e.status==="failed"){t=`${l("Analysis stopped after errors. Analyzed","echo-knowledge-base")} ${e.processed} ${l("of","echo-knowledge-base")} ${e.total} ${l("articles","echo-knowledge-base")}`}else if(e.status==="scheduled"){t=l("Analysis scheduled, waiting to start...","echo-knowledge-base")}else if(e.status==="canceled"){t=l("Analysis canceled","echo-knowledge-base")}return o("div",{className:"epkb-ai-analysis-progress"},o("div",{className:"epkb-ai-progress-bar"},o("div",{className:"epkb-ai-progress-fill",style:{width:`${e.percent}%`,background:"linear-gradient(90deg, #667EEA 0%, #764BA2 100%)"}}),o("span",{className:"epkb-ai-progress-percentage"},`${e.percent}%`)),t&&o("p",{className:"epkb-ai-progress-message",style:e.status==="failed"?{color:"#d54e21"}:{}},t))};window.EPKB_AI_ContentAnalysisSync={startContentAnalysis:_,pollAnalysisStatus:g,processAnalysisBatch:m,useContentAnalysisSyncContext:y}})();