(function(){"use strict";const{useState:e,useEffect:t,useCallback:a,createElement:s,Fragment:n,useContext:l,useRef:o,useMemo:c}=wp.element;const{__:i}=wp.i18n;const{showError:d,showSuccess:r,makeApiRequest:g,showConfirmDialog:u,formatServerDateTime:p,useTableSearch:b}=window.EPKB_AI_Util_React||{};const{useSyncContext:h}=window.EPKB_AI_Sync||{};const k=()=>{try{const e=l(window.EPKB_AI_TrainingDataCacheContext);return e||null}catch(e){return null}};const f=({collectionId:l,collectionName:h="",hasApiKey:f=true,onSelectedIdsChange:m,onBulkDeleteCallback:w,onSelectAllCallback:y,onTotalItemsChange:N,onTrainingDataChange:_,refreshTrigger:S=0,syncProgress:v=null,isSyncing:C=false,onFilterStateChange:D,onUpdateRowsCallback:x,initialStats:$=null,onStatsUpdate:A=null,selectedIds:T=null})=>{const[P,I]=e([]);const[E,R]=e([]);const L=T!==null?T:E;const[O,F]=e((()=>{if($&&Object.keys($).length>0){return{added:0,updated:0,outdated:0,error:0,pending:0,...$}}return{added:0,updated:0,outdated:0,error:0,pending:0}}));const[U,B]=e(true);const[j,K]=e(1);const[q,M]=e(1);const[z,J]=e(false);const[Z,G]=e(new Set);const[H,Q]=e(new Set);const V=20;const[W,X]=e([]);const[Y,ee]=e([]);const[te,ae]=e(null);const[se,ne]=e("asc");const[le,oe]=e(false);const[ce,ie]=e(false);const[de,re]=e([]);const[ge,ue]=e(false);const pe=a((async()=>{ue(true);try{const e=await g("training-data",{params:{collection_id:l,page:1,per_page:100}});if(e.success){let t=[...e.data||[]];const a=e.pagination?.total_pages||1;for(let e=2;e<=a;e++){const a=await g("training-data",{params:{collection_id:l,page:e,per_page:100}});if(a.success&&a.data){t=[...t,...a.data]}}re(t);return t}}catch(e){console.error("Failed to fetch all data for filtering:",e);throw e}finally{ue(false)}return[]}),[l]);const be=a((async e=>{if(!e)return null;if(ge)return null;if(de.length>0){return de}try{const e=await pe();return e}catch(e){console.error("Server search failed:",e);return null}}),[pe,ge,de]);const{searchTerm:he,displayedData:ke,isSearching:fe,searchMessage:me,handleSearchChange:we,clearSearch:ye}=b({data:P,allData:de.length>0?de:null,onServerSearch:be,searchFields:["title","type","item_type","url","item_id"]});const Ne=a((()=>he||W.length>0||Y.length>0),[he,W,Y]);const _e=a((()=>{let e;if(W.length>0||Y.length>0){e=de.length>0?de:ke;console.log(`Filters active. Using ${de.length>0?"allData":"displayedData"} with ${e.length} items`)}else{e=ke}let t=[...e];if((W.length>0||Y.length>0)&&de.length>0&&he){const e=he.toLowerCase();t=t.filter((t=>t.title&&t.title.toLowerCase().includes(e)||t.type&&t.type.toLowerCase().includes(e)||t.item_type&&t.item_type.toLowerCase().includes(e)||t.url&&t.url.toLowerCase().includes(e)||t.item_id&&t.item_id.toString().includes(e)))}if(W.length>0){t=t.filter((e=>e.status&&W.includes(e.status)))}if(Y.length>0){t=t.filter((e=>Y.includes(e.item_type)))}if(te){t.sort(((e,t)=>{let a=e[te];let s=t[te];if(te==="item_id"){a=parseInt(a)||0;s=parseInt(s)||0}if(te==="last_synced"){a=new Date(a||0).getTime();s=new Date(s||0).getTime()}if(a<s)return se==="asc"?-1:1;if(a>s)return se==="asc"?1:-1;return 0}))}return t}),[ke,de,W,Y,te,se,he]);const Se=a((()=>{const e=_e();if(!Ne()){return e}const t=(j-1)*V;return e.slice(t,t+V)}),[_e,j,V,Ne]);const ve=a((()=>{if(Ne()){const e=_e();return Math.ceil(e.length/V)}return q}),[_e,Ne,V,q]);const Ce=k();const De=a((()=>`collection_${l}_page_${j}`),[l,j]);const xe=a((e=>{I((t=>t.map((t=>{if(e.includes(t.item_id)){return{...t,status:"updated",last_synced:(new Date).toISOString().replace("T"," ").replace(/\.\d{3}Z$/,"")}}return t}))));G(new Set(e));R([]);setTimeout((()=>{G(new Set)}),3e3);if(Ce){const t=De();const a=Ce.get(t);if(a&&a.data){const s=a.data.map((t=>{if(t&&e.includes(t.item_id)){return{...t,status:"updated",last_synced:(new Date).toISOString().replace("T"," ").replace(/\.\d{3}Z$/,"")}}return t}));Ce.set(t,{...a,data:s,timestamp:Date.now()})}}}),[De,Ce]);t((()=>{if(x){x((()=>xe))}}),[x,xe]);t((()=>{K(1);if(W.length===0&&Y.length===0&&!he){re([])}}),[W,Y,he]);t((()=>()=>{re([])}),[]);const $e=a((async(e=false)=>{const t=De();if(!e&&Ce){const e=Ce.get(t);if(e&&e.data&&e.totalPages!==undefined){I(e.data);M(e.totalPages);if(_){_(e.data)}B(false);g("training-data",{params:{collection_id:l,page:j,per_page:V}}).then((a=>{if(a.success){if(a.status_counts){F({added:0,updated:0,outdated:0,error:0,pending:0,...a.status_counts})}const s=a.pagination?Number(a.pagination.total_pages):1;if(s!==e.totalPages){M(s)}if(a.data){const n=a.data;const l=JSON.stringify(e.data);const o=JSON.stringify(n);if(l!==o){I(n);if(Ce){Ce.set(t,{data:n,totalPages:s,timestamp:Date.now()})}if(_){_(n)}}else if(s!==e.totalPages){if(Ce){Ce.set(t,{data:e.data,totalPages:s,timestamp:Date.now()})}}}}})).catch((()=>{}));return}}B(true);try{const e=await g("training-data",{params:{collection_id:l,page:j,per_page:V}});if(e.success){const a=e.data||[];const s=e.status_counts||{};const n=e.pagination?Number(e.pagination.total_pages):1;if(Ce){Ce.set(t,{data:a,totalPages:n,timestamp:Date.now()})}I(a);M(n);F({added:0,updated:0,outdated:0,error:0,pending:0,...s});if(_){_(a)}}}catch(e){if(e.message!=="API key required"&&e.code!=="fetch_error"){console.error("Failed to fetch training data:",e);d(i("Failed to load training data","echo-knowledge-base"))}}finally{B(false)}}),[l,j,De,_,Ce,Ne]);const Ae=a((e=>{if(e){const e=Se();R(e.map((e=>e.id)))}else{R([])}}),[Se]);const Te=async()=>{J(true);if(Ce){for(let e=1;e<=q;e++){const t=`collection_${l}_page_${e}`;Ce.remove(t)}}if(de.length>0){re([])}await $e(true);J(false);r(i("Data refreshed successfully","echo-knowledge-base"))};const Pe=a((async()=>{if(!E.length)return;const e=await u({title:i("Delete Selected Items","echo-knowledge-base"),message:i("Are you sure you want to delete the selected items?","echo-knowledge-base"),confirmText:i("Delete","echo-knowledge-base"),cancelText:i("Cancel","echo-knowledge-base"),confirmButtonClass:"epkb-ai-button-danger"});if(!e){return}Q(new Set(E));try{const e=await g("training-data/delete-selected",{method:"DELETE",data:{ids:E}});r(i("Items deleted successfully","echo-knowledge-base"));R([]);setTimeout((()=>{Q(new Set);const e=De();Ce.remove(e);$e(true)}),500)}catch(e){console.error("Delete error:",e);if(e.message!=="API key required"&&!e._errorDisplayed){d(e.message||i("Failed to delete items","echo-knowledge-base"))}Q(new Set)}}),[E,De,Ce,$e]);t((()=>{if(Ne()&&de.length===0){pe()}else if(!Ne()){$e()}}),[j,l,Ne,$e,pe,de.length]);t((()=>{if(S>0){const e=De();Ce.remove(e);$e(true);R([])}}),[S]);t((()=>{const e=e=>{if(!e.target.closest(".epkb-ai-table-header-content")){oe(false);ie(false)}};document.addEventListener("click",e);return()=>document.removeEventListener("click",e)}),[]);t((()=>{if(m){m(E)}}),[E,m]);t((()=>{if(w&&Pe){w((()=>{Pe()}))}}),[w,Pe]);t((()=>{if(y){y(Ae)}}),[y,Ae]);const Ie=c((()=>{if(O){return Object.keys(O).filter((e=>["added","updated","outdated","error","pending"].includes(e))).reduce(((e,t)=>e+(O[t]||0)),0)}return 0}),[O]);t((()=>{if(N){N(Ie)}}),[Ie,N]);t((()=>{if(D){const e=he!==""||W.length>0||Y.length>0;D(e)}}),[he,W,Y,D]);const Ee=o(false);t((()=>{if(v&&v.percentage===100&&!v.isRunning){if(!Ee.current){Ee.current=true;for(let e=1;e<=q;e++){const t=`collection_${l}_page_${e}`;Ce.remove(t)}if(A){A()}}}else if(v&&v.isRunning){Ee.current=false}}),[v?.percentage,v?.isRunning]);const Re=e=>{if(E.includes(e)){R(E.filter((t=>t!==e)))}else{R([...E,e])}if(m){m([...E,e],true)}};const Le=async e=>{const t=Array.isArray(e)?e:[e];const a=await u({title:i("Delete Items","echo-knowledge-base"),message:i("Are you sure you want to delete the selected items?","echo-knowledge-base"),confirmText:i("Delete","echo-knowledge-base"),cancelText:i("Cancel","echo-knowledge-base"),confirmButtonClass:"epkb-ai-button-danger"});if(!a){return}Q(new Set(t));try{await g("training-data/delete-selected",{method:"DELETE",data:{ids:t}});r(i("Items deleted successfully","echo-knowledge-base"));R([]);setTimeout((()=>{Q(new Set);const e=De();Ce.remove(e);$e(true)}),500)}catch(e){if(e.message!=="API key required"&&!e._errorDisplayed){d(e.message||i("Failed to delete items","echo-knowledge-base"))}Q(new Set)}};const Oe=e=>{const t={added:{label:i("Added","echo-knowledge-base"),className:"status-added"},updated:{label:i("Updated","echo-knowledge-base"),className:"status-updated"},adding:{label:i("Adding","echo-knowledge-base"),className:"status-adding"},updating:{label:i("Updating","echo-knowledge-base"),className:"status-updating"},outdated:{label:i("Outdated","echo-knowledge-base"),className:"status-outdated"},error:{label:i("Error","echo-knowledge-base"),className:"status-error"},pending:{label:i("Pending","echo-knowledge-base"),className:"status-pending"}};const a=t[e]||{label:e,className:"status-pending"};return s("span",{className:`epkb-ai-status-badge ${a.className}`},a.label)};const Fe=()=>["added","updated","outdated","error","pending"];const Ue=()=>{const e=[...new Set(P.map((e=>e.type||"Article")))];return e.sort()};const Be=async e=>{let t;if(W.includes(e)){t=W.filter((t=>t!==e))}else{t=[...W,e]}X(t);const a=t.length>0||Y.length>0;if(a&&de.length===0&&!ge){pe()}};const je=async e=>{let t;if(Y.includes(e)){t=Y.filter((t=>t!==e))}else{t=[...Y,e]}ee(t);const a=W.length>0||t.length>0;if(a&&de.length===0&&!ge){pe()}};const Ke=e=>{if(te===e){ne(se==="asc"?"desc":"asc")}else{ae(e);ne("asc")}};const qe=a((()=>{const e={};if(O){Object.keys(O).forEach((t=>{if(["added","updated","outdated","error","pending"].includes(t)){const a=O[t]||0;if(a>0){e[t]=a}}}))}return e}),[O]);if(!U&&P.length===0&&!Ne()){return s("div",{className:"epkb-ai-data-source-table"},s("div",{className:"epkb-ai-empty-state"},s("div",{className:"epkb-ai-empty-icon"},s("span",{className:"epkbfa epkbfa-file-text-o"})),s("h4",null,i("No published articles found","echo-knowledge-base")),s("p",null,i("No published knowledge base articles were found. Create and publish some articles first, then they will automatically appear here ready for AI synchronization.","echo-knowledge-base"))))}return s("div",{className:"epkb-ai-data-source-table"},s("div",{className:"epkb-ai-table-content"},s("div",{className:"epkb-ai-table-actions"},s("div",{className:"epkb-ai-table-actions-left"},s("div",{className:"epkb-ai-search-input"},s("input",{type:"text",placeholder:i("Search by title, type, URL, or ID...","echo-knowledge-base"),value:he,onChange:e=>we(e.target.value)}),s("span",{className:"epkb-ai-search-icon epkbfa epkbfa-search"})),s("div",{className:"epkb-ai-status-counts-bar"},s("span",{className:"epkb-ai-status-totals-label"},i("Totals:","echo-knowledge-base")),(Object.entries(qe()).length>0?Object.entries(qe()):[]).map((([e,t])=>{const a={added:{label:i("Added","echo-knowledge-base"),className:"status-added"},updated:{label:i("Updated","echo-knowledge-base"),className:"status-updated"},outdated:{label:i("Outdated","echo-knowledge-base"),className:"status-outdated"},error:{label:i("Error","echo-knowledge-base"),className:"status-error"},pending:{label:i("Pending","echo-knowledge-base"),className:"status-pending"}}[e]||{label:e,className:"status-default"};const n=W.includes(e);const l=W.length>0;return s("div",{key:e,className:`epkb-ai-status-count ${a.className} ${n?"active":""} ${l&&!n?"inactive":""}`,onClick:()=>Be(e),title:n?i("Click to remove filter","echo-knowledge-base"):i("Click to filter by this status","echo-knowledge-base")},s("span",{className:"epkb-ai-status-label"},a.label),s("span",{className:"epkb-ai-status-number"}," "+t))})),C&&v&&s("div",{className:"epkb-ai-sync-progress-indicator"},s("span",{className:v.isRunning!==false?"epkb-ai-sync-icon epkbfa epkbfa-refresh fa-spin":"epkb-ai-sync-icon epkbfa epkbfa-check-circle",style:v.isRunning===false?{color:"#46b450"}:{}}),s("span",{className:"epkb-ai-sync-text"},v.isRunning!==false?i("Syncing","echo-knowledge-base"):i("Sync Complete","echo-knowledge-base")),s("span",{className:"epkb-ai-sync-percentage"},`${v.percentage||0}%`),s("span",{className:"epkb-ai-sync-separator"},"•"),s("span",{className:"epkb-ai-sync-total"},`${v.synced||0}/${v.total||0}`)))),s("div",{className:"epkb-ai-table-actions-right"},s("button",{className:"epkb-ai-button epkb-ai-button-success",onClick:Te,disabled:U||z||C,style:{backgroundColor:"#46b450",borderColor:"#46b450",color:"#fff",padding:"6px 12px",fontSize:"14px",marginRight:E.length>0?"15px":"0"}},z?i("Refreshing...","echo-knowledge-base"):s(n,null,s("span",{className:"epkbfa epkbfa-refresh",style:{marginRight:"5px"}}),i("Refresh","echo-knowledge-base"))),E.length>0&&s("span",{className:"epkb-ai-selected-count"},`${E.length} ${i("selected","echo-knowledge-base")}`))),U?s("div",{className:"epkb-ai-loading"},i("Loading training data...","echo-knowledge-base")):s(n,null,s("table",{className:"epkb-ai-data-table"},s("thead",null,s("tr",null,s("th",{className:"epkb-ai-table-checkbox"},s("input",{type:"checkbox",checked:(()=>{const e=Se();return L.length===e.length&&e.length>0})(),onChange:e=>Ae(e.target.checked)})),s("th",{style:{position:"relative"}},s("div",{className:"epkb-ai-table-header-content"},s("span",null,i("Status","echo-knowledge-base")),s("span",{className:`epkb-ai-filter-label ${W.length>0?"active":""}`,onClick:()=>oe(!le)},i("Filter","echo-knowledge-base")),le&&s("div",{className:"epkb-ai-filter-dropdown",onClick:e=>e.stopPropagation()},Fe().map((e=>{const t={added:i("Added","echo-knowledge-base"),updated:i("Updated","echo-knowledge-base"),adding:i("Adding","echo-knowledge-base"),updating:i("Updating","echo-knowledge-base"),outdated:i("Outdated","echo-knowledge-base"),error:i("Error","echo-knowledge-base"),pending:i("Pending","echo-knowledge-base")};return s("label",{key:e,className:"epkb-ai-filter-option"},s("input",{type:"checkbox",checked:W.includes(e),onChange:()=>Be(e)}),s("span",null,t[e]||e))}))))),s("th",null,s("div",{className:"epkb-ai-table-header-content"},s("span",null,i("Title","echo-knowledge-base")),s("span",{className:`epkb-ai-sort-label ${te==="title"?"active":""}`,onClick:()=>Ke("title")},te==="title"?(se==="asc"?"↑":"↓")+" "+i("Sort","echo-knowledge-base"):i("Sort","echo-knowledge-base")))),s("th",{style:{position:"relative"}},s("div",{className:"epkb-ai-table-header-content"},s("span",null,i("Type","echo-knowledge-base")),s("span",{className:`epkb-ai-filter-label ${Y.length>0?"active":""}`,onClick:()=>ie(!ce)},i("Filter","echo-knowledge-base")),ce&&s("div",{className:"epkb-ai-filter-dropdown",onClick:e=>e.stopPropagation()},Ue().map((e=>s("label",{key:e,className:"epkb-ai-filter-option"},s("input",{type:"checkbox",checked:Y.includes(e),onChange:()=>je(e)}),s("span",null,e))))))),s("th",null,s("div",{className:"epkb-ai-table-header-content"},s("span",null,i("Updated","echo-knowledge-base")),s("span",{className:`epkb-ai-sort-label ${te==="last_synced"?"active":""}`,onClick:()=>Ke("last_synced")},te==="last_synced"?(se==="asc"?"↑":"↓")+" "+i("Sort","echo-knowledge-base"):i("Sort","echo-knowledge-base")))))),s("tbody",null,Se().length===0?s("tr",null,s("td",{colSpan:7,style:{textAlign:"center",padding:"20px"}},i("No training data found","echo-knowledge-base"))):Se().map((e=>{let t="";if(H.has(e.id)){t="epkb-ai-deleting-row"}else if(e.status==="updating"){t="epkb-ai-syncing-row"}else if(Z.has(e.item_id)){t="epkb-ai-recently-synced"}return s("tr",{key:e.id,className:t},s("td",{className:"epkb-ai-table-checkbox"},s("input",{type:"checkbox",checked:L.includes(e.id),onChange:()=>Re(e.id)})),s("td",null,Oe(e.status)),s("td",{className:"epkb-ai-table-title"},s("a",{href:`${window.epkb_ai_api.admin_url}post.php?post=${e.item_id}&action=edit`,target:"_blank",rel:"noopener noreferrer",style:{textDecoration:"none",color:"inherit"}},e.title)),s("td",null,e.type||i("Article","echo-knowledge-base")),s("td",{className:"epkb-ai-table-date"},p?p(e.last_synced||e.created,i("Never","echo-knowledge-base")):e.last_synced||e.created||i("Never","echo-knowledge-base")))})))),(me||ge||fe)&&s("div",{className:"epkb-ai-search-message",style:{textAlign:"center",padding:"10px",color:"#666",fontStyle:"italic"}},ge?i("Loading all data for filtering...","echo-knowledge-base"):fe?i("Searching server for more results...","echo-knowledge-base"):me),(W.length>0||Y.length>0)&&de.length===0&&!ge&&!U&&s("div",{className:"epkb-ai-search-message",style:{textAlign:"center",padding:"10px",color:"#666",fontStyle:"italic"}},i("Applying filters...","echo-knowledge-base")),(()=>{const e=ve();if(e<=1){return null}return s("div",{className:"epkb-ai-pagination"},s("button",{disabled:j===1,onClick:()=>K(j-1),className:"epkb-ai-button epkb-ai-button-secondary"},i("Previous","echo-knowledge-base")),s("span",{className:"epkb-ai-page-info"},`${i("Page","echo-knowledge-base")} ${j} ${i("of","echo-knowledge-base")} ${e}`),s("button",{disabled:j===e,onClick:()=>K(j+1),className:"epkb-ai-button epkb-ai-button-secondary"},i("Next","echo-knowledge-base")))})())))};window.EPKB_AI_DataSourceTable=f})();