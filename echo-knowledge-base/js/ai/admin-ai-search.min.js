(function(){"use strict";const{useState:e,useEffect:s,useCallback:a,useRef:t,createElement:i}=wp.element;const{__:n}=wp.i18n;const{showError:o,showSuccess:c,makeApiRequest:l,showLoadingDialog:r,useTableSearch:d,formatServerDateTime:p,TutorialButton:u,SetupStepsGuide:_}=window.EPKB_AI_Util_React||{};const{parseMessageFormatting:b}=window.EPKBChatUtils||{};const m=e=>{const s=document.createElement("div");s.className="epkb-ai-dialog epkb-ai-loading-dialog";s.style.cssText=`\n\t\t\tposition: fixed;\n\t\t\tbottom: 20px;\n\t\t\tright: 20px;\n\t\t\tbackground: white;\n\t\t\tborder-radius: 8px;\n\t\t\tpadding: 24px;\n\t\t\tmax-width: 350px;\n\t\t\tbox-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);\n\t\t\tz-index: 999999;\n\t\t\tdisplay: flex;\n\t\t\talign-items: center;\n\t\t\tgap: 16px;\n\t\t\tborder: 1px solid #ddd;\n\t\t`;const a=document.createElement("div");a.className="epkb-loading-spinner";a.style.cssText="width: 24px; height: 24px; flex-shrink: 0;";const t=document.createElement("p");t.style.cssText="margin: 0; color: #555; font-size: 14px; line-height: 1.5; font-weight: 500;";t.textContent=e;s.appendChild(a);s.appendChild(t);document.body.appendChild(s);s.offsetHeight;return{close:()=>{s.style.transition="opacity 0.3s ease-out";s.style.opacity="0";setTimeout((()=>s.remove()),300)}}};const h=({searches:o,selectedId:l,onSelect:r,onDelete:u,isLoading:_,onRefresh:b,onSearch:h,allSearches:k,currentPage:f,totalPages:g,onPageChange:y,autoSelectTopRowSignal:w})=>{const[v,N]=e([]);const[S,x]=e(false);const[C,T]=e("desc");const[R,P]=e((()=>{const e="epkb_viewed_search_history";try{const s=localStorage.getItem(e);return s?new Set(JSON.parse(s)):new Set}catch(e){return new Set}}));const E=a((e=>{P((s=>{const a=new Set(s);a.add(e);const t="epkb_viewed_search_history";try{localStorage.setItem(t,JSON.stringify([...a]))}catch(e){}return a}))}),[]);const{searchTerm:A,displayedData:I,isSearching:q,searchMessage:D,handleSearchChange:L,clearSearch:O}=d({data:o,allData:k,onServerSearch:h,searchFields:["query","user_name","user"]});const B=[...I].sort(((e,s)=>{const a=new Date(e.created_at||e.time||0);const t=new Date(s.created_at||s.time||0);if(C==="asc"){return a-t}else{return t-a}}));const $=t(w);s((()=>{if(w===$.current){return}if(l!==null){$.current=w;return}if(B.length===0){return}const e=B[0].id;E(e);r(e);$.current=w}),[w,l,B,E,r]);const M=e=>{if(e){N(B.map((e=>e.id)))}else{N([])}};const U=()=>{T(C==="asc"?"desc":"asc")};const j=(e,s)=>{if(s){N([...v,e])}else{N(v.filter((s=>s!==e)))}};const F=async e=>{if(!e||!u){return}const s=m(n("Deleting search...","echo-knowledge-base"));const a=document.getElementById(`search-row-${e}`);if(a){a.style.opacity="0.5";a.style.transition="opacity 0.3s ease"}try{await u([e],{showSuccessMessage:false});N((s=>s.filter((s=>s!==e))))}catch(e){if(a){a.style.opacity="1"}}finally{if(s){s.close()}}};const H=async()=>{if(v.length===0)return;const{showConfirmDialog:e}=window.EPKB_AI_Util_React||{};if(!e){if(!confirm(n("Are you sure you want to delete the selected searches?","echo-knowledge-base"))){return}}else{const s=await e({title:n("Delete Search History","echo-knowledge-base"),message:n("Are you sure you want to delete the selected searches?","echo-knowledge-base"),confirmText:n("Delete","echo-knowledge-base"),cancelText:n("Cancel","echo-knowledge-base"),confirmButtonClass:"epkb-ai-button-destructive"});if(!s){return}}const s=m(n("Deleting searches...","echo-knowledge-base"));v.forEach((e=>{const s=document.getElementById(`search-row-${e}`);if(s){s.style.opacity="0.5";s.style.transition="opacity 0.3s ease"}}));try{await u(v);N([])}catch(e){v.forEach((e=>{const s=document.getElementById(`search-row-${e}`);if(s){s.style.opacity="1"}}));throw e}finally{if(s){s.close()}}};const z=async()=>{x(true);await b();x(false);c(n("Search history refreshed successfully","echo-knowledge-base"))};return i("div",{className:"epkb-ai-data-source-table"},i("div",{className:"epkb-ai-table-content"},i("div",{className:"epkb-submissions-table-container"},i("div",{className:"epkb-table-filter-container"},i("div",{className:"epkb-ai-search-input"},i("input",{type:"text",placeholder:n("Search queries...","echo-knowledge-base"),value:A,onChange:e=>L(e.target.value)}),i("span",{className:"epkb-ai-search-icon epkbfa epkbfa-search"})),i("button",{className:"epkb-ai-button epkb-ai-button-success",onClick:z,disabled:_||S,style:{backgroundColor:"#46b450",borderColor:"#46b450",color:"#fff",padding:"6px 12px",fontSize:"14px",marginRight:v.length>0?"10px":"0"}},S?n("Refreshing...","echo-knowledge-base"):i("span",null,i("span",{className:"epkbfa epkbfa-refresh",style:{marginRight:"5px"}}),n("Refresh","echo-knowledge-base"))),v.length>0&&i("button",{className:"epkb-ai-button epkb-ai-button-destructive",onClick:H},n("Delete Selected","echo-knowledge-base"))),_?i("div",{className:"epkb-ai-loading"},i("div",{className:"epkb-loading-spinner"}),i("p",null,n("Loading search history...","echo-knowledge-base"))):B.length===0&&!A?i("div",{className:"epkb-ai-no-data"},i("p",null,n("No searches found","echo-knowledge-base"))):i("table",{id:"epkb-search-conversations-table"},i("thead",null,i("tr",null,i("th",null,i("input",{type:"checkbox",checked:v.length===B.length&&B.length>0,onChange:e=>M(e.target.checked)})),i("th",{"data-column":"search_date",style:{cursor:"pointer",userSelect:"none"},onClick:U},i("span",null,n("Time","echo-knowledge-base")," ",C==="asc"?"↑":"↓")),i("th",{"data-column":"user"},n("User","echo-knowledge-base")),i("th",{"data-column":"query"},n("Search Query","echo-knowledge-base")),i("th",{"data-column":"info"},n("Info","echo-knowledge-base")),i("th",{"data-column":"actions"}))),i("tbody",null,B.map((e=>i("tr",{key:e.id,id:`search-row-${e.id}`,className:`${l===e.id?"selected":""} ${!R.has(e.id)?"epkb-ai-unviewed-record":""}`.trim(),onClick:()=>{E(e.id);r(e.id)}},i("td",null,i("input",{type:"checkbox",checked:v.includes(e.id),onChange:s=>j(e.id,s.target.checked),onClick:e=>e.stopPropagation()})),i("td",null,p?p(e.created_at||e.time,"-"):e.created_at||e.time||"-"),i("td",null,e.user_id&&e.user_id>0?i("a",{href:`user-edit.php?user_id=${e.user_id}`,target:"_blank",rel:"noopener noreferrer",style:{textDecoration:"none"}},e.user_name||e.user):e.user_name||e.user||"Guest"),i("td",null,e.query),i("td",{className:"epkb-ai-search-info-cell"},(()=>{let s=null;if(e.metadata){s=typeof e.metadata==="string"?JSON.parse(e.metadata):e.metadata}if(s&&s.contact_submission){return i("span",{style:{color:"#2271b1",fontWeight:"600"}},i("span",{className:"epkbfa epkbfa-user",style:{fontSize:"16px",marginRight:"5px"},title:n("Contact request submitted","echo-knowledge-base")}),n("User Needs Help","echo-knowledge-base"))}const a=s?s.vote:null;if(a==="up"){return i("span",{className:"epkbfa epkbfa-thumbs-up",style:{color:"#46b450",fontSize:"16px"},title:n("Positive feedback","echo-knowledge-base")})}else if(a==="down"){return i("span",{className:"epkbfa epkbfa-thumbs-down",style:{color:"#dc3232",fontSize:"16px"},title:n("Negative feedback","echo-knowledge-base")})}return"-"})()),i("td",{className:"epkb-ai-actions-cell"},(l===e.id||v.includes(e.id))&&i("button",{type:"button",className:"epkb-ai-button epkb-ai-button-destructive epkb-ai-button-small",onClick:s=>{s.stopPropagation();F(e.id)}},n("Delete","echo-knowledge-base")))))))),(D||q)&&i("div",{className:"epkb-ai-search-message",style:{textAlign:"center",padding:"10px",color:"#666",fontStyle:"italic"}},q?n("Searching server for more results...","echo-knowledge-base"):D),(()=>{if(g<=1){return null}return i("div",{className:"epkb-ai-pagination"},i("button",{disabled:f===1,onClick:()=>y(f-1),className:"epkb-ai-button epkb-ai-button-secondary"},n("Previous","echo-knowledge-base")),i("span",{className:"epkb-ai-page-info"},`${n("Page","echo-knowledge-base")} ${f} ${n("of","echo-knowledge-base")} ${g}`),i("button",{disabled:f===g,onClick:()=>y(f+1),className:"epkb-ai-button epkb-ai-button-secondary"},n("Next","echo-knowledge-base")))})())))};const k=({search:e})=>{if(!e){return i("div",{className:"epkb-ai-data-source-settings"},i("h3",{className:"epkb-ai-data-source-heading"},n("Search Details","echo-knowledge-base")),i("div",{className:"epkb-ai-action-content"},i("div",{className:"epkb-ai-no-selection"},i("p",null,n("Select a search to view details","echo-knowledge-base")))))}return i("div",{className:"epkb-ai-data-source-settings"},i("h3",{className:"epkb-ai-data-source-heading"},n("Search Details","echo-knowledge-base")),i("div",{className:"epkb-ai-action-content"},i("div",{className:"epkb-ai-conversation-details"},(()=>{let s=null;if(e.metadata){s=typeof e.metadata==="string"?JSON.parse(e.metadata):e.metadata}if(s&&s.contact_submission){const e=s.contact_submission;return i("div",{className:"epkb-ai-contact-request-box",style:{marginTop:"20px",padding:"15px",background:"#f9f9f9",borderRadius:"4px"}},i("h4",{style:{marginTop:"0",color:"#2271b1"}},i("span",{className:"epkbfa epkbfa-user",style:{marginRight:"5px"}}),n("Contact Request","echo-knowledge-base")),i("div",{className:"epkb-ai-meta-item"},i("span",{className:"epkb-ai-meta-label"},n("Name:","echo-knowledge-base")),i("span",{className:"epkb-ai-meta-value"},e.name||"-")),i("div",{className:"epkb-ai-meta-item"},i("span",{className:"epkb-ai-meta-label"},n("Email:","echo-knowledge-base")),i("span",{className:"epkb-ai-meta-value"},e.email?i("a",{href:`mailto:${e.email}`},e.email):"-")))}return null})(),(()=>{let s=null;if(e.metadata){s=typeof e.metadata==="string"?JSON.parse(e.metadata):e.metadata}const a=s?s.vote:null;if(a){return i("div",{className:"epkb-ai-feedback-box",style:{marginTop:"20px",padding:"15px",background:"#f9f9f9",borderRadius:"4px"}},i("h4",{style:{marginTop:"0",color:"#2271b1"}},i("span",{className:"epkbfa epkbfa-star",style:{marginRight:"5px"}}),n("Feedback","echo-knowledge-base")),i("div",{className:"epkb-ai-meta-item"},i("span",{className:"epkb-ai-meta-label"},n("Vote:","echo-knowledge-base")),i("span",{className:"epkb-ai-meta-value"},a==="up"?i("span",{style:{color:"#46b450",fontWeight:"bold"}},i("span",{className:"epkbfa epkbfa-thumbs-up",style:{fontSize:"16px",marginRight:"5px"}}),n("Positive","echo-knowledge-base")):i("span",{style:{color:"#dc3232",fontWeight:"bold"}},i("span",{className:"epkbfa epkbfa-thumbs-down",style:{fontSize:"16px",marginRight:"5px"}}),n("Negative","echo-knowledge-base")))))}return null})(),i("div",{className:"epkb-ai-conversation-thread"},i("h4",null,n("Search Interaction","echo-knowledge-base")),e.messages&&e.messages.length>0?i("div",{className:"epkb-ai-messages-list"},e.messages.map(((e,s)=>{const a=typeof e.content==="string"?e.content:e.content?String(e.content):"";const t=e.role==="assistant"&&typeof b==="function";const o=t?b(a):a;return i("div",{key:s,className:`epkb-ai-message epkb-ai-message-${e.role}`},i("div",{className:"epkb-ai-message-header"},i("span",{className:"epkb-ai-message-role"},e.role==="user"?n("User","echo-knowledge-base"):n("AI Assistant","echo-knowledge-base")),e.timestamp&&i("span",{className:"epkb-ai-message-time"},p?p(e.timestamp,""):e.timestamp)),i("div",{className:"epkb-ai-message-bubble"},i("div",{className:"epkb-ai-message-content",...t?{dangerouslySetInnerHTML:{__html:o}}:{}},t?null:a)))}))):i("div",{className:"epkb-ai-messages-list"},(e.ai_response||e.response)&&(()=>{const s=e.ai_response||e.response;const a=typeof b==="function";const t=a?b(s):s;return i("div",{className:"epkb-ai-message epkb-ai-message-assistant"},i("div",{className:"epkb-ai-message-header"},i("span",{className:"epkb-ai-message-role"},n("AI Response","echo-knowledge-base")),e.response_time&&i("span",{className:"epkb-ai-message-time"},p?p(e.response_time,""):e.response_time)),i("div",{className:"epkb-ai-message-bubble"},i("div",{className:"epkb-ai-message-content",...a?{dangerouslySetInnerHTML:{__html:t}}:{}},a?null:s)))})(),e.results&&e.results.length>0&&i("div",{className:"epkb-ai-message epkb-ai-message-system"},i("div",{className:"epkb-ai-message-header"},i("span",{className:"epkb-ai-message-role"},n("Search Results","echo-knowledge-base"))),i("div",{className:"epkb-ai-message-bubble"},i("div",{className:"epkb-ai-message-content"},i("div",{className:"epkb-ai-search-results-list"},e.results.map(((e,s)=>i("div",{key:s,className:"epkb-ai-result-item"},i("div",{className:"epkb-ai-result-header"},i("a",{href:e.url,target:"_blank",rel:"noopener noreferrer"},e.title),e.clicked&&i("span",{className:"epkb-ai-clicked-badge"},n("✓ Clicked","echo-knowledge-base"))),e.score&&i("div",{className:"epkb-ai-result-meta"},n("Relevance:","echo-knowledge-base")," ",(e.score*100).toFixed(0)+"%")))))))))))))};const f=({field:a,fieldName:t,value:n,onChange:o,onPresetChange:c})=>{const[l,r]=e(false);const d=["epkb-ai-field","epkb-ai-field-select","epkb-ai-behavior-preset-select"];if(a.field_class){a.field_class.split(" ").forEach((e=>{if(e&&!d.includes(e)){d.push(e)}}))}s((()=>{const e=e=>{if(!e.target.closest(".epkb-ai-custom-dropdown")){r(false)}};const s=document.querySelector(".epkb-ai-behavior-preset-select");const a=s?s.closest(".epkb-ai-settings-section"):null;if(a){if(l){a.classList.add("epkb-has-dropdown-open")}else{a.classList.remove("epkb-has-dropdown-open")}}if(l){document.addEventListener("click",e);return()=>{document.removeEventListener("click",e);if(a){a.classList.remove("epkb-has-dropdown-open")}}}}),[l]);const p=e=>{const s=e.split(" - ");if(s.length===2){return{name:s[0].trim(),description:s[1].trim()}}return{name:e,description:""}};const u=a.options[n]||"";const _=p(u);return i("div",{className:d.join(" ")},i("label",{className:"epkb-ai-field-label"},a.label),i("div",{className:"epkb-ai-custom-dropdown"},i("div",{className:"epkb-ai-dropdown-trigger",onClick:()=>r(!l)},i("span",{className:"epkb-ai-dropdown-value"},_.name),i("span",{className:"epkb-ai-dropdown-arrow"},l?"▲":"▼")),l&&i("div",{className:"epkb-ai-dropdown-menu"},Object.entries(a.options).map((([e,s])=>{const a=p(s);return i("div",{key:e,className:"epkb-ai-dropdown-option"+(n===e?" selected":""),onClick:async()=>{o(t,e);if(c&&e!=="custom"){await c(e)}r(false)}},i("div",{className:"epkb-ai-option-name"},a.name),a.description&&i("div",{className:"epkb-ai-option-description"},a.description))})))),a.description&&i("p",{className:"epkb-ai-field-description"},a.description))};const g=({fieldName:e,field:s,value:a,onChange:t})=>{const{useState:o}=wp.element;const[c,l]=o("");const r=s.column_number||1;const d=s.available_sections||{};const p=Array.isArray(a)?a:[];const u=()=>{if(!c)return;const s=[...p,c];t(e,s);l("")};const _=s=>{const a=p.filter(((e,a)=>a!==s));t(e,a)};const b=(s,a)=>{const i=[...p];const n=a==="up"?s-1:s+1;if(n<0||n>=i.length)return;[i[s],i[n]]=[i[n],i[s]];t(e,i)};return i("div",{className:"epkb-ai-field epkb-ai-field-sections-manager"+(s.field_class?" "+s.field_class:"")},i("label",{className:"epkb-ai-field-label"},s.label),i("div",{className:"epkb-search-results-column-manager","data-column":r},i("div",{className:"epkb-selected-sections"},i("ul",{className:"epkb-sections-list"},p.length===0?i("li",{className:"epkb-no-sections"},n("No sections added yet","echo-knowledge-base")):p.map(((e,s)=>i("li",{key:e+"-"+s,className:"epkb-section-item","data-section-id":e},i("span",{className:"epkb-section-name"},d[e]||e),i("div",{className:"epkb-section-actions"},i("button",{type:"button",className:"epkb-btn-move-up",disabled:s===0,onClick:()=>b(s,"up")},i("i",{className:"epkbfa epkbfa-arrow-up"})),i("button",{type:"button",className:"epkb-btn-move-down",disabled:s===p.length-1,onClick:()=>b(s,"down")},i("i",{className:"epkbfa epkbfa-arrow-down"})),i("button",{type:"button",className:"epkb-btn-remove",onClick:()=>_(s)},i("i",{className:"epkbfa epkbfa-times"})))))))),i("div",{className:"epkb-add-section-controls"},i("select",{className:"epkb-section-select",value:c,onChange:e=>l(e.target.value)},i("option",{value:""},n("-- Select Section --","echo-knowledge-base")),Object.entries(d).map((([e,s])=>i("option",{key:e,value:e},s)))),i("button",{type:"button",className:"epkb-btn-add-section epkb-primary-btn",onClick:u},n("Add Section","echo-knowledge-base")))),s.description&&i("p",{className:"epkb-ai-field-description"},s.description))};const y=({field:e,settings:s,onChange:a})=>{const{useState:t}=wp.element;const[o,c]=t("tips");const l=e.sections||{};const r=e.prompts||{};const d=e.default_prompts||{};const p=e=>{const s={tips:"ai_search_results_tips_prompt",steps:"ai_search_results_steps_prompt",glossary_terms:"ai_search_results_glossary_prompt",you_can_also_ask:"ai_search_results_you_can_also_ask_prompt",tasks_list:"ai_search_results_tasks_list_prompt",related_keywords:"ai_search_results_related_keywords_prompt"};return s[e]||""};const u=e=>d[e]||"";const _=e=>{const a=p(e);const t=u(e);if(s.hasOwnProperty(a)){return s[a]!==""?s[a]:t}if(r[e]&&r[e]!==""){return r[e]}return t};const b=e=>{const a=p(e);const t=u(e);if(s.hasOwnProperty(a)){return s[a]!==""&&s[a]!==t}if(r[e]&&r[e]!==""){return r[e]!==t}return false};const m=(e,s)=>{const t=p(e);if(t){const i=u(e);const n=s===i?"":s;a(t,n)}};const h=async e=>{const{showConfirmDialog:s}=window.EPKB_AI_Util_React||{};if(!s){if(confirm(n("Are you sure you want to reset to the default prompt?","echo-knowledge-base"))){m(e,"")}}else{const a=await s({title:n("Reset Prompt","echo-knowledge-base"),message:n("Are you sure you want to reset to the default prompt? Your custom prompt will be lost.","echo-knowledge-base"),confirmText:n("Reset","echo-knowledge-base"),cancelText:n("Cancel","echo-knowledge-base"),confirmButtonClass:"epkb-ai-button-destructive"});if(a){m(e,"")}}};const k=_(o);const f=b(o);return i("div",{className:"epkb-ai-field epkb-ai-field-section-prompt-editor"+(e.field_class?" "+e.field_class:"")},i("label",{className:"epkb-ai-field-label"},e.label),i("div",{className:"epkb-section-prompt-editor"},i("div",{className:"epkb-section-prompt-selector"},i("label",null,n("Select Section:","echo-knowledge-base")),i("select",{className:"epkb-ai-select",value:o,onChange:e=>c(e.target.value)},Object.entries(l).map((([e,s])=>i("option",{key:e,value:e},s))))),i("div",{className:"epkb-section-prompt-textarea-wrapper"},i("div",{className:"epkb-section-prompt-header"},i("label",null,n("Prompt:","echo-knowledge-base")),i("button",{type:"button",className:"epkb-ai-reset-button",onClick:()=>h(o),disabled:!f},n("Reset to Default","echo-knowledge-base"))),i("textarea",{className:"epkb-section-prompt-textarea",value:k,onChange:e=>m(o,e.target.value),rows:20}),f&&i("div",{className:"epkb-section-prompt-status"},i("span",{className:"epkbfa epkbfa-check-circle",style:{color:"#46b450",marginRight:"5px"}}),n("Using custom prompt","echo-knowledge-base")),!f&&i("div",{className:"epkb-section-prompt-status"},i("span",{className:"epkbfa epkbfa-info-circle",style:{color:"#666",marginRight:"5px"}}),n("Using default prompt","echo-knowledge-base")))),e.description&&i("p",{className:"epkb-ai-field-description"},e.description))};const w=({field:e,settings:s,onChange:a})=>{const t=e.kb_mappings||[];const n=e.collection_options||{};const o=e=>{const a=`kb_collection_${e}`;if(s.hasOwnProperty(a)){return s[a]}const i=t.find((s=>s.kb_id===e));return i?i.collection_id:0};const c=(e,s)=>{a(`kb_collection_${e}`,parseInt(s,10))};const l=t.length===1;return i("div",{className:"epkb-ai-field epkb-ai-field-kb-collection-mapping"+(e.field_class?" "+e.field_class:"")},i("label",{className:"epkb-ai-field-label"},e.label),i("div",{className:"epkb-ai-kb-collection-list"},t.map((e=>i("div",{key:e.kb_id,className:"epkb-ai-kb-collection-item"+(l?" epkb-ai-kb-collection-single":"")},!l&&i("span",{className:"epkb-ai-kb-name"},e.kb_name),i("select",{className:"epkb-ai-select epkb-ai-collection-select",value:o(e.kb_id),onChange:s=>c(e.kb_id,s.target.value)},Object.entries(n).map((([e,s])=>i("option",{key:e,value:e},s)))))))),e.description&&i("p",{className:"epkb-ai-field-description"},e.description))};const v=({settings:e,onChange:a,onSave:t,isSaving:o,onPresetChange:c,onLayoutPresetChange:l,collectionIssues:r=[]})=>{const d=Array.isArray(r)&&r.length>0;const p=e=>{const s=[];if(e.kb_name){s.push(e.kb_name)}const a=s.length?s.join(" • ")+": ":"";return`${a}${e.message||""}`};s((()=>{const s=()=>{const s=e.ai_search_preset||"";const a=s==="custom";const t=e.search_model_field||"ai_chatgpt_search_model";const i=e[t]||"";const n=i.indexOf("gpt-5")===0;const o=document.getElementById("ai_setup");if(!o)return;const c=o.querySelectorAll(".epkb-ai-field-row");c.forEach((e=>{const s=e.querySelector(".epkb-ai-field-label");const t=e.querySelector("select");const i=e.querySelector('input[type="number"]');const o=s?.textContent||"";if(o.includes("Choose AI Behavior")||o.includes("Collection")){return}const c=t&&(o.includes("Model")||o.includes("Verbosity")||o.includes("Reasoning")||o.includes("Temperature")||o.includes("Top P")||o.includes("Max Tokens"));const l=i&&(o.includes("Temperature")||o.includes("Top P")||o.includes("Max Tokens"));if(c||l){if(!a){e.style.display="none";return}const s=o.includes("Verbosity");const t=o.includes("Reasoning");const i=o.includes("Temperature");const c=o.includes("Top P");if(n){if(i||c){e.style.display="none"}else{e.style.display=""}}else{if(s||t){e.style.display="none"}else{e.style.display=""}}}}))};setTimeout(s,0)}),[e.ai_search_preset,e.ai_search_enabled,e.ai_search_mode,e[e.search_model_field||"ai_chatgpt_search_model"]]);s((()=>{const s=()=>{const s=e.ai_search_mode||"simple_search";if(s==="simple_search"){const e=document.querySelectorAll(".epkb-ai-mode-simple_search");e.forEach((e=>{const s=e.closest(".epkb-ai-field");if(s)s.style.display=""}));const s=document.querySelectorAll(".epkb-ai-mode-smart_search");s.forEach((e=>{if(e.id==="epkb-ai-pro-ad-container"){e.style.display="none"}else{const s=e.closest(".epkb-ai-field");if(s)s.style.display="none"}}));const a=document.querySelector(".epkb-ai-behavior-preset-select");if(a&&!a.classList.contains("epkb-ai-mode-simple_search")){const e=a.closest(".epkb-ai-field");if(e)e.style.display=""}["search_results_presets","search_results_columns","search_results_column_sections","search_results_sections","search_results_section_prompts"].forEach((e=>{const s=document.getElementById(e);if(s)s.style.display="none"}));return}if(s==="smart_search"){const e=document.querySelectorAll(".epkb-ai-mode-simple_search");e.forEach((e=>{const s=e.closest(".epkb-ai-field");if(s)s.style.display="none"}));const s=document.querySelectorAll(".epkb-ai-mode-smart_search");s.forEach((e=>{if(e.id==="epkb-ai-pro-ad-container"){e.style.display=""}else{const s=e.closest(".epkb-ai-field");if(s)s.style.display=""}}));const a=document.querySelector(".epkb-ai-behavior-preset-select");if(a){const e=a.closest(".epkb-ai-field");if(e){if(a.classList.contains("epkb-ai-mode-simple_search")){e.style.display="none"}else{e.style.display=""}}}["search_results_presets","search_results_columns","search_results_column_sections","search_results_sections","search_results_section_prompts"].forEach((e=>{const s=document.getElementById(e);if(s)s.style.display=""}))}};s()}),[e.ai_search_mode]);s((()=>{const s=()=>{const s=e.ai_search_results_num_columns||"1";const a=document.querySelector('[data-column="1"]');const t=document.querySelector('[data-column="2"]');const i=document.querySelector('[data-column="3"]');const o=t?t.closest(".epkb-ai-field"):null;const c=i?i.closest(".epkb-ai-field"):null;if(o){o.style.display=parseInt(s)>=2?"":"none"}if(c){c.style.display=parseInt(s)>=3?"":"none"}const l=a?a.closest(".epkb-ai-field").querySelector(".epkb-ai-field-label"):null;const r=o?o.querySelector(".epkb-ai-field-label"):null;const d=c?c.querySelector(".epkb-ai-field-label"):null;if(l){l.textContent=s==="1"?n("Single Column","echo-knowledge-base"):n("Left Column","echo-knowledge-base")}if(r){r.textContent=s==="2"?n("Right Column","echo-knowledge-base"):n("Middle Column","echo-knowledge-base")}if(d){d.textContent=n("Right Column","echo-knowledge-base")}};s()}),[e.ai_search_results_num_columns]);const u=(s,t)=>{const o=e.hasOwnProperty(s)?e[s]:t.value||"";switch(t.type){case"toggle":return i("div",{className:"epkb-ai-field epkb-ai-field-toggle"},i("label",{className:"epkb-ai-toggle-label"},i("input",{type:"checkbox",checked:o==="on",onChange:e=>a(s,e.target.checked?"on":"off")}),i("span",{className:"epkb-ai-toggle-text"},t.label)),t.description&&i("p",{className:"epkb-ai-field-description"},t.description));case"radio":return i("div",{className:"epkb-ai-field epkb-ai-field-radio"+(t.field_class?" "+t.field_class:"")},i("div",{className:"epkb-ai-field-label"},t.label),i("div",{className:"epkb-ai-radio-group"},Object.entries(t.options).map((([e,t])=>i("label",{key:e,className:"epkb-ai-radio-label"},i("input",{type:"radio",name:s,value:e,checked:o===e,onChange:e=>a(s,e.target.value)}),i("span",{className:"epkb-ai-radio-text"},t))))),t.description&&i("p",{className:"epkb-ai-field-description"},t.description));case"checkbox":return i("div",{className:"epkb-ai-field epkb-ai-field-checkbox"+(t.field_class?" "+t.field_class:"")},i("label",{className:"epkb-ai-checkbox-label"},i("input",{type:"checkbox",checked:o==="on",onChange:e=>a(s,e.target.checked?"on":"off")}),i("span",{className:"epkb-ai-checkbox-text"},t.label)),t.description&&i("p",{className:"epkb-ai-field-description"},t.description));case"text":return i("div",{className:"epkb-ai-field epkb-ai-field-text"+(t.field_class?" "+t.field_class:"")},i("label",{className:"epkb-ai-field-label"},t.label),i("input",{type:"text",className:"epkb-ai-input",value:o||"",onChange:e=>a(s,e.target.value),placeholder:t.placeholder||""}),t.description&&i("p",{className:"epkb-ai-field-description"},t.description));case"number":return i("div",{className:"epkb-ai-field epkb-ai-field-number"+(t.field_class?" "+t.field_class:"")},i("label",{className:"epkb-ai-field-label"},t.label),i("input",{type:"number",className:"epkb-ai-input",value:o||"",onChange:e=>a(s,e.target.value),min:t.min,max:t.max,step:t.step}),t.description&&i("p",{className:"epkb-ai-field-description"},t.description));case"select":if(t.field_class&&t.field_class.includes("epkb-ai-behavior-preset-select")){return i(f,{field:t,fieldName:s,value:o,onChange:a,onPresetChange:c})}if(t.field_class&&t.field_class.includes("epkb-ai-layout-preset-select")){return i(f,{field:t,fieldName:s,value:o,onChange:a,onPresetChange:l})}const r=e=>{const s=typeof e==="string"&&e.indexOf("gpt-5")===0;if(s){return{type:"gpt5",defaults:{verbosity:"medium",reasoning:"medium",max_output_tokens:5e3}}}return{type:"gpt4",defaults:{temperature:.2,top_p:1,max_output_tokens:5e3}}};return i("div",{className:"epkb-ai-field epkb-ai-field-select"+(t.field_class?" "+t.field_class:"")},i("label",{className:"epkb-ai-field-label"},t.label),i("select",{className:"epkb-ai-select",value:o,onChange:t=>{const i=t.target.value;a(s,i);const n=e.search_model_field||"ai_chatgpt_search_model";if(s===n){const s=e.ai_search_preset!==undefined?e.ai_search_preset:e.sections&&e.sections.search_behavior&&e.sections.search_behavior.fields&&e.sections.search_behavior.fields.ai_search_preset?e.sections.search_behavior.fields.ai_search_preset.value:"custom";if(s==="custom"){const e=r(i);if(e.type==="gpt5"){if(e.defaults.verbosity!==undefined)a("ai_search_verbosity",e.defaults.verbosity);if(e.defaults.reasoning!==undefined)a("ai_search_reasoning",e.defaults.reasoning)}else{if(e.defaults.temperature!==undefined)a("ai_search_temperature",e.defaults.temperature);if(e.defaults.top_p!==undefined)a("ai_search_top_p",e.defaults.top_p)}if(e.defaults.max_output_tokens!==undefined)a("ai_search_max_output_tokens",e.defaults.max_output_tokens)}}}},Object.entries(t.options).map((([e,s])=>i("option",{key:e,value:e},s)))),t.description&&i("p",{className:"epkb-ai-field-description"},t.description));case"textarea":return i("div",{className:"epkb-ai-field epkb-ai-textarea-field"+(t.field_class?" "+t.field_class:"")},i("div",{className:"epkb-ai-textarea-header"},i("label",null,t.label),t.show_reset&&i("button",{type:"button",className:"epkb-ai-reset-button",onClick:async()=>{if(t.default){const{showConfirmDialog:e}=window.EPKB_AI_Util_React||{};if(!e){if(confirm(n("Are you sure you want to reset to default instructions?","echo-knowledge-base"))){a(s,t.default)}}else{const i=await e({title:n("Reset Instructions","echo-knowledge-base"),message:n("Are you sure you want to reset to default instructions? Your custom instructions will be lost.","echo-knowledge-base"),confirmText:n("Reset","echo-knowledge-base"),cancelText:n("Cancel","echo-knowledge-base"),confirmButtonClass:"epkb-ai-button-destructive"});if(i){a(s,t.default)}}}}},n("Reset to Default","echo-knowledge-base"))),i("textarea",{value:o||"",onChange:e=>a(s,e.target.value),rows:t.rows||3,placeholder:t.placeholder}),t.description&&i("p",{className:"epkb-ai-field-description"},t.description));case"custom_html":return i("div",{className:"epkb-ai-field epkb-ai-field-custom-html"+(t.field_class?" "+t.field_class:"")},i("label",{className:"epkb-ai-field-label"},t.label),i("div",{className:"epkb-ai-custom-html-content",dangerouslySetInnerHTML:{__html:t.value||""}}),t.description&&i("p",{className:"epkb-ai-field-description"},t.description));case"sections_manager":return i(g,{fieldName:s,field:t,value:Array.isArray(o)?o:[],onChange:a});case"html":return i("div",{className:"epkb-ai-field epkb-ai-field-html"+(t.field_class?" "+t.field_class:""),dangerouslySetInnerHTML:{__html:t.html||""}});case"kb_collection_mapping":return i(w,{field:t,settings:e,onChange:a});case"section_prompt_editor":return i(y,{field:t,settings:e,onChange:a});default:return null}};return i("div",{className:"epkb-ai-settings"},d&&i("div",{className:"epkb-ai-notice epkb-ai-notice-error",style:{marginBottom:"16px"}},i("h4",{style:{margin:"0 0 6px"}},n("Training data issues detected","echo-knowledge-base")),i("p",{style:{margin:"0 0 8px"}},n("AI Search needs a valid Training Data collection. Resolve the issues below in Training Data or KB Configuration.","echo-knowledge-base")),i("ul",{className:"epkb-ai-issue-list",style:{margin:0,paddingLeft:"18px"}},r.map(((e,s)=>i("li",{key:e.collection_id||s},p(e)))))),i("div",{className:"epkb-ai-settings-sections-wrapper"},Object.entries(e.sections||{}).map((([e,s])=>i("div",{key:e,id:e,className:"epkb-ai-settings-section"},i("div",{className:"epkb-ai-section-header"},s.icon&&i("span",{className:s.icon}),i("div",{className:"epkb-ai-header-text"},i("h3",null,s.title))),i("div",{className:"epkb-ai-section-content"},Object.entries(s.fields||{}).map((([e,s])=>i("div",{key:e,className:"epkb-ai-field-row"},u(e,s)))))))),e.ai_pro_ad_html&&i("div",{id:"epkb-ai-pro-ad-container",className:"epkb-ai-pro-ad epkb-ai-mode-smart_search",style:{margin:"20px 0"},dangerouslySetInnerHTML:{__html:e.ai_pro_ad_html}})),i("div",{className:"epkb-ai-settings-actions"},i("button",{className:"epkb-ai-button epkb-ai-button-primary",onClick:t,disabled:o},o?n("Saving...","echo-knowledge-base"):n("Save Settings","echo-knowledge-base"))))};const N=({settings:o,tabData:c,isLoading:l,onDataChange:r,makeApiRequest:d,showError:p,showSuccess:b,onTabSwitch:m})=>{const[f,g]=e((()=>{const e=new URL(window.location);return e.searchParams.get("active_sub_tab")||c?.active_sub_tab||"search-history"}));const[y,w]=e(null);const[N,S]=e([]);const[x,C]=e(false);const[T,R]=e(false);const[P,E]=e(c?.ai_config||{});const[A,I]=e(false);const[q,D]=e(null);const[L,O]=e(false);const[B,$]=e(1);const[M,U]=e(1);const[j,F]=e(0);const H=10;const z=t(B);const K=t(y);const[G,J]=e(0);const W=t(false);s((()=>{z.current=B}),[B]);s((()=>{K.current=y}),[y]);const[V,Y]=e({ai_search_enabled:c?.ai_config?.ai_search_enabled||"off",ai_chat_enabled:c?.ai_config?.ai_chat_enabled||"off"});s((()=>{if(c){S([]);if(c.ai_config){E(c.ai_config);Y({ai_search_enabled:c.ai_config.ai_search_enabled||"off",ai_chat_enabled:c.ai_config.ai_chat_enabled||"off"})}}}),[c]);const Q=a((async()=>{O(true);try{const e=await d("ai-search/searches",{method:"GET",params:{kb_id:o?.kb_id||1,per_page:100}});if(e&&e.searches){let s=[...e.searches];const a=e.pagination?.total_pages||1;for(let e=2;e<=a;e++){const a=await d("ai-search/searches",{method:"GET",params:{kb_id:o?.kb_id||1,page:e,per_page:100}});if(a&&a.searches){s=[...s,...a.searches]}}D(s);return s}}catch(e){console.error("Failed to fetch all searches for filtering:",e);throw e}finally{O(false)}return[]}),[d,o?.kb_id]);const X=a((async e=>{if(!e)return null;$(1);if(L)return null;if(q&&q.length>0){return q}try{const e=await Q();return e}catch(e){console.error("Server search failed:",e);return null}}),[Q,L,q]);const Z=async(e=1)=>{if(!d){return Promise.resolve([])}if(P.ai_search_enabled==="off"){S([]);D(null);I(true);U(1);return Promise.resolve([])}C(true);try{const s=await d("ai-search/searches",{method:"GET",params:{kb_id:o?.kb_id||1,per_page:10,page:e}});if(s&&s.searches){S(s.searches);I(true);U(s.pages||1);F(s.total||0);D(null);if(W.current){W.current=false;if(K.current===null){J((e=>e+1))}}return s.searches}else{S([]);I(true);D(null);U(1);F(0);W.current=false;return[]}}catch(e){p(e.message||n("Failed to load search history","echo-knowledge-base"));throw e}finally{C(false)}};s((()=>{if(f==="search-history"&&!A){Z(B)}}),[f,A,o?.kb_id,d]);s((()=>{if(f==="search-history"&&A){Z(B)}}),[B]);s((()=>()=>{I(false);S([]);D(null);w(null)}),[]);const ee=(e,s)=>{E((a=>({...a,[e]:s})))};const se=e=>{const s=window.epkb_ai_api?.presets?.search||{};const a=P.search_model_field||"ai_chatgpt_search_model";if(e!=="custom"&&s[e]){const t=s[e];E((s=>{const i={...s,ai_search_preset:e};if(t.model!==undefined)i[a]=t.model;if(t.verbosity!==undefined)i.ai_search_verbosity=t.verbosity;if(t.reasoning!==undefined)i.ai_search_reasoning=t.reasoning;if(t.temperature!==undefined)i.ai_search_temperature=t.temperature;if(t.max_output_tokens!==undefined)i.ai_search_max_output_tokens=t.max_output_tokens;if(t.top_p!==undefined)i.ai_search_top_p=t.top_p;return i}))}else{E((s=>({...s,ai_search_preset:e})))}};const ae=e=>{const s=window.epkb_ai_api?.presets?.search_layout||{};if(e!=="custom"&&s[e]){const a=s[e];E((s=>({...s,ai_search_results_layout_preset:e,...a})))}else{E((s=>({...s,ai_search_results_layout_preset:e})))}};const te=async()=>{R(true);const e=P.search_model_field||"ai_chatgpt_search_model";try{const s={};Object.keys(P).forEach((e=>{if(e.startsWith("kb_collection_")){const a=e.replace("kb_collection_","");s[a]=P[e]}}));const a={ai_search_enabled:P.ai_search_enabled,ai_search_mode:P.ai_search_mode,ai_search_preset:P.ai_search_preset,ai_show_sources:P.ai_show_sources,[e]:P[e],ai_search_instructions:P.ai_search_instructions,ai_search_verbosity:P.ai_search_verbosity,ai_search_reasoning:P.ai_search_reasoning,ai_search_temperature:P.ai_search_temperature,ai_search_max_output_tokens:P.ai_search_max_output_tokens,ai_search_top_p:P.ai_search_top_p,ai_search_immediate_query:P.ai_search_immediate_query,ai_search_ask_button_text:P.ai_search_ask_button_text,ai_search_results_width:P.ai_search_results_width,ai_search_results_separator:P.ai_search_results_separator,ai_search_results_num_columns:P.ai_search_results_num_columns,ai_search_results_column_widths:P.ai_search_results_column_widths,ai_search_results_column_1_sections:P.ai_search_results_column_1_sections,ai_search_results_column_2_sections:P.ai_search_results_column_2_sections,ai_search_results_column_3_sections:P.ai_search_results_column_3_sections,ai_search_results_matching_articles_name:P.ai_search_results_matching_articles_name,ai_search_results_ai_answer_name:P.ai_search_results_ai_answer_name,ai_search_results_glossary_name:P.ai_search_results_glossary_name,ai_search_results_tips_name:P.ai_search_results_tips_name,ai_search_results_steps_name:P.ai_search_results_steps_name,ai_search_results_tasks_list_name:P.ai_search_results_tasks_list_name,ai_search_results_you_can_also_ask_name:P.ai_search_results_you_can_also_ask_name,ai_search_results_related_keywords_name:P.ai_search_results_related_keywords_name,ai_search_results_custom_prompt_name:P.ai_search_results_custom_prompt_name,ai_search_results_feedback_name:P.ai_search_results_feedback_name,ai_search_results_contact_us_name:P.ai_search_results_contact_us_name,ai_search_results_custom_prompt_text:P.ai_search_results_custom_prompt_text,ai_search_results_tips_prompt:P.ai_search_results_tips_prompt,ai_search_results_steps_prompt:P.ai_search_results_steps_prompt,ai_search_results_glossary_prompt:P.ai_search_results_glossary_prompt,ai_search_results_you_can_also_ask_prompt:P.ai_search_results_you_can_also_ask_prompt,ai_search_results_tasks_list_prompt:P.ai_search_results_tasks_list_prompt,ai_search_results_related_keywords_prompt:P.ai_search_results_related_keywords_prompt,ai_search_results_contact_support_button_text:P.ai_search_results_contact_support_button_text,ai_search_results_contact_support_email:P.ai_search_results_contact_support_email,ai_search_results_articles_count:P.ai_search_results_articles_count_simple||P.ai_search_results_articles_count,kb_collection_mappings:s};const t=await d("ai/settings",{method:"POST",data:{settings:a}});if(t.success){b(n("Settings saved successfully","echo-knowledge-base"));r({ai_config:P});const e=V.ai_search_enabled!==P.ai_search_enabled;const s=V.ai_chat_enabled!==P.ai_chat_enabled;if(e||s){setTimeout((()=>{const e=new URL(window.location.href);e.searchParams.set("active_tab","search");window.location.href=e.toString()}),1e3)}else{Y({ai_search_enabled:P.ai_search_enabled,ai_chat_enabled:P.ai_chat_enabled||V.ai_chat_enabled})}}}catch(e){p(e.message||n("Failed to save settings","echo-knowledge-base"))}finally{R(false)}};const ie=async(e,s={})=>{const{showSuccessMessage:a=true}=s;try{const s=await d("ai-search/searches/bulk",{method:"DELETE",data:{ids:e}});const t=s.success||s===true||typeof s==="string"&&s.includes("deleted successfully")||s.message&&s.message.includes("deleted successfully");if(t){if(a){const e=typeof s==="string"?s:s.message||n("Searches deleted successfully","echo-knowledge-base");b(e)}const t=s&&Number.isInteger(s.deleted)?s.deleted:e.length;const i=Math.max(0,j-t);const c=Math.max(1,Math.ceil(i/H));F(i);U(c);D(null);const l=K.current!==null&&e.includes(K.current);if(l){W.current=true;w(null);K.current=null}const r=new Set(e);const p=N.filter((e=>!r.has(e.id)));const u=N.length-p.length;S(p);const _=z.current;if(_>c){$(c);return}const m=()=>{if(!W.current){return}W.current=false;if(K.current===null){J((e=>e+1))}};if(u>0){const e=(_-1)*H+p.length;try{const s=await d("ai-search/searches",{method:"GET",params:{kb_id:o?.kb_id||1,per_page:u,offset:e}});if(s&&s.searches&&z.current===_){S((e=>{const a=new Set(e.map((e=>e.id)));const t=s.searches.filter((e=>!a.has(e.id)));return t.length?[...e,...t]:e}))}}catch(e){console.error("Failed to fetch replacement searches:",e)}finally{if(z.current===_){m()}}}else{m()}}else{throw new Error(s.message||s||n("Failed to delete searches","echo-knowledge-base"))}}catch(e){p(e.message||n("Failed to delete searches","echo-knowledge-base"));throw e}};const ne=N.find((e=>e.id===y));const oe=[{id:"search-history",title:n("Search History","echo-knowledge-base")},{id:"search-settings",title:n("Search Settings","echo-knowledge-base")}];const ce=c?.sub_tabs?Object.values(c.sub_tabs):oe;const le=c?.ai_config?.ai_disclaimer_accepted==="on";if(!le){const{DisclaimerRequiredMessage:e}=window.EPKB_AI_Util_React||{};if(e){return i(e,{i18n:o?.i18n||{},onAccept:()=>{if(m){m("general-settings")}else{const e=new URL(window.location.href);if(e.searchParams.has("page")){e.searchParams.set("active_tab","general-settings");window.location.href=e.toString()}}}})}}const re=()=>{switch(f){case"search-history":if(P.ai_search_enabled==="off"){return i("div",{className:"epkb-ai-disabled-message"},i("div",{className:"epkb-ai-notice epkb-ai-notice-warning"},i("h3",null,n("AI Search is Disabled","echo-knowledge-base")),i("p",null,n("To view search history, please enable AI Search in the Settings tab.","echo-knowledge-base")),i("button",{className:"epkb-ai-button epkb-ai-button-primary",onClick:()=>{g("search-settings");const e=new URL(window.location);e.searchParams.set("active_sub_tab","search-settings");window.history.pushState({},"",e)}},n("Go to Settings","echo-knowledge-base"))))}return i("div",{className:"epkb-ai-data-source-layout"},i(h,{searches:N,allSearches:q,selectedId:y,onSelect:w,onDelete:ie,isLoading:x,onRefresh:()=>Z(B),onSearch:X,currentPage:B,totalPages:M,onPageChange:$,autoSelectTopRowSignal:G}),i(k,{search:ne}));case"search-settings":const e={};if(c?.settings_sections){Object.entries(c.settings_sections).forEach((([s,a])=>{if(a.sub_tab==="search-settings"){e[s]=a}}))}return i(v,{settings:{...P,sections:e,ai_pro_ad_html:c?.ai_pro_ad_html},collectionIssues:c?.collection_issues||[],onChange:ee,onSave:te,isSaving:T,onPresetChange:se,onLayoutPresetChange:ae});default:return null}};return i("div",{className:"epkb-ai-search-container"},_&&i(_,{setupSteps:c?.setup_steps,onTabSwitch:m}),ce.length>0&&i("div",{className:"epkb-ai-sub-tabs"},i("div",{className:"epkb-ai-sub-tabs-header"},i("div",{className:"epkb-ai-sub-tabs-nav"},ce.map((e=>i("button",{key:e.id,className:`epkb-ai-sub-tab-button epkb-ai-sub-tab-${e.id} ${f===e.id?"active":""}`,onClick:()=>{g(e.id);const s=new URL(window.location);s.searchParams.set("active_sub_tab",e.id);window.history.pushState({},"",s)}},e.title)))),u&&i(u,{url:"https://www.echoknowledgebase.com/documentation/step-3-enable-ai-search/"}),f==="search-settings"&&i("button",{type:"button",className:"epkb-ai-button epkb-ai-button-primary epkb-ai-sub-tabs-save-button",onClick:te,disabled:T},T?n("Saving...","echo-knowledge-base"):n("Save Settings","echo-knowledge-base")))),re())};window.EPKB_AI_Search={AIAdminSearch:N}})();