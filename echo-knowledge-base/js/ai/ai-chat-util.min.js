(function(){"use strict";const e="epkb_ai_chat_debug";const t="epkb_debug";function s(){const s=new URLSearchParams(window.location.search);if(s.get(t)==="1"){sessionStorage.setItem(e,"true");return true}return sessionStorage.getItem(e)==="true"}window.epkbEnableDebug=function(t=true){if(t){sessionStorage.setItem(e,"true");console.log("EPKB AI Chat debug mode enabled for this session. Refresh the page to see all debug messages.")}else{sessionStorage.removeItem(e);console.log("EPKB AI Chat debug mode disabled.")}};function r(e,t,s=null){const r=Date.now();const a=Math.random().toString(36).substring(2,11);const n=t?"user":"assistant";return{id:r,messageId:s||`msg_${n}_${r}_${a}`,text:e,isUser:t}}function a(e){const t=e.trim();if(!t){return{valid:false,error:"Empty message"}}if(t.length>2e3){return{valid:false,error:"Message too long",userMessage:"Your message is too long. Please limit it to 2000 characters."}}const s=t.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi,"");const r=Date.now();const a=Math.random().toString(36).substr(2,9);const n=`msg_user_${r}_${a}`;const o={id:r,messageId:n,text:s,isUser:true};return{valid:true,message:o,text:s,messageId:n}}function n(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=Math.random()*16|0;const s=e==="x"?t:t&3|8;return s.toString(16)}))}function o(e){if(typeof marked==="undefined"||!marked||!marked.parse){console.warn("EPKB AI Chat: marked library not available for parsing");return e}try{const t={breaks:true,gfm:true,headerIds:false,mangle:false,sanitize:false};return marked.parse(e,t)}catch(t){console.error("EPKB AI Chat: Error parsing message with marked:",t);return e}}function i(e,t){return(e.status===403||e.status===401)&&t.code==="rest_cookie_invalid_nonce"}function c(e,t=null,s=false){const r={type:"unknown",message:"",code:"",userMessage:"",adminMessage:"",isRetryable:false,statusCode:null,context:{}};if(e.name==="AbortError"||e.message&&e.message.toLowerCase().includes("timeout")||e.message&&e.message.toLowerCase().includes("signal")){r.type="timeout";r.code="timeout_error";r.message="Request timed out";r.userMessage="The response is taking longer than expected. The system will retry automatically.";r.adminMessage="Request timeout: "+(e.message||"Unknown timeout error");r.isRetryable=true;r.finalMessage=s?r.adminMessage:r.userMessage;return r}if(t&&t.data){const e=t.data;r.code=e.error||e.code||"";r.message=e.message||"";r.userMessage=e.user_message||e.message||"";r.adminMessage=e.admin_message||"";r.type=e.error_type||"unknown";r.isRetryable=e.is_retryable||false;r.statusCode=t.status||t.statusCode||null;if(e.retry_after){r.context.retryAfter=e.retry_after}if(e.details){r.context={...r.context,...e.details}}if(!s){r.finalMessage=r.userMessage||"Unable to connect. Please refresh the page and try again."}else{r.finalMessage=r.adminMessage||r.userMessage||"An unexpected error occurred."}return r}if(e instanceof Error){r.message=e.message;r.code=e.code||"";if(e.name==="NetworkError"||e.message.includes("network")){r.type="network";r.userMessage="Network error. Please check your internet connection.";r.adminMessage="Network error: "+e.message;r.isRetryable=true}else{r.userMessage="Unable to connect. Please refresh the page and try again.";r.adminMessage="Client error: "+e.message}r.finalMessage=s?r.adminMessage:r.userMessage}return r}function l(){const e=window.epkbChatWidgetRoot||"epkb-ai-chat-widget-root";return document.getElementById(e)}function u(e){return{"X-WP-Nonce":e,"Content-Type":"application/json"}}function d(e,t=null,s=1e4,r=null){const a={method:e,credentials:"same-origin",headers:u(r)};if(t){a.body=JSON.stringify(t)}if(typeof AbortSignal!=="undefined"&&AbortSignal.timeout){a.signal=AbortSignal.timeout(s)}return a}function g(e){const{createElement:t}=e;return function(){return t("div",{className:"epkb-ai-chat-message"},t("div",{className:"epkb-ai-chat-typing"},t("div",{className:"epkb-ai-chat-typing-dot"}),t("div",{className:"epkb-ai-chat-typing-dot"}),t("div",{className:"epkb-ai-chat-typing-dot"})))}}function m(e){const{createElement:t}=e;return function(){return t("div",{className:"epkb-ai-chat-loading-skeleton"},t("div",{className:"epkb-ai-chat-skeleton-message epkb-ai-chat-skeleton-message--bot"},t("div",{className:"epkb-ai-chat-skeleton-line"}),t("div",{className:"epkb-ai-chat-skeleton-line epkb-ai-chat-skeleton-line--short"})),t("div",{className:"epkb-ai-chat-skeleton-message epkb-ai-chat-skeleton-message--user"},t("div",{className:"epkb-ai-chat-skeleton-line"})),t("div",{className:"epkb-ai-chat-skeleton-message epkb-ai-chat-skeleton-message--bot"},t("div",{className:"epkb-ai-chat-skeleton-line"}),t("div",{className:"epkb-ai-chat-skeleton-line"}),t("div",{className:"epkb-ai-chat-skeleton-line epkb-ai-chat-skeleton-line--short"})))}}function p(e){const{useEffect:t}=e;return function(e,s,r){t((()=>{if(!s)return;const t=t=>{if(t.key==="Tab"&&e.current){const s=e.current.querySelectorAll('button:not([disabled]), input:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])');const r=s[0];const a=s[s.length-1];if(t.shiftKey&&document.activeElement===r){t.preventDefault();a.focus()}else if(!t.shiftKey&&document.activeElement===a){t.preventDefault();r.focus()}}if(t.key==="Escape"&&r){r()}};document.addEventListener("keydown",t);return()=>{document.removeEventListener("keydown",t)}}),[s,e,r])}}function f(e,t=false,s=null){if(!t){return e}const r='<button class="epkb-error-report-btn" style="display: none; margin-left: 10px; font-size: 12px; padding: 2px 8px; cursor: pointer;">Report Issue</button>';return e+" "+r}function b(e,t,s={}){console.error(`%c[EPKB ${e} Error]`,"color: #ff0000; font-weight: bold;",t);if(Object.keys(s).length>0){const e=Object.entries(s).map((([e,t])=>({Property:e,Value:typeof t==="object"?JSON.stringify(t):t})));console.table(e)}}function h(e){const{message:t,isAdmin:s=false,container:r,onReport:a=null,source:n="search"}=e;const o=window.jQuery;const i=o(r);i.empty();const c={chat:{base:"epkb-ai-chat-error",message:"epkb-ai-chat-error__message",button:"epkb-ai-chat-error__report-btn"},search:{base:"epkb-ai-search-error__dropdown",message:"epkb-ai-search-error__message",button:"epkb-ai-search-error__report-btn"}};const l=c[n]||c.search;if(s&&a){i.html(`\n                <div class="${l.base}">\n                    <div class="${l.message}">${t}</div>\n                    <button class="${l.button}" type="button" style="display: none; margin-top: 10px; font-size: 12px; padding: 4px 12px; cursor: pointer; background: #007cba; color: white; border: none; border-radius: 3px;">\n                        Report Issue\n                    </button>\n                </div>\n            `);i.find("."+l.button).on("click",(()=>a(t)))}else{const e=n==="chat"?"epkb-ai-chat-error":"epkb-ai-search-error__user-message";i.html(`<div class="${e}">${t}</div>`)}i.show()}function k(e,t,s={},r=""){const a=[`${e} Error Report`,"===================","",`Error: ${t}`,r?`Context: ${r}`:"",`Time: ${(new Date).toISOString()}`,`URL: ${window.location.href}`,`Browser: ${navigator.userAgent}`,""];if(s&&Object.keys(s).length>0){a.push("Details:",JSON.stringify(s,null,2))}return a.filter((e=>e!=="")).join("\n")}window.EPKBChatUtils={isDebugMode:s,createMessage:r,prepareMessage:a,generateIdempotencyKey:n,parseMessageFormatting:o,isInvalidNonceError:i,parseAIChatErrorResponse:c,parseErrorResponse:c,formatErrorMessage:f,logError:b,showErrorMessage:h,createErrorReport:k,getChatRootElement:l,createHeaders:u,createFetchOptions:d,TypingIndicator:g,LoadingSkeleton:m,useFocusTrap:p}})();