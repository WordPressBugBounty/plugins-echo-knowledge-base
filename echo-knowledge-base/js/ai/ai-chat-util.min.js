(function(){"use strict";const e="epkb_ai_chat_debug";const t="epkb_debug";function s(){const s=new URLSearchParams(window.location.search);if(s.get(t)==="1"){sessionStorage.setItem(e,"true");return true}return sessionStorage.getItem(e)==="true"}window.epkbEnableDebug=function(t=true){if(t){sessionStorage.setItem(e,"true");console.log("EPKB AI Chat debug mode enabled for this session. Refresh the page to see all debug messages.")}else{sessionStorage.removeItem(e);console.log("EPKB AI Chat debug mode disabled.")}};function a(e,t,s=null){const a=Date.now();const n=Math.random().toString(36).substring(2,11);const r=t?"user":"assistant";return{id:a,messageId:s||`msg_${r}_${a}_${n}`,text:e,isUser:t}}function n(e){const t=e.trim();if(!t){return{valid:false,error:"Empty message"}}if(t.length>2e3){return{valid:false,error:"Message too long",userMessage:"Your message is too long. Please limit it to 2000 characters."}}const s=t.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi,"");const a=Date.now();const n=Math.random().toString(36).substr(2,9);const r=`msg_user_${a}_${n}`;const o={id:a,messageId:r,text:s,isUser:true};return{valid:true,message:o,text:s,messageId:r}}function r(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=Math.random()*16|0;const s=e==="x"?t:t&3|8;return s.toString(16)}))}function o(e){if(typeof marked==="undefined"||!marked||!marked.parse){console.warn("EPKB AI Chat: marked library not available for parsing");return e}try{const t={breaks:true,gfm:true,headerIds:false,mangle:false,sanitize:false};return marked.parse(e,t)}catch(t){console.error("EPKB AI Chat: Error parsing message with marked:",t);return e}}function i(e,t){return(e.status===403||e.status===401)&&t.code==="rest_cookie_invalid_nonce"}function c(e,t=null,s=false){const a={type:"unknown",message:"",code:"",userMessage:"",adminMessage:"",isRetryable:false,statusCode:null,context:{}};if(e.name==="AbortError"||e.message&&e.message.toLowerCase().includes("timeout")||e.message&&e.message.toLowerCase().includes("signal")){a.type="timeout";a.code="timeout_error";a.message="Request timed out";a.userMessage="The response is taking longer than expected. The system will retry automatically.";a.adminMessage="Request timeout: "+(e.message||"Unknown timeout error");a.isRetryable=true;a.finalMessage=s?a.adminMessage:a.userMessage;return a}if(t&&t.data){const e=t.data;a.code=e.error||e.code||"";a.message=e.message||"";a.userMessage=e.user_message||e.message||"";a.adminMessage=e.admin_message||"";a.type=e.error_type||"unknown";a.isRetryable=e.is_retryable||false;a.statusCode=t.status||t.statusCode||null;if(e.retry_after){a.context.retryAfter=e.retry_after}if(e.details){a.context={...a.context,...e.details}}if(!s){a.finalMessage=a.userMessage||"Unable to connect. Please refresh the page and try again."}else{a.finalMessage=a.adminMessage||a.userMessage||"An unexpected error occurred."}return a}if(e instanceof Error){a.message=e.message;a.code=e.code||"";if(e.name==="NetworkError"||e.message.includes("network")){a.type="network";a.userMessage="Network error. Please check your internet connection.";a.adminMessage="Network error: "+e.message;a.isRetryable=true}else{a.userMessage="Unable to connect. Please refresh the page and try again.";a.adminMessage="Client error: "+e.message}a.finalMessage=s?a.adminMessage:a.userMessage}return a}function l(){const e=window.epkbChatWidgetRoot||"epkb-ai-chat-widget-root";return document.getElementById(e)}function u(e){return{"X-WP-Nonce":e,"Content-Type":"application/json"}}function d(e,t=null,s=1e4,a=null){const n={method:e,credentials:"same-origin",headers:u(a)};if(t){n.body=JSON.stringify(t)}if(typeof AbortSignal!=="undefined"&&AbortSignal.timeout){n.signal=AbortSignal.timeout(s)}return n}function g(e){const{createElement:t}=e;return function(){return t("div",{className:"epkb-ai-chat-message"},t("div",{className:"epkb-ai-chat-typing"},t("div",{className:"epkb-ai-chat-typing-dot"}),t("div",{className:"epkb-ai-chat-typing-dot"}),t("div",{className:"epkb-ai-chat-typing-dot"})))}}function m(e){const{createElement:t}=e;return function(){return t("div",{className:"epkb-ai-chat-loading-skeleton"},t("div",{className:"epkb-ai-chat-skeleton-message epkb-ai-chat-skeleton-message--bot"},t("div",{className:"epkb-ai-chat-skeleton-line"}),t("div",{className:"epkb-ai-chat-skeleton-line epkb-ai-chat-skeleton-line--short"})),t("div",{className:"epkb-ai-chat-skeleton-message epkb-ai-chat-skeleton-message--user"},t("div",{className:"epkb-ai-chat-skeleton-line"})),t("div",{className:"epkb-ai-chat-skeleton-message epkb-ai-chat-skeleton-message--bot"},t("div",{className:"epkb-ai-chat-skeleton-line"}),t("div",{className:"epkb-ai-chat-skeleton-line"}),t("div",{className:"epkb-ai-chat-skeleton-line epkb-ai-chat-skeleton-line--short"})))}}function f(e){const{useEffect:t}=e;return function(e,s,a){t((()=>{if(!s)return;const t=t=>{if(t.key==="Tab"&&e.current){const s=e.current.querySelectorAll('button:not([disabled]), input:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])');const a=s[0];const n=s[s.length-1];if(t.shiftKey&&document.activeElement===a){t.preventDefault();n.focus()}else if(!t.shiftKey&&document.activeElement===n){t.preventDefault();a.focus()}}if(t.key==="Escape"&&a){a()}};document.addEventListener("keydown",t);return()=>{document.removeEventListener("keydown",t)}}),[s,e,a])}}function p(e,t=false,s=null){if(!t){return e}const a='<button class="epkb-error-report-btn" style="margin-left: 10px; font-size: 12px; padding: 2px 8px; cursor: pointer;">Submit Issue</button>';return e+" "+a}window.EPKBChatUtils={isDebugMode:s,createMessage:a,prepareMessage:n,generateIdempotencyKey:r,parseMessageFormatting:o,isInvalidNonceError:i,parseAIChatErrorResponse:c,parseErrorResponse:c,formatErrorMessage:p,getChatRootElement:l,createHeaders:u,createFetchOptions:d,TypingIndicator:g,LoadingSkeleton:m,useFocusTrap:f}})();