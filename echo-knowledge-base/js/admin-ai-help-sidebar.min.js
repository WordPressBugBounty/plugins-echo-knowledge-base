jQuery(document).ready((function(e){if(wp&&wp.data){wp.data.subscribe((function(){setTimeout((function(){if(e("#epkb-ai-help-sidebar-button").length===0){var t=e(".edit-post-header-toolbar");if(typeof t!="undefined"){e(t).append('<input type="button" id="epkb-ai-help-sidebar-button" value="'+epkb_ai_vars.ai_help_button_title+'">')}}}),100)}))}e(document).on("click","#wp-admin-bar-epkb-ai-help-sidebar-button",(function(t){t.preventDefault();e(".epkb-ai-help-sidebar").addClass("epkb-ai-help-sidebar--active");e("#wp-admin-bar-epkb-ai-help-sidebar-button").addClass("wp-admin-bar-epkb-ai-help-sidebar-button--active");return false}));e(document).on("click","#epkb-ai-help-sidebar-button, #epkb-ai-help-meta-box-button",(function(){e(".epkb-ai-help-sidebar").addClass("epkb-ai-help-sidebar--active")}));e(document).on("click",".epkb-ai-help-sidebar-btn-close",(function(t){t.preventDefault();e(".epkb-ai-help-sidebar").removeClass("epkb-ai-help-sidebar--active");e("#wp-admin-bar-epkb-ai-help-sidebar-button").removeClass("wp-admin-bar-epkb-ai-help-sidebar-button--active");return false}));e(document).on("click",".epkb-ai-help-sidebar__nav-link",(function(){e(".epkb-ai-help-sidebar__nav-link").removeClass("epkb-ai-help-sidebar__nav-link--active");e(this).addClass("epkb-ai-help-sidebar__nav-link--active");let t=e(this).data("target");e(".epkb-ai-help-sidebar__body").removeClass("epkb-ai-help-sidebar__body--active");e(".epkb-ai-help-sidebar__body-"+t).addClass("epkb-ai-help-sidebar__body--active");e(".epkb-ai-help-sidebar").attr("data-active-tab",t)}));e(document).on("click",".epkb-ai-help-sidebar__open-settings-tab-btn",(function(t){t.stopPropagation();e(".epkb-ai-help-sidebar__nav-link").trigger("click");return false}));e(document).on("click",".epkb-ai-help-sidebar__main-intro__dismiss-btn",(function(){e(this).closest(".epkb-ai-help-sidebar__main-intro").remove();let t={action:"epkb_ai_request",_wpnonce_epkb_ajax_action:epkb_ai_vars.nonce,ai_action:"epkb_ai_dismiss_main_intro"};_(t,undefined,undefined,false,false,e(".epkb-ai-help-sidebar__improve-text-selected-text-container"))}));e(document).on("click",".epkb-ai__fix-improve-text-btn",(function(t){t.preventDefault();if(!i()){return false}e(".epkb-ai-help-sidebar__main").hide();e(".epkb-ai-help-sidebar__screen-usage").hide();e(".epkb-ai-help-sidebar").attr("data-back-btn","show");e(".epkb-ai-help-sidebar__improve-text").show();e(".epkb-ai-help-sidebar").addClass("epkb-ai-help-sidebar--select-text-mode");return false}));e(document).on("click",".epkb-ai-help-sidebar__nav-back-btn",(function(){e('[data-target="helper-functions"]').trigger("click");e(".epkb-ai-help-sidebar__main").show();e(".epkb-ai-help-sidebar__screen-usage").hide();e(".epkb-ai-help-sidebar").attr("data-back-btn","hide");e(".epkb-ai-help-sidebar__improve-text").hide();e(".epkb-ai-help-sidebar__article-outline").hide();e(".epkb-ai-help-sidebar").removeClass("epkb-ai-help-sidebar--select-text-mode")}));e(document).on("selectionchange",(function(){if(e(this.getSelection().anchorNode).closest("#wpbody-content").length==0){return}if(!e(".epkb-ai-help-sidebar").hasClass("epkb-ai-help-sidebar--active")||e(".epkb-ai-help-sidebar__improve-text").css("display")=="none"){return}if(document.getSelection().toString().length==0){return}let t=document.getSelection().getRangeAt(0);let a=t.cloneContents();e(".epkb-ai-help-sidebar__improve-text-input__textarea").html(a);e(".epkb-ai-help-sidebar__improve-text-input__textarea").find("#elementor-editor").remove();let i=n(e(".epkb-ai-help-sidebar__improve-text-input__textarea").html());e(".epkb-ai-help-sidebar__improve-text-input__textarea").html(i);let s=e(t.commonAncestorContainer).prop("tagName");if(s&&(s==="UL"||s==="OL")&&e(".epkb-ai-help-sidebar__improve-text-input__textarea").find(":first-child").prop("tagName")==="LI"){e(".epkb-ai-help-sidebar__improve-text-input__textarea").html("<"+s.toLowerCase()+">"+i+"</"+s.toLowerCase()+">")}}));e("#wp-admin-bar-epkb-ai-help-sidebar-button, #epkb-ai-help-meta-box-button").one("click",(function(){let t=e("#content_ifr").contents();t.on("selectionchange",(function(){if(!e(".epkb-ai-help-sidebar").hasClass("epkb-ai-help-sidebar--active")||e(".epkb-ai-help-sidebar__improve-text").css("display")=="none"){return}if(document.getElementById("content_ifr").contentDocument.getSelection().toString().length==0){return}let t=document.getElementById("content_ifr").contentDocument.getSelection().getRangeAt(0);let a=t.cloneContents();e(".epkb-ai-help-sidebar__improve-text-input__textarea").html(a);e(".epkb-ai-help-sidebar__improve-text-input__textarea").find("#elementor-editor").remove();let i=n(e(".epkb-ai-help-sidebar__improve-text-input__textarea").html());e(".epkb-ai-help-sidebar__improve-text-input__textarea").html(i);let s=e(t.commonAncestorContainer).prop("tagName");if(s&&(s==="UL"||s==="OL")&&e(".epkb-ai-help-sidebar__improve-text-input__textarea").find(":first-child").prop("tagName")==="LI"){e(".epkb-ai-help-sidebar__improve-text-input__textarea").html("<"+s.toLowerCase()+">"+i+"</"+s.toLowerCase()+">")}}))}));let t="";e(document).on("selectionchange",(function(){if(e(this.getSelection().anchorNode).closest(".epkb-ai-help-sidebar__improve-text-input__textarea-wrap").length==0){return}let a=document.getSelection().getRangeAt(0);t=a.cloneContents()}));e('.epkb-ai-help-sidebar__improve-text-toolbar input[type="submit"]').on("click",(function(a){let i=e("<div></div>").append(t).html();let n=s(i)>3?i:e(".epkb-ai-help-sidebar__improve-text-input__textarea").html();if(s(n)<3){r(epkb_ai_vars.msg_empty_input);return false}if(e(this).hasClass("epkb_ai_copy")){let t;if(s(i)>3){t=document.getSelection().getRangeAt(0)}else{t=document.createRange();t.selectNodeContents(e(".epkb-ai-help-sidebar__improve-text-input__textarea").get(0))}let a=window.getSelection();a.removeAllRanges();a.addRange(t);document.execCommand("copy");a.removeAllRanges();l(epkb_ai_vars.msg_ai_copied_to_clipboard);return}let p={action:"epkb_ai_request",_wpnonce_epkb_ajax_action:epkb_ai_vars.nonce,input_text:n,ai_action:e(this).attr("class").trim()};_(p,(function(t){if(!t.error&&typeof t.message!="undefined"){l(t.message);e(".epkb-ai-help-sidebar__screen-usage").show().find(".epkb-ai-help-sidebar__screen-usage-tokens span").html(t.tokens_used);if(typeof t.fixed_input_text!="undefined"&&t.fixed_input_text.length>0){if(s(i)>3){e(".epkb-ai-help-sidebar__improve-text-input__textarea").html(e(".epkb-ai-help-sidebar__improve-text-input__textarea").html().replace(n,t.fixed_input_text))}else{e(".epkb-ai-help-sidebar__improve-text-input__textarea").html(t.fixed_input_text)}}}}),undefined,false,false,e(".epkb-ai-help-sidebar__improve-text-selected-text-container"));return false}));e(document).on("click",".epkb_ai_generate_article_outline",(function(t){t.preventDefault();if(!i()){return false}let n="";if(e("input#title").length){n=a(e("input#title").val())}else{n=a(wp.data.select("core/editor").getEditedPostAttribute("title"))}e(".epkb-ai-help-sidebar__screen-usage").hide();e(".epkb-ai-help-sidebar__main").hide();e(".epkb-ai-help-sidebar__article-outline").show();e(".epkb-ai-help-sidebar__article-outline-input-container").show();e(".epkb-ai-help-sidebar__article-outline-results-container").hide();e(".epkb-ai-help-sidebar").attr("data-back-btn","show");e("#epkb_ai_article_title").val(n);return false}));e(document).on("click",".epkb_ai_generate_article_outline_button ",(function(t){t.preventDefault();if(!i()){return false}let a=e("#epkb_ai_article_title").val();if(a.length<3){r(epkb_ai_vars.msg_empty_input);return false}let n={action:"epkb_ai_request",_wpnonce_epkb_ajax_action:epkb_ai_vars.nonce,input_text:a,ai_action:"epkb_ai_generate_outline"};_(n,(function(t){if(!t.error&&typeof t.message!="undefined"&&typeof t.result!="undefined"&&t.result.length>0){l(t.message)}if(typeof t.result!="undefined"&&t.result.length>0){e(".epkb-ai-help-sidebar__screen-usage").show().find(".epkb-ai-help-sidebar__screen-usage-tokens span").html(t.tokens_used);e(".epkb-ai-help-sidebar__article-outline-result__textarea").html(t.result);e(".epkb-ai-help-sidebar__article-outline-input-container").hide();e(".epkb-ai-help-sidebar__article-outline-results-container").show()}}),undefined,false,false,e(".epkb-ai-help-sidebar__article-outline"))}));e(document).on("keypress",".epkb-ai-help-sidebar__ai-input",(function(t){if(t.keyCode!==13&&t.which!==13&&t.key!=="Enter"){return}let i=e(this);let n=a(i.val());e(".epkb-ai-help-sidebar__ai-response-container").html('<div class="epkb-ai-help-sidebar__ai-response-prompt">'+'<span class="epkbfa epkbfa-user epkb-ai-help-sidebar__ai-response-prompt-icon"></span>'+'<div class="epkb-ai-help-sidebar__ai-response-prompt-text">'+n+"</div>"+"</div>");i.attr("disabled","disabled");let s={action:"epkb_ai_request",_wpnonce_epkb_ajax_action:epkb_ai_vars.nonce,input_text:n,ai_action:"epkb_ai_chat"};_(s,(function(t){if(typeof t.result!="undefined"&&t.result.length>0){e(".epkb-ai-help-sidebar__screen-usage").show().find(".epkb-ai-help-sidebar__screen-usage-tokens span").html(t.tokens_used);e(".epkb-ai-help-sidebar__ai-response-container").append('<div class="epkb-ai-help-sidebar__ai-response-result">'+'<span class="ep_font_icon_light_bulb epkb-ai-help-sidebar__ai-response-result-icon"></span>'+'<div class="epkb-ai-help-sidebar__ai-response-result-text">'+a(t.result)+"</div>"+"</div>")}}),undefined,false,(function(){i.removeAttr("disabled").focus()}),e(".epkb-ai-help-sidebar__ai-response-container"))}));e(document).on("click",".epkb-ai__open-feedback-btn, #ai-help-feedback-link",(function(t){e(".epkb-ai-help-sidebar__nav-link").removeClass("epkb-ai-help-sidebar__nav-link--active");let a=e(this).data("target");e(".epkb-ai-help-sidebar__body").removeClass("epkb-ai-help-sidebar__body--active");e(".epkb-ai-help-sidebar__body-"+a).addClass("epkb-ai-help-sidebar__body--active");e(".epkb-ai-help-sidebar").attr("data-active-tab",a);e(".epkb-ai-help-sidebar").attr("data-back-btn","show");return false}));e(document).on("submit",".epkb-ai-help-sidebar__feedback-form",(function(t){t.preventDefault();t.stopPropagation();let a=e(this);let i={action:"epkb_ai_feedback",_wpnonce_epkb_ajax_action:epkb_ai_vars.nonce,feedback_text:a.find('textarea[name="feedback_text"]').val(),feedback_email:a.find('input[name="feedback_email"]').val(),feedback_name:a.find('input[name="feedback_name"]').val()};_(i,(function(t){if(typeof t.message!="undefined"&&t.message.length>0){l(t.message);e(".epkb-ai-help-sidebar__nav-back-btn").trigger("click")}}),undefined,false,false,e(".epkb-ai-help-sidebar__feedback-form"))}));function a(e){return e.trim().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function i(){if(e(".epkb-ai-help-sidebar").attr("data-apikey-state")==="off"){let t=e("#openai_api_key");if(t.length&&!t.val().trim().length){r(epkb_ai_vars.msg_no_key_admin);e(".epkb-ai-help-sidebar__nav-link").trigger("click")}else if(!t.length){r(epkb_ai_vars.msg_no_key)}return false}return true}function n(e){return e.replace(/(<\/?(?:span|p|li|ul|ol|br|i|strong|b|h1|h2|h3|h4|h5|h6|em|sub|sup|pre)[^>]*>)|<[^>]+>/gi,"$1").replace(/\s+\S+?=("|')(.*?)("|')/g,"")}function s(e){return e.replace(/<[^>]*>/g,"").replace(/&nbsp;/g,"").trim().length}e(document).on("click",".epkb-ai-help-sidebar__settings-save-btn",(function(){let t=e(".epkb-ai-help-sidebar__settings-form");if(!t.length){return}let a=e('input[name="openai_api_key"]').val().trim();let i={action:"epkb_ai_request",_wpnonce_epkb_ajax_action:epkb_ai_vars.nonce,ai_action:"epkb_ai_save_settings",openai_api_key:a,enable_legacy_open_ai:e('input[name="enable_legacy_open_ai"]').prop("checked")?"on":"off"};_(i,(function(t){if(!t.error&&typeof t.message!="undefined"){l(t.message);let i=a.length>0?"on":"off";e(".epkb-ai-help-sidebar").attr("data-apikey-state",i)}}),undefined,false,false,e(".epkb-ai-help-sidebar__body-settings"));return false}));function p(e,t,a){return'<div class="eckb-bottom-notice-message">'+'<span class="eckb-bottom-notice-message-icon '+(a=="success"?"ep_font_icon_checkmark":"epkbfa epkbfa-times-circle")+'"></span>'+'<div class="contents">'+'<span class="'+a+'">'+(e?"<h4>"+e+"</h4>":"")+(t?"<p>"+t+"</p>":"")+"</span>"+"</div>"+"</div>"}let o;function r(t,a=""){e(".epkb-ai-help-sidebar__bottom-notice-message-container").html("");e(".epkb-ai-help-sidebar__bottom-notice-message-container").append(p(a,t,"error"));clearTimeout(o);o=setTimeout((function(){e(".eckb-bottom-notice-message").addClass("fadeOutDown")}),1e4)}function l(t,a=""){e(".epkb-ai-help-sidebar__bottom-notice-message-container").html("");e(".epkb-ai-help-sidebar__bottom-notice-message-container").append(p(a,t,"success"));clearTimeout(o);o=setTimeout((function(){e(".eckb-bottom-notice-message").addClass("fadeOutDown")}),1e4)}function b(t){if(!t.length){return}e("html, body").animate({scrollTop:t.offset().top-100},300)}e(document.body).on("click",".epkb-close-notice",(function(){let t=e(this).closest(".eckb-bottom-notice-message");t.addClass("fadeOutDown");setTimeout((function(){t.html("")}),1e3)}));e(document.body).on("click",".epkbfa-times-circle",(function(){let t=e(this).closest(".epkb-ai-help-sidebar__bottom-notice-message-container");t.addClass("fadeOutDown");setTimeout((function(){t.html("")}),1e3)}));function _(t,a,i,n,s,o){let r;let l;a=typeof a==="undefined"?"epkb_callback_noop":a;e.ajax({type:"POST",dataType:"json",data:t,url:ajaxurl,beforeSend:function(e){if(typeof o=="undefined"||o===false){d("show",epkb_ai_vars.msg_ai_help_loading)}if(typeof o=="object"){d("show",epkb_ai_vars.msg_ai_help_loading,o)}}}).done((function(e){l=e?e:"";if(l.error||typeof l.message==="undefined"){r=l.message?l.message:p("",epkb_ai_vars.reload_try_again,"error")}})).fail((function(e,t,a){r=a?" ["+a+"]":epkb_ai_vars.unknown_error;r=p(epkb_ai_vars.error_occurred+". "+epkb_ai_vars.msg_try_again,r,"error")})).always((function(){l=typeof l==="undefined"?"":l;if(typeof s=="function"){s(l)}if(typeof o=="undefined"||o===false){d("remove","")}if(typeof o=="object"){d("remove","",o)}if(r){e(".epkb-ai-help-sidebar__bottom-notice-message-container").html("");e(".epkb-ai-help-sidebar__bottom-notice-message-container").append(r);setTimeout((function(){e(".eckb-bottom-notice-message").addClass("fadeOutDown")}),1e4);return}if(typeof a==="function"){if(i==="undefined"){a(l)}else{a(l,i)}}else{if(n){location.reload()}}}))}e(".epkb-ai-help-sidebar__improve-text-result__textarea").on("click",(function(){this.focus();this.select()}));function d(e,t,a){if(e==="show"){let e='<div class="epkb-admin-dialog-box-loading">'+'<div class="epkb-admin-dbl__header">'+'<div class="epkb-admin-dbl-icon epkbfa epkbfa-hourglass-half"></div>'+(t?'<div class="epkb-admin-text">'+t+"</div>":"")+"</div>"+"</div>"+'<div class="epkb-admin-dialog-box-overlay"></div>';a.append(e)}else if(e==="remove"){a.find(".epkb-admin-dialog-box-loading").remove();a.find(".epkb-admin-dialog-box-overlay").remove()}}}));