jQuery(document).ready((function(e){wp&&wp.data&&wp.data.subscribe((function(){setTimeout((function(){if(0===e("#epkb-ai-help-sidebar-button").length){var t=e(".edit-post-header-toolbar");void 0!==t&&e(t).append('<input type="button" id="epkb-ai-help-sidebar-button" value="'+epkb_ai_vars.ai_help_button_title+'">')}}),100)})),e(document).on("click","#wp-admin-bar-epkb-ai-help-sidebar-button",(function(t){return t.preventDefault(),e(".epkb-ai-help-sidebar").addClass("epkb-ai-help-sidebar--active"),e("#wp-admin-bar-epkb-ai-help-sidebar-button").addClass("wp-admin-bar-epkb-ai-help-sidebar-button--active"),!1})),e(document).on("click","#epkb-ai-help-sidebar-button, #epkb-ai-help-meta-box-button",(function(){e(".epkb-ai-help-sidebar").addClass("epkb-ai-help-sidebar--active")})),e(document).on("click",".epkb-ai-help-sidebar-btn-close",(function(t){return t.preventDefault(),e(".epkb-ai-help-sidebar").removeClass("epkb-ai-help-sidebar--active"),e("#wp-admin-bar-epkb-ai-help-sidebar-button").removeClass("wp-admin-bar-epkb-ai-help-sidebar-button--active"),!1})),e(document).on("click",".epkb-ai-help-sidebar__nav-link",(function(){e(".epkb-ai-help-sidebar__nav-link").removeClass("epkb-ai-help-sidebar__nav-link--active"),e(this).addClass("epkb-ai-help-sidebar__nav-link--active");let t=e(this).data("target");e(".epkb-ai-help-sidebar__body").removeClass("epkb-ai-help-sidebar__body--active"),e(".epkb-ai-help-sidebar__body-"+t).addClass("epkb-ai-help-sidebar__body--active"),e(".epkb-ai-help-sidebar").attr("data-active-tab",t)})),e(document).on("click",".epkb-ai-help-sidebar__open-settings-tab-btn",(function(t){return t.stopPropagation(),e(".epkb-ai-help-sidebar__nav-link").trigger("click"),!1})),e(document).on("click",".epkb-ai-help-sidebar__main-intro__dismiss-btn",(function(){e(this).closest(".epkb-ai-help-sidebar__main-intro").remove(),b({action:"epkb_ai_request",_wpnonce_epkb_ajax_action:epkb_ai_vars.nonce,ai_action:"epkb_ai_dismiss_main_intro"},void 0,void 0,!1,!1,e(".epkb-ai-help-sidebar__improve-text-selected-text-container"))})),e(document).on("click",".epkb-ai__fix-improve-text-btn",(function(t){return t.preventDefault(),!!n()&&(e(".epkb-ai-help-sidebar__main").hide(),e(".epkb-ai-help-sidebar__screen-usage").hide(),e(".epkb-ai-help-sidebar").attr("data-back-btn","show"),e(".epkb-ai-help-sidebar__improve-text").show(),e(".epkb-ai-help-sidebar").addClass("epkb-ai-help-sidebar--select-text-mode"),!1)})),e(document).on("click",".epkb-ai-help-sidebar__nav-back-btn",(function(){e('[data-target="helper-functions"]').trigger("click"),e(".epkb-ai-help-sidebar__main").show(),e(".epkb-ai-help-sidebar__screen-usage").hide(),e(".epkb-ai-help-sidebar").attr("data-back-btn","hide"),e(".epkb-ai-help-sidebar__improve-text").hide(),e(".epkb-ai-help-sidebar__article-outline").hide(),e(".epkb-ai-help-sidebar").removeClass("epkb-ai-help-sidebar--select-text-mode")})),e(document).on("selectionchange",(function(){if(0==e(this.getSelection().anchorNode).closest("#wpbody-content").length)return;if(!e(".epkb-ai-help-sidebar").hasClass("epkb-ai-help-sidebar--active")||"none"==e(".epkb-ai-help-sidebar__improve-text").css("display"))return;if(0==document.getSelection().toString().length)return;let t=document.getSelection().getRangeAt(0),a=t.cloneContents();e(".epkb-ai-help-sidebar__improve-text-input__textarea").html(a),e(".epkb-ai-help-sidebar__improve-text-input__textarea").find("#elementor-editor").remove();let i=o(e(".epkb-ai-help-sidebar__improve-text-input__textarea").html());e(".epkb-ai-help-sidebar__improve-text-input__textarea").html(i);let n=e(t.commonAncestorContainer).prop("tagName");!n||"UL"!==n&&"OL"!==n||"LI"!==e(".epkb-ai-help-sidebar__improve-text-input__textarea").find(":first-child").prop("tagName")||e(".epkb-ai-help-sidebar__improve-text-input__textarea").html("<"+n.toLowerCase()+">"+i+"</"+n.toLowerCase()+">")})),e("#wp-admin-bar-epkb-ai-help-sidebar-button, #epkb-ai-help-meta-box-button").one("click",(function(){e("#content_ifr").contents().on("selectionchange",(function(){if(!e(".epkb-ai-help-sidebar").hasClass("epkb-ai-help-sidebar--active")||"none"==e(".epkb-ai-help-sidebar__improve-text").css("display"))return;if(0==document.getElementById("content_ifr").contentDocument.getSelection().toString().length)return;let t=document.getElementById("content_ifr").contentDocument.getSelection().getRangeAt(0),a=t.cloneContents();e(".epkb-ai-help-sidebar__improve-text-input__textarea").html(a),e(".epkb-ai-help-sidebar__improve-text-input__textarea").find("#elementor-editor").remove();let i=o(e(".epkb-ai-help-sidebar__improve-text-input__textarea").html());e(".epkb-ai-help-sidebar__improve-text-input__textarea").html(i);let n=e(t.commonAncestorContainer).prop("tagName");!n||"UL"!==n&&"OL"!==n||"LI"!==e(".epkb-ai-help-sidebar__improve-text-input__textarea").find(":first-child").prop("tagName")||e(".epkb-ai-help-sidebar__improve-text-input__textarea").html("<"+n.toLowerCase()+">"+i+"</"+n.toLowerCase()+">")}))}));let t,a="";function i(e){return e.trim().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function n(){if("off"===e(".epkb-ai-help-sidebar").attr("data-apikey-state")){let t=e("#openai_api_key");return t.length&&!t.val().trim().length?(r(epkb_ai_vars.msg_no_key_admin),e(".epkb-ai-help-sidebar__nav-link").trigger("click")):t.length||r(epkb_ai_vars.msg_no_key),!1}return!0}function o(e){return e.replace(/(<\/?(?:span|p|li|ul|ol|br|i|strong|b|h1|h2|h3|h4|h5|h6|em|sub|sup|pre)[^>]*>)|<[^>]+>/gi,"$1").replace(/\s+\S+?=("|')(.*?)("|')/g,"")}function p(e){return e.replace(/<[^>]*>/g,"").replace(/&nbsp;/g,"").trim().length}function s(e,t,a){return'<div class="eckb-bottom-notice-message"><span class="eckb-bottom-notice-message-icon '+("success"==a?"ep_font_icon_checkmark":"epkbfa epkbfa-times-circle")+'"></span><div class="contents"><span class="'+a+'">'+(e?"<h4>"+e+"</h4>":"")+(t?"<p>"+t+"</p>":"")+"</span></div></div>"}function r(a,i=""){e(".epkb-ai-help-sidebar__bottom-notice-message-container").html(""),e(".epkb-ai-help-sidebar__bottom-notice-message-container").append(s(i,a,"error")),clearTimeout(t),t=setTimeout((function(){e(".eckb-bottom-notice-message").addClass("fadeOutDown")}),1e4)}function l(a,i=""){e(".epkb-ai-help-sidebar__bottom-notice-message-container").html(""),e(".epkb-ai-help-sidebar__bottom-notice-message-container").append(s(i,a,"success")),clearTimeout(t),t=setTimeout((function(){e(".eckb-bottom-notice-message").addClass("fadeOutDown")}),1e4)}function b(t,a,i,n,o,p){let r,l;a=void 0===a?"epkb_callback_noop":a,e.ajax({type:"POST",dataType:"json",data:t,url:ajaxurl,beforeSend:function(e){void 0!==p&&!1!==p||_("show",epkb_ai_vars.msg_ai_help_loading),"object"==typeof p&&_("show",epkb_ai_vars.msg_ai_help_loading,p)}}).done((function(e){l=e||"",(l.error||void 0===l.message)&&(r=l.message?l.message:s("",epkb_ai_vars.reload_try_again,"error"))})).fail((function(e,t,a){r=a?" ["+a+"]":epkb_ai_vars.unknown_error,r=s(epkb_ai_vars.error_occurred+". "+epkb_ai_vars.msg_try_again,r,"error")})).always((function(){if(l=void 0===l?"":l,"function"==typeof o&&o(l),void 0!==p&&!1!==p||_("remove",""),"object"==typeof p&&_("remove","",p),r)return e(".epkb-ai-help-sidebar__bottom-notice-message-container").html(""),e(".epkb-ai-help-sidebar__bottom-notice-message-container").append(r),void setTimeout((function(){e(".eckb-bottom-notice-message").addClass("fadeOutDown")}),1e4);"function"==typeof a?"undefined"===i?a(l):a(l,i):n&&location.reload()}))}function _(e,t,a){if("show"===e){let e='<div class="epkb-admin-dialog-box-loading"><div class="epkb-admin-dbl__header"><div class="epkb-admin-dbl-icon epkbfa epkbfa-hourglass-half"></div>'+(t?'<div class="epkb-admin-text">'+t+"</div>":"")+'</div></div><div class="epkb-admin-dialog-box-overlay"></div>';a.append(e)}else"remove"===e&&(a.find(".epkb-admin-dialog-box-loading").remove(),a.find(".epkb-admin-dialog-box-overlay").remove())}e(document).on("selectionchange",(function(){if(0==e(this.getSelection().anchorNode).closest(".epkb-ai-help-sidebar__improve-text-input__textarea-wrap").length)return;let t=document.getSelection().getRangeAt(0);a=t.cloneContents()})),e('.epkb-ai-help-sidebar__improve-text-toolbar input[type="submit"]').on("click",(function(t){let i=e("<div></div>").append(a).html(),n=p(i)>3?i:e(".epkb-ai-help-sidebar__improve-text-input__textarea").html();if(p(n)<3)return r(epkb_ai_vars.msg_empty_input),!1;if(e(this).hasClass("epkb_ai_copy")){let t;p(i)>3?t=document.getSelection().getRangeAt(0):(t=document.createRange(),t.selectNodeContents(e(".epkb-ai-help-sidebar__improve-text-input__textarea").get(0)));let a=window.getSelection();return a.removeAllRanges(),a.addRange(t),document.execCommand("copy"),a.removeAllRanges(),void l(epkb_ai_vars.msg_ai_copied_to_clipboard)}return b({action:"epkb_ai_request",_wpnonce_epkb_ajax_action:epkb_ai_vars.nonce,input_text:n,ai_action:e(this).attr("class").trim()},(function(t){t.error||void 0===t.message||(l(t.message),e(".epkb-ai-help-sidebar__screen-usage").show().find(".epkb-ai-help-sidebar__screen-usage-tokens span").html(t.tokens_used),void 0!==t.fixed_input_text&&t.fixed_input_text.length>0&&(p(i)>3?e(".epkb-ai-help-sidebar__improve-text-input__textarea").html(e(".epkb-ai-help-sidebar__improve-text-input__textarea").html().replace(n,t.fixed_input_text)):e(".epkb-ai-help-sidebar__improve-text-input__textarea").html(t.fixed_input_text)))}),void 0,!1,!1,e(".epkb-ai-help-sidebar__improve-text-selected-text-container")),!1})),e(document).on("click",".epkb_ai_generate_article_outline",(function(t){if(t.preventDefault(),!n())return!1;let a="";return a=e("input#title").length?i(e("input#title").val()):i(wp.data.select("core/editor").getEditedPostAttribute("title")),e(".epkb-ai-help-sidebar__screen-usage").hide(),e(".epkb-ai-help-sidebar__main").hide(),e(".epkb-ai-help-sidebar__article-outline").show(),e(".epkb-ai-help-sidebar__article-outline-input-container").show(),e(".epkb-ai-help-sidebar__article-outline-results-container").hide(),e(".epkb-ai-help-sidebar").attr("data-back-btn","show"),e("#epkb_ai_article_title").val(a),!1})),e(document).on("click",".epkb_ai_generate_article_outline_button ",(function(t){if(t.preventDefault(),!n())return!1;let a=e("#epkb_ai_article_title").val();if(a.length<3)return r(epkb_ai_vars.msg_empty_input),!1;b({action:"epkb_ai_request",_wpnonce_epkb_ajax_action:epkb_ai_vars.nonce,input_text:a,ai_action:"epkb_ai_generate_outline"},(function(t){!t.error&&void 0!==t.message&&void 0!==t.result&&t.result.length>0&&l(t.message),void 0!==t.result&&t.result.length>0&&(e(".epkb-ai-help-sidebar__screen-usage").show().find(".epkb-ai-help-sidebar__screen-usage-tokens span").html(t.tokens_used),e(".epkb-ai-help-sidebar__article-outline-result__textarea").html(t.result),e(".epkb-ai-help-sidebar__article-outline-input-container").hide(),e(".epkb-ai-help-sidebar__article-outline-results-container").show())}),void 0,!1,!1,e(".epkb-ai-help-sidebar__article-outline"))})),e(document).on("keypress",".epkb-ai-help-sidebar__ai-input",(function(t){if(13!==t.keyCode&&13!==t.which&&"Enter"!==t.key)return;let a=e(this),n=i(a.val());e(".epkb-ai-help-sidebar__ai-response-container").html('<div class="epkb-ai-help-sidebar__ai-response-prompt"><span class="epkbfa epkbfa-user epkb-ai-help-sidebar__ai-response-prompt-icon"></span><div class="epkb-ai-help-sidebar__ai-response-prompt-text">'+n+"</div></div>"),a.attr("disabled","disabled"),b({action:"epkb_ai_request",_wpnonce_epkb_ajax_action:epkb_ai_vars.nonce,input_text:n,ai_action:"epkb_ai_chat"},(function(t){void 0!==t.result&&t.result.length>0&&(e(".epkb-ai-help-sidebar__screen-usage").show().find(".epkb-ai-help-sidebar__screen-usage-tokens span").html(t.tokens_used),e(".epkb-ai-help-sidebar__ai-response-container").append('<div class="epkb-ai-help-sidebar__ai-response-result"><span class="ep_font_icon_light_bulb epkb-ai-help-sidebar__ai-response-result-icon"></span><div class="epkb-ai-help-sidebar__ai-response-result-text">'+i(t.result)+"</div></div>"))}),void 0,!1,(function(){a.removeAttr("disabled").focus()}),e(".epkb-ai-help-sidebar__ai-response-container"))})),e(document).on("click",".epkb-ai__open-feedback-btn, #ai-help-feedback-link",(function(t){e(".epkb-ai-help-sidebar__nav-link").removeClass("epkb-ai-help-sidebar__nav-link--active");let a=e(this).data("target");return e(".epkb-ai-help-sidebar__body").removeClass("epkb-ai-help-sidebar__body--active"),e(".epkb-ai-help-sidebar__body-"+a).addClass("epkb-ai-help-sidebar__body--active"),e(".epkb-ai-help-sidebar").attr("data-active-tab",a),e(".epkb-ai-help-sidebar").attr("data-back-btn","show"),!1})),e(document).on("submit",".epkb-ai-help-sidebar__feedback-form",(function(t){t.preventDefault(),t.stopPropagation();let a=e(this);b({action:"epkb_ai_feedback",_wpnonce_epkb_ajax_action:epkb_ai_vars.nonce,feedback_text:a.find('textarea[name="feedback_text"]').val(),feedback_email:a.find('input[name="feedback_email"]').val(),feedback_name:a.find('input[name="feedback_name"]').val()},(function(t){void 0!==t.message&&t.message.length>0&&(l(t.message),e(".epkb-ai-help-sidebar__nav-back-btn").trigger("click"))}),void 0,!1,!1,e(".epkb-ai-help-sidebar__feedback-form"))})),e(document).on("click",".epkb-ai-help-sidebar__settings-save-btn",(function(){if(!e(".epkb-ai-help-sidebar__settings-form").length)return;let t=e('input[name="openai_api_key"]').val().trim();return b({action:"epkb_ai_request",_wpnonce_epkb_ajax_action:epkb_ai_vars.nonce,ai_action:"epkb_ai_save_settings",openai_api_key:t,enable_legacy_open_ai:e('input[name="enable_legacy_open_ai"]').prop("checked")?"on":"off"},(function(a){if(!a.error&&void 0!==a.message){l(a.message);let i=t.length>0?"on":"off";e(".epkb-ai-help-sidebar").attr("data-apikey-state",i)}}),void 0,!1,!1,e(".epkb-ai-help-sidebar__body-settings")),!1})),e(document.body).on("click",".epkb-close-notice",(function(){let t=e(this).closest(".eckb-bottom-notice-message");t.addClass("fadeOutDown"),setTimeout((function(){t.html("")}),1e3)})),e(document.body).on("click",".epkbfa-times-circle",(function(){let t=e(this).closest(".epkb-ai-help-sidebar__bottom-notice-message-container");t.addClass("fadeOutDown"),setTimeout((function(){t.html("")}),1e3)})),e(".epkb-ai-help-sidebar__improve-text-result__textarea").on("click",(function(){this.focus(),this.select()}))}));