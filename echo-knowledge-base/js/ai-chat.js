(function(){"use strict";const e=window.wp&&window.wp.element;const t=e||window.React;const n=window.ReactDOM;if(!t||!n){console.error("EPKB Chat widget: React is not available");return}if(!window.EPKBChatAPI||!window.EPKBChatSession||!window.EPKBChatUtils){console.error("EPKB Chat widget: Required modules not loaded");return}const{useState:a,useEffect:s,useRef:r,createElement:o,memo:c}=t;const{ChatAPIClient:i}=window.EPKBChatAPI;const{SessionManager:l}=window.EPKBChatSession;const{isDebugMode:u,createMessage:d,prepareMessage:f,parseMessageFormatting:g,getChatRootElement:h,TypingIndicator:w,LoadingSkeleton:m,useFocusTrap:p}=window.EPKBChatUtils;const v=w(t);const b=m(t);const k=p(t);const y=c((function e({message:t,isUser:n}){const a=!n?g(t):t;return o("div",{className:`epkb-ai-chat-message ${n?"epkb-ai-chat-message--user":"epkb-ai-chat-message--bot"}`},o("div",{className:"epkb-ai-chat-message-content",...!n&&a!==t?{dangerouslySetInnerHTML:{__html:a}}:{}},!n&&a!==t?null:t))}),((e,t)=>e.message===t.message&&e.isUser===t.isUser));function _(){const[e,t]=a(false);const n=window.epkbAIChat||{};const c=n.welcome||"Hello! How can I help you today?";const g=h();const w=g&&g.getAttribute("data-is-admin")==="true";const m=u();const p=w||m;if(m&&!w){console.log("EPKB AI Chat: Debug mode enabled. Technical messages will be shown.");console.log("To disable debug mode, run: epkbEnableDebug(false)")}const _=r(new l);const C=r(new i({rest_url:n.rest_url,rest_nonce:n.rest_nonce,isAdmin:w,debugMode:m}));s((()=>{C.current.setSessionManager(_.current)}),[]);const[I,N]=a([d(c,false)]);const[M,E]=a("");const[P,S]=a(false);const[x,A]=a(false);const[R,K]=a("");const[U,T]=a(false);const[B,D]=a(false);const[F,L]=a(n.rest_nonce||"");const[$,H]=a("");const O=r(n.rest_nonce||"");const W=r(false);const Y=r(false);const q=r(false);const V=r(null);const j=r(false);const z=r(null);const G=r(null);const J=r(null);s((()=>{O.current=F;C.current.setNonce(F)}),[F]);s((()=>{if(e&&!Y.current){Y.current=true}}),[e]);s((()=>{if(!e||q.current)return;q.current=true;async function t(){const e=_.current.load();if(e.error){if(p){console.error("Failed to load session:",e.error);if(e.error.type==="storage_error"){console.error("Session storage error details:",e.error.details)}}}if(e.valid&&e.chatId){H(e.chatId);return}const t=await C.current.getActiveConversation();if(t.success&&t.data&&t.data.chat_id){H(t.data.chat_id);_.current.save(null,t.data.chat_id);return}if(!t.success&&t.action){switch(t.action){case"refresh_nonce":if(p){console.log("Invalid nonce when checking active conversation, refreshing...")}const e=await Z(true);if(e){const e=await C.current.getActiveConversation();if(e.success&&e.data&&e.data.chat_id){H(e.data.chat_id);_.current.save(null,e.data.chat_id);return}}break;case"show_error":if(t.userMessage){K(t.userMessage)}break;case"continue":default:break}}T(true)}t()}),[e,p]);s((()=>{if($&&!U&&!B){ee($)}}),[$,U,B]);s((()=>{if(G.current){G.current.scrollIntoView({behavior:"smooth"})}}),[I,P]);s((()=>{if($&&I.length>1){const e=I.map((e=>({id:e.messageId,content:e.text,role:e.isUser?"user":"assistant"})));_.current.saveMessages($,e)}}),[$,I]);k(z,e,(()=>t(false)));s((()=>{if(e){j.current=true;if(J.current){J.current.focus()}}else if(j.current){if(V.current){V.current.focus()}}}),[e]);s((()=>()=>{W.current=false;C.current.clearRetries()}),[]);function Q(){A(false);S(false);W.current=false}function X(e){if(e.new_token){if(p){console.log("Received new token from server")}L(e.new_token);O.current=e.new_token;C.current.setNonce(e.new_token)}}async function Z(e=false){const t=await C.current.refreshNonce(e);if(t){L(t);O.current=t}return t}async function ee(e){if(U||!e||B){return}D(true);K("");const t=_.current.loadMessages(e);if(t&&t.length>0){if(p){console.log(`Loaded ${t.length} messages from cache`)}const e=t.map((e=>d(e.content,e.role==="user",e.id)));N(e);T(true);D(false);return}await te(e)}async function te(e){const t=await C.current.loadConversationHistoryWithRetry(null,e,{onSuccess:e=>{const t=e.map((e=>d(e.content,e.role==="user",e.id)));N(t);T(true)},onNewToken:X,onInvalidNonce:async()=>{await Z(true);T(false);D(false)},onExpired:e=>{ae({finalMessage:e})},onError:e=>{K(e);T(true)}});if(!t.success&&!t.invalidNonce){T(true)}D(false)}async function ne(){if(p){console.log("Starting new conversation...")}const e=await C.current.clearConversation();if(e.success&&e.data&&e.data.chat_id){const t=e.data.chat_id;H(t);_.current.save(null,t);_.current.clearMessageCache($);N([d(c,false)]);K("");T(true);if(p){console.log("New conversation started with chat_id:",t)}}else{if(e.action==="refresh_nonce"){if(p){console.log("Invalid nonce when clearing conversation, refreshing...")}const e=await Z(true);if(e){const e=await C.current.clearConversation();if(e.success&&e.data&&e.data.chat_id){const t=e.data.chat_id;H(t);_.current.save(null,t);_.current.clearMessageCache($);N([d(c,false)]);K("");T(true);return}}}if(e.userMessage){K(e.userMessage)}else{K("Failed to start new conversation. Please try again.")}if(p&&e.errorInfo){console.error("Failed to clear conversation:",e.errorInfo)}}}function ae(e){K("Your previous conversation has expired. Starting a new conversation...");const t=$;H("");_.current.clearChatOnly();if(t){_.current.clearMessageCache(t)}T(true);setTimeout((()=>{K("")}),5e3)}async function se(e,t){const a=await C.current.sendMessageWithRetry(e,t,$,n.widget_id||"1",0,false,{onNewToken:X,onSessionUpdate:e=>{H(e.chatId);if(e.chatId){T(true)}},onSuccess:e=>{const t=d(e.response,false,e.message_id);N((e=>{const n=e.some((e=>e.messageId===t.messageId||!e.isUser&&e.text===t.text&&Math.abs(e.id-t.id)<5e3));if(n){if(p){console.log("Duplicate bot message detected, skipping:",t.messageId)}return e}return[...e,t]}));Q()},onInvalidNonce:async()=>{await Z(true);W.current=false;A(false)},onTimeoutError:(e,t)=>{Q();const a=t?t.finalMessage:n.error_generic||"Unable to connect. Please refresh the page and try again.";K(a)},onRetry:(e,t)=>{A(false);W.current=false;if(e>1){S(true)}},onFinalError:(e,t)=>{Q();if(t&&t.code){if(t.code==="conversation_expired"||t.code==="invalid_chat_id"||t.code==="chat_not_found"){ae(t);return}if(t.code==="invalid_session"||t.code==="session_expired"){K("Your session has expired. Please refresh the page to continue.");return}}let a;if(t){a=t.finalMessage;if(t.type==="rate_limit"&&t.context.retryAfter){a+=` Please try again in ${t.context.retryAfter} seconds.`}if(w&&t.code){console.error("AI Chat Error Details:",{type:t.type,code:t.code,statusCode:t.statusCode,context:t.context})}}else{a=n.error_generic||"Unable to connect. Please refresh the page and try again."}K(a)}});return a}const re=async()=>{if(x||W.current)return;const e=f(M);if(!e.valid){return}C.current.clearRetries();K("");N((t=>[...t,e.message]));E("");S(true);W.current=true;A(true);await se(e.text,e.messageId)};const oe=e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();re()}};function ce(){return o("div",{className:"epkb-ai-chat-widget"},e&&o("div",{className:"epkb-ai-chat-window",role:"dialog","aria-modal":"true","aria-label":n.title||"AI Assistant",ref:z},o("div",{className:"epkb-ai-chat-header"},o("h3",null,n.title||"AI Assistant"),o("div",{className:"epkb-ai-chat-header-actions"},$&&o("button",{onClick:async()=>{if(confirm("Start a new conversation?")){await ne()}},className:"epkb-ai-chat-new",title:"New Conversation","aria-label":"Start new conversation"},"ðŸ”„"),o("button",{onClick:()=>t(false),className:"epkb-ai-chat-close","aria-label":"Close chat"},"Ã—"))),o("div",{className:"epkb-ai-chat-messages"},B&&I.length===1?o(b):I.map((e=>o(y,{key:e.messageId||e.id,message:e.text,isUser:e.isUser}))),P&&o(v),o("div",{ref:G}),R&&o("div",{className:"epkb-ai-chat-error",style:{position:"sticky",bottom:0,marginTop:"10px"}},R)),o("div",{className:"epkb-ai-chat-input-container"},o("div",{className:"epkb-ai-chat-input-wrapper"},o("input",{ref:J,type:"text",value:M,onChange:e=>E(e.target.value),onKeyDown:oe,placeholder:n.placeholder||"Type your message...",className:"epkb-ai-chat-input"}),o("button",{onClick:re,className:`epkb-ai-chat-send ${x?"epkb-ai-chat-send--loading":""}`,disabled:!M.trim()||x,"aria-label":x?"Sending message":"Send message"},x?"âŸ³":"âž¤")))),o("button",{onClick:()=>t(!e),className:`epkb-ai-chat-toggle ${e?"epkb-ai-chat-toggle--open":""}`,"aria-label":e?"Close chat":"Open chat",ref:V},e?"Ã—":"ðŸ’¬"))}return ce()}function C(){const e=h();if(!e){console.error("EPKB Chat widget root element not found");return}if(n.createRoot){const t=n.createRoot(e);t.render(o(_))}else{n.render(o(_),e)}}if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",C)}else{C()}})();