(function(){"use strict";const{useState:e,useEffect:a,useRef:t,createElement:s}=React;const{createRoot:n}=ReactDOM;function o({message:e,isUser:a}){return s("div",{className:`epkb-ai-chat-message ${a?"epkb-ai-chat-message--user":"epkb-ai-chat-message--bot"}`},s("div",{className:"epkb-ai-chat-message-content"},e))}function i(){return s("div",{className:"epkb-ai-chat-message"},s("div",{className:"epkb-ai-chat-typing"},s("div",{className:"epkb-ai-chat-typing-dot"}),s("div",{className:"epkb-ai-chat-typing-dot"}),s("div",{className:"epkb-ai-chat-typing-dot"})))}function c(){const[n,c]=e(false);const r=window.epkbAIChat||{};const l=r.welcome||"Hello! How can I help you today?";const[d,p]=e([{id:1,text:l,isUser:false}]);const[u,m]=e("");const[h,f]=e(false);const[b,_]=e("");const[g,k]=e("");const[w,y]=e(false);const[v,N]=e("");const[x,S]=e(false);const I=t(null);const C=t(null);const D=t(null);const j=t(false);a(()=>{U()},[]);a(()=>{if(I.current){I.current.scrollIntoView({behavior:"smooth"})}},[d,h]);a(()=>{if(n&&C.current){C.current.focus()}},[n]);a(()=>()=>{if(D.current){clearTimeout(D.current)}j.current=false},[]);function E(e,a){try{if(e){localStorage.setItem("epkb_ai_chat_session",e)}if(a){localStorage.setItem("epkb_ai_chat_id",a)}}catch(e){console.error("Failed to save session:",e)}}function U(){try{const e=localStorage.getItem("epkb_ai_chat_session");const a=localStorage.getItem("epkb_ai_chat_id");if(e&&a){_(e);k(a);T(e,a)}}catch(e){console.error("Failed to load session:",e)}}function F(){try{localStorage.removeItem("epkb_ai_chat_session");localStorage.removeItem("epkb_ai_chat_id")}catch(e){console.error("Failed to clear session:",e)}}async function T(e,a){if(x||!e||!a){return}y(true);N("");try{const t=new FormData;t.append("action","epkb_ai_get_conversation");t.append("_wpnonce_epkb_ajax_action",r.ai_chat_message_nonce||"");t.append("session_id",e);t.append("chat_id",a);t.append("kb_id",r.kb_id);const s=await fetch(r.ajaxurl||"/wp-admin/admin-ajax.php",{method:"POST",body:t,signal:AbortSignal.timeout(1e4)});const n=await s.json();if(n.success&&n.data&&n.data.messages){const e=n.data.messages.map((e,a)=>({id:Date.now()+a,text:e.content,isUser:e.role==="user"}));if(e.length>0){p(e);S(true)}}}catch(e){console.error("Failed to load conversation history:",e)}finally{y(false)}}async function A(e,a=0){if(j.current){return}j.current=true;y(true);N("");if(a>0){f(true)}try{const a=new FormData;a.append("action","epkb_ai_chat_message");a.append("_wpnonce_epkb_ajax_action",r.ai_chat_message_nonce||"");a.append("message",e);a.append("kb_id",r.kb_id);if(b){a.append("session_id",b)}if(g){a.append("chat_id",g)}const t=await fetch(r.ajaxurl||"/wp-admin/admin-ajax.php",{method:"POST",body:a,signal:AbortSignal.timeout(3e4)});const s=await t.json();if(!s.success){throw new Error(s.data?.message||"Failed to get response")}if(s.data.session_id){_(s.data.session_id)}if(s.data.chat_id){k(s.data.chat_id)}if(s.data.session_id||s.data.chat_id){E(s.data.session_id||b,s.data.chat_id||g)}const n={id:Date.now(),text:s.data.response,isUser:false};p(e=>[...e,n]);f(false);y(false);j.current=false}catch(t){console.error("Chat error:",t);if(a<3&&t.name!=="AbortError"){const t=Math.pow(2,a)*1e3;y(false);j.current=false;D.current=setTimeout(()=>{A(e,a+1)},t)}else{y(false);f(false);j.current=false;N(t.message||r.error||"Sorry, I encountered an error. Please try again.")}}}const P=async()=>{if(!u.trim()||w||j.current)return;if(D.current){clearTimeout(D.current)}N("");const e={id:Date.now(),text:u,isUser:true};p(a=>[...a,e]);const a=u;m("");f(true);await A(a)};const R=e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();P()}};return s("div",{className:"epkb-ai-chat-widget"},n&&s("div",{className:"epkb-ai-chat-window"},s("div",{className:"epkb-ai-chat-header"},s("h3",null,r.title||"AI Assistant"),s("div",{className:"epkb-ai-chat-header-actions"},g&&s("button",{onClick:()=>{if(confirm("Start a new conversation?")){p([{id:Date.now(),text:l,isUser:false}]);_("");k("");N("");F()}},className:"epkb-ai-chat-new",title:"New Conversation"},"ðŸ”„"),s("button",{onClick:()=>c(false),className:"epkb-ai-chat-close"},"Ã—"))),s("div",{className:"epkb-ai-chat-messages"},d.map(e=>s(o,{key:e.id,message:e.text,isUser:e.isUser})),h&&s(i),s("div",{ref:I}),v&&s("div",{className:"epkb-ai-chat-error",style:{position:"sticky",bottom:0,marginTop:"10px"}},v)),s("div",{className:"epkb-ai-chat-input-container"},s("div",{className:"epkb-ai-chat-input-wrapper"},s("input",{ref:C,type:"text",value:u,onChange:e=>m(e.target.value),onKeyPress:R,placeholder:r.placeholder||"Type your message...",className:"epkb-ai-chat-input"}),s("button",{onClick:P,className:`epkb-ai-chat-send ${w?"epkb-ai-chat-send--loading":""}`,disabled:!u.trim()||w},w?"âŸ³":"âž¤")))),s("button",{onClick:()=>c(!n),className:`epkb-ai-chat-toggle ${n?"epkb-ai-chat-toggle--open":""}`},n?"Ã—":"ðŸ’¬"))}function r(){const e=window.epkbChatWidgetRoot||"epkb-ai-chat-widget-root";const a=document.getElementById(e);if(!a){console.error("EPKB Chat widget root element not found");return}const t=n(a);t.render(s(c))}if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",r)}else{r()}})();