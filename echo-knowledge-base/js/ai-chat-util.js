(function(){"use strict";const e="epkb_ai_chat_debug";const t="epkb_debug";function s(){const s=new URLSearchParams(window.location.search);if(s.get(t)==="1"){sessionStorage.setItem(e,"true");return true}return sessionStorage.getItem(e)==="true"}window.epkbEnableDebug=function(t=true){if(t){sessionStorage.setItem(e,"true");console.log("EPKB AI Chat debug mode enabled for this session. Refresh the page to see all debug messages.")}else{sessionStorage.removeItem(e);console.log("EPKB AI Chat debug mode disabled.")}};function a(e,t,s=null){const a=Date.now();const n=Math.random().toString(36).substring(2,11);const r=t?"user":"assistant";return{id:a,messageId:s||`msg_${r}_${a}_${n}`,text:e,isUser:t}}function n(e){const t=e.trim();if(!t){return{valid:false,error:"Empty message"}}if(t.length>2e3){return{valid:false,error:"Message too long",userMessage:"Your message is too long. Please limit it to 2000 characters."}}const s=t.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi,"");const a=Date.now();const n=Math.random().toString(36).substr(2,9);const r=`msg_user_${a}_${n}`;const o={id:a,messageId:r,text:s,isUser:true};return{valid:true,message:o,text:s,messageId:r}}function r(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=Math.random()*16|0;const s=e==="x"?t:t&3|8;return s.toString(16)}))}function o(e){if(typeof marked==="undefined"||!marked||!marked.parse){console.warn("EPKB AI Chat: marked library not available for parsing");return e}try{const t={breaks:true,gfm:true,headerIds:false,mangle:false,sanitize:false};return marked.parse(e,t)}catch(t){console.error("EPKB AI Chat: Error parsing message with marked:",t);return e}}function i(e,t){return(e.status===403||e.status===401)&&t.code==="rest_cookie_invalid_nonce"}function c(e,t=null,s=false){const a={type:"unknown",message:"",code:"",userMessage:"",adminMessage:"",isRetryable:false,statusCode:null,context:{}};if(e.name==="AbortError"||e.message&&e.message.toLowerCase().includes("timeout")||e.message&&e.message.toLowerCase().includes("signal")){a.type="timeout";a.code="timeout_error";a.message="Request timed out";a.userMessage="The response is taking longer than expected. The system will retry automatically.";a.adminMessage="Request timeout: "+(e.message||"Unknown timeout error");a.isRetryable=true;return a}if(t){a.statusCode=t.status||t.statusCode;const e=t.data||t;if(e){a.code=e.code||"";a.message=e.message||"";if(e.data&&e.data.status){a.statusCode=e.data.status}if(e.data&&typeof e.data==="object"){a.context={...e.data,status:undefined}}}if(a.statusCode===401||a.statusCode===403){a.type="authentication";a.userMessage="Authentication failed. Please refresh the page and try again.";a.adminMessage=`Auth error (${a.statusCode}): ${a.message}`}else if(a.statusCode===429){a.type="rate_limit";a.userMessage="Too many requests. Please wait a moment and try again.";a.adminMessage="Rate limit exceeded";a.isRetryable=true;if(e.retry_after){a.context.retryAfter=e.retry_after}}else if(a.statusCode>=500){a.type="server_error";a.userMessage="Server error occurred. Please try again later.";a.adminMessage=`Server error (${a.statusCode}): ${a.message}`;a.isRetryable=true}else if(a.statusCode===404){a.type="not_found";a.userMessage="The requested resource was not found.";a.adminMessage=`Not found (404): ${a.message}`}}if(e instanceof Error){if(!a.message){a.message=e.message}if(e.code&&!a.code){a.code=e.code}if(e.name==="NetworkError"||e.message.includes("network")){a.type="network";a.userMessage="Network error. Please check your internet connection.";a.adminMessage="Network error: "+e.message;a.isRetryable=true}}if(!s){a.finalMessage=a.userMessage||"Unable to connect. Please refresh the page and try again."}else{a.finalMessage=a.adminMessage||a.message||"An unexpected error occurred.";if(a.code){a.finalMessage+=` (Code: ${a.code})`}}if(!a.isRetryable&&a.code){const e=["rate_limit","rate_limit_exceeded","api_error","network_error","server_error","service_unavailable"];a.isRetryable=e.includes(a.code)}return a}function u(){const e=window.epkbChatWidgetRoot||"epkb-ai-chat-widget-root";return document.getElementById(e)}function d(e){return{"X-WP-Nonce":e,"Content-Type":"application/json"}}function l(e,t=null,s=1e4,a=null){const n={method:e,credentials:"same-origin",headers:d(a)};if(t){n.body=JSON.stringify(t)}if(typeof AbortSignal!=="undefined"&&AbortSignal.timeout){n.signal=AbortSignal.timeout(s)}return n}function g(e){const{createElement:t}=e;return function(){return t("div",{className:"epkb-ai-chat-message"},t("div",{className:"epkb-ai-chat-typing"},t("div",{className:"epkb-ai-chat-typing-dot"}),t("div",{className:"epkb-ai-chat-typing-dot"}),t("div",{className:"epkb-ai-chat-typing-dot"})))}}function m(e){const{createElement:t}=e;return function(){return t("div",{className:"epkb-ai-chat-loading-skeleton"},t("div",{className:"epkb-ai-chat-skeleton-message epkb-ai-chat-skeleton-message--bot"},t("div",{className:"epkb-ai-chat-skeleton-line"}),t("div",{className:"epkb-ai-chat-skeleton-line epkb-ai-chat-skeleton-line--short"})),t("div",{className:"epkb-ai-chat-skeleton-message epkb-ai-chat-skeleton-message--user"},t("div",{className:"epkb-ai-chat-skeleton-line"})),t("div",{className:"epkb-ai-chat-skeleton-message epkb-ai-chat-skeleton-message--bot"},t("div",{className:"epkb-ai-chat-skeleton-line"}),t("div",{className:"epkb-ai-chat-skeleton-line"}),t("div",{className:"epkb-ai-chat-skeleton-line epkb-ai-chat-skeleton-line--short"})))}}function f(e){const{useEffect:t}=e;return function(e,s,a){t((()=>{if(!s)return;const t=t=>{if(t.key==="Tab"&&e.current){const s=e.current.querySelectorAll('button:not([disabled]), input:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])');const a=s[0];const n=s[s.length-1];if(t.shiftKey&&document.activeElement===a){t.preventDefault();n.focus()}else if(!t.shiftKey&&document.activeElement===n){t.preventDefault();a.focus()}}if(t.key==="Escape"&&a){a()}};document.addEventListener("keydown",t);return()=>{document.removeEventListener("keydown",t)}}),[s,e,a])}}window.EPKBChatUtils={isDebugMode:s,createMessage:a,prepareMessage:n,generateIdempotencyKey:r,parseMessageFormatting:o,isInvalidNonceError:i,parseErrorResponse:c,getChatRootElement:u,createHeaders:d,createFetchOptions:l,TypingIndicator:g,LoadingSkeleton:m,useFocusTrap:f}})();